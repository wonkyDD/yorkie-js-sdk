(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[476],{1083:function(e,t,r){var i=r(4850);!function(e){"use strict";var t,r,n,s,o,a,l,h,c,u,d,g,f,m,p,y,T,v,b,S,A,k,I,C,w,E,N=Object.defineProperty,__defNormalProp=(e,t,r)=>t in e?N(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,__publicField=(e,t,r)=>(__defNormalProp(e,"symbol"!=typeof t?t+"":t,r),r);function codeToString(e){let t=A[e];return"string"!=typeof t?e.toString():t[0].toLowerCase()+t.substring(1).replace(/[A-Z]/g,e=>"_"+e.toLowerCase())}(t=A||(A={}))[t.Canceled=1]="Canceled",t[t.Unknown=2]="Unknown",t[t.InvalidArgument=3]="InvalidArgument",t[t.DeadlineExceeded=4]="DeadlineExceeded",t[t.NotFound=5]="NotFound",t[t.AlreadyExists=6]="AlreadyExists",t[t.PermissionDenied=7]="PermissionDenied",t[t.ResourceExhausted=8]="ResourceExhausted",t[t.FailedPrecondition=9]="FailedPrecondition",t[t.Aborted=10]="Aborted",t[t.OutOfRange=11]="OutOfRange",t[t.Unimplemented=12]="Unimplemented",t[t.Internal=13]="Internal",t[t.Unavailable=14]="Unavailable",t[t.DataLoss=15]="DataLoss",t[t.Unauthenticated=16]="Unauthenticated";let ConnectError=class ConnectError extends Error{constructor(e,t=A.Unknown,r,i,n){super(e.length?`[${codeToString(t)}] ${e}`:`[${codeToString(t)}]`),this.name="ConnectError",Object.setPrototypeOf(this,new.target.prototype),this.rawMessage=e,this.code=t,this.metadata=new Headers(null!=r?r:{}),this.details=null!=i?i:[],this.cause=n}static from(e,t=A.Unknown){return e instanceof ConnectError?e:e instanceof Error?"AbortError"==e.name?new ConnectError(e.message,A.Canceled):new ConnectError(e.message,t,void 0,void 0,e):new ConnectError(String(e),t,void 0,void 0,e)}static[Symbol.hasInstance](e){return e instanceof Error&&(Object.getPrototypeOf(e)===ConnectError.prototype||"ConnectError"===e.name&&"code"in e&&"number"==typeof e.code&&"metadata"in e&&"details"in e&&Array.isArray(e.details)&&"rawMessage"in e&&"string"==typeof e.rawMessage&&"cause"in e)}findDetails(e){let t="typeName"in e?{findMessage:t=>t===e.typeName?e:void 0}:e,r=[];for(let e of this.details){if("getType"in e){t.findMessage(e.getType().typeName)&&r.push(e);continue}let i=t.findMessage(e.type);if(i)try{r.push(i.fromBinary(e.value))}catch(e){}}return r}};function assert(e,t){if(!e)throw Error(t)}function assertInt32(e){if("number"!=typeof e)throw Error("invalid int 32: "+typeof e);if(!Number.isInteger(e)||e>2147483647||e<-2147483648)throw Error("invalid int 32: "+e)}function assertUInt32(e){if("number"!=typeof e)throw Error("invalid uint 32: "+typeof e);if(!Number.isInteger(e)||e>4294967295||e<0)throw Error("invalid uint 32: "+e)}function assertFloat32(e){if("number"!=typeof e)throw Error("invalid float 32: "+typeof e);if(Number.isFinite(e)&&(e>34028234663852886e22||e<-34028234663852886e22))throw Error("invalid float 32: "+e)}let D=Symbol("@bufbuild/protobuf/enum-type");function setEnumType(e,t,r,i){e[D]=makeEnumType(t,r.map(t=>({no:t.no,name:t.name,localName:e[t.no]})))}function makeEnumType(e,t,r){let i=Object.create(null),n=Object.create(null),s=[];for(let e of t){let t=normalizeEnumValue(e);s.push(t),i[e.name]=t,n[e.no]=t}return{typeName:e,values:s,findName:e=>i[e],findNumber:e=>n[e]}}function normalizeEnumValue(e){return"localName"in e?e:Object.assign(Object.assign({},e),{localName:e.name})}let Message=class Message{equals(e){return this.getType().runtime.util.equals(this.getType(),this,e)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(e,t){let r=this.getType(),i=r.runtime.bin,n=i.makeReadOptions(t);return i.readMessage(this,n.readerFactory(e),e.byteLength,n),this}fromJson(e,t){let r=this.getType(),i=r.runtime.json,n=i.makeReadOptions(t);return i.readMessage(r,e,n,this),this}fromJsonString(e,t){let r;try{r=JSON.parse(e)}catch(e){throw Error(`cannot decode ${this.getType().typeName} from JSON: ${e instanceof Error?e.message:String(e)}`)}return this.fromJson(r,t)}toBinary(e){let t=this.getType(),r=t.runtime.bin,i=r.makeWriteOptions(e),n=i.writerFactory();return r.writeMessage(this,n,i),n.finish()}toJson(e){let t=this.getType(),r=t.runtime.json,i=r.makeWriteOptions(e);return r.writeMessage(this,i)}toJsonString(e){var t;let r=this.toJson(e);return JSON.stringify(r,null,null!==(t=null==e?void 0:e.prettySpaces)&&void 0!==t?t:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}};function varint64read(){let e=0,t=0;for(let r=0;r<28;r+=7){let i=this.buf[this.pos++];if(e|=(127&i)<<r,(128&i)==0)return this.assertBounds(),[e,t]}let r=this.buf[this.pos++];if(e|=(15&r)<<28,t=(112&r)>>4,(128&r)==0)return this.assertBounds(),[e,t];for(let r=3;r<=31;r+=7){let i=this.buf[this.pos++];if(t|=(127&i)<<r,(128&i)==0)return this.assertBounds(),[e,t]}throw Error("invalid varint")}function varint64write(e,t,r){for(let i=0;i<28;i+=7){let n=e>>>i,s=!(n>>>7==0&&0==t),o=(s?128|n:n)&255;if(r.push(o),!s)return}let i=e>>>28&15|(7&t)<<4,n=t>>3!=0;if(r.push((n?128|i:i)&255),n){for(let e=3;e<31;e+=7){let i=t>>>e,n=i>>>7!=0,s=(n?128|i:i)&255;if(r.push(s),!n)return}r.push(t>>>31&1)}}function int64FromString(e){let t="-"===e[0];t&&(e=e.slice(1));let r=0,i=0;function add1e6digit(t,n){let s=Number(e.slice(t,n));i*=1e6,(r=1e6*r+s)>=4294967296&&(i+=r/4294967296|0,r%=4294967296)}return add1e6digit(-24,-18),add1e6digit(-18,-12),add1e6digit(-12,-6),add1e6digit(-6),t?negate(r,i):newBits(r,i)}function uInt64ToString(e,t){if({lo:e,hi:t}={lo:e>>>0,hi:t>>>0},t<=2097151)return String(4294967296*t+e);let r=16777215&e,i=(e>>>24|t<<8)&16777215,n=t>>16&65535,s=r+6777216*i+6710656*n,o=i+8147497*n,a=2*n;return s>=1e7&&(o+=Math.floor(s/1e7),s%=1e7),o>=1e7&&(a+=Math.floor(o/1e7),o%=1e7),a.toString()+decimalFrom1e7WithLeadingZeros(o)+decimalFrom1e7WithLeadingZeros(s)}function newBits(e,t){return{lo:0|e,hi:0|t}}function negate(e,t){return t=~t,e?e=~e+1:t+=1,newBits(e,t)}let decimalFrom1e7WithLeadingZeros=e=>{let t=String(e);return"0000000".slice(t.length)+t};function varint32write(e,t){if(e>=0){for(;e>127;)t.push(127&e|128),e>>>=7;t.push(e)}else{for(let r=0;r<9;r++)t.push(127&e|128),e>>=7;t.push(1)}}function varint32read(){let e=this.buf[this.pos++],t=127&e;if((128&e)==0||(t|=(127&(e=this.buf[this.pos++]))<<7,(128&e)==0)||(t|=(127&(e=this.buf[this.pos++]))<<14,(128&e)==0)||(t|=(127&(e=this.buf[this.pos++]))<<21,(128&e)==0))return this.assertBounds(),t;t|=(15&(e=this.buf[this.pos++]))<<28;for(let t=5;(128&e)!=0&&t<10;t++)e=this.buf[this.pos++];if((128&e)!=0)throw Error("invalid varint");return this.assertBounds(),t>>>0}let x=function(){let e=new DataView(new ArrayBuffer(8)),t="function"==typeof BigInt&&"function"==typeof e.getBigInt64&&"function"==typeof e.getBigUint64&&"function"==typeof e.setBigInt64&&"function"==typeof e.setBigUint64&&("object"!=typeof i||"object"!=typeof i.env||"1"!==i.env.BUF_BIGINT_DISABLE);if(t){let t=BigInt("-9223372036854775808"),r=BigInt("9223372036854775807"),i=BigInt("0"),n=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(e){let i="bigint"==typeof e?e:BigInt(e);if(i>r||i<t)throw Error(`int64 invalid: ${e}`);return i},uParse(e){let t="bigint"==typeof e?e:BigInt(e);if(t>n||t<i)throw Error(`uint64 invalid: ${e}`);return t},enc(t){return e.setBigInt64(0,this.parse(t),!0),{lo:e.getInt32(0,!0),hi:e.getInt32(4,!0)}},uEnc(t){return e.setBigInt64(0,this.uParse(t),!0),{lo:e.getInt32(0,!0),hi:e.getInt32(4,!0)}},dec:(t,r)=>(e.setInt32(0,t,!0),e.setInt32(4,r,!0),e.getBigInt64(0,!0)),uDec:(t,r)=>(e.setInt32(0,t,!0),e.setInt32(4,r,!0),e.getBigUint64(0,!0))}}let assertInt64String=e=>assert(/^-?[0-9]+$/.test(e),`int64 invalid: ${e}`),assertUInt64String=e=>assert(/^[0-9]+$/.test(e),`uint64 invalid: ${e}`);return{zero:"0",supported:!1,parse:e=>("string"!=typeof e&&(e=e.toString()),assertInt64String(e),e),uParse:e=>("string"!=typeof e&&(e=e.toString()),assertUInt64String(e),e),enc:e=>("string"!=typeof e&&(e=e.toString()),assertInt64String(e),int64FromString(e)),uEnc:e=>("string"!=typeof e&&(e=e.toString()),assertUInt64String(e),int64FromString(e)),dec:(e,t)=>(function(e,t){let r=newBits(e,t),i=2147483648&r.hi;i&&(r=negate(r.lo,r.hi));let n=uInt64ToString(r.lo,r.hi);return i?"-"+n:n})(e,t),uDec:(e,t)=>uInt64ToString(e,t)}}();function scalarEquals(e,t,r){if(t===r)return!0;if(e==k.BYTES){if(!(t instanceof Uint8Array)||!(r instanceof Uint8Array)||t.length!==r.length)return!1;for(let e=0;e<t.length;e++)if(t[e]!==r[e])return!1;return!0}switch(e){case k.UINT64:case k.FIXED64:case k.INT64:case k.SFIXED64:case k.SINT64:return t==r}return!1}function scalarZeroValue(e,t){switch(e){case k.BOOL:return!1;case k.UINT64:case k.FIXED64:case k.INT64:case k.SFIXED64:case k.SINT64:return 0==t?x.zero:"0";case k.DOUBLE:case k.FLOAT:return 0;case k.BYTES:return new Uint8Array(0);case k.STRING:return"";default:return 0}}function isScalarZeroValue(e,t){switch(e){case k.BOOL:return!1===t;case k.STRING:return""===t;case k.BYTES:return t instanceof Uint8Array&&!t.byteLength;default:return 0==t}}(r=k||(k={}))[r.DOUBLE=1]="DOUBLE",r[r.FLOAT=2]="FLOAT",r[r.INT64=3]="INT64",r[r.UINT64=4]="UINT64",r[r.INT32=5]="INT32",r[r.FIXED64=6]="FIXED64",r[r.FIXED32=7]="FIXED32",r[r.BOOL=8]="BOOL",r[r.STRING=9]="STRING",r[r.BYTES=12]="BYTES",r[r.UINT32=13]="UINT32",r[r.SFIXED32=15]="SFIXED32",r[r.SFIXED64=16]="SFIXED64",r[r.SINT32=17]="SINT32",r[r.SINT64=18]="SINT64",(n=I||(I={}))[n.BIGINT=0]="BIGINT",n[n.STRING=1]="STRING",(s=C||(C={}))[s.Varint=0]="Varint",s[s.Bit64=1]="Bit64",s[s.LengthDelimited=2]="LengthDelimited",s[s.StartGroup=3]="StartGroup",s[s.EndGroup=4]="EndGroup",s[s.Bit32=5]="Bit32";let BinaryWriter=class BinaryWriter{constructor(e){this.stack=[],this.textEncoder=null!=e?e:new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let t=0;t<this.chunks.length;t++)e+=this.chunks[t].length;let t=new Uint8Array(e),r=0;for(let e=0;e<this.chunks.length;e++)t.set(this.chunks[e],r),r+=this.chunks[e].length;return this.chunks=[],t}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),t=this.stack.pop();if(!t)throw Error("invalid state, fork stack empty");return this.chunks=t.chunks,this.buf=t.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(assertUInt32(e);e>127;)this.buf.push(127&e|128),e>>>=7;return this.buf.push(e),this}int32(e){return assertInt32(e),varint32write(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let t=this.textEncoder.encode(e);return this.uint32(t.byteLength),this.raw(t)}float(e){assertFloat32(e);let t=new Uint8Array(4);return new DataView(t.buffer).setFloat32(0,e,!0),this.raw(t)}double(e){let t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),this.raw(t)}fixed32(e){assertUInt32(e);let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),this.raw(t)}sfixed32(e){assertInt32(e);let t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),this.raw(t)}sint32(e){return assertInt32(e),varint32write(e=(e<<1^e>>31)>>>0,this.buf),this}sfixed64(e){let t=new Uint8Array(8),r=new DataView(t.buffer),i=x.enc(e);return r.setInt32(0,i.lo,!0),r.setInt32(4,i.hi,!0),this.raw(t)}fixed64(e){let t=new Uint8Array(8),r=new DataView(t.buffer),i=x.uEnc(e);return r.setInt32(0,i.lo,!0),r.setInt32(4,i.hi,!0),this.raw(t)}int64(e){let t=x.enc(e);return varint64write(t.lo,t.hi,this.buf),this}sint64(e){let t=x.enc(e),r=t.hi>>31;return varint64write(t.lo<<1^r,(t.hi<<1|t.lo>>>31)^r,this.buf),this}uint64(e){let t=x.uEnc(e);return varint64write(t.lo,t.hi,this.buf),this}};let BinaryReader=class BinaryReader{constructor(e,t){this.varint64=varint64read,this.uint32=varint32read,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=null!=t?t:new TextDecoder}tag(){let e=this.uint32(),t=e>>>3,r=7&e;if(t<=0||r<0||r>5)throw Error("illegal tag: field no "+t+" wire type "+r);return[t,r]}skip(e,t){let r=this.pos;switch(e){case C.Varint:for(;128&this.buf[this.pos++];);break;case C.Bit64:this.pos+=4;case C.Bit32:this.pos+=4;break;case C.LengthDelimited:let i=this.uint32();this.pos+=i;break;case C.StartGroup:for(;;){let[e,r]=this.tag();if(r===C.EndGroup){if(void 0!==t&&e!==t)throw Error("invalid end group tag");break}this.skip(r,e)}break;default:throw Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(r,this.pos)}assertBounds(){if(this.pos>this.len)throw RangeError("premature EOF")}int32(){return 0|this.uint32()}sint32(){let e=this.uint32();return e>>>1^-(1&e)}int64(){return x.dec(...this.varint64())}uint64(){return x.uDec(...this.varint64())}sint64(){let[e,t]=this.varint64(),r=-(1&e);return e=(e>>>1|(1&t)<<31)^r,t=t>>>1^r,x.dec(e,t)}bool(){let[e,t]=this.varint64();return 0!==e||0!==t}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return x.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return x.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),t=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}};function createExtensionContainer(e){let t=e.field.localName,r=Object.create(null);return r[t]=function(e){let t=e.field;if(t.repeated)return[];if(void 0!==t.default)return t.default;switch(t.kind){case"enum":return t.T.values[0].no;case"scalar":return scalarZeroValue(t.T,t.L);case"message":let r=t.T,i=new r;return r.fieldWrapper?r.fieldWrapper.unwrapField(i):i;case"map":throw"map fields are not allowed to be extensions"}}(e),[r,()=>r[t]]}let R="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),_=[];for(let e=0;e<R.length;e++)_[R[e].charCodeAt(0)]=e;_["-".charCodeAt(0)]=R.indexOf("+"),_["_".charCodeAt(0)]=R.indexOf("/");let O={dec(e){let t=3*e.length/4;"="==e[e.length-2]?t-=2:"="==e[e.length-1]&&(t-=1);let r=new Uint8Array(t),i=0,n=0,s,o=0;for(let t=0;t<e.length;t++){if(void 0===(s=_[e.charCodeAt(t)]))switch(e[t]){case"=":n=0;case"\n":case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(n){case 0:o=s,n=1;break;case 1:r[i++]=o<<2|(48&s)>>4,o=s,n=2;break;case 2:r[i++]=(15&o)<<4|(60&s)>>2,o=s,n=3;break;case 3:r[i++]=(3&o)<<6|s,n=0}}if(1==n)throw Error("invalid base64 string.");return r.subarray(0,i)},enc(e){let t="",r=0,i,n=0;for(let s=0;s<e.length;s++)switch(i=e[s],r){case 0:t+=R[i>>2],n=(3&i)<<4,r=1;break;case 1:t+=R[n|i>>4],n=(15&i)<<2,r=2;break;case 2:t+=R[n|i>>6]+R[63&i],r=0}return r&&(t+=R[n]+"=",1==r&&(t+="=")),t}};function hasExtension(e,t){let r=e.getType();return t.extendee.typeName===r.typeName&&!!r.runtime.bin.listUnknownFields(e).find(e=>e.no==t.field.no)}function assertExtendee(e,t){assert(e.extendee.typeName==t.getType().typeName,`extension ${e.typeName} can only be applied to message ${e.extendee.typeName}`)}function isFieldSet(e,t){let r=e.localName;if(e.repeated)return t[r].length>0;if(e.oneof)return t[e.oneof.localName].case===r;switch(e.kind){case"enum":case"scalar":if(e.opt||e.req)return void 0!==t[r];if("enum"==e.kind)return t[r]!==e.T.values[0].no;return!isScalarZeroValue(e.T,t[r]);case"message":return void 0!==t[r];case"map":return Object.keys(t[r]).length>0}}function clearField(e,t){let r=e.localName,i=!e.opt&&!e.req;if(e.repeated)t[r]=[];else if(e.oneof)t[e.oneof.localName]={case:void 0};else switch(e.kind){case"map":t[r]={};break;case"enum":t[r]=i?e.T.values[0].no:void 0;break;case"scalar":t[r]=i?scalarZeroValue(e.T,e.L):void 0;break;case"message":t[r]=void 0}}function isMessage(e,t){if(null===e||"object"!=typeof e||!Object.getOwnPropertyNames(Message.prototype).every(t=>t in e&&"function"==typeof e[t]))return!1;let r=e.getType();return null!==r&&"function"==typeof r&&"typeName"in r&&"string"==typeof r.typeName&&(void 0===t||r.typeName==t.typeName)}function wrapField(e,t){return isMessage(t)||!e.fieldWrapper?t:e.fieldWrapper.wrapField(t)}k.DOUBLE,k.FLOAT,k.INT64,k.UINT64,k.INT32,k.UINT32,k.BOOL,k.STRING,k.BYTES;let P={ignoreUnknownFields:!1},F={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0},B=Symbol(),L=Symbol();function debugJsonValue(e){if(null===e)return"null";switch(typeof e){case"object":return Array.isArray(e)?"array":"object";case"string":return e.length>100?"string":`"${e.split('"').join('\\"')}"`;default:return String(e)}}function readField$1(e,t,r,i,n){let s=r.localName;if(r.repeated){if(assert("map"!=r.kind),null===t)return;if(!Array.isArray(t))throw Error(`cannot decode field ${n.typeName}.${r.name} from JSON: ${debugJsonValue(t)}`);let o=e[s];for(let e of t){if(null===e)throw Error(`cannot decode field ${n.typeName}.${r.name} from JSON: ${debugJsonValue(e)}`);switch(r.kind){case"message":o.push(r.T.fromJson(e,i));break;case"enum":let t=readEnum(r.T,e,i.ignoreUnknownFields,!0);t!==L&&o.push(t);break;case"scalar":try{o.push(readScalar$1(r.T,e,r.L,!0))}catch(i){let t=`cannot decode field ${n.typeName}.${r.name} from JSON: ${debugJsonValue(e)}`;throw i instanceof Error&&i.message.length>0&&(t+=`: ${i.message}`),Error(t)}}}}else if("map"==r.kind){if(null===t)return;if("object"!=typeof t||Array.isArray(t))throw Error(`cannot decode field ${n.typeName}.${r.name} from JSON: ${debugJsonValue(t)}`);let o=e[s];for(let[e,s]of Object.entries(t)){let a;if(null===s)throw Error(`cannot decode field ${n.typeName}.${r.name} from JSON: map value null`);try{a=function(e,t){if(e===k.BOOL)switch(t){case"true":t=!0;break;case"false":t=!1}return readScalar$1(e,t,I.BIGINT,!0).toString()}(r.K,e)}catch(i){let e=`cannot decode map key for field ${n.typeName}.${r.name} from JSON: ${debugJsonValue(t)}`;throw i instanceof Error&&i.message.length>0&&(e+=`: ${i.message}`),Error(e)}switch(r.V.kind){case"message":o[a]=r.V.T.fromJson(s,i);break;case"enum":let l=readEnum(r.V.T,s,i.ignoreUnknownFields,!0);l!==L&&(o[a]=l);break;case"scalar":try{o[a]=readScalar$1(r.V.T,s,I.BIGINT,!0)}catch(i){let e=`cannot decode map value for field ${n.typeName}.${r.name} from JSON: ${debugJsonValue(t)}`;throw i instanceof Error&&i.message.length>0&&(e+=`: ${i.message}`),Error(e)}}}}else switch(r.oneof&&(e=e[r.oneof.localName]={case:s},s="value"),r.kind){case"message":let o=r.T;if(null===t&&"google.protobuf.Value"!=o.typeName)return;let a=e[s];isMessage(a)?a.fromJson(t,i):(e[s]=a=o.fromJson(t,i),o.fieldWrapper&&!r.oneof&&(e[s]=o.fieldWrapper.unwrapField(a)));break;case"enum":let l=readEnum(r.T,t,i.ignoreUnknownFields,!1);switch(l){case B:clearField(r,e);break;case L:break;default:e[s]=l}break;case"scalar":try{let i=readScalar$1(r.T,t,r.L,!1);i===B?clearField(r,e):e[s]=i}catch(i){let e=`cannot decode field ${n.typeName}.${r.name} from JSON: ${debugJsonValue(t)}`;throw i instanceof Error&&i.message.length>0&&(e+=`: ${i.message}`),Error(e)}}}function readScalar$1(e,t,r,i){if(null===t)return i?scalarZeroValue(e,r):B;switch(e){case k.DOUBLE:case k.FLOAT:if("NaN"===t)return Number.NaN;if("Infinity"===t)return Number.POSITIVE_INFINITY;if("-Infinity"===t)return Number.NEGATIVE_INFINITY;if(""===t||"string"==typeof t&&t.trim().length!==t.length||"string"!=typeof t&&"number"!=typeof t)break;let n=Number(t);if(Number.isNaN(n)||!Number.isFinite(n))break;return e==k.FLOAT&&assertFloat32(n),n;case k.INT32:case k.FIXED32:case k.SFIXED32:case k.SINT32:case k.UINT32:let s;if("number"==typeof t?s=t:"string"==typeof t&&t.length>0&&t.trim().length===t.length&&(s=Number(t)),void 0===s)break;return e==k.UINT32||e==k.FIXED32?assertUInt32(s):assertInt32(s),s;case k.INT64:case k.SFIXED64:case k.SINT64:if("number"!=typeof t&&"string"!=typeof t)break;let o=x.parse(t);return r?o.toString():o;case k.FIXED64:case k.UINT64:if("number"!=typeof t&&"string"!=typeof t)break;let a=x.uParse(t);return r?a.toString():a;case k.BOOL:if("boolean"!=typeof t)break;return t;case k.STRING:if("string"!=typeof t)break;try{encodeURIComponent(t)}catch(e){throw Error("invalid UTF8")}return t;case k.BYTES:if(""===t)return new Uint8Array(0);if("string"!=typeof t)break;return O.dec(t)}throw Error()}function readEnum(e,t,r,i){if(null===t)return"google.protobuf.NullValue"==e.typeName?0:i?e.values[0].no:B;switch(typeof t){case"number":if(Number.isInteger(t))return t;break;case"string":let n=e.findName(t);if(void 0!==n)return n.no;if(r)return L}throw Error(`cannot decode enum ${e.typeName} from JSON: ${debugJsonValue(t)}`)}function writeField$1(e,t,r){if("map"==e.kind){assert("object"==typeof t&&null!=t);let i={},n=Object.entries(t);switch(e.V.kind){case"scalar":for(let[t,r]of n)i[t.toString()]=writeScalar$1(e.V.T,r);break;case"message":for(let[e,t]of n)i[e.toString()]=t.toJson(r);break;case"enum":let s=e.V.T;for(let[e,t]of n)i[e.toString()]=writeEnum(s,t,r.enumAsInteger)}return r.emitDefaultValues||n.length>0?i:void 0}if(e.repeated){assert(Array.isArray(t));let i=[];switch(e.kind){case"scalar":for(let r=0;r<t.length;r++)i.push(writeScalar$1(e.T,t[r]));break;case"enum":for(let n=0;n<t.length;n++)i.push(writeEnum(e.T,t[n],r.enumAsInteger));break;case"message":for(let e=0;e<t.length;e++)i.push(t[e].toJson(r))}return r.emitDefaultValues||i.length>0?i:void 0}switch(e.kind){case"scalar":return writeScalar$1(e.T,t);case"enum":return writeEnum(e.T,t,r.enumAsInteger);case"message":return wrapField(e.T,t).toJson(r)}}function writeEnum(e,t,r){var i;if(assert("number"==typeof t),"google.protobuf.NullValue"==e.typeName)return null;if(r)return t;let n=e.findNumber(t);return null!==(i=null==n?void 0:n.name)&&void 0!==i?i:t}function writeScalar$1(e,t){switch(e){case k.INT32:case k.SFIXED32:case k.SINT32:case k.FIXED32:case k.UINT32:return assert("number"==typeof t),t;case k.FLOAT:case k.DOUBLE:if(assert("number"==typeof t),Number.isNaN(t))return"NaN";if(t===Number.POSITIVE_INFINITY)return"Infinity";if(t===Number.NEGATIVE_INFINITY)return"-Infinity";return t;case k.STRING:return assert("string"==typeof t),t;case k.BOOL:return assert("boolean"==typeof t),t;case k.UINT64:case k.FIXED64:case k.INT64:case k.SFIXED64:case k.SINT64:return assert("bigint"==typeof t||"string"==typeof t||"number"==typeof t),t.toString();case k.BYTES:return assert(t instanceof Uint8Array),O.enc(t)}}let M=Symbol("@bufbuild/protobuf/unknown-fields"),V={readUnknownFields:!0,readerFactory:e=>new BinaryReader(e)},$={writeUnknownFields:!0,writerFactory:()=>new BinaryWriter};function readField(e,t,r,i,n){let{repeated:s,localName:o}=r;switch(r.oneof&&((e=e[r.oneof.localName]).case!=o&&delete e.value,e.case=o,o="value"),r.kind){case"scalar":case"enum":let a="enum"==r.kind?k.INT32:r.T,l=readScalar;if("scalar"==r.kind&&r.L>0&&(l=readScalarLTString),s){let r=e[o],n=i==C.LengthDelimited&&a!=k.STRING&&a!=k.BYTES;if(n){let e=t.uint32()+t.pos;for(;t.pos<e;)r.push(l(t,a))}else r.push(l(t,a))}else e[o]=l(t,a);break;case"message":let h=r.T;s?e[o].push(readMessageField(t,new h,n,r)):isMessage(e[o])?readMessageField(t,e[o],n,r):(e[o]=readMessageField(t,new h,n,r),!h.fieldWrapper||r.oneof||r.repeated||(e[o]=h.fieldWrapper.unwrapField(e[o])));break;case"map":let[c,u]=function(e,t,r){let i,n;let s=t.uint32(),o=t.pos+s;for(;t.pos<o;){let[s]=t.tag();switch(s){case 1:i=readScalar(t,e.K);break;case 2:switch(e.V.kind){case"scalar":n=readScalar(t,e.V.T);break;case"enum":n=t.int32();break;case"message":n=readMessageField(t,new e.V.T,r,void 0)}}}if(void 0===i&&(i=scalarZeroValue(e.K,I.BIGINT)),"string"!=typeof i&&"number"!=typeof i&&(i=i.toString()),void 0===n)switch(e.V.kind){case"scalar":n=scalarZeroValue(e.V.T,I.BIGINT);break;case"enum":n=e.V.T.values[0].no;break;case"message":n=new e.V.T}return[i,n]}(r,t,n);e[o][c]=u}}function readMessageField(e,t,r,i){let n=t.getType().runtime.bin,s=null==i?void 0:i.delimited;return n.readMessage(t,e,s?i.no:e.uint32(),r,s),t}function readScalarLTString(e,t){let r=readScalar(e,t);return"bigint"==typeof r?r.toString():r}function readScalar(e,t){switch(t){case k.STRING:return e.string();case k.BOOL:return e.bool();case k.DOUBLE:return e.double();case k.FLOAT:return e.float();case k.INT32:return e.int32();case k.INT64:return e.int64();case k.UINT64:return e.uint64();case k.FIXED64:return e.fixed64();case k.BYTES:return e.bytes();case k.FIXED32:return e.fixed32();case k.SFIXED32:return e.sfixed32();case k.SFIXED64:return e.sfixed64();case k.SINT64:return e.sint64();case k.UINT32:return e.uint32();case k.SINT32:return e.sint32()}}function writeField(e,t,r,i){assert(void 0!==t);let n=e.repeated;switch(e.kind){case"scalar":case"enum":let s="enum"==e.kind?k.INT32:e.T;if(n){if(assert(Array.isArray(t)),e.packed)!function(e,t,r,i){if(!i.length)return;e.tag(r,C.LengthDelimited).fork();let[,n]=scalarTypeInfo(t);for(let t=0;t<i.length;t++)e[n](i[t]);e.join()}(r,s,e.no,t);else for(let i of t)writeScalar(r,s,e.no,i)}else writeScalar(r,s,e.no,t);break;case"message":if(n)for(let n of(assert(Array.isArray(t)),t))writeMessageField(r,i,e,n);else writeMessageField(r,i,e,t);break;case"map":for(let[n,s]of(assert("object"==typeof t&&null!=t),Object.entries(t)))!function(e,t,r,i,n){e.tag(r.no,C.LengthDelimited),e.fork();let s=i;switch(r.K){case k.INT32:case k.FIXED32:case k.UINT32:case k.SFIXED32:case k.SINT32:s=Number.parseInt(i);break;case k.BOOL:assert("true"==i||"false"==i),s="true"==i}switch(writeScalar(e,r.K,1,s),r.V.kind){case"scalar":writeScalar(e,r.V.T,2,n);break;case"enum":writeScalar(e,k.INT32,2,n);break;case"message":assert(void 0!==n),e.tag(2,C.LengthDelimited).bytes(n.toBinary(t))}e.join()}(r,i,e,n,s)}}function writeMessageField(e,t,r,i){let n=wrapField(r.T,i);r.delimited?e.tag(r.no,C.StartGroup).raw(n.toBinary(t)).tag(r.no,C.EndGroup):e.tag(r.no,C.LengthDelimited).bytes(n.toBinary(t))}function writeScalar(e,t,r,i){assert(void 0!==i);let[n,s]=scalarTypeInfo(t);e.tag(r,n)[s](i)}function scalarTypeInfo(e){let t=C.Varint;switch(e){case k.BYTES:case k.STRING:t=C.LengthDelimited;break;case k.DOUBLE:case k.FIXED64:case k.SFIXED64:t=C.Bit64;break;case k.FIXED32:case k.SFIXED32:case k.FLOAT:t=C.Bit32}let r=k[e].toLowerCase();return[t,r]}function cloneSingularField(e){if(void 0===e)return e;if(isMessage(e))return e.clone();if(e instanceof Uint8Array){let t=new Uint8Array(e.byteLength);return t.set(e),t}return e}function toU8Arr(e){return e instanceof Uint8Array?e:new Uint8Array(e)}let InternalFieldList=class InternalFieldList{constructor(e,t){this._fields=e,this._normalizer=t}findJsonName(e){if(!this.jsonNames){let e={};for(let t of this.list())e[t.jsonName]=e[t.name]=t;this.jsonNames=e}return this.jsonNames[e]}find(e){if(!this.numbers){let e={};for(let t of this.list())e[t.no]=t;this.numbers=e}return this.numbers[e]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort((e,t)=>e.no-t.no)),this.numbersAsc}byMember(){if(!this.members){let e;this.members=[];let t=this.members;for(let r of this.list())r.oneof?r.oneof!==e&&(e=r.oneof,t.push(e)):t.push(r)}return this.members}};function localFieldName(e,t){let r=protoCamelCase(e);return t?r:safeObjectProperty(safeMessageProperty(r))}let U=protoCamelCase;function protoCamelCase(e){let t=!1,r=[];for(let i=0;i<e.length;i++){let n=e.charAt(i);switch(n){case"_":t=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":r.push(n),t=!1;break;default:t&&(t=!1,n=n.toUpperCase()),r.push(n)}}return r.join("")}let J=new Set(["constructor","toString","toJSON","valueOf"]),j=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),fallback=e=>`${e}$`,safeMessageProperty=e=>j.has(e)?fallback(e):e,safeObjectProperty=e=>J.has(e)?fallback(e):e;let InternalOneofInfo=class InternalOneofInfo{constructor(e){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=e,this.localName=localFieldName(e,!1)}addField(e){assert(e.oneof===this,`field ${e.name} not one of ${this.name}`),this.fields.push(e)}findField(e){if(!this._lookup){this._lookup=Object.create(null);for(let e=0;e<this.fields.length;e++)this._lookup[this.fields[e].localName]=this.fields[e]}return this._lookup[e]}};let q={syntax:"proto3",json:{makeReadOptions:function(e){return e?Object.assign(Object.assign({},P),e):P},makeWriteOptions:function(e){return e?Object.assign(Object.assign({},F),e):F},readMessage(e,t,r,i){if(null==t||Array.isArray(t)||"object"!=typeof t)throw Error(`cannot decode message ${e.typeName} from JSON: ${debugJsonValue(t)}`);i=null!=i?i:new e;let n=new Map,s=r.typeRegistry;for(let[o,a]of Object.entries(t)){let t=e.fields.findJsonName(o);if(t){if(t.oneof){if(null===a&&"scalar"==t.kind)continue;let r=n.get(t.oneof);if(void 0!==r)throw Error(`cannot decode message ${e.typeName} from JSON: multiple keys for oneof "${t.oneof.name}" present: "${r}", "${o}"`);n.set(t.oneof,o)}readField$1(i,a,t,r,e)}else{let t=!1;if((null==s?void 0:s.findExtension)&&o.startsWith("[")&&o.endsWith("]")){let n=s.findExtension(o.substring(1,o.length-1));if(n&&n.extendee.typeName==e.typeName){t=!0;let[e,s]=createExtensionContainer(n);readField$1(e,a,n.field,r,n),function(e,t,r,i){assertExtendee(t,e);let n=t.runtime.bin.makeReadOptions(i),s=t.runtime.bin.makeWriteOptions(i);if(hasExtension(e,t)){let r=e.getType().runtime.bin.listUnknownFields(e).filter(e=>e.no!=t.field.no);for(let t of(e.getType().runtime.bin.discardUnknownFields(e),r))e.getType().runtime.bin.onUnknownField(e,t.no,t.wireType,t.data)}let o=s.writerFactory(),a=t.field;a.opt||a.repeated||"enum"!=a.kind&&"scalar"!=a.kind||(a=Object.assign(Object.assign({},t.field),{opt:!0})),t.runtime.bin.writeField(a,r,o,s);let l=n.readerFactory(o.finish());for(;l.pos<l.len;){let[t,r]=l.tag(),i=l.skip(r,t);e.getType().runtime.bin.onUnknownField(e,t,r,i)}}(i,n,s(),r)}}if(!t&&!r.ignoreUnknownFields)throw Error(`cannot decode message ${e.typeName} from JSON: key "${o}" is unknown`)}}return i},writeMessage(e,t){let r;let i=e.getType(),n={};try{for(r of i.fields.byNumber()){if(!isFieldSet(r,e)){var s;if(r.req)throw"required field not set";if(!t.emitDefaultValues||!((s=r).repeated||"map"==s.kind||!s.oneof&&"message"!=s.kind&&!s.opt&&!s.req))continue}let i=r.oneof?e[r.oneof.localName].value:e[r.localName],o=writeField$1(r,i,t);void 0!==o&&(n[t.useProtoFieldName?r.name:r.jsonName]=o)}let o=t.typeRegistry;if(null==o?void 0:o.findExtensionFor)for(let r of i.runtime.bin.listUnknownFields(e)){let s=o.findExtensionFor(i.typeName,r.no);if(s&&hasExtension(e,s)){let r=function(e,t,r){assertExtendee(t,e);let i=t.runtime.bin.makeReadOptions(r),n=function(e,t){if(!t.repeated&&("enum"==t.kind||"scalar"==t.kind)){for(let r=e.length-1;r>=0;--r)if(e[r].no==t.no)return[e[r]];return[]}return e.filter(e=>e.no===t.no)}(e.getType().runtime.bin.listUnknownFields(e),t.field),[s,o]=createExtensionContainer(t);for(let e of n)t.runtime.bin.readField(s,i.readerFactory(e.data),t.field,e.wireType,i);return o()}(e,s,t),i=writeField$1(s.field,r,t);void 0!==i&&(n[s.field.jsonName]=i)}}}catch(n){let e=r?`cannot encode field ${i.typeName}.${r.name} to JSON`:`cannot encode message ${i.typeName} to JSON`,t=n instanceof Error?n.message:String(n);throw Error(e+(t.length>0?`: ${t}`:""))}return n},readScalar:(e,t,r)=>readScalar$1(e,t,null!=r?r:I.BIGINT,!0),writeScalar(e,t,r){if(void 0!==t&&(r||isScalarZeroValue(e,t)))return writeScalar$1(e,t)},debug:debugJsonValue},bin:{makeReadOptions:function(e){return e?Object.assign(Object.assign({},V),e):V},makeWriteOptions:function(e){return e?Object.assign(Object.assign({},$),e):$},listUnknownFields(e){var t;return null!==(t=e[M])&&void 0!==t?t:[]},discardUnknownFields(e){delete e[M]},writeUnknownFields(e,t){let r=e[M];if(r)for(let e of r)t.tag(e.no,e.wireType).raw(e.data)},onUnknownField(e,t,r,i){Array.isArray(e[M])||(e[M]=[]),e[M].push({no:t,wireType:r,data:i})},readMessage(e,t,r,i,n){let s,o;let a=e.getType(),l=n?t.len:t.pos+r;for(;t.pos<l&&([s,o]=t.tag(),!0!==n||o!=C.EndGroup);){let r=a.fields.find(s);if(!r){let r=t.skip(o,s);i.readUnknownFields&&this.onUnknownField(e,s,o,r);continue}readField(e,t,r,o,i)}if(n&&(o!=C.EndGroup||s!==r))throw Error("invalid end group tag")},readField,writeMessage(e,t,r){let i=e.getType();for(let n of i.fields.byNumber()){if(!isFieldSet(n,e)){if(n.req)throw Error(`cannot encode field ${i.typeName}.${n.name} to binary: required field not set`);continue}let s=n.oneof?e[n.oneof.localName].value:e[n.localName];writeField(n,s,t,r)}return r.writeUnknownFields&&this.writeUnknownFields(e,t),t},writeField(e,t,r,i){void 0!==t&&writeField(e,t,r,i)}},util:Object.assign(Object.assign({},{setEnumType,initPartial(e,t){if(void 0===e)return;let r=t.getType();for(let i of r.fields.byMember()){let r=i.localName;if(null!=e[r])switch(i.kind){case"oneof":let n=e[r].case;if(void 0===n)continue;let s=i.findField(n),o=e[r].value;s&&"message"==s.kind&&!isMessage(o,s.T)?o=new s.T(o):s&&"scalar"===s.kind&&s.T===k.BYTES&&(o=toU8Arr(o)),t[r]={case:n,value:o};break;case"scalar":case"enum":let a=e[r];i.T===k.BYTES&&(a=i.repeated?a.map(toU8Arr):toU8Arr(a)),t[r]=a;break;case"map":switch(i.V.kind){case"scalar":case"enum":if(i.V.T===k.BYTES)for(let[i,n]of Object.entries(e[r]))t[r][i]=toU8Arr(n);else Object.assign(t[r],e[r]);break;case"message":let l=i.V.T;for(let i of Object.keys(e[r])){let n=e[r][i];l.fieldWrapper||(n=new l(n)),t[r][i]=n}}break;case"message":let h=i.T;if(i.repeated)t[r]=e[r].map(e=>isMessage(e,h)?e:new h(e));else{let i=e[r];h.fieldWrapper?"google.protobuf.BytesValue"===h.typeName?t[r]=toU8Arr(i):t[r]=i:t[r]=isMessage(i,h)?i:new h(i)}}}},equals:(e,t,r)=>t===r||!!t&&!!r&&e.fields.byMember().every(e=>{let i=t[e.localName],n=r[e.localName];if(e.repeated){if(i.length!==n.length)return!1;switch(e.kind){case"message":return i.every((t,r)=>e.T.equals(t,n[r]));case"scalar":return i.every((t,r)=>scalarEquals(e.T,t,n[r]));case"enum":return i.every((e,t)=>scalarEquals(k.INT32,e,n[t]))}throw Error(`repeated cannot contain ${e.kind}`)}switch(e.kind){case"message":return e.T.equals(i,n);case"enum":return scalarEquals(k.INT32,i,n);case"scalar":return scalarEquals(e.T,i,n);case"oneof":if(i.case!==n.case)return!1;let s=e.findField(i.case);if(void 0===s)return!0;switch(s.kind){case"message":return s.T.equals(i.value,n.value);case"enum":return scalarEquals(k.INT32,i.value,n.value);case"scalar":return scalarEquals(s.T,i.value,n.value)}throw Error(`oneof cannot contain ${s.kind}`);case"map":let o=Object.keys(i).concat(Object.keys(n));switch(e.V.kind){case"message":let a=e.V.T;return o.every(e=>a.equals(i[e],n[e]));case"enum":return o.every(e=>scalarEquals(k.INT32,i[e],n[e]));case"scalar":let l=e.V.T;return o.every(e=>scalarEquals(l,i[e],n[e]))}}}),clone(e){let t=e.getType(),r=new t;for(let i of t.fields.byMember()){let t;let n=e[i.localName];if(i.repeated)t=n.map(cloneSingularField);else if("map"==i.kind)for(let[e,s]of(t=r[i.localName],Object.entries(n)))t[e]=cloneSingularField(s);else if("oneof"==i.kind){let e=i.findField(n.case);t=e?{case:n.case,value:cloneSingularField(n.value)}:{case:void 0}}else t=cloneSingularField(n);r[i.localName]=t}for(let i of t.runtime.bin.listUnknownFields(e))t.runtime.bin.onUnknownField(r,i.no,i.wireType,i.data);return r}}),{newFieldList:e=>new InternalFieldList(e,e=>(function(e,t){var r,i,n,s,o,a;let l;let h=[];for(let c of"function"==typeof e?e():e){if(c.localName=localFieldName(c.name,void 0!==c.oneof),c.jsonName=null!==(r=c.jsonName)&&void 0!==r?r:U(c.name),c.repeated=null!==(i=c.repeated)&&void 0!==i&&i,"scalar"==c.kind&&(c.L=null!==(n=c.L)&&void 0!==n?n:I.BIGINT),c.delimited=null!==(s=c.delimited)&&void 0!==s&&s,c.req=null!==(o=c.req)&&void 0!==o&&o,c.opt=null!==(a=c.opt)&&void 0!==a&&a,void 0===c.packed&&(t?c.packed="enum"==c.kind||"scalar"==c.kind&&c.T!=k.BYTES&&c.T!=k.STRING:c.packed=!1),void 0!==c.oneof){let e="string"==typeof c.oneof?c.oneof:c.oneof.name;l&&l.name==e||(l=new InternalOneofInfo(e)),c.oneof=l,l.addField(c)}h.push(c)}return h})(e,!0)),initFields:e=>{for(let t of e.getType().fields.byMember()){if(t.opt)continue;let r=t.localName;if(t.repeated){e[r]=[];continue}switch(t.kind){case"oneof":e[r]={case:void 0};break;case"enum":e[r]=0;break;case"map":e[r]={};break;case"scalar":e[r]=scalarZeroValue(t.T,t.L)}}}}),makeMessageType(e,t,r){return function(e,t,r,i){var n;let s=null!==(n=null==i?void 0:i.localName)&&void 0!==n?n:t.substring(t.lastIndexOf(".")+1),o={[s]:function(t){e.util.initFields(this),e.util.initPartial(t,this)}}[s];return Object.setPrototypeOf(o.prototype,new Message),Object.assign(o,{runtime:e,typeName:t,fields:e.util.newFieldList(r),fromBinary:(e,t)=>new o().fromBinary(e,t),fromJson:(e,t)=>new o().fromJson(e,t),fromJsonString:(e,t)=>new o().fromJsonString(e,t),equals:(t,r)=>e.util.equals(o,t,r)}),o}(this,e,t,r)},makeEnum:function(e,t,r){let i={};for(let e of t){let t=normalizeEnumValue(e);i[t.localName]=t.no,i[t.no]=t.localName}return setEnumType(i,e,t),i},makeEnumType,getEnumType:function(e){let t=e[D];return assert(t,"missing enum type on enum object"),t},makeExtension(e,t,r){var i;let n;return i=this,{typeName:e,extendee:t,get field(){if(!n){let t="function"==typeof r?r():r;t.name=e.split(".").pop(),t.jsonName=`[${e}]`,n=i.util.newFieldList([t]).list()[0]}return n},runtime:i}}};(o=w||(w={}))[o.Unary=0]="Unary",o[o.ServerStreaming=1]="ServerStreaming",o[o.ClientStreaming=2]="ClientStreaming",o[o.BiDiStreaming=3]="BiDiStreaming",(a=E||(E={}))[a.NoSideEffects=1]="NoSideEffects",a[a.Idempotent=2]="Idempotent";let Timestamp=class Timestamp extends Message{constructor(e){super(),this.seconds=x.zero,this.nanos=0,q.util.initPartial(e,this)}fromJson(e,t){if("string"!=typeof e)throw Error(`cannot decode google.protobuf.Timestamp from JSON: ${q.json.debug(e)}`);let r=e.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!r)throw Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");let i=Date.parse(r[1]+"-"+r[2]+"-"+r[3]+"T"+r[4]+":"+r[5]+":"+r[6]+(r[8]?r[8]:"Z"));if(Number.isNaN(i))throw Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(i<Date.parse("0001-01-01T00:00:00Z")||i>Date.parse("9999-12-31T23:59:59Z"))throw Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=x.parse(i/1e3),this.nanos=0,r[7]&&(this.nanos=parseInt("1"+r[7]+"0".repeat(9-r[7].length))-1e9),this}toJson(e){let t=1e3*Number(this.seconds);if(t<Date.parse("0001-01-01T00:00:00Z")||t>Date.parse("9999-12-31T23:59:59Z"))throw Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let r="Z";if(this.nanos>0){let e=(this.nanos+1e9).toString().substring(1);r="000000"===e.substring(3)?"."+e.substring(0,3)+"Z":"000"===e.substring(6)?"."+e.substring(0,6)+"Z":"."+e+"Z"}return new Date(t).toISOString().replace(".000Z",r)}toDate(){return new Date(1e3*Number(this.seconds)+Math.ceil(this.nanos/1e6))}static now(){return Timestamp.fromDate(new Date)}static fromDate(e){let t=e.getTime();return new Timestamp({seconds:x.parse(Math.floor(t/1e3)),nanos:t%1e3*1e6})}static fromBinary(e,t){return new Timestamp().fromBinary(e,t)}static fromJson(e,t){return new Timestamp().fromJson(e,t)}static fromJsonString(e,t){return new Timestamp().fromJsonString(e,t)}static equals(e,t){return q.util.equals(Timestamp,e,t)}};Timestamp.runtime=q,Timestamp.typeName="google.protobuf.Timestamp",Timestamp.fields=q.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);let Duration=class Duration extends Message{constructor(e){super(),this.seconds=x.zero,this.nanos=0,q.util.initPartial(e,this)}fromJson(e,t){if("string"!=typeof e)throw Error(`cannot decode google.protobuf.Duration from JSON: ${q.json.debug(e)}`);let r=e.match(/^(-?[0-9]+)(?:\.([0-9]+))?s/);if(null===r)throw Error(`cannot decode google.protobuf.Duration from JSON: ${q.json.debug(e)}`);let i=Number(r[1]);if(i>315576e6||i<-315576e6)throw Error(`cannot decode google.protobuf.Duration from JSON: ${q.json.debug(e)}`);if(this.seconds=x.parse(i),"string"==typeof r[2]){let e=r[2]+"0".repeat(9-r[2].length);this.nanos=parseInt(e),(i<0||Object.is(i,-0))&&(this.nanos=-this.nanos)}return this}toJson(e){if(Number(this.seconds)>315576e6||-315576e6>Number(this.seconds))throw Error("cannot encode google.protobuf.Duration to JSON: value out of range");let t=this.seconds.toString();if(0!==this.nanos){let e=Math.abs(this.nanos).toString();"000000"===(e="0".repeat(9-e.length)+e).substring(3)?e=e.substring(0,3):"000"===e.substring(6)&&(e=e.substring(0,6)),t+="."+e,this.nanos<0&&0==Number(this.seconds)&&(t="-"+t)}return t+"s"}static fromBinary(e,t){return new Duration().fromBinary(e,t)}static fromJson(e,t){return new Duration().fromJson(e,t)}static fromJsonString(e,t){return new Duration().fromJsonString(e,t)}static equals(e,t){return q.util.equals(Duration,e,t)}};Duration.runtime=q,Duration.typeName="google.protobuf.Duration",Duration.fields=q.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);let Any=class Any extends Message{constructor(e){super(),this.typeUrl="",this.value=new Uint8Array(0),q.util.initPartial(e,this)}toJson(e){var t;if(""===this.typeUrl)return{};let r=this.typeUrlToName(this.typeUrl),i=null===(t=null==e?void 0:e.typeRegistry)||void 0===t?void 0:t.findMessage(r);if(!i)throw Error(`cannot encode message google.protobuf.Any to JSON: "${this.typeUrl}" is not in the type registry`);let n=i.fromBinary(this.value),s=n.toJson(e);return(r.startsWith("google.protobuf.")||null===s||Array.isArray(s)||"object"!=typeof s)&&(s={value:s}),s["@type"]=this.typeUrl,s}fromJson(e,t){var r;let i;if(null===e||Array.isArray(e)||"object"!=typeof e)throw Error(`cannot decode message google.protobuf.Any from JSON: expected object but got ${null===e?"null":Array.isArray(e)?"array":typeof e}`);if(0==Object.keys(e).length)return this;let n=e["@type"];if("string"!=typeof n||""==n)throw Error('cannot decode message google.protobuf.Any from JSON: "@type" is empty');let s=this.typeUrlToName(n),o=null===(r=null==t?void 0:t.typeRegistry)||void 0===r?void 0:r.findMessage(s);if(!o)throw Error(`cannot decode message google.protobuf.Any from JSON: ${n} is not in the type registry`);if(s.startsWith("google.protobuf.")&&Object.prototype.hasOwnProperty.call(e,"value"))i=o.fromJson(e.value,t);else{let r=Object.assign({},e);delete r["@type"],i=o.fromJson(r,t)}return this.packFrom(i),this}packFrom(e){this.value=e.toBinary(),this.typeUrl=this.typeNameToUrl(e.getType().typeName)}unpackTo(e){return!!this.is(e.getType())&&(e.fromBinary(this.value),!0)}unpack(e){if(""===this.typeUrl)return;let t=e.findMessage(this.typeUrlToName(this.typeUrl));if(t)return t.fromBinary(this.value)}is(e){if(""===this.typeUrl)return!1;let t=this.typeUrlToName(this.typeUrl);return t===("string"==typeof e?e:e.typeName)}typeNameToUrl(e){return`type.googleapis.com/${e}`}typeUrlToName(e){if(!e.length)throw Error(`invalid type url: ${e}`);let t=e.lastIndexOf("/"),r=t>=0?e.substring(t+1):e;if(!r.length)throw Error(`invalid type url: ${e}`);return r}static pack(e){let t=new Any;return t.packFrom(e),t}static fromBinary(e,t){return new Any().fromBinary(e,t)}static fromJson(e,t){return new Any().fromJson(e,t)}static fromJsonString(e,t){return new Any().fromJsonString(e,t)}static equals(e,t){return q.util.equals(Any,e,t)}};Any.runtime=q,Any.typeName="google.protobuf.Any",Any.fields=q.util.newFieldList(()=>[{no:1,name:"type_url",kind:"scalar",T:9},{no:2,name:"value",kind:"scalar",T:12}]);let DoubleValue=class DoubleValue extends Message{constructor(e){super(),this.value=0,q.util.initPartial(e,this)}toJson(e){return q.json.writeScalar(k.DOUBLE,this.value,!0)}fromJson(e,t){try{this.value=q.json.readScalar(k.DOUBLE,e)}catch(t){let e='cannot decode message google.protobuf.DoubleValue from JSON"';throw t instanceof Error&&t.message.length>0&&(e+=`: ${t.message}`),Error(e)}return this}static fromBinary(e,t){return new DoubleValue().fromBinary(e,t)}static fromJson(e,t){return new DoubleValue().fromJson(e,t)}static fromJsonString(e,t){return new DoubleValue().fromJsonString(e,t)}static equals(e,t){return q.util.equals(DoubleValue,e,t)}};DoubleValue.runtime=q,DoubleValue.typeName="google.protobuf.DoubleValue",DoubleValue.fields=q.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:1}]),DoubleValue.fieldWrapper={wrapField:e=>new DoubleValue({value:e}),unwrapField:e=>e.value};let FloatValue=class FloatValue extends Message{constructor(e){super(),this.value=0,q.util.initPartial(e,this)}toJson(e){return q.json.writeScalar(k.FLOAT,this.value,!0)}fromJson(e,t){try{this.value=q.json.readScalar(k.FLOAT,e)}catch(t){let e='cannot decode message google.protobuf.FloatValue from JSON"';throw t instanceof Error&&t.message.length>0&&(e+=`: ${t.message}`),Error(e)}return this}static fromBinary(e,t){return new FloatValue().fromBinary(e,t)}static fromJson(e,t){return new FloatValue().fromJson(e,t)}static fromJsonString(e,t){return new FloatValue().fromJsonString(e,t)}static equals(e,t){return q.util.equals(FloatValue,e,t)}};FloatValue.runtime=q,FloatValue.typeName="google.protobuf.FloatValue",FloatValue.fields=q.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:2}]),FloatValue.fieldWrapper={wrapField:e=>new FloatValue({value:e}),unwrapField:e=>e.value};let Int64Value=class Int64Value extends Message{constructor(e){super(),this.value=x.zero,q.util.initPartial(e,this)}toJson(e){return q.json.writeScalar(k.INT64,this.value,!0)}fromJson(e,t){try{this.value=q.json.readScalar(k.INT64,e)}catch(t){let e='cannot decode message google.protobuf.Int64Value from JSON"';throw t instanceof Error&&t.message.length>0&&(e+=`: ${t.message}`),Error(e)}return this}static fromBinary(e,t){return new Int64Value().fromBinary(e,t)}static fromJson(e,t){return new Int64Value().fromJson(e,t)}static fromJsonString(e,t){return new Int64Value().fromJsonString(e,t)}static equals(e,t){return q.util.equals(Int64Value,e,t)}};Int64Value.runtime=q,Int64Value.typeName="google.protobuf.Int64Value",Int64Value.fields=q.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:3}]),Int64Value.fieldWrapper={wrapField:e=>new Int64Value({value:e}),unwrapField:e=>e.value};let UInt64Value=class UInt64Value extends Message{constructor(e){super(),this.value=x.zero,q.util.initPartial(e,this)}toJson(e){return q.json.writeScalar(k.UINT64,this.value,!0)}fromJson(e,t){try{this.value=q.json.readScalar(k.UINT64,e)}catch(t){let e='cannot decode message google.protobuf.UInt64Value from JSON"';throw t instanceof Error&&t.message.length>0&&(e+=`: ${t.message}`),Error(e)}return this}static fromBinary(e,t){return new UInt64Value().fromBinary(e,t)}static fromJson(e,t){return new UInt64Value().fromJson(e,t)}static fromJsonString(e,t){return new UInt64Value().fromJsonString(e,t)}static equals(e,t){return q.util.equals(UInt64Value,e,t)}};UInt64Value.runtime=q,UInt64Value.typeName="google.protobuf.UInt64Value",UInt64Value.fields=q.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:4}]),UInt64Value.fieldWrapper={wrapField:e=>new UInt64Value({value:e}),unwrapField:e=>e.value};let Int32Value=class Int32Value extends Message{constructor(e){super(),this.value=0,q.util.initPartial(e,this)}toJson(e){return q.json.writeScalar(k.INT32,this.value,!0)}fromJson(e,t){try{this.value=q.json.readScalar(k.INT32,e)}catch(t){let e='cannot decode message google.protobuf.Int32Value from JSON"';throw t instanceof Error&&t.message.length>0&&(e+=`: ${t.message}`),Error(e)}return this}static fromBinary(e,t){return new Int32Value().fromBinary(e,t)}static fromJson(e,t){return new Int32Value().fromJson(e,t)}static fromJsonString(e,t){return new Int32Value().fromJsonString(e,t)}static equals(e,t){return q.util.equals(Int32Value,e,t)}};Int32Value.runtime=q,Int32Value.typeName="google.protobuf.Int32Value",Int32Value.fields=q.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:5}]),Int32Value.fieldWrapper={wrapField:e=>new Int32Value({value:e}),unwrapField:e=>e.value};let UInt32Value=class UInt32Value extends Message{constructor(e){super(),this.value=0,q.util.initPartial(e,this)}toJson(e){return q.json.writeScalar(k.UINT32,this.value,!0)}fromJson(e,t){try{this.value=q.json.readScalar(k.UINT32,e)}catch(t){let e='cannot decode message google.protobuf.UInt32Value from JSON"';throw t instanceof Error&&t.message.length>0&&(e+=`: ${t.message}`),Error(e)}return this}static fromBinary(e,t){return new UInt32Value().fromBinary(e,t)}static fromJson(e,t){return new UInt32Value().fromJson(e,t)}static fromJsonString(e,t){return new UInt32Value().fromJsonString(e,t)}static equals(e,t){return q.util.equals(UInt32Value,e,t)}};UInt32Value.runtime=q,UInt32Value.typeName="google.protobuf.UInt32Value",UInt32Value.fields=q.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:13}]),UInt32Value.fieldWrapper={wrapField:e=>new UInt32Value({value:e}),unwrapField:e=>e.value};let BoolValue=class BoolValue extends Message{constructor(e){super(),this.value=!1,q.util.initPartial(e,this)}toJson(e){return q.json.writeScalar(k.BOOL,this.value,!0)}fromJson(e,t){try{this.value=q.json.readScalar(k.BOOL,e)}catch(t){let e='cannot decode message google.protobuf.BoolValue from JSON"';throw t instanceof Error&&t.message.length>0&&(e+=`: ${t.message}`),Error(e)}return this}static fromBinary(e,t){return new BoolValue().fromBinary(e,t)}static fromJson(e,t){return new BoolValue().fromJson(e,t)}static fromJsonString(e,t){return new BoolValue().fromJsonString(e,t)}static equals(e,t){return q.util.equals(BoolValue,e,t)}};BoolValue.runtime=q,BoolValue.typeName="google.protobuf.BoolValue",BoolValue.fields=q.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:8}]),BoolValue.fieldWrapper={wrapField:e=>new BoolValue({value:e}),unwrapField:e=>e.value};let StringValue=class StringValue extends Message{constructor(e){super(),this.value="",q.util.initPartial(e,this)}toJson(e){return q.json.writeScalar(k.STRING,this.value,!0)}fromJson(e,t){try{this.value=q.json.readScalar(k.STRING,e)}catch(t){let e='cannot decode message google.protobuf.StringValue from JSON"';throw t instanceof Error&&t.message.length>0&&(e+=`: ${t.message}`),Error(e)}return this}static fromBinary(e,t){return new StringValue().fromBinary(e,t)}static fromJson(e,t){return new StringValue().fromJson(e,t)}static fromJsonString(e,t){return new StringValue().fromJsonString(e,t)}static equals(e,t){return q.util.equals(StringValue,e,t)}};StringValue.runtime=q,StringValue.typeName="google.protobuf.StringValue",StringValue.fields=q.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:9}]),StringValue.fieldWrapper={wrapField:e=>new StringValue({value:e}),unwrapField:e=>e.value};let BytesValue=class BytesValue extends Message{constructor(e){super(),this.value=new Uint8Array(0),q.util.initPartial(e,this)}toJson(e){return q.json.writeScalar(k.BYTES,this.value,!0)}fromJson(e,t){try{this.value=q.json.readScalar(k.BYTES,e)}catch(t){let e='cannot decode message google.protobuf.BytesValue from JSON"';throw t instanceof Error&&t.message.length>0&&(e+=`: ${t.message}`),Error(e)}return this}static fromBinary(e,t){return new BytesValue().fromBinary(e,t)}static fromJson(e,t){return new BytesValue().fromJson(e,t)}static fromJsonString(e,t){return new BytesValue().fromJsonString(e,t)}static equals(e,t){return q.util.equals(BytesValue,e,t)}};function createEnvelopeReadableStream(e){let t;let r=new Uint8Array(0);return new ReadableStream({start(){t=e.getReader()},async pull(e){let i;for(;;){if(void 0===i&&r.byteLength>=5){let e=0;for(let t=1;t<5;t++)e=(e<<8)+r[t];i={flags:r[0],length:e}}if(void 0!==i&&r.byteLength>=i.length+5)break;let e=await t.read();if(e.done)break;!function(e){let t=new Uint8Array(r.length+e.length);t.set(r),t.set(e,r.length),r=t}(e.value)}if(void 0===i){if(0==r.byteLength){e.close();return}e.error(new ConnectError("premature end of stream",A.DataLoss));return}let n=r.subarray(5,5+i.length);r=r.subarray(5+i.length),e.enqueue({flags:i.flags,data:n})}})}function encodeEnvelope(e,t){let r=new Uint8Array(t.length+5);r.set(t,5);let i=new DataView(r.buffer,r.byteOffset,r.byteLength);return i.setUint8(0,e),i.setUint32(1,t.length),r}BytesValue.runtime=q,BytesValue.typeName="google.protobuf.BytesValue",BytesValue.fields=q.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:12}]),BytesValue.fieldWrapper={wrapField:e=>new BytesValue({value:e}),unwrapField:e=>e.value};var z=globalThis&&globalThis.__asyncValues||function(e){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},verb("next"),verb("throw"),verb("return"),t[Symbol.asyncIterator]=function(){return this},t);function verb(r){t[r]=e[r]&&function(t){return new Promise(function(i,n){!function(e,t,r,i){Promise.resolve(i).then(function(t){e({value:t,done:r})},t)}(i,n,(t=e[r](t)).done,t.value)})}}},K=globalThis&&globalThis.__await||function(e){return this instanceof K?(this.v=e,this):new K(e)},G=globalThis&&globalThis.__asyncGenerator||function(e,t,r){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var i,n=r.apply(e,t||[]),s=[];return i={},verb("next"),verb("throw"),verb("return",function(e){return function(t){return Promise.resolve(t).then(e,reject)}}),i[Symbol.asyncIterator]=function(){return this},i;function verb(e,t){n[e]&&(i[e]=function(t){return new Promise(function(r,i){s.push([e,t,r,i])>1||resume(e,t)})},t&&(i[e]=t(i[e])))}function resume(e,t){try{var r;(r=n[e](t)).value instanceof K?Promise.resolve(r.value.v).then(fulfill,reject):settle(s[0][2],r)}catch(e){settle(s[0][3],e)}}function fulfill(e){resume("next",e)}function reject(e){resume("throw",e)}function settle(e,t){e(t),s.shift(),s.length&&resume(s[0][0],s[0][1])}},W=globalThis&&globalThis.__asyncDelegator||function(e){var t,r;return t={},verb("next"),verb("throw",function(e){throw e}),verb("return"),t[Symbol.iterator]=function(){return this},t;function verb(i,n){t[i]=e[i]?function(t){return(r=!r)?{value:K(e[i](t)),done:!1}:n?n(t):t}:n}},Y=globalThis&&globalThis.__asyncValues||function(e){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},verb("next"),verb("throw"),verb("return"),t[Symbol.asyncIterator]=function(){return this},t);function verb(r){t[r]=e[r]&&function(t){return new Promise(function(i,n){!function(e,t,r,i){Promise.resolve(i).then(function(t){e({value:t,done:r})},t)}(i,n,(t=e[r](t)).done,t.value)})}}},H=globalThis&&globalThis.__await||function(e){return this instanceof H?(this.v=e,this):new H(e)},X=globalThis&&globalThis.__asyncDelegator||function(e){var t,r;return t={},verb("next"),verb("throw",function(e){throw e}),verb("return"),t[Symbol.iterator]=function(){return this},t;function verb(i,n){t[i]=e[i]?function(t){return(r=!r)?{value:H(e[i](t)),done:!1}:n?n(t):t}:n}},Z=globalThis&&globalThis.__asyncGenerator||function(e,t,r){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var i,n=r.apply(e,t||[]),s=[];return i={},verb("next"),verb("throw"),verb("return",function(e){return function(t){return Promise.resolve(t).then(e,reject)}}),i[Symbol.asyncIterator]=function(){return this},i;function verb(e,t){n[e]&&(i[e]=function(t){return new Promise(function(r,i){s.push([e,t,r,i])>1||resume(e,t)})},t&&(i[e]=t(i[e])))}function resume(e,t){try{var r;(r=n[e](t)).value instanceof H?Promise.resolve(r.value.v).then(fulfill,reject):settle(s[0][2],r)}catch(e){settle(s[0][3],e)}}function fulfill(e){resume("next",e)}function reject(e){resume("throw",e)}function settle(e,t){e(t),s.shift(),s.length&&resume(s[0][0],s[0][1])}};function handleStreamResponse(e,t){let r=(function(){var r,i;return Z(this,arguments,function*(){let n=yield H(e);null===(r=null==t?void 0:t.onHeader)||void 0===r||r.call(t,n.header),yield H((yield*X(Y(n.message)))),null===(i=null==t?void 0:t.onTrailer)||void 0===i||i.call(t,n.trailer)})})()[Symbol.asyncIterator]();return{[Symbol.asyncIterator]:()=>({next:()=>r.next()})}}function getAbortSignalReason(e){if(!e.aborted)return;if(void 0!==e.reason)return e.reason;let t=Error("This operation was aborted");return t.name="AbortError",t}function createContextValues(){return{get(e){return e.id in this?this[e.id]:e.defaultValue},set(e,t){return this[e.id]=t,this},delete(e){return delete this[e.id],this}}}function trailerParse(e){let t=new Headers,r=new TextDecoder().decode(e).split("\r\n");for(let e of r){if(""===e)continue;let r=e.indexOf(":");if(r>0){let i=e.substring(0,r).trim(),n=e.substring(r+1).trim();t.append(i,n)}}return t}let Q="Grpc-Status",ee="Grpc-Message";let Status=class Status extends Message{constructor(e){super(),this.code=0,this.message="",this.details=[],q.util.initPartial(e,this)}static fromBinary(e,t){return new Status().fromBinary(e,t)}static fromJson(e,t){return new Status().fromJson(e,t)}static fromJsonString(e,t){return new Status().fromJsonString(e,t)}static equals(e,t){return q.util.equals(Status,e,t)}};function findTrailerError(e){var t;let r=e.get("Grpc-Status-Details-Bin");if(null!=r){let t=function(e,t,r){try{let r=O.dec(e);if(t)return t.fromBinary(r,void 0);return r}catch(e){throw ConnectError.from(e,A.DataLoss)}}(r,Status);if(0==t.code)return;let i=new ConnectError(t.message,t.code,e);return i.details=t.details.map(e=>({type:e.typeUrl.substring(e.typeUrl.lastIndexOf("/")+1),value:e.value})),i}let i=e.get(Q);if(null!=i){if("0"===i)return;let r=parseInt(i,10);return r in A?new ConnectError(decodeURIComponent(null!==(t=e.get(ee))&&void 0!==t?t:""),r,e):new ConnectError(`invalid grpc-status: ${i}`,A.Internal,e)}}function createMethodUrl(e,t,r){let i="string"==typeof t?t:t.typeName,n="string"==typeof r?r:r.name;return e.toString().replace(/\/?$/,`/${i}/${n}`)}function normalize(e,t){return t instanceof e?t:new e(t)}function applyInterceptors(e,t){var r;return null!==(r=null==t?void 0:t.concat().reverse().reduce((e,t)=>t(e),e))&&void 0!==r?r:e}function createClientMethodSerializers(e,t,r,i){let n=t?createBinarySerialization(e.I,i):createJsonSerialization(e.I,r),s=t?createBinarySerialization(e.O,i):createJsonSerialization(e.O,r);return{parse:s.parse,serialize:n.serialize}}function createBinarySerialization(e,t){return{parse(r){try{return e.fromBinary(r,t)}catch(t){let e=t instanceof Error?t.message:String(t);throw new ConnectError(`parse binary: ${e}`,A.InvalidArgument)}},serialize(e){try{return e.toBinary(t)}catch(t){let e=t instanceof Error?t.message:String(t);throw new ConnectError(`serialize binary: ${e}`,A.Internal)}}}}function createJsonSerialization(e,t){var r,i;let n=null!==(r=null==t?void 0:t.textEncoder)&&void 0!==r?r:new TextEncoder,s=null!==(i=null==t?void 0:t.textDecoder)&&void 0!==i?i:new TextDecoder,o=function(e){var t;let r=Object.assign({},e);return null!==(t=r.ignoreUnknownFields)&&void 0!==t||(r.ignoreUnknownFields=!0),r}(t);return{parse(t){try{let r=s.decode(t);return e.fromJsonString(r,o)}catch(e){throw ConnectError.from(e,A.InvalidArgument)}},serialize(e){try{let t=e.toJsonString(o);return n.encode(t)}catch(e){throw ConnectError.from(e,A.Internal)}}}}function setupSignal(e){let{signal:t,cleanup:r}=function(e){let t;let r=new AbortController,listener=()=>{r.abort(new ConnectError("the operation timed out",A.DeadlineExceeded))};return void 0!==e&&(e<=0?listener():t=setTimeout(listener,e)),{signal:r.signal,cleanup:()=>clearTimeout(t)}}(e.timeoutMs),i=function(...e){let t=new AbortController,r=e.filter(e=>void 0!==e).concat(t.signal);for(let e of r){if(e.aborted){onAbort.apply(e);break}e.addEventListener("abort",onAbort)}function onAbort(){for(let e of(t.signal.aborted||t.abort(getAbortSignalReason(this)),r))e.removeEventListener("abort",onAbort)}return t}(e.signal,t);return[i.signal,function(e){let n=ConnectError.from(t.aborted?getAbortSignalReason(t):e);return i.abort(n),r(),Promise.reject(n)},function(){r(),i.abort()}]}function validateTrailer(e,t){let r=findTrailerError(e);if(r)throw t.forEach((e,t)=>{r.metadata.append(t,e)}),r}function requestHeader(e,t,r,i){let n=new Headers(null!=r?r:{});return n.set("Content-Type",e?"application/grpc-web+proto":"application/grpc-web+json"),n.set("X-Grpc-Web","1"),n.set("X-User-Agent","connect-es/1.4.0"),i&&n.set("User-Agent","connect-es/1.4.0"),void 0!==t&&n.set("Grpc-Timeout",`${t}m`),n}function validateResponse(e,t){var r;if(e>=200&&e<300){let e=findTrailerError(t);if(e)throw e;return{foundStatus:t.has(Q)}}throw new ConnectError(decodeURIComponent(null!==(r=t.get(ee))&&void 0!==r?r:`HTTP ${e}`),function(e){switch(e){case 400:return A.Internal;case 401:return A.Unauthenticated;case 403:return A.PermissionDenied;case 404:return A.Unimplemented;case 429:case 502:case 503:case 504:return A.Unavailable;default:return A.Unknown}}(e),t)}Status.runtime=q,Status.typeName="google.rpc.Status",Status.fields=q.util.newFieldList(()=>[{no:1,name:"code",kind:"scalar",T:5},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"details",kind:"message",T:Any,repeated:!0}]);var et=globalThis&&globalThis.__await||function(e){return this instanceof et?(this.v=e,this):new et(e)},er=globalThis&&globalThis.__asyncGenerator||function(e,t,r){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var i,n=r.apply(e,t||[]),s=[];return i={},verb("next"),verb("throw"),verb("return",function(e){return function(t){return Promise.resolve(t).then(e,reject)}}),i[Symbol.asyncIterator]=function(){return this},i;function verb(e,t){n[e]&&(i[e]=function(t){return new Promise(function(r,i){s.push([e,t,r,i])>1||resume(e,t)})},t&&(i[e]=t(i[e])))}function resume(e,t){try{var r;(r=n[e](t)).value instanceof et?Promise.resolve(r.value.v).then(fulfill,reject):settle(s[0][2],r)}catch(e){settle(s[0][3],e)}}function fulfill(e){resume("next",e)}function reject(e){resume("throw",e)}function settle(e,t){e(t),s.shift(),s.length&&resume(s[0][0],s[0][1])}};let ei=q.makeEnum("yorkie.v1.ValueType",[{no:0,name:"VALUE_TYPE_NULL",localName:"NULL"},{no:1,name:"VALUE_TYPE_BOOLEAN",localName:"BOOLEAN"},{no:2,name:"VALUE_TYPE_INTEGER",localName:"INTEGER"},{no:3,name:"VALUE_TYPE_LONG",localName:"LONG"},{no:4,name:"VALUE_TYPE_DOUBLE",localName:"DOUBLE"},{no:5,name:"VALUE_TYPE_STRING",localName:"STRING"},{no:6,name:"VALUE_TYPE_BYTES",localName:"BYTES"},{no:7,name:"VALUE_TYPE_DATE",localName:"DATE"},{no:8,name:"VALUE_TYPE_JSON_OBJECT",localName:"JSON_OBJECT"},{no:9,name:"VALUE_TYPE_JSON_ARRAY",localName:"JSON_ARRAY"},{no:10,name:"VALUE_TYPE_TEXT",localName:"TEXT"},{no:11,name:"VALUE_TYPE_INTEGER_CNT",localName:"INTEGER_CNT"},{no:12,name:"VALUE_TYPE_LONG_CNT",localName:"LONG_CNT"},{no:13,name:"VALUE_TYPE_TREE",localName:"TREE"}]),en=q.makeEnum("yorkie.v1.DocEventType",[{no:0,name:"DOC_EVENT_TYPE_DOCUMENT_CHANGED",localName:"DOCUMENT_CHANGED"},{no:1,name:"DOC_EVENT_TYPE_DOCUMENT_WATCHED",localName:"DOCUMENT_WATCHED"},{no:2,name:"DOC_EVENT_TYPE_DOCUMENT_UNWATCHED",localName:"DOCUMENT_UNWATCHED"},{no:3,name:"DOC_EVENT_TYPE_DOCUMENT_BROADCAST",localName:"DOCUMENT_BROADCAST"}]),es=q.makeMessageType("yorkie.v1.Snapshot",()=>[{no:1,name:"root",kind:"message",T:eS},{no:2,name:"presences",kind:"map",K:9,V:{kind:"message",T:e$}}]),eo=q.makeMessageType("yorkie.v1.ChangePack",()=>[{no:1,name:"document_key",kind:"scalar",T:9},{no:2,name:"checkpoint",kind:"message",T:eU},{no:3,name:"snapshot",kind:"scalar",T:12},{no:4,name:"changes",kind:"message",T:ea,repeated:!0},{no:5,name:"min_synced_ticket",kind:"message",T:ej},{no:6,name:"is_removed",kind:"scalar",T:8}]),ea=q.makeMessageType("yorkie.v1.Change",()=>[{no:1,name:"id",kind:"message",T:el},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"operations",kind:"message",T:eh,repeated:!0},{no:4,name:"presence_change",kind:"message",T:eM}]),el=q.makeMessageType("yorkie.v1.ChangeID",()=>[{no:1,name:"client_seq",kind:"scalar",T:13},{no:2,name:"server_seq",kind:"scalar",T:3,L:1},{no:3,name:"lamport",kind:"scalar",T:3,L:1},{no:4,name:"actor_id",kind:"scalar",T:12}]),eh=q.makeMessageType("yorkie.v1.Operation",()=>[{no:1,name:"set",kind:"message",T:ec,oneof:"body"},{no:2,name:"add",kind:"message",T:eu,oneof:"body"},{no:3,name:"move",kind:"message",T:ed,oneof:"body"},{no:4,name:"remove",kind:"message",T:eg,oneof:"body"},{no:5,name:"edit",kind:"message",T:ef,oneof:"body"},{no:6,name:"select",kind:"message",T:em,oneof:"body"},{no:7,name:"style",kind:"message",T:ep,oneof:"body"},{no:8,name:"increase",kind:"message",T:ey,oneof:"body"},{no:9,name:"tree_edit",kind:"message",T:eT,oneof:"body"},{no:10,name:"tree_style",kind:"message",T:ev,oneof:"body"}]),ec=q.makeMessageType("yorkie.v1.Operation.Set",()=>[{no:1,name:"parent_created_at",kind:"message",T:ej},{no:2,name:"key",kind:"scalar",T:9},{no:3,name:"value",kind:"message",T:eb},{no:4,name:"executed_at",kind:"message",T:ej}],{localName:"Operation_Set"}),eu=q.makeMessageType("yorkie.v1.Operation.Add",()=>[{no:1,name:"parent_created_at",kind:"message",T:ej},{no:2,name:"prev_created_at",kind:"message",T:ej},{no:3,name:"value",kind:"message",T:eb},{no:4,name:"executed_at",kind:"message",T:ej}],{localName:"Operation_Add"}),ed=q.makeMessageType("yorkie.v1.Operation.Move",()=>[{no:1,name:"parent_created_at",kind:"message",T:ej},{no:2,name:"prev_created_at",kind:"message",T:ej},{no:3,name:"created_at",kind:"message",T:ej},{no:4,name:"executed_at",kind:"message",T:ej}],{localName:"Operation_Move"}),eg=q.makeMessageType("yorkie.v1.Operation.Remove",()=>[{no:1,name:"parent_created_at",kind:"message",T:ej},{no:2,name:"created_at",kind:"message",T:ej},{no:3,name:"executed_at",kind:"message",T:ej}],{localName:"Operation_Remove"}),ef=q.makeMessageType("yorkie.v1.Operation.Edit",()=>[{no:1,name:"parent_created_at",kind:"message",T:ej},{no:2,name:"from",kind:"message",T:eJ},{no:3,name:"to",kind:"message",T:eJ},{no:4,name:"created_at_map_by_actor",kind:"map",K:9,V:{kind:"message",T:ej}},{no:5,name:"content",kind:"scalar",T:9},{no:6,name:"executed_at",kind:"message",T:ej},{no:7,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}}],{localName:"Operation_Edit"}),em=q.makeMessageType("yorkie.v1.Operation.Select",()=>[{no:1,name:"parent_created_at",kind:"message",T:ej},{no:2,name:"from",kind:"message",T:eJ},{no:3,name:"to",kind:"message",T:eJ},{no:4,name:"executed_at",kind:"message",T:ej}],{localName:"Operation_Select"}),ep=q.makeMessageType("yorkie.v1.Operation.Style",()=>[{no:1,name:"parent_created_at",kind:"message",T:ej},{no:2,name:"from",kind:"message",T:eJ},{no:3,name:"to",kind:"message",T:eJ},{no:4,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:5,name:"executed_at",kind:"message",T:ej},{no:6,name:"created_at_map_by_actor",kind:"map",K:9,V:{kind:"message",T:ej}}],{localName:"Operation_Style"}),ey=q.makeMessageType("yorkie.v1.Operation.Increase",()=>[{no:1,name:"parent_created_at",kind:"message",T:ej},{no:2,name:"value",kind:"message",T:eb},{no:3,name:"executed_at",kind:"message",T:ej}],{localName:"Operation_Increase"}),eT=q.makeMessageType("yorkie.v1.Operation.TreeEdit",()=>[{no:1,name:"parent_created_at",kind:"message",T:ej},{no:2,name:"from",kind:"message",T:eB},{no:3,name:"to",kind:"message",T:eB},{no:4,name:"created_at_map_by_actor",kind:"map",K:9,V:{kind:"message",T:ej}},{no:5,name:"contents",kind:"message",T:eP,repeated:!0},{no:7,name:"split_level",kind:"scalar",T:5},{no:6,name:"executed_at",kind:"message",T:ej}],{localName:"Operation_TreeEdit"}),ev=q.makeMessageType("yorkie.v1.Operation.TreeStyle",()=>[{no:1,name:"parent_created_at",kind:"message",T:ej},{no:2,name:"from",kind:"message",T:eB},{no:3,name:"to",kind:"message",T:eB},{no:4,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:5,name:"executed_at",kind:"message",T:ej},{no:6,name:"attributes_to_remove",kind:"scalar",T:9,repeated:!0},{no:7,name:"created_at_map_by_actor",kind:"map",K:9,V:{kind:"message",T:ej}}],{localName:"Operation_TreeStyle"}),eb=q.makeMessageType("yorkie.v1.JSONElementSimple",()=>[{no:1,name:"created_at",kind:"message",T:ej},{no:2,name:"moved_at",kind:"message",T:ej},{no:3,name:"removed_at",kind:"message",T:ej},{no:4,name:"type",kind:"enum",T:q.getEnumType(ei)},{no:5,name:"value",kind:"scalar",T:12}]),eS=q.makeMessageType("yorkie.v1.JSONElement",()=>[{no:1,name:"json_object",kind:"message",T:eA,oneof:"body"},{no:2,name:"json_array",kind:"message",T:ek,oneof:"body"},{no:3,name:"primitive",kind:"message",T:eI,oneof:"body"},{no:5,name:"text",kind:"message",T:eC,oneof:"body"},{no:6,name:"counter",kind:"message",T:ew,oneof:"body"},{no:7,name:"tree",kind:"message",T:eE,oneof:"body"}]),eA=q.makeMessageType("yorkie.v1.JSONElement.JSONObject",()=>[{no:1,name:"nodes",kind:"message",T:eN,repeated:!0},{no:2,name:"created_at",kind:"message",T:ej},{no:3,name:"moved_at",kind:"message",T:ej},{no:4,name:"removed_at",kind:"message",T:ej}],{localName:"JSONElement_JSONObject"}),ek=q.makeMessageType("yorkie.v1.JSONElement.JSONArray",()=>[{no:1,name:"nodes",kind:"message",T:eD,repeated:!0},{no:2,name:"created_at",kind:"message",T:ej},{no:3,name:"moved_at",kind:"message",T:ej},{no:4,name:"removed_at",kind:"message",T:ej}],{localName:"JSONElement_JSONArray"}),eI=q.makeMessageType("yorkie.v1.JSONElement.Primitive",()=>[{no:1,name:"type",kind:"enum",T:q.getEnumType(ei)},{no:2,name:"value",kind:"scalar",T:12},{no:3,name:"created_at",kind:"message",T:ej},{no:4,name:"moved_at",kind:"message",T:ej},{no:5,name:"removed_at",kind:"message",T:ej}],{localName:"JSONElement_Primitive"}),eC=q.makeMessageType("yorkie.v1.JSONElement.Text",()=>[{no:1,name:"nodes",kind:"message",T:eR,repeated:!0},{no:2,name:"created_at",kind:"message",T:ej},{no:3,name:"moved_at",kind:"message",T:ej},{no:4,name:"removed_at",kind:"message",T:ej}],{localName:"JSONElement_Text"}),ew=q.makeMessageType("yorkie.v1.JSONElement.Counter",()=>[{no:1,name:"type",kind:"enum",T:q.getEnumType(ei)},{no:2,name:"value",kind:"scalar",T:12},{no:3,name:"created_at",kind:"message",T:ej},{no:4,name:"moved_at",kind:"message",T:ej},{no:5,name:"removed_at",kind:"message",T:ej}],{localName:"JSONElement_Counter"}),eE=q.makeMessageType("yorkie.v1.JSONElement.Tree",()=>[{no:1,name:"nodes",kind:"message",T:eO,repeated:!0},{no:2,name:"created_at",kind:"message",T:ej},{no:3,name:"moved_at",kind:"message",T:ej},{no:4,name:"removed_at",kind:"message",T:ej}],{localName:"JSONElement_Tree"}),eN=q.makeMessageType("yorkie.v1.RHTNode",()=>[{no:1,name:"key",kind:"scalar",T:9},{no:2,name:"element",kind:"message",T:eS}]),eD=q.makeMessageType("yorkie.v1.RGANode",()=>[{no:1,name:"next",kind:"message",T:eD},{no:2,name:"element",kind:"message",T:eS}]),ex=q.makeMessageType("yorkie.v1.NodeAttr",()=>[{no:1,name:"value",kind:"scalar",T:9},{no:2,name:"updated_at",kind:"message",T:ej},{no:3,name:"is_removed",kind:"scalar",T:8}]),eR=q.makeMessageType("yorkie.v1.TextNode",()=>[{no:1,name:"id",kind:"message",T:e_},{no:2,name:"value",kind:"scalar",T:9},{no:3,name:"removed_at",kind:"message",T:ej},{no:4,name:"ins_prev_id",kind:"message",T:e_},{no:5,name:"attributes",kind:"map",K:9,V:{kind:"message",T:ex}}]),e_=q.makeMessageType("yorkie.v1.TextNodeID",()=>[{no:1,name:"created_at",kind:"message",T:ej},{no:2,name:"offset",kind:"scalar",T:5}]),eO=q.makeMessageType("yorkie.v1.TreeNode",()=>[{no:1,name:"id",kind:"message",T:eF},{no:2,name:"type",kind:"scalar",T:9},{no:3,name:"value",kind:"scalar",T:9},{no:4,name:"removed_at",kind:"message",T:ej},{no:5,name:"ins_prev_id",kind:"message",T:eF},{no:6,name:"ins_next_id",kind:"message",T:eF},{no:7,name:"depth",kind:"scalar",T:5},{no:8,name:"attributes",kind:"map",K:9,V:{kind:"message",T:ex}}]),eP=q.makeMessageType("yorkie.v1.TreeNodes",()=>[{no:1,name:"content",kind:"message",T:eO,repeated:!0}]),eF=q.makeMessageType("yorkie.v1.TreeNodeID",()=>[{no:1,name:"created_at",kind:"message",T:ej},{no:2,name:"offset",kind:"scalar",T:5}]),eB=q.makeMessageType("yorkie.v1.TreePos",()=>[{no:1,name:"parent_id",kind:"message",T:eF},{no:2,name:"left_sibling_id",kind:"message",T:eF}]);q.makeMessageType("yorkie.v1.User",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"created_at",kind:"message",T:Timestamp}]),q.makeMessageType("yorkie.v1.Project",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"public_key",kind:"scalar",T:9},{no:4,name:"secret_key",kind:"scalar",T:9},{no:5,name:"auth_webhook_url",kind:"scalar",T:9},{no:6,name:"auth_webhook_methods",kind:"scalar",T:9,repeated:!0},{no:7,name:"client_deactivate_threshold",kind:"scalar",T:9},{no:8,name:"created_at",kind:"message",T:Timestamp},{no:9,name:"updated_at",kind:"message",T:Timestamp}]),q.makeMessageType("yorkie.v1.UpdatableProjectFields",()=>[{no:1,name:"name",kind:"message",T:StringValue},{no:2,name:"auth_webhook_url",kind:"message",T:StringValue},{no:3,name:"auth_webhook_methods",kind:"message",T:eL},{no:4,name:"client_deactivate_threshold",kind:"message",T:StringValue}]);let eL=q.makeMessageType("yorkie.v1.UpdatableProjectFields.AuthWebhookMethods",()=>[{no:1,name:"methods",kind:"scalar",T:9,repeated:!0}],{localName:"UpdatableProjectFields_AuthWebhookMethods"});q.makeMessageType("yorkie.v1.DocumentSummary",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"key",kind:"scalar",T:9},{no:3,name:"snapshot",kind:"scalar",T:9},{no:4,name:"created_at",kind:"message",T:Timestamp},{no:5,name:"accessed_at",kind:"message",T:Timestamp},{no:6,name:"updated_at",kind:"message",T:Timestamp}]);let eM=q.makeMessageType("yorkie.v1.PresenceChange",()=>[{no:1,name:"type",kind:"enum",T:q.getEnumType(eV)},{no:2,name:"presence",kind:"message",T:e$}]),eV=q.makeEnum("yorkie.v1.PresenceChange.ChangeType",[{no:0,name:"CHANGE_TYPE_UNSPECIFIED",localName:"UNSPECIFIED"},{no:1,name:"CHANGE_TYPE_PUT",localName:"PUT"},{no:2,name:"CHANGE_TYPE_DELETE",localName:"DELETE"},{no:3,name:"CHANGE_TYPE_CLEAR",localName:"CLEAR"}]),e$=q.makeMessageType("yorkie.v1.Presence",()=>[{no:1,name:"data",kind:"map",K:9,V:{kind:"scalar",T:9}}]),eU=q.makeMessageType("yorkie.v1.Checkpoint",()=>[{no:1,name:"server_seq",kind:"scalar",T:3,L:1},{no:2,name:"client_seq",kind:"scalar",T:13}]),eJ=q.makeMessageType("yorkie.v1.TextNodePos",()=>[{no:1,name:"created_at",kind:"message",T:ej},{no:2,name:"offset",kind:"scalar",T:5},{no:3,name:"relative_offset",kind:"scalar",T:5}]),ej=q.makeMessageType("yorkie.v1.TimeTicket",()=>[{no:1,name:"lamport",kind:"scalar",T:3,L:1},{no:2,name:"delimiter",kind:"scalar",T:13},{no:3,name:"actor_id",kind:"scalar",T:12}]),eq=q.makeMessageType("yorkie.v1.DocEventBody",()=>[{no:1,name:"topic",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12}]),ez=q.makeMessageType("yorkie.v1.DocEvent",()=>[{no:1,name:"type",kind:"enum",T:q.getEnumType(en)},{no:2,name:"publisher",kind:"scalar",T:9},{no:3,name:"body",kind:"message",T:eq}]),eK=q.makeMessageType("yorkie.v1.ActivateClientRequest",()=>[{no:1,name:"client_key",kind:"scalar",T:9}]),eG=q.makeMessageType("yorkie.v1.ActivateClientResponse",()=>[{no:1,name:"client_id",kind:"scalar",T:9}]),eW=q.makeMessageType("yorkie.v1.DeactivateClientRequest",()=>[{no:1,name:"client_id",kind:"scalar",T:9}]),eY=q.makeMessageType("yorkie.v1.DeactivateClientResponse",[]),eH=q.makeMessageType("yorkie.v1.AttachDocumentRequest",()=>[{no:1,name:"client_id",kind:"scalar",T:9},{no:2,name:"change_pack",kind:"message",T:eo}]),eX=q.makeMessageType("yorkie.v1.AttachDocumentResponse",()=>[{no:1,name:"document_id",kind:"scalar",T:9},{no:2,name:"change_pack",kind:"message",T:eo}]),eZ=q.makeMessageType("yorkie.v1.DetachDocumentRequest",()=>[{no:1,name:"client_id",kind:"scalar",T:9},{no:2,name:"document_id",kind:"scalar",T:9},{no:3,name:"change_pack",kind:"message",T:eo},{no:4,name:"remove_if_not_attached",kind:"scalar",T:8}]),eQ=q.makeMessageType("yorkie.v1.DetachDocumentResponse",()=>[{no:2,name:"change_pack",kind:"message",T:eo}]),e0=q.makeMessageType("yorkie.v1.WatchDocumentRequest",()=>[{no:1,name:"client_id",kind:"scalar",T:9},{no:2,name:"document_id",kind:"scalar",T:9}]),e1=q.makeMessageType("yorkie.v1.WatchDocumentResponse",()=>[{no:1,name:"initialization",kind:"message",T:e2,oneof:"body"},{no:2,name:"event",kind:"message",T:ez,oneof:"body"}]),e2=q.makeMessageType("yorkie.v1.WatchDocumentResponse.Initialization",()=>[{no:1,name:"client_ids",kind:"scalar",T:9,repeated:!0}],{localName:"WatchDocumentResponse_Initialization"}),e3=q.makeMessageType("yorkie.v1.RemoveDocumentRequest",()=>[{no:1,name:"client_id",kind:"scalar",T:9},{no:2,name:"document_id",kind:"scalar",T:9},{no:3,name:"change_pack",kind:"message",T:eo}]),e6=q.makeMessageType("yorkie.v1.RemoveDocumentResponse",()=>[{no:1,name:"change_pack",kind:"message",T:eo}]),e4=q.makeMessageType("yorkie.v1.PushPullChangesRequest",()=>[{no:1,name:"client_id",kind:"scalar",T:9},{no:2,name:"document_id",kind:"scalar",T:9},{no:3,name:"change_pack",kind:"message",T:eo},{no:4,name:"push_only",kind:"scalar",T:8}]),e5=q.makeMessageType("yorkie.v1.PushPullChangesResponse",()=>[{no:1,name:"change_pack",kind:"message",T:eo}]),e9=q.makeMessageType("yorkie.v1.BroadcastRequest",()=>[{no:1,name:"client_id",kind:"scalar",T:9},{no:2,name:"document_id",kind:"scalar",T:9},{no:3,name:"topic",kind:"scalar",T:9},{no:4,name:"payload",kind:"scalar",T:12}]),e8=q.makeMessageType("yorkie.v1.BroadcastResponse",[]),e7={typeName:"yorkie.v1.YorkieService",methods:{activateClient:{name:"ActivateClient",I:eK,O:eG,kind:w.Unary},deactivateClient:{name:"DeactivateClient",I:eW,O:eY,kind:w.Unary},attachDocument:{name:"AttachDocument",I:eH,O:eX,kind:w.Unary},detachDocument:{name:"DetachDocument",I:eZ,O:eQ,kind:w.Unary},removeDocument:{name:"RemoveDocument",I:e3,O:e6,kind:w.Unary},pushPullChanges:{name:"PushPullChanges",I:e4,O:e5,kind:w.Unary},watchDocument:{name:"WatchDocument",I:e0,O:e1,kind:w.ServerStreaming},broadcast:{name:"Broadcast",I:e9,O:e8,kind:w.Unary}}};/**
   * @license
   * Copyright 2009 The Closure Library Authors
   * Copyright 2020 Daniel Wirtz / The long.js Authors.
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *     http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *
   * SPDX-License-Identifier: Apache-2.0
   */var te=null;try{te=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch(e){}function Long(e,t,r){this.low=0|e,this.high=0|t,this.unsigned=!!r}function isLong(e){return!0===(e&&e.__isLong__)}function ctz32(e){var t=Math.clz32(e&-e);return e?31-t:t}Long.prototype.__isLong__,Object.defineProperty(Long.prototype,"__isLong__",{value:!0}),Long.isLong=isLong;var tt={},tr={};function fromInt(e,t){var r,i,n;return t?(e>>>=0,(n=0<=e&&e<256)&&(i=tr[e]))?i:(r=fromBits(e,0,!0),n&&(tr[e]=r),r):(e|=0,(n=-128<=e&&e<128)&&(i=tt[e]))?i:(r=fromBits(e,e<0?-1:0,!1),n&&(tt[e]=r),r)}function fromNumber(e,t){if(isNaN(e))return t?th:tl;if(t){if(e<0)return th;if(e>=ts)return tf}else{if(e<=-to)return tm;if(e+1>=to)return tg}return e<0?fromNumber(-e,t).neg():fromBits(e%tn|0,e/tn|0,t)}function fromBits(e,t,r){return new Long(e,t,r)}Long.fromInt=fromInt,Long.fromNumber=fromNumber,Long.fromBits=fromBits;var ti=Math.pow;function fromString(e,t,r){if(0===e.length)throw Error("empty string");if("number"==typeof t?(r=t,t=!1):t=!!t,"NaN"===e||"Infinity"===e||"+Infinity"===e||"-Infinity"===e)return t?th:tl;if((r=r||10)<2||36<r)throw RangeError("radix");if((i=e.indexOf("-"))>0)throw Error("interior hyphen");if(0===i)return fromString(e.substring(1),t,r).neg();for(var i,n=fromNumber(ti(r,8)),s=tl,o=0;o<e.length;o+=8){var a=Math.min(8,e.length-o),l=parseInt(e.substring(o,o+a),r);if(a<8){var h=fromNumber(ti(r,a));s=s.mul(h).add(fromNumber(l))}else s=(s=s.mul(n)).add(fromNumber(l))}return s.unsigned=t,s}function fromValue(e,t){return"number"==typeof e?fromNumber(e,t):"string"==typeof e?fromString(e,t):fromBits(e.low,e.high,"boolean"==typeof t?t:e.unsigned)}Long.fromString=fromString,Long.fromValue=fromValue;var tn=4294967296,ts=18446744073709552e3,to=0x7fffffffffffffff,ta=fromInt(16777216),tl=fromInt(0);Long.ZERO=tl;var th=fromInt(0,!0);Long.UZERO=th;var tc=fromInt(1);Long.ONE=tc;var tu=fromInt(1,!0);Long.UONE=tu;var td=fromInt(-1);Long.NEG_ONE=td;var tg=fromBits(-1,2147483647,!1);Long.MAX_VALUE=tg;var tf=fromBits(-1,-1,!0);Long.MAX_UNSIGNED_VALUE=tf;var tm=fromBits(0,-2147483648,!1);Long.MIN_VALUE=tm;var tp=Long.prototype;tp.toInt=function(){return this.unsigned?this.low>>>0:this.low},tp.toNumber=function(){return this.unsigned?(this.high>>>0)*tn+(this.low>>>0):this.high*tn+(this.low>>>0)},tp.toString=function(e){if((e=e||10)<2||36<e)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative()){if(!this.eq(tm))return"-"+this.neg().toString(e);var t=fromNumber(e),r=this.div(t),i=r.mul(t).sub(this);return r.toString(e)+i.toInt().toString(e)}for(var n=fromNumber(ti(e,6),this.unsigned),s=this,o="";;){var a=s.div(n),l=(s.sub(a.mul(n)).toInt()>>>0).toString(e);if((s=a).isZero())return l+o;for(;l.length<6;)l="0"+l;o=""+l+o}},tp.getHighBits=function(){return this.high},tp.getHighBitsUnsigned=function(){return this.high>>>0},tp.getLowBits=function(){return this.low},tp.getLowBitsUnsigned=function(){return this.low>>>0},tp.getNumBitsAbs=function(){if(this.isNegative())return this.eq(tm)?64:this.neg().getNumBitsAbs();for(var e=0!=this.high?this.high:this.low,t=31;t>0&&(e&1<<t)==0;t--);return 0!=this.high?t+33:t+1},tp.isZero=function(){return 0===this.high&&0===this.low},tp.eqz=tp.isZero,tp.isNegative=function(){return!this.unsigned&&this.high<0},tp.isPositive=function(){return this.unsigned||this.high>=0},tp.isOdd=function(){return(1&this.low)==1},tp.isEven=function(){return(1&this.low)==0},tp.equals=function(e){return isLong(e)||(e=fromValue(e)),(this.unsigned===e.unsigned||this.high>>>31!=1||e.high>>>31!=1)&&this.high===e.high&&this.low===e.low},tp.eq=tp.equals,tp.notEquals=function(e){return!this.eq(e)},tp.neq=tp.notEquals,tp.ne=tp.notEquals,tp.lessThan=function(e){return 0>this.comp(e)},tp.lt=tp.lessThan,tp.lessThanOrEqual=function(e){return 0>=this.comp(e)},tp.lte=tp.lessThanOrEqual,tp.le=tp.lessThanOrEqual,tp.greaterThan=function(e){return this.comp(e)>0},tp.gt=tp.greaterThan,tp.greaterThanOrEqual=function(e){return this.comp(e)>=0},tp.gte=tp.greaterThanOrEqual,tp.ge=tp.greaterThanOrEqual,tp.compare=function(e){if(isLong(e)||(e=fromValue(e)),this.eq(e))return 0;var t=this.isNegative(),r=e.isNegative();return t&&!r?-1:!t&&r?1:this.unsigned?e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1:this.sub(e).isNegative()?-1:1},tp.comp=tp.compare,tp.negate=function(){return!this.unsigned&&this.eq(tm)?tm:this.not().add(tc)},tp.neg=tp.negate,tp.add=function(e){isLong(e)||(e=fromValue(e));var t,r,i=this.high>>>16,n=65535&this.high,s=this.low>>>16,o=65535&this.low,a=e.high>>>16,l=65535&e.high,h=e.low>>>16,c=65535&e.low,u=0,d=0;return t=0+((r=0+(o+c))>>>16),r&=65535,t+=s+h,d+=t>>>16,t&=65535,d+=n+l,u+=d>>>16,d&=65535,u+=i+a,fromBits(t<<16|r,(u&=65535)<<16|d,this.unsigned)},tp.subtract=function(e){return isLong(e)||(e=fromValue(e)),this.add(e.neg())},tp.sub=tp.subtract,tp.multiply=function(e){if(this.isZero())return this;if(isLong(e)||(e=fromValue(e)),te)return fromBits(te.mul(this.low,this.high,e.low,e.high),te.get_high(),this.unsigned);if(e.isZero())return this.unsigned?th:tl;if(this.eq(tm))return e.isOdd()?tm:tl;if(e.eq(tm))return this.isOdd()?tm:tl;if(this.isNegative())return e.isNegative()?this.neg().mul(e.neg()):this.neg().mul(e).neg();if(e.isNegative())return this.mul(e.neg()).neg();if(this.lt(ta)&&e.lt(ta))return fromNumber(this.toNumber()*e.toNumber(),this.unsigned);var t,r,i=this.high>>>16,n=65535&this.high,s=this.low>>>16,o=65535&this.low,a=e.high>>>16,l=65535&e.high,h=e.low>>>16,c=65535&e.low,u=0,d=0;return t=0+((r=0+o*c)>>>16),r&=65535,t+=s*c,d+=t>>>16,t&=65535,t+=o*h,d+=t>>>16,t&=65535,d+=n*c,u+=d>>>16,d&=65535,d+=s*h,u+=d>>>16,d&=65535,d+=o*l,u+=d>>>16,d&=65535,u+=i*c+n*h+s*l+o*a,fromBits(t<<16|r,(u&=65535)<<16|d,this.unsigned)},tp.mul=tp.multiply,tp.divide=function(e){if(isLong(e)||(e=fromValue(e)),e.isZero())throw Error("division by zero");if(te){var t,r,i;return this.unsigned||-2147483648!==this.high||-1!==e.low||-1!==e.high?fromBits((this.unsigned?te.div_u:te.div_s)(this.low,this.high,e.low,e.high),te.get_high(),this.unsigned):this}if(this.isZero())return this.unsigned?th:tl;if(this.unsigned){if(e.unsigned||(e=e.toUnsigned()),e.gt(this))return th;if(e.gt(this.shru(1)))return tu;i=th}else{if(this.eq(tm))return e.eq(tc)||e.eq(td)?tm:e.eq(tm)?tc:(t=this.shr(1).div(e).shl(1)).eq(tl)?e.isNegative()?tc:td:(r=this.sub(e.mul(t)),i=t.add(r.div(e)));if(e.eq(tm))return this.unsigned?th:tl;if(this.isNegative())return e.isNegative()?this.neg().div(e.neg()):this.neg().div(e).neg();if(e.isNegative())return this.div(e.neg()).neg();i=tl}for(r=this;r.gte(e);){for(var n=Math.ceil(Math.log(t=Math.max(1,Math.floor(r.toNumber()/e.toNumber())))/Math.LN2),s=n<=48?1:ti(2,n-48),o=fromNumber(t),a=o.mul(e);a.isNegative()||a.gt(r);)t-=s,a=(o=fromNumber(t,this.unsigned)).mul(e);o.isZero()&&(o=tc),i=i.add(o),r=r.sub(a)}return i},tp.div=tp.divide,tp.modulo=function(e){return(isLong(e)||(e=fromValue(e)),te)?fromBits((this.unsigned?te.rem_u:te.rem_s)(this.low,this.high,e.low,e.high),te.get_high(),this.unsigned):this.sub(this.div(e).mul(e))},tp.mod=tp.modulo,tp.rem=tp.modulo,tp.not=function(){return fromBits(~this.low,~this.high,this.unsigned)},tp.countLeadingZeros=function(){return this.high?Math.clz32(this.high):Math.clz32(this.low)+32},tp.clz=tp.countLeadingZeros,tp.countTrailingZeros=function(){return this.low?ctz32(this.low):ctz32(this.high)+32},tp.ctz=tp.countTrailingZeros,tp.and=function(e){return isLong(e)||(e=fromValue(e)),fromBits(this.low&e.low,this.high&e.high,this.unsigned)},tp.or=function(e){return isLong(e)||(e=fromValue(e)),fromBits(this.low|e.low,this.high|e.high,this.unsigned)},tp.xor=function(e){return isLong(e)||(e=fromValue(e)),fromBits(this.low^e.low,this.high^e.high,this.unsigned)},tp.shiftLeft=function(e){return(isLong(e)&&(e=e.toInt()),0==(e&=63))?this:e<32?fromBits(this.low<<e,this.high<<e|this.low>>>32-e,this.unsigned):fromBits(0,this.low<<e-32,this.unsigned)},tp.shl=tp.shiftLeft,tp.shiftRight=function(e){return(isLong(e)&&(e=e.toInt()),0==(e&=63))?this:e<32?fromBits(this.low>>>e|this.high<<32-e,this.high>>e,this.unsigned):fromBits(this.high>>e-32,this.high>=0?0:-1,this.unsigned)},tp.shr=tp.shiftRight,tp.shiftRightUnsigned=function(e){return(isLong(e)&&(e=e.toInt()),0==(e&=63))?this:e<32?fromBits(this.low>>>e|this.high<<32-e,this.high>>>e,this.unsigned):32===e?fromBits(this.high,0,this.unsigned):fromBits(this.high>>>e-32,0,this.unsigned)},tp.shru=tp.shiftRightUnsigned,tp.shr_u=tp.shiftRightUnsigned,tp.rotateLeft=function(e){var t;return(isLong(e)&&(e=e.toInt()),0==(e&=63))?this:32===e?fromBits(this.high,this.low,this.unsigned):e<32?(t=32-e,fromBits(this.low<<e|this.high>>>t,this.high<<e|this.low>>>t,this.unsigned)):(e-=32,t=32-e,fromBits(this.high<<e|this.low>>>t,this.low<<e|this.high>>>t,this.unsigned))},tp.rotl=tp.rotateLeft,tp.rotateRight=function(e){var t;return(isLong(e)&&(e=e.toInt()),0==(e&=63))?this:32===e?fromBits(this.high,this.low,this.unsigned):e<32?(t=32-e,fromBits(this.high<<t|this.low>>>e,this.low<<t|this.high>>>e,this.unsigned)):(e-=32,t=32-e,fromBits(this.low<<t|this.high>>>e,this.high<<t|this.low>>>e,this.unsigned))},tp.rotr=tp.rotateRight,tp.toSigned=function(){return this.unsigned?fromBits(this.low,this.high,!1):this},tp.toUnsigned=function(){return this.unsigned?this:fromBits(this.low,this.high,!0)},tp.toBytes=function(e){return e?this.toBytesLE():this.toBytesBE()},tp.toBytesLE=function(){var e=this.high,t=this.low;return[255&t,t>>>8&255,t>>>16&255,t>>>24,255&e,e>>>8&255,e>>>16&255,e>>>24]},tp.toBytesBE=function(){var e=this.high,t=this.low;return[e>>>24,e>>>16&255,e>>>8&255,255&e,t>>>24,t>>>16&255,t>>>8&255,255&t]},Long.fromBytes=function(e,t,r){return r?Long.fromBytesLE(e,t):Long.fromBytesBE(e,t)},Long.fromBytesLE=function(e,t){return new Long(e[0]|e[1]<<8|e[2]<<16|e[3]<<24,e[4]|e[5]<<8|e[6]<<16|e[7]<<24,t)},Long.fromBytesBE=function(e,t){return new Long(e[4]<<24|e[5]<<16|e[6]<<8|e[7],e[0]<<24|e[1]<<16|e[2]<<8|e[3],t)};let ty=q.makeMessageType("google.rpc.ErrorInfo",()=>[{no:1,name:"reason",kind:"scalar",T:9},{no:2,name:"domain",kind:"scalar",T:9},{no:3,name:"metadata",kind:"map",K:9,V:{kind:"scalar",T:9}}]);q.makeMessageType("google.rpc.RetryInfo",()=>[{no:1,name:"retry_delay",kind:"message",T:Duration}]),q.makeMessageType("google.rpc.DebugInfo",()=>[{no:1,name:"stack_entries",kind:"scalar",T:9,repeated:!0},{no:2,name:"detail",kind:"scalar",T:9}]),q.makeMessageType("google.rpc.QuotaFailure",()=>[{no:1,name:"violations",kind:"message",T:tT,repeated:!0}]);let tT=q.makeMessageType("google.rpc.QuotaFailure.Violation",()=>[{no:1,name:"subject",kind:"scalar",T:9},{no:2,name:"description",kind:"scalar",T:9}],{localName:"QuotaFailure_Violation"});q.makeMessageType("google.rpc.PreconditionFailure",()=>[{no:1,name:"violations",kind:"message",T:tv,repeated:!0}]);let tv=q.makeMessageType("google.rpc.PreconditionFailure.Violation",()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"subject",kind:"scalar",T:9},{no:3,name:"description",kind:"scalar",T:9}],{localName:"PreconditionFailure_Violation"});q.makeMessageType("google.rpc.BadRequest",()=>[{no:1,name:"field_violations",kind:"message",T:tb,repeated:!0}]);let tb=q.makeMessageType("google.rpc.BadRequest.FieldViolation",()=>[{no:1,name:"field",kind:"scalar",T:9},{no:2,name:"description",kind:"scalar",T:9}],{localName:"BadRequest_FieldViolation"});q.makeMessageType("google.rpc.RequestInfo",()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"serving_data",kind:"scalar",T:9}]),q.makeMessageType("google.rpc.ResourceInfo",()=>[{no:1,name:"resource_type",kind:"scalar",T:9},{no:2,name:"resource_name",kind:"scalar",T:9},{no:3,name:"owner",kind:"scalar",T:9},{no:4,name:"description",kind:"scalar",T:9}]),q.makeMessageType("google.rpc.Help",()=>[{no:1,name:"links",kind:"message",T:tS,repeated:!0}]);let tS=q.makeMessageType("google.rpc.Help.Link",()=>[{no:1,name:"description",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9}],{localName:"Help_Link"});q.makeMessageType("google.rpc.LocalizedMessage",()=>[{no:1,name:"locale",kind:"scalar",T:9},{no:2,name:"message",kind:"scalar",T:9}]);var tA=((l=tA||{}).Ok="ok",l.ErrClientNotActivated="ErrClientNotActivated",l.ErrClientNotFound="ErrClientNotFound",l.ErrUnimplemented="ErrUnimplemented",l.Unsupported="unsupported",l.ErrDocumentNotAttached="ErrDocumentNotAttached",l.ErrDocumentNotDetached="ErrDocumentNotDetached",l.ErrDocumentRemoved="ErrDocumentRemoved",l.ErrInvalidObjectKey="ErrInvalidObjectKey",l.ErrInvalidArgument="ErrInvalidArgument",l);let YorkieError=class YorkieError extends Error{constructor(e,t){super(t),__publicField(this,"name","YorkieError"),__publicField(this,"stack"),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}};function deepcopy(e){if(e instanceof Map){let t=Array.from(e);return new Map(JSON.parse(JSON.stringify(t)))}return JSON.parse(JSON.stringify(e))}let isEmpty=e=>!e||0===Object.entries(e).length,stringifyObjectValues=e=>{let t={};for(let[r,i]of Object.entries(e))t[r]=JSON.stringify(i);return t},parseObjectValues=e=>{let t={};for(let[r,i]of Object.entries(e))t[r]=JSON.parse(i);return t};var tk=((h=tk||{}).Put="put",h.Clear="clear",h);let Presence=class Presence{constructor(e,t){__publicField(this,"context"),__publicField(this,"presence"),this.context=e,this.presence=t}set(e,t){for(let t of Object.keys(e))this.presence[t]=e[t];this.context.setPresenceChange({type:"put",presence:deepcopy(this.presence)}),this.context.setReversePresence(e,t)}get(e){return this.presence[e]}clear(){this.presence={},this.context.setPresenceChange({type:"clear"})}};let tI="000000000000000000000000";let TimeTicket=class TimeTicket{constructor(e,t,r){__publicField(this,"lamport"),__publicField(this,"delimiter"),__publicField(this,"actorID"),this.lamport=e,this.delimiter=t,this.actorID=r}static of(e,t,r){return new TimeTicket(e,t,r)}static fromStruct(e){return TimeTicket.of(Long.fromString(e.lamport,!0),e.delimiter,e.actorID)}toIDString(){return`${this.lamport.toString()}:${this.actorID}:${this.delimiter}`}toStruct(){return{lamport:this.getLamportAsString(),delimiter:this.getDelimiter(),actorID:this.getActorID()}}toTestString(){return`${this.lamport.toString()}:${this.actorID.slice(-2)}:${this.delimiter}`}setActor(e){return new TimeTicket(this.lamport,this.delimiter,e)}getLamportAsString(){return this.lamport.toString()}getLamport(){return this.lamport}getDelimiter(){return this.delimiter}getActorID(){return this.actorID}after(e){return this.compare(e)>0}equals(e){return 0===this.compare(e)}compare(e){if(this.lamport.greaterThan(e.lamport))return 1;if(e.lamport.greaterThan(this.lamport))return -1;let t=this.actorID.localeCompare(e.actorID);return 0!==t?t:this.delimiter>e.delimiter?1:e.delimiter>this.delimiter?-1:0}};let tC=Long.MAX_VALUE,tw=new TimeTicket(Long.fromNumber(0),0,tI);new TimeTicket(Long.fromNumber(1),1,tI);let tE=new TimeTicket(tC,4294967295,"FFFFFFFFFFFFFFFFFFFFFFFF");var tN=((c=tN||{})[c.Trivial=0]="Trivial",c[c.Debug=1]="Debug",c[c.Info=2]="Info",c[c.Warn=3]="Warn",c[c.Error=4]="Error",c[c.Fatal=5]="Fatal",c);let tD=2;function setLogLevel(e){tD=e}let tx={trivial:(...e)=>{tD>0||"undefined"==typeof console||console.log("YORKIE T:",...e)},debug:(...e)=>{tD>1||"undefined"==typeof console||console.log("YORKIE D:",...e)},info:(...e)=>{tD>2||"undefined"==typeof console||console.log("YORKIE I:",...e)},warn:(...e)=>{tD>3||"undefined"==typeof console||(void 0!==console.warn?console.warn("YORKIE W:",...e):console.log("YORKIE W:",...e))},error:(...e)=>{tD>4||"undefined"==typeof console||(void 0!==console.error?console.error("YORKIE E:",...e):console.log("YORKIE E:",...e))},fatal:(e,...t)=>{throw"undefined"!=typeof console&&(void 0!==console.error?console.error("YORKIE F:",...t):console.log("YORKIE F:",...t)),Error(`YORKIE F: ${e}`)},isEnabled:e=>tD<=e};function escapeString(e){return e.replace(/["'\\\n\r\f\b\t\u2028\u2029]/g,function(e){switch(e){case'"':case"\\":return"\\"+e;case"\n":return"\\n";case"\r":return"\\r";case"\f":return"\\f";case"\b":return"\\b";case"	":return"\\t";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:return e}})}let CRDTElement=class CRDTElement{constructor(e){__publicField(this,"createdAt"),__publicField(this,"movedAt"),__publicField(this,"removedAt"),this.createdAt=e}getCreatedAt(){return this.createdAt}getID(){return this.createdAt}getMovedAt(){return this.movedAt}getRemovedAt(){return this.removedAt}getPositionedAt(){return this.movedAt?this.movedAt:this.createdAt}setMovedAt(e){return!!(!this.movedAt||e&&e.after(this.movedAt))&&(this.movedAt=e,!0)}setRemovedAt(e){this.removedAt=e}remove(e){return!!(e&&e.after(this.getPositionedAt())&&(!this.removedAt||e.after(this.removedAt)))&&(this.removedAt=e,!0)}isRemoved(){return!!this.removedAt}};let CRDTContainer=class CRDTContainer extends CRDTElement{constructor(e){super(e)}};let ElementRHTNode=class ElementRHTNode{constructor(e,t){__publicField(this,"strKey"),__publicField(this,"value"),this.strKey=e,this.value=t}static of(e,t){return new ElementRHTNode(e,t)}isRemoved(){return this.value.isRemoved()}getStrKey(){return this.strKey}getValue(){return this.value}remove(e){return this.value.remove(e)}};let ElementRHT=class ElementRHT{constructor(){__publicField(this,"nodeMapByKey"),__publicField(this,"nodeMapByCreatedAt"),this.nodeMapByKey=new Map,this.nodeMapByCreatedAt=new Map}static create(){return new ElementRHT}set(e,t,r){let i;let n=this.nodeMapByKey.get(e);null!=n&&!n.isRemoved()&&n.remove(r)&&(i=n.getValue());let s=ElementRHTNode.of(e,t);return this.nodeMapByCreatedAt.set(t.getCreatedAt().toIDString(),s),(null==n||r.after(n.getValue().getPositionedAt()))&&(this.nodeMapByKey.set(e,s),t.setMovedAt(r)),i}delete(e,t){this.nodeMapByCreatedAt.has(e.toIDString())||tx.fatal(`fail to find ${e.toIDString()}`);let r=this.nodeMapByCreatedAt.get(e.toIDString());return r.remove(t),r.getValue()}subPathOf(e){let t=this.nodeMapByCreatedAt.get(e.toIDString());if(t)return t.getStrKey()}purge(e){let t=this.nodeMapByCreatedAt.get(e.getCreatedAt().toIDString());if(!t){tx.fatal(`fail to find ${e.getCreatedAt().toIDString()}`);return}let r=this.nodeMapByKey.get(t.getStrKey());t===r&&this.nodeMapByKey.delete(r.getStrKey()),this.nodeMapByCreatedAt.delete(t.getValue().getCreatedAt().toIDString())}deleteByKey(e,t){let r=this.nodeMapByKey.get(e);if(null!=r&&r.remove(t))return r.getValue()}has(e){let t=this.nodeMapByKey.get(e);return null!=t&&!t.isRemoved()}getByID(e){return this.nodeMapByCreatedAt.get(e.toIDString())}get(e){let t=this.nodeMapByKey.get(e);if(!(!t||t.isRemoved()))return t}*[Symbol.iterator](){for(let[,e]of this.nodeMapByKey)yield e}};let CRDTObject=class CRDTObject extends CRDTContainer{constructor(e,t){super(e),__publicField(this,"memberNodes"),this.memberNodes=t}static create(e,t){if(!t)return new CRDTObject(e,ElementRHT.create());let r=ElementRHT.create();for(let[e,i]of Object.entries(t))r.set(e,i.deepcopy(),i.getCreatedAt());return new CRDTObject(e,r)}subPathOf(e){return this.memberNodes.subPathOf(e)}purge(e){this.memberNodes.purge(e)}set(e,t,r){return this.memberNodes.set(e,t,r)}delete(e,t){return this.memberNodes.delete(e,t)}deleteByKey(e,t){return this.memberNodes.deleteByKey(e,t)}get(e){let t=this.memberNodes.get(e);return null==t?void 0:t.getValue()}getByID(e){let t=this.memberNodes.getByID(e);return null==t?void 0:t.getValue()}has(e){return this.memberNodes.has(e)}toJSON(){let e=[];for(let[t,r]of this)e.push(`"${escapeString(t)}":${r.toJSON()}`);return`{${e.join(",")}}`}toJS(){return JSON.parse(this.toJSON())}toJSForTest(){let e={};for(let[t,r]of this){let{createdAt:i,value:n,type:s}=r.toJSForTest();e[t]={key:t,createdAt:i,value:n,type:s}}return{createdAt:this.getCreatedAt().toTestString(),value:e,type:"YORKIE_OBJECT"}}getKeys(){let e=[];for(let[t]of this)e.push(t);return e}toSortedJSON(){var e;let t=[];for(let[e]of this)t.push(e);let r=[];for(let i of t.sort()){let t=null==(e=this.memberNodes.get(i))?void 0:e.getValue();r.push(`"${escapeString(i)}":${t.toSortedJSON()}`)}return`{${r.join(",")}}`}getRHT(){return this.memberNodes}deepcopy(){let e=CRDTObject.create(this.getCreatedAt());for(let t of this.memberNodes)e.memberNodes.set(t.getStrKey(),t.getValue().deepcopy(),this.getPositionedAt());return e.remove(this.getRemovedAt()),e}getDescendants(e){for(let t of this.memberNodes){let r=t.getValue();if(e(r,this))return;r instanceof CRDTContainer&&r.getDescendants(e)}}*[Symbol.iterator](){let e=new Set;for(let t of this.memberNodes)e.has(t.getStrKey())||(e.add(t.getStrKey()),t.isRemoved()||(yield[t.getStrKey(),t.getValue()]))}};var tR=((u=tR||{}).Local="local",u.Remote="remote",u.UndoRedo="undoredo",u);let Operation=class Operation{constructor(e,t){__publicField(this,"parentCreatedAt"),__publicField(this,"executedAt"),this.parentCreatedAt=e,this.executedAt=t}getParentCreatedAt(){return this.parentCreatedAt}getExecutedAt(){if(!this.executedAt)throw Error("executedAt has not been set yet");return this.executedAt}setActor(e){this.executedAt&&(this.executedAt=this.executedAt.setActor(e))}setExecutedAt(e){this.executedAt=e}};let SplayNode=class SplayNode{constructor(e){__publicField(this,"value"),__publicField(this,"left"),__publicField(this,"right"),__publicField(this,"parent"),__publicField(this,"weight"),this.value=e,this.initWeight()}getNodeString(){return`${this.weight}${this.value}`}getValue(){return this.value}getLeftWeight(){return this.hasLeft()?this.left.getWeight():0}getRightWeight(){return this.hasRight()?this.right.getWeight():0}getWeight(){return this.weight}getLeft(){return this.left}getRight(){return this.right}getParent(){return this.parent}hasLeft(){return!!this.left}hasRight(){return!!this.right}hasParent(){return!!this.parent}setLeft(e){this.left=e}setRight(e){this.right=e}setParent(e){this.parent=e}unlink(){this.parent=void 0,this.right=void 0,this.left=void 0}hasLinks(){return this.hasParent()||this.hasLeft()||this.hasRight()}increaseWeight(e){this.weight+=e}initWeight(){this.weight=this.getLength()}};let SplayTree=class SplayTree{constructor(e){__publicField(this,"root"),this.root=e}get length(){return this.root?this.root.getWeight():0}find(e){if(!this.root||e<0)return[void 0,0];let t=this.root;for(;;)if(t.hasLeft()&&e<=t.getLeftWeight())t=t.getLeft();else if(t.hasRight()&&t.getLeftWeight()+t.getLength()<e)e-=t.getLeftWeight()+t.getLength(),t=t.getRight();else{e-=t.getLeftWeight();break}return e>t.getLength()&&tx.fatal(`out of index range: pos: ${e} > node.length: ${t.getLength()}`),[t,e]}indexOf(e){let t;if(!e||e!==this.root&&!e.hasLinks())return -1;let r=0,i=e;for(;i;)t&&t!==i.getRight()||(r+=i.getLength()+(i.hasLeft()?i.getLeftWeight():0)),t=i,i=i.getParent();return r-e.getLength()}getRoot(){return this.root}insert(e){return this.insertAfter(this.root,e)}insertAfter(e,t){return e?(this.splayNode(e),this.root=t,t.setRight(e.getRight()),e.hasRight()&&e.getRight().setParent(t),t.setLeft(e),e.setParent(t),e.setRight(),this.updateWeight(e),this.updateWeight(t)):this.root=t,t}updateWeight(e){e.initWeight(),e.hasLeft()&&e.increaseWeight(e.getLeftWeight()),e.hasRight()&&e.increaseWeight(e.getRightWeight())}updateTreeWeight(e){for(;e;)this.updateWeight(e),e=e.getParent()}splayNode(e){if(e)for(;;)if(this.isLeftChild(e.getParent())&&this.isRightChild(e))this.rotateLeft(e),this.rotateRight(e);else if(this.isRightChild(e.getParent())&&this.isLeftChild(e))this.rotateRight(e),this.rotateLeft(e);else if(this.isLeftChild(e.getParent())&&this.isLeftChild(e))this.rotateRight(e.getParent()),this.rotateRight(e);else if(this.isRightChild(e.getParent())&&this.isRightChild(e))this.rotateLeft(e.getParent()),this.rotateLeft(e);else{this.isLeftChild(e)?this.rotateRight(e):this.isRightChild(e)&&this.rotateLeft(e),this.updateWeight(e);return}}delete(e){this.splayNode(e);let t=new SplayTree(e.getLeft());t.root&&t.root.setParent();let r=new SplayTree(e.getRight());if(r.root&&r.root.setParent(),t.root){let e=t.getRightmost();t.splayNode(e),t.root.setRight(r.root),r.root&&r.root.setParent(t.root),this.root=t.root}else this.root=r.root;e.unlink(),this.root&&this.updateWeight(this.root)}deleteRange(e,t){if(!t){this.splayNode(e),this.cutOffRight(e);return}this.splayNode(e),this.splayNode(t),t.getLeft()!=e&&this.rotateRight(e),this.cutOffRight(e)}cutOffRight(e){let t=[];for(let r of(this.traversePostorder(e.getRight(),t),t))r.initWeight();this.updateTreeWeight(e)}toTestString(){let e=[];return this.traverseInorder(this.root,e),e.map(e=>`[${e.getWeight()},${e.getLength()}]${e.getValue()||""}`).join("")}checkWeight(){let e=[];for(let t of(this.traverseInorder(this.root,e),e))if(t.getWeight()!=t.getLength()+t.getLeftWeight()+t.getRightWeight())return!1;return!0}getRightmost(){let e=this.root;for(;e.hasRight();)e=e.getRight();return e}traverseInorder(e,t){e&&(this.traverseInorder(e.getLeft(),t),t.push(e),this.traverseInorder(e.getRight(),t))}traversePostorder(e,t){e&&(this.traversePostorder(e.getLeft(),t),this.traversePostorder(e.getRight(),t),t.push(e))}rotateLeft(e){let t=e.getParent();t.hasParent()?t===t.getParent().getLeft()?t.getParent().setLeft(e):t.getParent().setRight(e):this.root=e,e.setParent(t.getParent()),t.setRight(e.getLeft()),t.hasRight()&&t.getRight().setParent(t),e.setLeft(t),e.getLeft().setParent(e),this.updateWeight(t),this.updateWeight(e)}rotateRight(e){let t=e.getParent();t.hasParent()?t===t.getParent().getLeft()?t.getParent().setLeft(e):t.getParent().setRight(e):this.root=e,e.setParent(t.getParent()),t.setLeft(e.getRight()),t.hasLeft()&&t.getLeft().setParent(t),e.setRight(t),e.getRight().setParent(e),this.updateWeight(t),this.updateWeight(e)}isLeftChild(e){return!!(e&&e.hasParent())&&e.getParent().getLeft()===e}isRightChild(e){return!!(e&&e.hasParent())&&e.getParent().getRight()===e}};var t_=((d=t_||{})[d.Null=0]="Null",d[d.Boolean=1]="Boolean",d[d.Integer=2]="Integer",d[d.Long=3]="Long",d[d.Double=4]="Double",d[d.String=5]="String",d[d.Bytes=6]="Bytes",d[d.Date=7]="Date",d);let Primitive=class Primitive extends CRDTElement{constructor(e,t){super(t),__publicField(this,"valueType"),__publicField(this,"value"),this.valueType=Primitive.getPrimitiveType(e),this.value=void 0===e?null:e}static of(e,t){return new Primitive(e,t)}static valueFromBytes(e,t){switch(e){case 0:return null;case 1:return!!t[0];case 2:return t[0]|t[1]<<8|t[2]<<16|t[3]<<24;case 4:{let e=new DataView(t.buffer);return t.forEach(function(t,r){e.setUint8(r,t)}),e.getFloat64(0,!0)}case 5:return new TextDecoder("utf-8").decode(t);case 3:return Long.fromBytesLE(Array.from(t));case 6:return t;case 7:return new Date(Long.fromBytesLE(Array.from(t),!0).toNumber());default:throw new YorkieError(tA.ErrUnimplemented,`unimplemented type: ${e}`)}}toJSON(){return 5===this.valueType?`"${escapeString(this.value)}"`:`${this.value}`}toSortedJSON(){return this.toJSON()}toJSForTest(){return{createdAt:this.getCreatedAt().toTestString(),value:this.value,type:"YORKIE_PRIMITIVE"}}deepcopy(){let e=Primitive.of(this.value,this.getCreatedAt());return e.setMovedAt(this.getMovedAt()),e.setRemovedAt(this.getRemovedAt()),e}getType(){return this.valueType}static getPrimitiveType(e){switch(typeof e){case"undefined":return 0;case"boolean":return 1;case"number":if(this.isInteger(e))return 2;return 4;case"string":return 5;case"object":if(null===e)return 0;if(e instanceof Long)return 3;if(e instanceof Uint8Array)return 6;if(e instanceof Date)return 7}}static isSupport(e){let t=Primitive.getPrimitiveType(e);return void 0!==t}static isInteger(e){return e%1==0}isNumericType(){let e=this.valueType;return 2===e||3===e||4===e}getValue(){return this.value}toBytes(){switch(this.valueType){case 0:return new Uint8Array;case 1:{let e=this.value;return new Uint8Array(e?[1]:[0])}case 2:{let e=this.value;return new Uint8Array([255&e,e>>8&255,e>>16&255,e>>24&255])}case 4:{let e=this.value,t=new Uint8Array(8),r=new DataView(t.buffer);return r.setFloat64(0,e,!0),t}case 5:return new TextEncoder().encode(this.value);case 3:{let e=this.value,t=e.toBytesLE();return Uint8Array.from(t)}case 6:{let e=this.value;return e}case 7:{let e=this.value,t=Long.fromNumber(e.getTime(),!0).toBytesLE();return Uint8Array.from(t)}default:throw new YorkieError(tA.ErrUnimplemented,`unimplemented type: ${this.valueType}`)}}};let RGATreeListNode=class RGATreeListNode extends SplayNode{constructor(e){super(e),__publicField(this,"prev"),__publicField(this,"next"),this.value=e}static createAfter(e,t){let r=new RGATreeListNode(t),i=e.next;return e.next=r,r.prev=e,r.next=i,i&&(i.prev=r),r}remove(e){return this.value.remove(e)}getCreatedAt(){return this.value.getCreatedAt()}getPositionedAt(){return this.value.getPositionedAt()}release(){this.prev&&(this.prev.next=this.next),this.next&&(this.next.prev=this.prev),this.prev=void 0,this.next=void 0}getLength(){return this.value.isRemoved()?0:1}getPrev(){return this.prev}getNext(){return this.next}getValue(){return this.value}isRemoved(){return this.value.isRemoved()}};let RGATreeList=class RGATreeList{constructor(){__publicField(this,"dummyHead"),__publicField(this,"last"),__publicField(this,"nodeMapByIndex"),__publicField(this,"nodeMapByCreatedAt");let e=Primitive.of(0,tw);e.setRemovedAt(tw),this.dummyHead=new RGATreeListNode(e),this.last=this.dummyHead,this.nodeMapByIndex=new SplayTree,this.nodeMapByCreatedAt=new Map,this.nodeMapByIndex.insert(this.dummyHead),this.nodeMapByCreatedAt.set(this.dummyHead.getCreatedAt().toIDString(),this.dummyHead)}static create(){return new RGATreeList}get length(){return this.nodeMapByIndex.length}findNextBeforeExecutedAt(e,t){let r=this.nodeMapByCreatedAt.get(e.toIDString());for(r||tx.fatal(`cant find the given node: ${e.toIDString()}`);r.getNext()&&r.getNext().getPositionedAt().after(t);)r=r.getNext();return r}release(e){this.last===e&&(this.last=e.getPrev()),e.release(),this.nodeMapByIndex.delete(e),this.nodeMapByCreatedAt.delete(e.getValue().getCreatedAt().toIDString())}insertAfter(e,t,r=t.getCreatedAt()){let i=this.findNextBeforeExecutedAt(e,r),n=RGATreeListNode.createAfter(i,t);i===this.last&&(this.last=n),this.nodeMapByIndex.insertAfter(i,n),this.nodeMapByCreatedAt.set(n.getCreatedAt().toIDString(),n)}moveAfter(e,t,r){let i=this.nodeMapByCreatedAt.get(e.toIDString());i||tx.fatal(`cant find the given node: ${e.toIDString()}`);let n=this.nodeMapByCreatedAt.get(t.toIDString());n||tx.fatal(`cant find the given node: ${t.toIDString()}`),i!==n&&(!n.getValue().getMovedAt()||r.after(n.getValue().getMovedAt()))&&(this.release(n),this.insertAfter(i.getCreatedAt(),n.getValue(),r),n.getValue().setMovedAt(r))}insert(e){this.insertAfter(this.last.getCreatedAt(),e)}getByID(e){return this.nodeMapByCreatedAt.get(e.toIDString())}subPathOf(e){let t=this.nodeMapByCreatedAt.get(e.toIDString());if(t)return String(this.nodeMapByIndex.indexOf(t))}purge(e){let t=this.nodeMapByCreatedAt.get(e.getCreatedAt().toIDString());t||tx.fatal(`fail to find the given createdAt: ${e.getCreatedAt().toIDString()}`),this.release(t)}getByIndex(e){if(e>=this.length)return;let[t,r]=this.nodeMapByIndex.find(e),i=t;if(0===e&&t===this.dummyHead||r>0)do i&&(i=i.getNext());while(i&&i.isRemoved());return i}getPrevCreatedAt(e){let t=this.nodeMapByCreatedAt.get(e.toIDString());do t=t.getPrev();while(this.dummyHead!==t&&t.isRemoved());return t.getValue().getCreatedAt()}delete(e,t){let r=this.nodeMapByCreatedAt.get(e.toIDString()),i=r.isRemoved();return r.remove(t)&&!i&&this.nodeMapByIndex.splayNode(r),r.getValue()}deleteByIndex(e,t){let r=this.getByIndex(e);if(r)return r.remove(t)&&this.nodeMapByIndex.splayNode(r),r.getValue()}getHead(){return this.dummyHead.getValue()}getLast(){return this.last.getValue()}getLastCreatedAt(){return this.last.getCreatedAt()}toTestString(){let e=[];for(let t of this){let r=`${t.getCreatedAt().toIDString()}:${t.getValue().toJSON()}`;t.isRemoved()?e.push(`{${r}}`):e.push(`[${r}]`)}return e.join("")}*[Symbol.iterator](){let e=this.dummyHead.getNext();for(;e;)yield e,e=e.getNext()}};let CRDTArray=class CRDTArray extends CRDTContainer{constructor(e,t){super(e),__publicField(this,"elements"),this.elements=t}static create(e,t){if(!t)return new CRDTArray(e,RGATreeList.create());let r=RGATreeList.create();for(let e of t)r.insertAfter(r.getLastCreatedAt(),e.deepcopy());return new CRDTArray(e,r)}subPathOf(e){return this.elements.subPathOf(e)}purge(e){this.elements.purge(e)}insertAfter(e,t){this.elements.insertAfter(e,t)}moveAfter(e,t,r){this.elements.moveAfter(e,t,r)}get(e){let t=this.elements.getByIndex(e);return null==t?void 0:t.getValue()}getByID(e){let t=this.elements.getByID(e);return null==t?void 0:t.getValue()}getHead(){return this.elements.getHead()}getLast(){return this.elements.getLast()}getPrevCreatedAt(e){return this.elements.getPrevCreatedAt(e)}delete(e,t){return this.elements.delete(e,t)}deleteByIndex(e,t){return this.elements.deleteByIndex(e,t)}getLastCreatedAt(){return this.elements.getLastCreatedAt()}get length(){return this.elements.length}*[Symbol.iterator](){for(let e of this.elements)e.isRemoved()||(yield e.getValue())}toTestString(){return this.elements.toTestString()}getDescendants(e){for(let t of this.elements){let r=t.getValue();if(e(r,this))return;r instanceof CRDTContainer&&r.getDescendants(e)}}toJSON(){let e=[];for(let t of this)e.push(t.toJSON());return`[${e.join(",")}]`}toJS(){return JSON.parse(this.toJSON())}toJSForTest(){let e={};for(let t=0;t<this.length;t++){let{createdAt:r,value:i,type:n}=this.get(t).toJSForTest();e[t]={key:String(t),createdAt:r,value:i,type:n}}return{createdAt:this.getCreatedAt().toTestString(),value:e,type:"YORKIE_ARRAY"}}toSortedJSON(){return this.toJSON()}getElements(){return this.elements}deepcopy(){let e=CRDTArray.create(this.getCreatedAt());for(let t of this.elements)e.elements.insertAfter(e.getLastCreatedAt(),t.getValue().deepcopy());return e.remove(this.getRemovedAt()),e}};let RemoveOperation=class RemoveOperation extends Operation{constructor(e,t,r){super(e,r),__publicField(this,"createdAt"),this.createdAt=t}static create(e,t,r){return new RemoveOperation(e,t,r)}execute(e,t){var r;let i=e.findByCreatedAt(this.getParentCreatedAt());if(i||tx.fatal(`fail to find ${this.getParentCreatedAt()}`),i instanceof CRDTContainer||tx.fatal(`only object and array can execute remove: ${i}`),t===tR.UndoRedo){let t=i.getByID(this.createdAt);for(;t;){if(t.getRemovedAt())return;t=null==(r=e.findElementPairByCreatedAt(t.getCreatedAt()))?void 0:r.parent}}let n=i.subPathOf(this.createdAt),s=this.toReverseOperation(i),o=i.delete(this.createdAt,this.getExecutedAt());e.registerRemovedElement(o);let a=i instanceof CRDTArray?[{type:"remove",path:e.createPath(this.getParentCreatedAt()),index:Number(n)}]:[{type:"remove",path:e.createPath(this.getParentCreatedAt()),key:n}];return{opInfos:a,reverseOp:s}}toReverseOperation(e){if(e instanceof CRDTObject){let t=e.subPathOf(this.createdAt);if(void 0!==t){let r=e.get(t);if(void 0!==r)return SetOperation.create(t,r.deepcopy(),this.getParentCreatedAt())}}}getEffectedCreatedAt(){return this.getParentCreatedAt()}toTestString(){return`${this.getParentCreatedAt().toTestString()}.REMOVE.${this.createdAt.toTestString()}`}getCreatedAt(){return this.createdAt}};let SetOperation=class SetOperation extends Operation{constructor(e,t,r,i){super(r,i),__publicField(this,"key"),__publicField(this,"value"),this.key=e,this.value=t}static create(e,t,r,i){return new SetOperation(e,t,r,i)}execute(e,t){var r;let i=e.findByCreatedAt(this.getParentCreatedAt());if(i||tx.fatal(`fail to find ${this.getParentCreatedAt()}`),i instanceof CRDTObject||tx.fatal("fail to execute, only object can execute set"),t===tR.UndoRedo){let t=i;for(;t;){if(t.getRemovedAt())return;t=null==(r=e.findElementPairByCreatedAt(t.getCreatedAt()))?void 0:r.parent}}let n=i.get(this.key),s=this.toReverseOperation(n),o=this.value.deepcopy(),a=i.set(this.key,o,this.getExecutedAt());return t===tR.UndoRedo&&e.findByCreatedAt(o.getCreatedAt())&&e.deregisterElement(o),e.registerElement(o,i),a&&e.registerRemovedElement(a),{opInfos:[{type:"set",path:e.createPath(this.getParentCreatedAt()),key:this.key}],reverseOp:s}}toReverseOperation(e){let t=RemoveOperation.create(this.getParentCreatedAt(),this.value.getCreatedAt());return void 0===e||e.isRemoved()||(t=SetOperation.create(this.key,e.deepcopy(),this.getParentCreatedAt())),t}getEffectedCreatedAt(){return this.value.getCreatedAt()}toTestString(){return`${this.getParentCreatedAt().toTestString()}.SET.${this.key}=${this.value.toSortedJSON()}`}getKey(){return this.key}getValue(){return this.value}};let AddOperation=class AddOperation extends Operation{constructor(e,t,r,i){super(e,i),__publicField(this,"prevCreatedAt"),__publicField(this,"value"),this.prevCreatedAt=t,this.value=r}static create(e,t,r,i){return new AddOperation(e,t,r,i)}execute(e){let t=e.findByCreatedAt(this.getParentCreatedAt());t||tx.fatal(`fail to find ${this.getParentCreatedAt()}`),t instanceof CRDTArray||tx.fatal("fail to execute, only array can execute add");let r=this.value.deepcopy();return t.insertAfter(this.prevCreatedAt,r),e.registerElement(r,t),{opInfos:[{type:"add",path:e.createPath(this.getParentCreatedAt()),index:Number(t.subPathOf(this.getEffectedCreatedAt()))}]}}getEffectedCreatedAt(){return this.value.getCreatedAt()}toTestString(){return`${this.getParentCreatedAt().toTestString()}.ADD.${this.value.toJSON()}`}getPrevCreatedAt(){return this.prevCreatedAt}getValue(){return this.value}};let MoveOperation=class MoveOperation extends Operation{constructor(e,t,r,i){super(e,i),__publicField(this,"prevCreatedAt"),__publicField(this,"createdAt"),this.prevCreatedAt=t,this.createdAt=r}static create(e,t,r,i){return new MoveOperation(e,t,r,i)}execute(e){let t=e.findByCreatedAt(this.getParentCreatedAt());t||tx.fatal(`fail to find ${this.getParentCreatedAt()}`),t instanceof CRDTArray||tx.fatal("fail to execute, only array can execute move");let r=Number(t.subPathOf(this.createdAt));t.moveAfter(this.prevCreatedAt,this.createdAt,this.getExecutedAt());let i=Number(t.subPathOf(this.createdAt));return{opInfos:[{type:"move",path:e.createPath(this.getParentCreatedAt()),index:i,previousIndex:r}]}}getEffectedCreatedAt(){return this.createdAt}toTestString(){return`${this.getParentCreatedAt().toTestString()}.MOVE`}getPrevCreatedAt(){return this.prevCreatedAt}getCreatedAt(){return this.createdAt}};let RHTNode=class RHTNode{constructor(e,t,r,i){__publicField(this,"key"),__publicField(this,"value"),__publicField(this,"updatedAt"),__publicField(this,"_isRemoved"),this.key=e,this.value=t,this.updatedAt=r,this._isRemoved=i}static of(e,t,r,i){return new RHTNode(e,t,r,i)}getKey(){return this.key}getValue(){return this.value}getUpdatedAt(){return this.updatedAt}isRemoved(){return this._isRemoved}toIDString(){return`${this.updatedAt.toIDString()}:${this.key}`}getRemovedAt(){if(this._isRemoved)return this.updatedAt}};let RHT=class RHT{constructor(){__publicField(this,"nodeMapByKey"),__publicField(this,"numberOfRemovedElement"),this.nodeMapByKey=new Map,this.numberOfRemovedElement=0}static create(){return new RHT}getNodeMapByKey(){return this.nodeMapByKey}set(e,t,r){let i=this.nodeMapByKey.get(e);if(i&&i.isRemoved()&&r.after(i.getUpdatedAt())&&(this.numberOfRemovedElement-=1),void 0===i||r.after(i.getUpdatedAt())){let n=RHTNode.of(e,t,r,!1);return(this.nodeMapByKey.set(e,n),void 0!==i&&i.isRemoved())?[i,n]:[void 0,n]}return i.isRemoved()?[i,void 0]:[void 0,void 0]}setInternal(e,t,r,i){let n=RHTNode.of(e,t,r,i);this.nodeMapByKey.set(e,n),i&&this.numberOfRemovedElement++}remove(e,t){let r=this.nodeMapByKey.get(e),i=[];if(void 0===r||t.after(r.getUpdatedAt())){if(void 0===r){this.numberOfRemovedElement+=1;let r=RHTNode.of(e,"",t,!0);return this.nodeMapByKey.set(e,r),i.push(r),i}let n=r.isRemoved();n||(this.numberOfRemovedElement+=1),n&&i.push(r);let s=RHTNode.of(e,r.getValue(),t,!0);this.nodeMapByKey.set(e,s),i.push(s)}return i}has(e){if(this.nodeMapByKey.has(e)){let t=this.nodeMapByKey.get(e);return void 0!==t&&!t.isRemoved()}return!1}get(e){if(this.nodeMapByKey.has(e))return this.nodeMapByKey.get(e).getValue()}deepcopy(){let e=new RHT;for(let[,t]of this.nodeMapByKey)e.setInternal(t.getKey(),t.getValue(),t.getUpdatedAt(),t.isRemoved());return e}toJSON(){if(!this.size())return"{}";let e=[];for(let[t,r]of this.nodeMapByKey)r.isRemoved()||e.push(`"${escapeString(t)}":"${escapeString(r.getValue())}"`);return`{${e.join(",")}}`}size(){return this.nodeMapByKey.size-this.numberOfRemovedElement}toObject(){let e={};for(let[t,r]of this.nodeMapByKey)r.isRemoved()||(e[t]=r.getValue());return e}*[Symbol.iterator](){for(let[,e]of this.nodeMapByKey)yield e}purge(e){let t=this.nodeMapByKey.get(e.getKey());void 0!=t&&t.toIDString()==e.toIDString()&&(this.nodeMapByKey.delete(e.getKey()),this.numberOfRemovedElement--)}};let CRDTTextValue=class CRDTTextValue{constructor(e){__publicField(this,"attributes"),__publicField(this,"content"),this.attributes=RHT.create(),this.content=e}static create(e){return new CRDTTextValue(e)}get length(){return this.content.length}substring(e,t){let r=new CRDTTextValue(this.content.substring(e,t));return r.attributes=this.attributes.deepcopy(),r}setAttr(e,t,r){return this.attributes.set(e,t,r)}getAttrs(){return this.attributes}toString(){return this.content}toJSON(){let e=escapeString(this.content),t=this.attributes.toObject(),r=[];for(let[e,i]of Object.entries(t)){let t=JSON.parse(i),n="string"==typeof t?`"${escapeString(e)}":"${escapeString(t)}"`:`"${escapeString(e)}":${String(t)}`;r.push(n)}return(r.sort(),0===r.length)?`{"val":"${e}"}`:`{"attrs":{${r.join(",")}},"val":"${e}"}`}getAttributes(){return this.attributes.toObject()}getContent(){return this.content}purge(e){this.attributes&&e instanceof RHTNode&&this.attributes.purge(e)}getGCPairs(){let e=[];for(let t of this.attributes)t.getRemovedAt()&&e.push({parent:this,child:t});return e}};let CRDTText=class CRDTText extends CRDTElement{constructor(e,t){super(t),__publicField(this,"rgaTreeSplit"),this.rgaTreeSplit=e}static create(e,t){return new CRDTText(e,t)}edit(e,t,r,i,n){let s=t?CRDTTextValue.create(t):void 0;if(s&&i)for(let[e,t]of Object.entries(i))s.setAttr(e,t,r);let[o,a,l,h]=this.rgaTreeSplit.edit(e,r,s,n),c=h.map(e=>({...e,value:e.value?{attributes:parseObjectValues(e.value.getAttributes()),content:e.value.getContent()}:{attributes:void 0,content:""},type:"content"}));return[a,c,l,[o,o]]}setStyle(e,t,r,i){let[,n]=this.rgaTreeSplit.findNodeWithSplit(e[1],r),[,s]=this.rgaTreeSplit.findNodeWithSplit(e[0],r),o=[],a=this.rgaTreeSplit.findBetween(s,n),l=new Map,h=[];for(let e of a){let t=e.getCreatedAt().getActorID(),n=(null==i?void 0:i.size)?i.has(t)?i.get(t):tw:tE;if(e.canStyle(r,n)){let r=l.get(t),i=e.getCreatedAt();(!r||i.after(r))&&l.set(t,i),h.push(e)}}let c=[];for(let e of h){if(e.isRemoved())continue;let[i,n]=this.rgaTreeSplit.findIndexesFromRange(e.createPosRange());for(let[s,a]of(o.push({type:"style",actor:r.getActorID(),from:i,to:n,value:{attributes:parseObjectValues(t)}}),Object.entries(t))){let[t]=e.getValue().setAttr(s,a,r);void 0!==t&&c.push({parent:e.getValue(),child:t})}}return[l,c,o]}indexRangeToPosRange(e,t){let r=this.rgaTreeSplit.indexToPos(e);return e===t?[r,r]:[r,this.rgaTreeSplit.indexToPos(t)]}get length(){return this.rgaTreeSplit.length}getTreeByIndex(){return this.rgaTreeSplit.getTreeByIndex()}getTreeByID(){return this.rgaTreeSplit.getTreeByID()}toJSON(){let e=[];for(let t of this.rgaTreeSplit)t.isRemoved()||e.push(t.getValue().toJSON());return`[${e.join(",")}]`}toSortedJSON(){return this.toJSON()}toJSForTest(){return{createdAt:this.getCreatedAt().toTestString(),value:JSON.parse(this.toJSON()),type:"YORKIE_TEXT"}}toString(){return this.rgaTreeSplit.toString()}values(){let e=[];for(let t of this.rgaTreeSplit)if(!t.isRemoved()){let r=t.getValue();e.push({attributes:parseObjectValues(r.getAttributes()),content:r.getContent()})}return e}getRGATreeSplit(){return this.rgaTreeSplit}toTestString(){return this.rgaTreeSplit.toTestString()}deepcopy(){let e=new CRDTText(this.rgaTreeSplit.deepcopy(),this.getCreatedAt());return e.remove(this.getRemovedAt()),e}findIndexesFromRange(e){return this.rgaTreeSplit.findIndexesFromRange(e)}getGCPairs(){let e=[];for(let t of this.rgaTreeSplit)for(let r of(t.getRemovedAt()&&e.push({parent:this.rgaTreeSplit,child:t}),t.getValue().getGCPairs()))e.push(r);return e}};let EditOperation=class EditOperation extends Operation{constructor(e,t,r,i,n,s,o){super(e,o),__publicField(this,"fromPos"),__publicField(this,"toPos"),__publicField(this,"maxCreatedAtMapByActor"),__publicField(this,"content"),__publicField(this,"attributes"),this.fromPos=t,this.toPos=r,this.maxCreatedAtMapByActor=i,this.content=n,this.attributes=s}static create(e,t,r,i,n,s,o){return new EditOperation(e,t,r,i,n,s,o)}execute(e){let t=e.findByCreatedAt(this.getParentCreatedAt());t||tx.fatal(`fail to find ${this.getParentCreatedAt()}`),t instanceof CRDTText||tx.fatal("fail to execute, only Text can execute edit");let[,r,i]=t.edit([this.fromPos,this.toPos],this.content,this.getExecutedAt(),Object.fromEntries(this.attributes),this.maxCreatedAtMapByActor);for(let t of i)e.registerGCPair(t);return{opInfos:r.map(({from:t,to:r,value:i})=>({type:"edit",from:t,to:r,value:i,path:e.createPath(this.getParentCreatedAt())}))}}getEffectedCreatedAt(){return this.getParentCreatedAt()}toTestString(){let e=this.getParentCreatedAt().toTestString(),t=this.fromPos.toTestString(),r=this.toPos.toTestString(),i=this.content;return`${e}.EDIT(${t},${r},${i})`}getFromPos(){return this.fromPos}getToPos(){return this.toPos}getContent(){return this.content}getAttributes(){return this.attributes||new Map}getMaxCreatedAtMapByActor(){return this.maxCreatedAtMapByActor}};let StyleOperation=class StyleOperation extends Operation{constructor(e,t,r,i,n,s){super(e,s),__publicField(this,"fromPos"),__publicField(this,"toPos"),__publicField(this,"maxCreatedAtMapByActor"),__publicField(this,"attributes"),this.fromPos=t,this.toPos=r,this.maxCreatedAtMapByActor=i,this.attributes=n}static create(e,t,r,i,n,s){return new StyleOperation(e,t,r,i,n,s)}execute(e){let t=e.findByCreatedAt(this.getParentCreatedAt());t||tx.fatal(`fail to find ${this.getParentCreatedAt()}`),t instanceof CRDTText||tx.fatal("fail to execute, only Text can execute edit");let[,r,i]=t.setStyle([this.fromPos,this.toPos],this.attributes?Object.fromEntries(this.attributes):{},this.getExecutedAt(),this.maxCreatedAtMapByActor);for(let t of r)e.registerGCPair(t);return{opInfos:i.map(({from:t,to:r,value:i})=>({type:"style",from:t,to:r,value:i,path:e.createPath(this.getParentCreatedAt())}))}}getEffectedCreatedAt(){return this.getParentCreatedAt()}toTestString(){let e=this.getParentCreatedAt().toTestString(),t=this.fromPos.toTestString(),r=this.toPos.toTestString(),i=this.attributes;return`${e}.STYL(${t},${r},${JSON.stringify(i)})`}getFromPos(){return this.fromPos}getToPos(){return this.toPos}getAttributes(){return this.attributes}getMaxCreatedAtMapByActor(){return this.maxCreatedAtMapByActor}};let tO="text";function addSizeOfLeftSiblings(e,t){let r=0,i=e.children;for(let e=0;e<t;e++){let t=i[e];t&&!t.isRemoved&&(r+=t.paddedSize)}return r}let IndexTreeNode=class IndexTreeNode{constructor(e,t=[]){if(__publicField(this,"type"),__publicField(this,"parent"),__publicField(this,"_children"),__publicField(this,"size"),this.type=e,this.size=0,this._children=t,this.isText&&this._children.length>0)throw Error(`Text node cannot have children: ${this.type}`)}updateAncestorsSize(){let e=this.parent,t=this.isRemoved?-1:1;for(;e&&(e.size+=this.paddedSize*t,!e.isRemoved);)e=e.parent}updateDescendantsSize(){let e=0;for(let t of this._children){let r=t.updateDescendantsSize();t.isRemoved||(e+=r)}return this.size+=e,this.paddedSize}get isText(){return this.type===tO}get paddedSize(){return this.size+(this.isText?0:2)}isAncestorOf(e){return function(e,t){if(e===t)return!1;for(;t.parent;){if(t.parent===e)return!0;t=t.parent}return!1}(this,e)}get nextSibling(){let e=this.parent.findOffset(this),t=this.parent.children[e+1];if(t)return t}get prevSibling(){let e=this.parent.findOffset(this),t=this.parent.children[e-1];if(t)return t}splitText(e,t){if(0===e||e===this.size)return;let r=this.value.slice(0,e),i=this.value.slice(e);if(!i.length)return;this.value=r;let n=this.cloneText(e+t);return n.value=i,this.parent.insertAfterInternal(n,this),n}get children(){return this._children.filter(e=>!e.isRemoved)}get allChildren(){return[...this._children]}hasTextChild(){return this.children.length>0&&this.children.every(e=>e.isText)}append(...e){if(this.isText)throw Error("Text node cannot have children");for(let t of(this._children.push(...e),e))t.parent=this,t.updateAncestorsSize()}prepend(...e){if(this.isText)throw Error("Text node cannot have children");for(let t of(this._children.unshift(...e),e))t.parent=this}insertBefore(e,t){if(this.isText)throw Error("Text node cannot have children");let r=this._children.indexOf(t);if(-1===r)throw Error("child not found");this.insertAtInternal(e,r),e.updateAncestorsSize()}insertAfter(e,t){if(this.isText)throw Error("Text node cannot have children");let r=this._children.indexOf(t);if(-1===r)throw Error("child not found");this.insertAtInternal(e,r+1),e.updateAncestorsSize()}insertAt(e,t){if(this.isText)throw Error("Text node cannot have children");this.insertAtInternal(e,t),e.updateAncestorsSize()}removeChild(e){if(this.isText)throw Error("Text node cannot have children");let t=this._children.indexOf(e);if(-1===t)throw Error("child not found");this._children.splice(t,1),e.parent=void 0}splitElement(e,t){let r=this.cloneElement(t);this.parent.insertAfterInternal(r,this),r.updateAncestorsSize();let i=this.children.slice(0,e),n=this.children.slice(e);for(let e of(this._children=i,r._children=n,this.size=this._children.reduce((e,t)=>e+t.paddedSize,0),r.size=r._children.reduce((e,t)=>e+t.paddedSize,0),r._children))e.parent=r;return r}insertAfterInternal(e,t){if(this.isText)throw Error("Text node cannot have children");let r=this._children.indexOf(t);if(-1===r)throw Error("child not found");this.insertAtInternal(e,r+1)}insertAtInternal(e,t){if(this.isText)throw Error("Text node cannot have children");this._children.splice(t,0,e),e.parent=this}findOffset(e){if(this.isText)throw Error("Text node cannot have children");if(e.isRemoved){let t=this._children.indexOf(e),r=this.allChildren.splice(0,t).filter(e=>!e.isRemoved).length;return r}return this.children.indexOf(e)}findBranchOffset(e){if(this.isText)throw Error("Text node cannot have children");let t=e;for(;t;){let e=this._children.indexOf(t);if(-1!==e)return e;t=t.parent}return -1}};var tP=((g=tP||{}).Start="Start",g.End="End",g.Text="Text",g);function traverseAll(e,t,r=0){for(let i of e._children)traverseAll(i,t,r+1);t(e,r)}let IndexTree=class IndexTree{constructor(e){__publicField(this,"root"),this.root=e}tokensBetween(e,t,r){!function tokensBetween(e,t,r,i){if(t>r)throw Error(`from is greater than to: ${t} > ${r}`);if(t>e.size)throw Error(`from is out of range: ${t} > ${e.size}`);if(r>e.size)throw Error(`to is out of range: ${r} > ${e.size}`);if(t===r)return;let n=0;for(let s of e.children){if(t-s.paddedSize<n&&n<r){let e=s.isText?t-n:t-n-1,o=s.isText?r-n:r-n-1,a=!s.isText&&e<0,l=!s.isText&&o>s.size;(s.isText||a)&&i([s,s.isText?"Text":"Start"],l),tokensBetween(s,Math.max(0,e),Math.min(o,s.size),i),l&&i([s,"End"],l)}n+=s.paddedSize}}(this.root,e,t,r)}traverse(e){!function traverse(e,t,r=0){for(let i of e.children)traverse(i,t,r+1);t(e,r)}(this.root,e,0)}traverseAll(e){traverseAll(this.root,e,0)}findTreePos(e,t=!0){return function findTreePos(e,t,r=!0){if(t>e.size)throw Error(`index is out of range: ${t} > ${e.size}`);if(e.isText)return{node:e,offset:t};let i=0,n=0;for(let s of e.children){if(r&&s.isText&&s.size>=t-n)return findTreePos(s,t-n,r);if(t===n)break;if(!r&&s.paddedSize===t-n)return{node:e,offset:i+1};if(s.paddedSize>t-n)return findTreePos(s,t-n-1,r);n+=s.paddedSize,i+=1}return{node:e,offset:i}}(this.root,e,t)}treePosToPath(e){let t=[],r=e.node;if(r.isText){let i=r.parent.findOffset(r);if(-1===i)throw Error("invalid treePos");let n=addSizeOfLeftSiblings(r.parent,i);t.push(n+e.offset),r=r.parent}else if(r.hasTextChild()){let i=addSizeOfLeftSiblings(r,e.offset);t.push(i)}else t.push(e.offset);for(;r.parent;){let e=r.parent.findOffset(r);if(-1===e)throw Error("invalid treePos");t.push(e),r=r.parent}return t.reverse()}pathToIndex(e){let t=this.pathToTreePos(e);return this.indexOf(t)}pathToTreePos(e){if(!e.length)throw Error("unacceptable path");let t=this.root;for(let r=0;r<e.length-1;r++){let i=e[r];if(!(t=t.children[i]))throw Error("unacceptable path")}if(t.hasTextChild())return function(e,t){if(e.size<t)throw Error("unacceptable path");for(let r=0;r<e.children.length;r++){let i=e.children[r];if(i.size<t)t-=i.size;else{e=i;break}}return{node:e,offset:t}}(t,e[e.length-1]);if(t.children.length<e[e.length-1])throw Error("unacceptable path");return{node:t,offset:e[e.length-1]}}getRoot(){return this.root}get size(){return this.root.size}findPostorderRight(e){let{node:t,offset:r}=e;if(t.isText){if(t.size===r){let e=t.nextSibling;return e||t.parent}return t}return t.children.length===r?t:function findLeftmost(e){return e.isText||0===e.children.length?e:findLeftmost(e.children[0])}(t.children[r])}indexOf(e){let{node:t}=e,{offset:r}=e,i=0,n=1;if(t.isText){i+=r;let e=t.parent,n=e.findOffset(t);if(-1===n)throw Error("invalid pos");i+=addSizeOfLeftSiblings(e,n),t=t.parent}else i+=addSizeOfLeftSiblings(t,r);for(;null==t?void 0:t.parent;){let e=t.parent,r=e.findOffset(t);if(-1===r)throw Error("invalid pos");i+=addSizeOfLeftSiblings(e,r),n++,t=t.parent}return i+n-1}indexToPath(e){let t=this.findTreePos(e);return this.treePosToPath(t)}};let DefaultComparator=(e,t)=>e===t?0:e<t?-1:1;let LLRBNode=class LLRBNode{constructor(e,t,r){__publicField(this,"key"),__publicField(this,"value"),__publicField(this,"parent"),__publicField(this,"left"),__publicField(this,"right"),__publicField(this,"isRed"),this.key=e,this.value=t,this.isRed=r}};let SortedMapIterator=class SortedMapIterator{constructor(e){__publicField(this,"stack"),this.stack=[],this.traverseInorder(e)}traverseInorder(e){e&&(this.traverseInorder(e.left),this.stack.push({key:e.key,value:e.value}),this.traverseInorder(e.right))}};let LLRBTree=class LLRBTree{constructor(e){__publicField(this,"root"),__publicField(this,"comparator"),__publicField(this,"counter"),this.comparator=void 0!==e?e:DefaultComparator,this.counter=0}put(e,t){return this.root=this.putInternal(e,t,this.root),this.root.isRed=!1,t}get(e){let t=this.getInternal(e,this.root);return t?t.value:void 0}remove(e){this.isRed(this.root.left)||this.isRed(this.root.right)||(this.root.isRed=!0),this.root=this.removeInternal(this.root,e),this.root&&(this.root.isRed=!1)}getIterator(){return new SortedMapIterator(this.root)}values(){let e=[];for(let t of this.getIterator().stack)e.push(t.value);return e}floorEntry(e){let t=this.root;for(;t;){let r=this.comparator(e,t.key);if(r>0){if(!t.right)return t;t.right.parent=t,t=t.right}else if(!(r<0))return t;else if(t.left)t.left.parent=t,t=t.left;else{let e=t.parent,r=t;for(;e&&r===e.left;)r=e,e=e.parent;return e}}}lastEntry(){if(!this.root)return this.root;let e=this.root;for(;e.right;)e=e.right;return e}size(){return this.counter}isEmpty(){return 0===this.counter}getInternal(e,t){for(;t;){let r=this.comparator(e,t.key);if(0===r)return t;r<0?t=t.left:r>0&&(t=t.right)}}putInternal(e,t,r){if(!r)return this.counter+=1,new LLRBNode(e,t,!0);let i=this.comparator(e,r.key);return i<0?r.left=this.putInternal(e,t,r.left):i>0?r.right=this.putInternal(e,t,r.right):r.value=t,this.isRed(r.right)&&!this.isRed(r.left)&&(r=this.rotateLeft(r)),this.isRed(r.left)&&this.isRed(r.left.left)&&(r=this.rotateRight(r)),this.isRed(r.left)&&this.isRed(r.right)&&this.flipColors(r),r}removeInternal(e,t){if(0>this.comparator(t,e.key))this.isRed(e.left)||this.isRed(e.left.left)||(e=this.moveRedLeft(e)),e.left=this.removeInternal(e.left,t);else{if(this.isRed(e.left)&&(e=this.rotateRight(e)),0===this.comparator(t,e.key)&&!e.right){this.counter-=1;return}if(this.isRed(e.right)||this.isRed(e.right.left)||(e=this.moveRedRight(e)),0===this.comparator(t,e.key)){this.counter-=1;let t=this.min(e.right);e.value=t.value,e.key=t.key,e.right=this.removeMin(e.right)}else e.right=this.removeInternal(e.right,t)}return this.fixUp(e)}min(e){return e.left?this.min(e.left):e}removeMin(e){if(e.left)return this.isRed(e.left)||this.isRed(e.left.left)||(e=this.moveRedLeft(e)),e.left=this.removeMin(e.left),this.fixUp(e)}fixUp(e){return this.isRed(e.right)&&(e=this.rotateLeft(e)),this.isRed(e.left)&&this.isRed(e.left.left)&&(e=this.rotateRight(e)),this.isRed(e.left)&&this.isRed(e.right)&&this.flipColors(e),e}moveRedLeft(e){return this.flipColors(e),this.isRed(e.right.left)&&(e.right=this.rotateRight(e.right),e=this.rotateLeft(e),this.flipColors(e)),e}moveRedRight(e){return this.flipColors(e),this.isRed(e.left.left)&&(e=this.rotateRight(e),this.flipColors(e)),e}isRed(e){return e&&e.isRed}rotateLeft(e){let t=e.right;return e.right=t.left,t.left=e,t.isRed=t.left.isRed,t.left.isRed=!0,t}rotateRight(e){let t=e.left;return e.left=t.right,t.right=e,t.isRed=t.right.isRed,t.right.isRed=!0,t}flipColors(e){e.isRed=!e.isRed,e.left.isRed=!e.left.isRed,e.right.isRed=!e.right.isRed}};let CRDTTreePos=class CRDTTreePos{constructor(e,t){__publicField(this,"parentID"),__publicField(this,"leftSiblingID"),this.parentID=e,this.leftSiblingID=t}static of(e,t){return new CRDTTreePos(e,t)}static fromTreePos(e){let t;let{offset:r}=e,{node:i}=e;return i.isText?(t=i.parent.children[0]===i&&0===r?i.parent:i,i=i.parent):t=0===r?i:i.children[r-1],CRDTTreePos.of(i.id,CRDTTreeNodeID.of(t.getCreatedAt(),t.getOffset()+r))}getParentID(){return this.parentID}static fromStruct(e){return CRDTTreePos.of(CRDTTreeNodeID.of(TimeTicket.fromStruct(e.parentID.createdAt),e.parentID.offset),CRDTTreeNodeID.of(TimeTicket.fromStruct(e.leftSiblingID.createdAt),e.leftSiblingID.offset))}toStruct(){return{parentID:{createdAt:this.getParentID().getCreatedAt().toStruct(),offset:this.getParentID().getOffset()},leftSiblingID:{createdAt:this.getLeftSiblingID().getCreatedAt().toStruct(),offset:this.getLeftSiblingID().getOffset()}}}toTreeNodePair(e){let t=this.getParentID(),r=this.getLeftSiblingID(),i=e.findFloorNode(t),n=e.findFloorNode(r);if(!i||!n)throw Error(`cannot find node of CRDTTreePos(${t.toTestString()}, ${r.toTestString()})`);return!r.equals(t)&&r.getOffset()>0&&r.getOffset()===n.id.getOffset()&&n.insPrevID&&(n=e.findFloorNode(n.insPrevID)),[i,n]}getLeftSiblingID(){return this.leftSiblingID}equals(e){return this.getParentID().getCreatedAt().equals(e.getParentID().getCreatedAt())&&this.getParentID().getOffset()===e.getParentID().getOffset()&&this.getLeftSiblingID().getCreatedAt().equals(e.getLeftSiblingID().getCreatedAt())&&this.getLeftSiblingID().getOffset()===e.getLeftSiblingID().getOffset()}};let CRDTTreeNodeID=class CRDTTreeNodeID{constructor(e,t){__publicField(this,"createdAt"),__publicField(this,"offset"),this.createdAt=e,this.offset=t}static of(e,t){return new CRDTTreeNodeID(e,t)}static fromStruct(e){return CRDTTreeNodeID.of(TimeTicket.fromStruct(e.createdAt),e.offset)}static createComparator(){return(e,t)=>{let r=e.getCreatedAt().compare(t.getCreatedAt());return 0!==r?r:e.getOffset()>t.getOffset()?1:e.getOffset()<t.getOffset()?-1:0}}getCreatedAt(){return this.createdAt}equals(e){return 0===this.createdAt.compare(e.createdAt)&&this.offset===e.offset}getOffset(){return this.offset}setOffset(e){this.offset=e}toStruct(){return{createdAt:this.createdAt.toStruct(),offset:this.offset}}toIDString(){return`${this.createdAt.toIDString()}:${this.offset}`}toTestString(){return`${this.createdAt.toTestString()}/${this.offset}`}};let CRDTTreeNode=class CRDTTreeNode extends IndexTreeNode{constructor(e,t,r,i,n){super(t),__publicField(this,"id"),__publicField(this,"removedAt"),__publicField(this,"attrs"),__publicField(this,"insPrevID"),__publicField(this,"insNextID"),__publicField(this,"_value",""),this.id=e,this.removedAt=n,i&&(this.attrs=i),"string"==typeof r?this.value=r:Array.isArray(r)&&(this._children=r)}toIDString(){return this.id.toIDString()}getRemovedAt(){return this.removedAt}static create(e,t,r,i){return new CRDTTreeNode(e,t,r,i)}deepcopy(){var e;let t=new CRDTTreeNode(this.id,this.type);return t.removedAt=this.removedAt,t._value=this._value,t.size=this.size,t.attrs=null==(e=this.attrs)?void 0:e.deepcopy(),t._children=this._children.map(e=>{let r=e.deepcopy();return r.parent=t,r}),t.insPrevID=this.insPrevID,t.insNextID=this.insNextID,t}get value(){if(!this.isText)throw Error(`cannot get value of element node: ${this.type}`);return this._value}set value(e){if(!this.isText)throw Error(`cannot set value of element node: ${this.type}`);this._value=e,this.size=e.length}get isRemoved(){return!!this.removedAt}remove(e){let t=!this.removedAt;(!this.removedAt||this.removedAt.compare(e)>0)&&(this.removedAt=e),t&&this.updateAncestorsSize()}cloneText(e){return new CRDTTreeNode(CRDTTreeNodeID.of(this.id.getCreatedAt(),e),this.type,void 0,void 0,this.removedAt)}cloneElement(e){return new CRDTTreeNode(CRDTTreeNodeID.of(e(),0),this.type,void 0,void 0,this.removedAt)}split(e,t,r){let i=this.isText?this.splitText(t,this.id.getOffset()):this.splitElement(t,r);if(i){if(i.insPrevID=this.id,this.insNextID){let t=e.findFloorNode(this.insNextID);t.insPrevID=i.id,i.insNextID=this.insNextID}this.insNextID=i.id,e.registerNode(i)}return i}getCreatedAt(){return this.id.getCreatedAt()}getOffset(){return this.id.getOffset()}canDelete(e,t){return!this.getCreatedAt().after(t)&&(!this.removedAt||e.after(this.removedAt))}canStyle(e,t){return!this.isText&&!this.getCreatedAt().after(t)&&(!this.removedAt||e.after(this.removedAt))}setAttrs(e,t){this.attrs||(this.attrs=new RHT);let r=[];for(let[i,n]of Object.entries(e))r.push(this.attrs.set(i,n,t));return r}purge(e){this.attrs&&this.attrs.purge(e)}getGCPairs(){let e=[];if(!this.attrs)return e;for(let t of this.attrs)t.getRemovedAt()&&e.push({parent:this,child:t});return e}};function toTreeNode(e){var t;if(e.isText)return{type:e.type,value:e.value};let r={type:e.type,children:e.children.map(toTreeNode)};return e.attrs&&(r.attributes=parseObjectValues(null==(t=e.attrs)?void 0:t.toObject())),r}function toXML(e){if(e.isText)return e.value;let t="";return e.attrs&&e.attrs.size()&&(t=" "+Array.from(e.attrs).filter(e=>!e.isRemoved()).sort((e,t)=>e.getKey().localeCompare(t.getKey())).map(e=>{let t=JSON.parse(e.getValue());return"string"==typeof t?`${e.getKey()}="${t}"`:`${e.getKey()}="${escapeString(e.getValue())}"`}).join(" ")),`<${e.type}${t}>${e.children.map(e=>toXML(e)).join("")}</${e.type}>`}let CRDTTree=class CRDTTree extends CRDTElement{constructor(e,t){super(t),__publicField(this,"indexTree"),__publicField(this,"nodeMapByID"),this.indexTree=new IndexTree(e),this.nodeMapByID=new LLRBTree(CRDTTreeNodeID.createComparator()),this.indexTree.traverseAll(e=>{this.nodeMapByID.put(e.id,e)})}static create(e,t){return new CRDTTree(e,t)}findFloorNode(e){let t=this.nodeMapByID.floorEntry(e);if(t&&t.key.getCreatedAt().equals(e.getCreatedAt()))return t.value}registerNode(e){this.nodeMapByID.put(e.id,e)}findNodesAndSplitText(e,t){let[r,i]=e.toTreeNodePair(this),n=i,s=r===n,o=n.parent&&!s?n.parent:r;if(n.isText&&n.split(this,e.getLeftSiblingID().getOffset()-n.id.getOffset()),t){let e=o.allChildren,r=s?0:e.indexOf(n)+1;for(let i=r;i<e.length;i++){let r=e[i];if(!r.id.getCreatedAt().after(t))break;n=r}}return[o,n]}style(e,t,r,i){let[n,s]=this.findNodesAndSplitText(e[0],r),[o,a]=this.findNodesAndSplitText(e[1],r),l=[],h=t?parseObjectValues(t):{},c=new Map,u=[];return this.traverseInPosRange(n,s,o,a,([e])=>{let n=e.getCreatedAt().getActorID(),s=i?i.has(n)?i.get(n):tw:tE;if(e.canStyle(r,s)&&t){let i=c.get(n),s=e.getCreatedAt();(!i||s.after(i))&&c.set(n,s);let o=e.setAttrs(t,r),a=o.reduce((e,[,t])=>(t&&(e[t.getKey()]=h[t.getKey()]),e),{}),d=e.parent,g=e.prevSibling||e.parent;for(let[t]of(Object.keys(a).length>0&&l.push({type:"style",from:this.toIndex(d,g),to:this.toIndex(e,e),fromPath:this.toPath(d,g),toPath:this.toPath(e,e),actor:r.getActorID(),value:a}),o))t&&u.push({parent:e,child:t})}}),[c,u,l]}removeStyle(e,t,r,i){let[n,s]=this.findNodesAndSplitText(e[0],r),[o,a]=this.findNodesAndSplitText(e[1],r),l=[],h=new Map,c=[];return this.traverseInPosRange(n,s,o,a,([e])=>{let n=e.getCreatedAt().getActorID(),s=i?i.has(n)?i.get(n):tw:tE;if(e.canStyle(r,s)&&t){let i=h.get(n),s=e.getCreatedAt();for(let o of((!i||s.after(i))&&h.set(n,s),e.attrs||(e.attrs=new RHT),t)){let t=e.attrs.remove(o,r);for(let r of t)c.push({parent:e,child:r})}let o=e.parent,a=e.prevSibling||e.parent;l.push({actor:r.getActorID(),type:"removeStyle",from:this.toIndex(o,a),to:this.toIndex(e,e),fromPath:this.toPath(o,a),toPath:this.toPath(e,e),value:t})}}),[h,c,l]}edit(e,t,r,i,n,s){let[o,a]=this.findNodesAndSplitText(e[0],i),[l,h]=this.findNodesAndSplitText(e[1],i),c=this.toIndex(o,a),u=this.toPath(o,a),d=[],g=[],f=[],m=new Map;this.traverseInPosRange(o,a,l,h,([e,t],r)=>{if(t===tP.Start&&!r)for(let t of e.children)f.push(t);let n=e.getCreatedAt().getActorID(),o=s?s.has(n)?s.get(n):tw:tE;if(e.canDelete(i,o)||d.includes(e.parent)){let r=m.get(n),i=e.getCreatedAt();(!r||i.after(r))&&m.set(n,i),(t===tP.Text||t===tP.Start)&&d.push(e),g.push([e,t])}});let p=this.makeDeletionChanges(g,i),y=[];for(let e of d)e.remove(i),e.isRemoved&&y.push({parent:this,child:e});for(let e of f)e.removedAt||o.append(e);if(r>0){let e=0,t=o,s=a;for(;e<r;)t.split(this,t.findOffset(s)+1,n),s=t,t=t.parent,e++;p.push({type:"content",from:c,to:c,fromPath:u,toPath:u,actor:i.getActorID()})}if(null==t?void 0:t.length){let e=[],r=a;for(let n of t)r===o?o.insertAt(n,0):o.insertAfter(n,r),r=n,traverseAll(n,e=>{o.isRemoved&&(e.remove(i),y.push({parent:this,child:e})),this.nodeMapByID.put(e.id,e)}),n.isRemoved||e.push(n);if(e.length){let t=e.map(e=>toTreeNode(e));p.length&&p[p.length-1].from===c?p[p.length-1].value=t:p.push({type:"content",from:c,to:c,fromPath:u,toPath:u,actor:i.getActorID(),value:t})}}return[p,y,m]}editT(e,t,r,i,n){let s=this.findPos(e[0]),o=this.findPos(e[1]);this.edit([s,o],t,r,i,n)}move(e,t,r){throw Error(`not implemented: ${e}, ${t}, ${r}`)}purge(e){var t;null==(t=e.parent)||t.removeChild(e),this.nodeMapByID.remove(e.id);let r=e.insPrevID,i=e.insNextID;if(r){let e=this.findFloorNode(r);e.insNextID=i}if(i){let e=this.findFloorNode(i);e.insPrevID=r}e.insPrevID=void 0,e.insNextID=void 0}getGCPairs(){let e=[];return this.indexTree.traverse(t=>{for(let r of(t.getRemovedAt()&&e.push({parent:this,child:t}),t.getGCPairs()))e.push(r)}),e}findPos(e,t=!0){let r=this.indexTree.findTreePos(e,t);return CRDTTreePos.fromTreePos(r)}pathToPosRange(e){let t=this.pathToIndex(e);return[this.findPos(t),this.findPos(t+1)]}pathToPos(e){let t=this.indexTree.pathToIndex(e);return this.findPos(t)}getRoot(){return this.indexTree.getRoot()}getSize(){return this.indexTree.size}getNodeSize(){return this.nodeMapByID.size()}getIndexTree(){return this.indexTree}toXML(){return toXML(this.indexTree.getRoot())}toJSON(){return JSON.stringify(this.getRootTreeNode())}toJSForTest(){return{createdAt:this.getCreatedAt().toTestString(),value:JSON.parse(this.toJSON()),type:"YORKIE_TREE"}}toJSInfoForTest(){let e=this.indexTree.getRoot(),toTreeNodeInfo=(e,t,r,i=0)=>{var n,s,o,a;let l,h,c;let u=e.isText?{node:e,offset:0}:t&&r?this.toTreePos(t,r):null;u&&(l=this.indexTree.indexOf(u),h=this.indexTree.treePosToPath(u),c=CRDTTreePos.fromTreePos(u).toStruct());let d={type:e.type,parent:null==t?void 0:t.id.toTestString(),size:e.size,id:e.id.toTestString(),removedAt:null==(n=e.removedAt)?void 0:n.toTestString(),insPrev:null==(s=e.insPrevID)?void 0:s.toTestString(),insNext:null==(o=e.insNextID)?void 0:o.toTestString(),value:e.isText?e.value:void 0,isRemoved:e.isRemoved,children:[],depth:i,attributes:e.attrs?parseObjectValues(null==(a=e.attrs)?void 0:a.toObject()):void 0,index:l,path:h,pos:c};for(let t=0;t<e.allChildren.length;t++){let r=0===t?e:e.allChildren[t-1];d.children.push(toTreeNodeInfo(e.allChildren[t],e,r,i+1))}return d};return toTreeNodeInfo(e)}getRootTreeNode(){return toTreeNode(this.indexTree.getRoot())}toTestTreeNode(){return function toTestTreeNode(e){return e.isText?{type:e.type,value:e.value,size:e.size,isRemoved:e.isRemoved}:{type:e.type,children:e.children.map(toTestTreeNode),size:e.size,isRemoved:e.isRemoved}}(this.indexTree.getRoot())}toSortedJSON(){return this.toJSON()}deepcopy(){let e=this.getRoot();return new CRDTTree(e.deepcopy(),this.getCreatedAt())}toPath(e,t){let r=this.toTreePos(e,t);return r?this.indexTree.treePosToPath(r):[]}toIndex(e,t){let r=this.toTreePos(e,t);return r?this.indexTree.indexOf(r):-1}indexToPath(e){return this.indexTree.indexToPath(e)}pathToIndex(e){return this.indexTree.pathToIndex(e)}indexRangeToPosRange(e){let t=this.findPos(e[0]);return e[0]===e[1]?[t,t]:[t,this.findPos(e[1])]}indexRangeToPosStructRange(e){let[t,r]=e,i=this.findPos(t);return t===r?[i.toStruct(),i.toStruct()]:[i.toStruct(),this.findPos(r).toStruct()]}posRangeToPathRange(e){let[t,r]=this.findNodesAndSplitText(e[0]),[i,n]=this.findNodesAndSplitText(e[1]);return[this.toPath(t,r),this.toPath(i,n)]}posRangeToIndexRange(e){let[t,r]=this.findNodesAndSplitText(e[0]),[i,n]=this.findNodesAndSplitText(e[1]);return[this.toIndex(t,r),this.toIndex(i,n)]}traverseInPosRange(e,t,r,i,n){let s=this.toIndex(e,t),o=this.toIndex(r,i);return this.indexTree.tokensBetween(s,o,n)}toTreePos(e,t){if(!e||!t)return;if(e.isRemoved){let t;for(;e.isRemoved;)e=(t=e).parent;let r=e.findOffset(t);return{node:e,offset:r}}if(e===t)return{node:e,offset:0};let r=e.findOffset(t);if(!t.isRemoved){if(t.isText)return{node:t,offset:t.paddedSize};r++}return{node:e,offset:r}}makeDeletionChanges(e,t){let r=[],i=[],n=null,s=null;for(let t=0;t<e.length;t++){let r=e[t],o=e[t+1];n||(n=r),s=r;let a=this.findRightToken(r);a&&o&&a[0]===o[0]&&a[1]===o[1]||(i.push([n,s]),n=null,s=null)}for(let e of i){let[i,n]=e,[s,o]=this.findLeftToken(i),[a,l]=n,h=o===tP.Start?s:s.parent,c=l===tP.Start?a:a.parent,u=this.toIndex(h,s),d=this.toIndex(c,a);u<d&&(r.length>0&&u===r[r.length-1].to?(r[r.length-1].to=d,r[r.length-1].toPath=this.toPath(c,a)):r.push({type:"content",from:u,to:d,fromPath:this.toPath(h,s),toPath:this.toPath(c,a),actor:t.getActorID()}))}return r.reverse()}findRightToken([e,t]){if(t===tP.Start){let t=e.allChildren;return t.length>0?[t[0],t[0].isText?tP.Text:tP.Start]:[e,tP.End]}let r=e.parent,i=r.allChildren,n=i.indexOf(e);if(r&&n===i.length-1)return[r,tP.End];let s=i[n+1];return[s,s.isText?tP.Text:tP.Start]}findLeftToken([e,t]){if(t===tP.End){let t=e.allChildren;if(t.length>0){let e=t[t.length-1];return[e,e.isText?tP.Text:tP.End]}return[e,tP.Start]}let r=e.parent,i=r.allChildren,n=i.indexOf(e);if(r&&0===n)return[r,tP.Start];let s=i[n-1];return[s,s.isText?tP.Text:tP.End]}};let TreeEditOperation=class TreeEditOperation extends Operation{constructor(e,t,r,i,n,s,o){super(e,o),__publicField(this,"fromPos"),__publicField(this,"toPos"),__publicField(this,"contents"),__publicField(this,"splitLevel"),__publicField(this,"maxCreatedAtMapByActor"),this.fromPos=t,this.toPos=r,this.contents=i,this.splitLevel=n,this.maxCreatedAtMapByActor=s}static create(e,t,r,i,n,s,o){return new TreeEditOperation(e,t,r,i,n,s,o)}execute(e){var t;let r=e.findByCreatedAt(this.getParentCreatedAt());r||tx.fatal(`fail to find ${this.getParentCreatedAt()}`),r instanceof CRDTTree||tx.fatal("fail to execute, only Tree can execute edit");let i=this.getExecutedAt(),[n,s]=r.edit([this.fromPos,this.toPos],null==(t=this.contents)?void 0:t.map(e=>e.deepcopy()),this.splitLevel,i,(()=>{let e=i.getDelimiter();return void 0!==this.contents&&(e+=this.contents.length),()=>TimeTicket.of(i.getLamport(),++e,i.getActorID())})(),this.maxCreatedAtMapByActor);for(let t of s)e.registerGCPair(t);return{opInfos:n.map(({from:t,to:r,value:i,splitLevel:n,fromPath:s,toPath:o})=>({type:"tree-edit",path:e.createPath(this.getParentCreatedAt()),from:t,to:r,value:i,splitLevel:n,fromPath:s,toPath:o}))}}getEffectedCreatedAt(){return this.getParentCreatedAt()}toTestString(){let e=this.getParentCreatedAt().toTestString(),t=`${this.fromPos.getLeftSiblingID().getCreatedAt().toTestString()}/${this.fromPos.getLeftSiblingID().getOffset()}`,r=`${this.toPos.getLeftSiblingID().getCreatedAt().toTestString()}/${this.toPos.getLeftSiblingID().getOffset()}`,i=this.contents||[];return`${e}.EDIT(${t},${r},${i.map(e=>toXML(e)).join("")})`}getFromPos(){return this.fromPos}getToPos(){return this.toPos}getContents(){return this.contents}getSplitLevel(){return this.splitLevel}getMaxCreatedAtMapByActor(){return this.maxCreatedAtMapByActor}};let ChangeID=class ChangeID{constructor(e,t,r,i){__publicField(this,"clientSeq"),__publicField(this,"serverSeq"),__publicField(this,"lamport"),__publicField(this,"actor"),this.clientSeq=e,this.serverSeq=i,this.lamport=t,this.actor=r}static of(e,t,r,i){return new ChangeID(e,t,r,i)}next(){return new ChangeID(this.clientSeq+1,this.lamport.add(1),this.actor)}syncLamport(e){return e.greaterThan(this.lamport)?new ChangeID(this.clientSeq,e,this.actor):new ChangeID(this.clientSeq,this.lamport.add(1),this.actor)}createTimeTicket(e){return TimeTicket.of(this.lamport,e,this.actor)}setActor(e){return new ChangeID(this.clientSeq,this.lamport,e,this.serverSeq)}getClientSeq(){return this.clientSeq}getServerSeq(){return this.serverSeq?this.serverSeq.toString():""}getLamport(){return this.lamport}getLamportAsString(){return this.lamport.toString()}getActorID(){return this.actor}toTestString(){return`${this.lamport.toString()}:${this.actor.slice(-2)}:${this.clientSeq}`}};let tF=new ChangeID(0,Long.fromInt(0,!0),tI);let Change=class Change{constructor({id:e,operations:t,presenceChange:r,message:i}){__publicField(this,"id"),__publicField(this,"operations"),__publicField(this,"presenceChange"),__publicField(this,"message"),this.id=e,this.operations=t||[],this.presenceChange=r,this.message=i}static create({id:e,operations:t,presenceChange:r,message:i}){return new Change({id:e,operations:t,presenceChange:r,message:i})}getID(){return this.id}getMessage(){return this.message}hasOperations(){return this.operations.length>0}getOperations(){return this.operations}setActor(e){for(let t of this.operations)t.setActor(e);this.id=this.id.setActor(e)}hasPresenceChange(){return void 0!==this.presenceChange}getPresenceChange(){return this.presenceChange}execute(e,t,r){let i=[],n=[];for(let t of this.operations){let s=t.execute(e,r);if(!s)continue;let{opInfos:o,reverseOp:a}=s;i.push(...o),a&&n.unshift(a)}return this.presenceChange&&(this.presenceChange.type===tk.Put?t.set(this.id.getActorID(),deepcopy(this.presenceChange.presence)):t.delete(this.id.getActorID())),{opInfos:i,reverseOps:n}}toTestString(){return`${this.operations.map(e=>e.toTestString()).join(",")}`}toStruct(){return{changeID:tV.bytesToHex(tV.toChangeID(this.getID()).toBinary()),message:this.getMessage(),operations:this.getOperations().map(e=>tV.bytesToHex(tV.toOperation(e).toBinary())),presenceChange:this.getPresenceChange()}}static fromStruct(e){let{changeID:t,operations:r,presenceChange:i,message:n}=e;return Change.create({id:tV.bytesToChangeID(tV.hexToBytes(t)),operations:null==r?void 0:r.map(e=>tV.bytesToOperation(tV.hexToBytes(e))),presenceChange:i,message:n})}};let ChangePack=class ChangePack{constructor(e,t,r,i,n,s){__publicField(this,"documentKey"),__publicField(this,"checkpoint"),__publicField(this,"isRemoved"),__publicField(this,"changes"),__publicField(this,"snapshot"),__publicField(this,"minSyncedTicket"),this.documentKey=e,this.checkpoint=t,this.isRemoved=r,this.changes=i,this.snapshot=n,this.minSyncedTicket=s}static create(e,t,r,i,n,s){return new ChangePack(e,t,r,i,n,s)}getDocumentKey(){return this.documentKey}getCheckpoint(){return this.checkpoint}getIsRemoved(){return this.isRemoved}getChanges(){return this.changes}hasChanges(){return this.changes.length>0}getChangeSize(){return this.changes.length}hasSnapshot(){return!!this.snapshot&&!!this.snapshot.length}getSnapshot(){return this.snapshot}getMinSyncedTicket(){return this.minSyncedTicket}};let Checkpoint=class Checkpoint{constructor(e,t){__publicField(this,"serverSeq"),__publicField(this,"clientSeq"),this.serverSeq=e,this.clientSeq=t}static of(e,t){return new Checkpoint(e,t)}increaseClientSeq(e){return 0===e?this:new Checkpoint(this.serverSeq,this.clientSeq+e)}forward(e){if(this.equals(e))return this;let t=this.serverSeq.greaterThan(e.serverSeq)?this.serverSeq:e.serverSeq,r=Math.max(this.clientSeq,e.clientSeq);return Checkpoint.of(t,r)}getServerSeqAsString(){return this.serverSeq.toString()}getClientSeq(){return this.clientSeq}getServerSeq(){return this.serverSeq}equals(e){return this.clientSeq===e.clientSeq&&this.serverSeq.equals(e.serverSeq)}toTestString(){return`serverSeq=${this.serverSeq}, clientSeq=${this.clientSeq}`}};let tB=new Checkpoint(Long.fromInt(0,!0),0);let RGATreeSplitNodeID=class RGATreeSplitNodeID{constructor(e,t){__publicField(this,"createdAt"),__publicField(this,"offset"),this.createdAt=e,this.offset=t}static of(e,t){return new RGATreeSplitNodeID(e,t)}static fromStruct(e){return RGATreeSplitNodeID.of(TimeTicket.fromStruct(e.createdAt),e.offset)}getCreatedAt(){return this.createdAt}getOffset(){return this.offset}equals(e){return 0===this.createdAt.compare(e.createdAt)&&this.offset===e.offset}hasSameCreatedAt(e){return 0===this.createdAt.compare(e.createdAt)}split(e){return new RGATreeSplitNodeID(this.createdAt,this.offset+e)}toStruct(){return{createdAt:this.createdAt.toStruct(),offset:this.offset}}toTestString(){return`${this.createdAt.toTestString()}:${this.offset}`}toIDString(){return`${this.createdAt.toIDString()}:${this.offset}`}};let tL=RGATreeSplitNodeID.of(tw,0);let RGATreeSplitPos=class RGATreeSplitPos{constructor(e,t){__publicField(this,"id"),__publicField(this,"relativeOffset"),this.id=e,this.relativeOffset=t}static of(e,t){return new RGATreeSplitPos(e,t)}static fromStruct(e){let t=RGATreeSplitNodeID.fromStruct(e.id);return RGATreeSplitPos.of(t,e.relativeOffset)}getID(){return this.id}getRelativeOffset(){return this.relativeOffset}getAbsoluteID(){return RGATreeSplitNodeID.of(this.id.getCreatedAt(),this.id.getOffset()+this.relativeOffset)}toTestString(){return`${this.id.toTestString()}:${this.relativeOffset}`}toStruct(){return{id:this.id.toStruct(),relativeOffset:this.relativeOffset}}equals(e){return!!this.id.equals(e.id)&&this.relativeOffset===e.relativeOffset}};let RGATreeSplitNode=class RGATreeSplitNode extends SplayNode{constructor(e,t,r){super(t),__publicField(this,"id"),__publicField(this,"removedAt"),__publicField(this,"prev"),__publicField(this,"next"),__publicField(this,"insPrev"),__publicField(this,"insNext"),this.id=e,this.removedAt=r}static create(e,t){return new RGATreeSplitNode(e,t)}static createComparator(){return(e,t)=>{let r=e.getCreatedAt().compare(t.getCreatedAt());return 0!==r?r:e.getOffset()>t.getOffset()?1:e.getOffset()<t.getOffset()?-1:0}}getID(){return this.id}getCreatedAt(){return this.id.getCreatedAt()}getLength(){return this.removedAt?0:this.getContentLength()}getContentLength(){return this.value&&this.value.length||0}getPrev(){return this.prev}getNext(){return this.next}getInsPrev(){return this.insPrev}getInsNext(){return this.insNext}getInsPrevID(){return this.insPrev.getID()}setPrev(e){this.prev=e,e&&(e.next=this)}setNext(e){this.next=e,e&&(e.prev=this)}setInsPrev(e){this.insPrev=e,e&&(e.insNext=this)}setInsNext(e){this.insNext=e,e&&(e.insPrev=this)}hasNext(){return!!this.next}hasInsPrev(){return!!this.insPrev}isRemoved(){return!!this.removedAt}getRemovedAt(){return this.removedAt}split(e){return new RGATreeSplitNode(this.id.split(e),this.splitValue(e),this.removedAt)}canDelete(e,t){let r=!this.removedAt;return!!(!this.getCreatedAt().after(t)&&(!this.removedAt||e.after(this.removedAt)))&&r}canStyle(e,t){return!this.getCreatedAt().after(t)&&(!this.removedAt||e.after(this.removedAt))}remove(e){this.removedAt=e}createPosRange(){return[RGATreeSplitPos.of(this.id,0),RGATreeSplitPos.of(this.id,this.getLength())]}deepcopy(){return new RGATreeSplitNode(this.id,this.value,this.removedAt)}toTestString(){return`${this.id.toTestString()} ${this.value?this.value:""}`}splitValue(e){let t=this.value;return this.value=t.substring(0,e),t.substring(e,t.length)}toIDString(){return this.id.toIDString()}};let RGATreeSplit=class RGATreeSplit{constructor(){__publicField(this,"head"),__publicField(this,"treeByIndex"),__publicField(this,"treeByID"),this.head=RGATreeSplitNode.create(tL),this.treeByIndex=new SplayTree,this.treeByID=new LLRBTree(RGATreeSplitNode.createComparator()),this.treeByIndex.insert(this.head),this.treeByID.put(this.head.getID(),this.head)}static create(){return new RGATreeSplit}edit(e,t,r,i){let[n,s]=this.findNodeWithSplit(e[1],t),[o,a]=this.findNodeWithSplit(e[0],t),l=this.findBetween(a,s),[h,c,u]=this.deleteNodes(l,t,i),d=s?s.getID():n.getID(),g=RGATreeSplitPos.of(d,0);if(r){let e=this.posToIndex(o.createPosRange()[1],!0),i=this.insertAfter(o,RGATreeSplitNode.create(RGATreeSplitNodeID.of(t,0),r));h.length&&h[h.length-1].from===e?h[h.length-1].value=r:h.push({actor:t.getActorID(),from:e,to:e,value:r}),g=RGATreeSplitPos.of(i.getID(),i.getContentLength())}let f=[];for(let[,e]of u)f.push({parent:this,child:e});return[g,c,f,h]}indexToPos(e){let[t,r]=this.treeByIndex.find(e);return RGATreeSplitPos.of(t.getID(),r)}findIndexesFromRange(e){let[t,r]=e;return[this.posToIndex(t,!1),this.posToIndex(r,!0)]}posToIndex(e,t){let r=e.getAbsoluteID(),i=t?this.findFloorNodePreferToLeft(r):this.findFloorNode(r);i||tx.fatal(`the node of the given id should be found: ${r.toTestString()}`);let n=this.treeByIndex.indexOf(i),s=i.isRemoved()?0:r.getOffset()-i.getID().getOffset();return n+s}findNode(e){return this.findFloorNode(e)}get length(){return this.treeByIndex.length}getTreeByIndex(){return this.treeByIndex}getTreeByID(){return this.treeByID}toString(){let e=[];for(let t of this)t.isRemoved()||e.push(t.getValue());return e.join("")}*[Symbol.iterator](){let e=this.head.getNext();for(;e;)yield e,e=e.getNext()}getHead(){return this.head}deepcopy(){let e;let t=new RGATreeSplit,r=this.head.getNext(),i=t.head;for(;r;){if(e=t.insertAfter(i,r.deepcopy()),r.hasInsPrev()){let i=t.findNode(r.getInsPrevID());e.setInsPrev(i)}i=e,r=r.getNext()}return t}toTestString(){let e=[],t=this.head;for(;t;)t.isRemoved()?e.push(`{${t.toTestString()}}`):e.push(`[${t.toTestString()}]`),t=t.getNext();return e.join("")}insertAfter(e,t){let r=e.getNext();return t.setPrev(e),r&&r.setPrev(t),this.treeByID.put(t.getID(),t),this.treeByIndex.insertAfter(e,t),t}findNodeWithSplit(e,t){let r=e.getAbsoluteID(),i=this.findFloorNodePreferToLeft(r),n=r.getOffset()-i.getID().getOffset();for(this.splitNode(i,n);i.hasNext()&&i.getNext().getCreatedAt().after(t);)i=i.getNext();return[i,i.getNext()]}findFloorNodePreferToLeft(e){let t=this.findFloorNode(e);if(t||tx.fatal(`the node of the given id should be found: ${e.toTestString()}`),e.getOffset()>0&&t.getID().getOffset()==e.getOffset()){if(!t.hasInsPrev())return t;t=t.getInsPrev()}return t}findFloorNode(e){let t=this.treeByID.floorEntry(e);if(t&&(t.key.equals(e)||t.key.hasSameCreatedAt(e)))return t.value}findBetween(e,t){let r=[],i=e;for(;i&&i!==t;)r.push(i),i=i.getNext();return r}splitNode(e,t){if(t>e.getContentLength()&&tx.fatal("offset should be less than or equal to length"),0===t)return e;if(t===e.getContentLength())return e.getNext();let r=e.split(t);this.treeByIndex.updateWeight(r),this.insertAfter(e,r);let i=e.getInsNext();return i&&i.setInsPrev(r),r.setInsPrev(e),r}deleteNodes(e,t,r){if(!e.length)return[[],new Map,new Map];let[i,n]=this.filterNodes(e,t,r),s=new Map,o=new Map,a=this.makeChanges(n,t);for(let e of i){let r=e.getCreatedAt().getActorID();(!s.has(r)||e.getID().getCreatedAt().after(s.get(r)))&&s.set(r,e.getID().getCreatedAt()),o.set(e.getID().toIDString(),e),e.remove(t)}return this.deleteIndexNodes(n),[a,s,o]}filterNodes(e,t,r){let i=!!r,n=[],s=[],[o,a]=this.findEdgesOfCandidates(e);for(let a of(s.push(o),e)){let e=a.getCreatedAt().getActorID(),o=i?r.has(e)?r.get(e):tw:tE;a.canDelete(t,o)?n.push(a):s.push(a)}return s.push(a),[n,s]}findEdgesOfCandidates(e){return[e[0].getPrev(),e[e.length-1].getNext()]}makeChanges(e,t){let r,i;let n=[];for(let s=0;s<e.length-1;s++){let o=e[s],a=e[s+1];o.getNext()!=a&&([r]=this.findIndexesFromRange(o.getNext().createPosRange()),a?[,i]=this.findIndexesFromRange(a.getPrev().createPosRange()):i=this.treeByIndex.length,r<i&&n.push({actor:t.getActorID(),from:r,to:i}))}return n.reverse()}deleteIndexNodes(e){for(let t=0;t<e.length-1;t++){let r=e[t],i=e[t+1];r.getNext()!=i&&this.treeByIndex.deleteRange(r,i)}}purge(e){this.treeByIndex.delete(e),this.treeByID.remove(e.getID());let t=e.getPrev(),r=e.getNext(),i=e.getInsPrev(),n=e.getInsNext();t&&t.setNext(r),r&&r.setPrev(t),e.setPrev(void 0),e.setNext(void 0),i&&i.setInsNext(n),n&&n.setInsPrev(i),e.setInsPrev(void 0),e.setInsNext(void 0)}};let removeDecimal=e=>e<0?Math.ceil(e):Math.floor(e);var tM=((f=tM||{})[f.IntegerCnt=0]="IntegerCnt",f[f.LongCnt=1]="LongCnt",f);let CRDTCounter=class CRDTCounter extends CRDTElement{constructor(e,t,r){switch(super(r),__publicField(this,"valueType"),__publicField(this,"value"),this.valueType=e,e){case 0:"number"==typeof t?t>2147483647||t<-2147483648?this.value=Long.fromNumber(t).toInt():this.value=removeDecimal(t):this.value=t.toInt();break;case 1:"number"==typeof t?this.value=Long.fromNumber(t):this.value=t;break;default:throw new YorkieError(tA.ErrUnimplemented,`unimplemented type: ${e}`)}}static create(e,t,r){return new CRDTCounter(e,t,r)}static valueFromBytes(e,t){switch(e){case 0:return t[0]|t[1]<<8|t[2]<<16|t[3]<<24;case 1:return Long.fromBytesLE(Array.from(t));default:throw new YorkieError(tA.ErrUnimplemented,`unimplemented type: ${e}`)}}toJSON(){return`${this.value}`}toSortedJSON(){return this.toJSON()}toJSForTest(){return{createdAt:this.getCreatedAt().toTestString(),value:this.value,type:"YORKIE_COUNTER"}}deepcopy(){let e=CRDTCounter.create(this.valueType,this.value,this.getCreatedAt());return e.setMovedAt(this.getMovedAt()),e}getType(){return this.valueType}static getCounterType(e){switch(typeof e){case"object":if(e instanceof Long)return 1;return;case"number":if(e>2147483647||e<-2147483648)return 1;return 0;default:return}}static isSupport(e){return!!CRDTCounter.getCounterType(e)}static isInteger(e){return e%1==0}isNumericType(){let e=this.valueType;return 0===e||1===e}getValueType(){return this.valueType}getValue(){return this.value}toBytes(){switch(this.valueType){case 0:{let e=this.value;return new Uint8Array([255&e,e>>8&255,e>>16&255,e>>24&255])}case 1:{let e=this.value,t=e.toBytesLE();return Uint8Array.from(t)}default:throw new YorkieError(tA.ErrUnimplemented,`unimplemented type: ${this.valueType}`)}}increase(e){function checkNumericType(e){if(!e.isNumericType())throw TypeError(`Unsupported type of value: ${typeof e.getValue()}`)}return checkNumericType(this),checkNumericType(e),1===this.valueType?this.value=this.value.add(e.getValue()):e.getType()===t_.Long?this.value=this.value+e.getValue().toInt():this.value=Long.fromNumber(this.value+removeDecimal(e.getValue())).toInt(),this}};let IncreaseOperation=class IncreaseOperation extends Operation{constructor(e,t,r){super(e,r),__publicField(this,"value"),this.value=t}static create(e,t,r){return new IncreaseOperation(e,t,r)}execute(e){let t=e.findByCreatedAt(this.getParentCreatedAt());t||tx.fatal(`fail to find ${this.getParentCreatedAt()}`),t instanceof CRDTCounter||tx.fatal("fail to execute, only Counter can execute increase");let r=this.value.deepcopy();return t.increase(r),{opInfos:[{type:"increase",path:e.createPath(this.getParentCreatedAt()),value:r.getValue()}],reverseOp:this.toReverseOperation()}}toReverseOperation(){let e=this.value.deepcopy(),t=e.getType(),r=t===t_.Long?e.getValue().multiply(-1):-1*e.getValue(),i=IncreaseOperation.create(this.getParentCreatedAt(),Primitive.of(r,e.getCreatedAt()));return i}getEffectedCreatedAt(){return this.getParentCreatedAt()}toTestString(){return`${this.getParentCreatedAt().toTestString()}.INCREASE.${this.value.toJSON()}`}getValue(){return this.value}};let TreeStyleOperation=class TreeStyleOperation extends Operation{constructor(e,t,r,i,n,s,o){super(e,o),__publicField(this,"fromPos"),__publicField(this,"toPos"),__publicField(this,"maxCreatedAtMapByActor"),__publicField(this,"attributes"),__publicField(this,"attributesToRemove"),this.fromPos=t,this.toPos=r,this.maxCreatedAtMapByActor=i,this.attributes=n,this.attributesToRemove=s}static create(e,t,r,i,n,s){return new TreeStyleOperation(e,t,r,i,n,[],s)}static createTreeRemoveStyleOperation(e,t,r,i,n,s){return new TreeStyleOperation(e,t,r,i,new Map,n,s)}execute(e){let t,r;let i=e.findByCreatedAt(this.getParentCreatedAt());if(i||tx.fatal(`fail to find ${this.getParentCreatedAt()}`),i instanceof CRDTTree||tx.fatal("fail to execute, only Tree can execute edit"),this.attributes.size){let e={};[...this.attributes].forEach(([t,r])=>e[t]=r),[,r,t]=i.style([this.fromPos,this.toPos],e,this.getExecutedAt(),this.maxCreatedAtMapByActor)}else{let e=this.attributesToRemove;[,r,t]=i.removeStyle([this.fromPos,this.toPos],e,this.getExecutedAt(),this.maxCreatedAtMapByActor)}for(let t of r)e.registerGCPair(t);return{opInfos:t.map(({from:t,to:r,value:i,fromPath:n,toPath:s})=>({type:"tree-style",from:t,to:r,value:this.attributes.size?{attributes:i}:{attributesToRemove:i},fromPath:n,toPath:s,path:e.createPath(this.getParentCreatedAt())}))}}getEffectedCreatedAt(){return this.getParentCreatedAt()}toTestString(){let e=this.getParentCreatedAt().toTestString(),t=`${this.fromPos.getLeftSiblingID().getCreatedAt().toTestString()}:${this.fromPos.getLeftSiblingID().getOffset()}`,r=`${this.toPos.getLeftSiblingID().getCreatedAt().toTestString()}:${this.toPos.getLeftSiblingID().getOffset()}`;return`${e}.STYLE(${t},${r},${Object.entries(this.attributes||{}).map(([e,t])=>`${e}:"${t}"`).join(" ")})`}getFromPos(){return this.fromPos}getToPos(){return this.toPos}getAttributes(){return this.attributes}getAttributesToRemove(){return this.attributesToRemove}getMaxCreatedAtMapByActor(){return this.maxCreatedAtMapByActor}};function toChangeID(e){var t;return new el({clientSeq:e.getClientSeq(),lamport:e.getLamportAsString(),actorId:hexToBytes(e.getActorID())})}function toTimeTicket(e){if(e){var t;return new ej({lamport:e.getLamportAsString(),delimiter:e.getDelimiter(),actorId:hexToBytes(e.getActorID())})}}function toValueType(e){switch(e){case t_.Null:return ei.NULL;case t_.Boolean:return ei.BOOLEAN;case t_.Integer:return ei.INTEGER;case t_.Long:return ei.LONG;case t_.Double:return ei.DOUBLE;case t_.String:return ei.STRING;case t_.Bytes:return ei.BYTES;case t_.Date:return ei.DATE;default:throw new YorkieError(tA.Unsupported,`unsupported type: ${e}`)}}function toCounterType(e){switch(e){case tM.IntegerCnt:return ei.INTEGER_CNT;case tM.LongCnt:return ei.LONG_CNT;default:throw new YorkieError(tA.Unsupported,`unsupported type: ${e}`)}}function toElementSimple(e){if(e instanceof CRDTObject)return new eb({type:ei.JSON_OBJECT,createdAt:toTimeTicket(e.getCreatedAt()),value:objectToBytes(e)});if(e instanceof CRDTArray)return new eb({type:ei.JSON_ARRAY,createdAt:toTimeTicket(e.getCreatedAt()),value:toArray(e).toBinary()});if(e instanceof CRDTText)return new eb({type:ei.TEXT,createdAt:toTimeTicket(e.getCreatedAt())});if(e instanceof Primitive)return new eb({type:toValueType(e.getType()),createdAt:toTimeTicket(e.getCreatedAt()),value:e.toBytes()});if(e instanceof CRDTCounter)return new eb({type:toCounterType(e.getType()),createdAt:toTimeTicket(e.getCreatedAt()),value:e.toBytes()});if(e instanceof CRDTTree)return new eb({type:ei.TREE,createdAt:toTimeTicket(e.getCreatedAt()),value:toTree(e).toBinary()});throw new YorkieError(tA.ErrUnimplemented,"unimplemented element")}function toTextNodePos(e){return new eJ({createdAt:toTimeTicket(e.getID().getCreatedAt()),offset:e.getID().getOffset(),relativeOffset:e.getRelativeOffset()})}function toTreePos(e){return new eB({parentId:toTreeNodeID(e.getParentID()),leftSiblingId:toTreeNodeID(e.getLeftSiblingID())})}function toTreeNodeID(e){return new eF({createdAt:toTimeTicket(e.getCreatedAt()),offset:e.getOffset()})}function toOperation(e){let t=new eh;if(e instanceof SetOperation){let r=new ec;r.parentCreatedAt=toTimeTicket(e.getParentCreatedAt()),r.key=e.getKey(),r.value=toElementSimple(e.getValue()),r.executedAt=toTimeTicket(e.getExecutedAt()),t.body.case="set",t.body.value=r}else if(e instanceof AddOperation){let r=new eu;r.parentCreatedAt=toTimeTicket(e.getParentCreatedAt()),r.prevCreatedAt=toTimeTicket(e.getPrevCreatedAt()),r.value=toElementSimple(e.getValue()),r.executedAt=toTimeTicket(e.getExecutedAt()),t.body.case="add",t.body.value=r}else if(e instanceof MoveOperation){let r=new ed;r.parentCreatedAt=toTimeTicket(e.getParentCreatedAt()),r.prevCreatedAt=toTimeTicket(e.getPrevCreatedAt()),r.createdAt=toTimeTicket(e.getCreatedAt()),r.executedAt=toTimeTicket(e.getExecutedAt()),t.body.case="move",t.body.value=r}else if(e instanceof RemoveOperation){let r=new eg;r.parentCreatedAt=toTimeTicket(e.getParentCreatedAt()),r.createdAt=toTimeTicket(e.getCreatedAt()),r.executedAt=toTimeTicket(e.getExecutedAt()),t.body.case="remove",t.body.value=r}else if(e instanceof EditOperation){let r=new ef;r.parentCreatedAt=toTimeTicket(e.getParentCreatedAt()),r.from=toTextNodePos(e.getFromPos()),r.to=toTextNodePos(e.getToPos());let i=r.createdAtMapByActor;for(let[t,r]of e.getMaxCreatedAtMapByActor())i[t]=toTimeTicket(r);r.content=e.getContent();let n=r.attributes;for(let[t,r]of e.getAttributes())n[t]=r;r.executedAt=toTimeTicket(e.getExecutedAt()),t.body.case="edit",t.body.value=r}else if(e instanceof StyleOperation){let r=new ep;r.parentCreatedAt=toTimeTicket(e.getParentCreatedAt()),r.from=toTextNodePos(e.getFromPos()),r.to=toTextNodePos(e.getToPos());let i=r.createdAtMapByActor;for(let[t,r]of e.getMaxCreatedAtMapByActor())i[t]=toTimeTicket(r);let n=r.attributes;for(let[t,r]of e.getAttributes())n[t]=r;r.executedAt=toTimeTicket(e.getExecutedAt()),t.body.case="style",t.body.value=r}else if(e instanceof IncreaseOperation){let r=new ey;r.parentCreatedAt=toTimeTicket(e.getParentCreatedAt()),r.value=toElementSimple(e.getValue()),r.executedAt=toTimeTicket(e.getExecutedAt()),t.body.case="increase",t.body.value=r}else if(e instanceof TreeEditOperation){let r=new eT,i=r.createdAtMapByActor;for(let[t,r]of e.getMaxCreatedAtMapByActor())i[t]=toTimeTicket(r);r.parentCreatedAt=toTimeTicket(e.getParentCreatedAt()),r.from=toTreePos(e.getFromPos()),r.to=toTreePos(e.getToPos()),r.contents=function(e){let t=[];if(!e||!e.length)return t;for(let r of e)t.push(new eP({content:toTreeNodes(r)}));return t}(e.getContents()),r.splitLevel=e.getSplitLevel(),r.executedAt=toTimeTicket(e.getExecutedAt()),t.body.case="treeEdit",t.body.value=r}else if(e instanceof TreeStyleOperation){let r=new ev;r.parentCreatedAt=toTimeTicket(e.getParentCreatedAt()),r.from=toTreePos(e.getFromPos()),r.to=toTreePos(e.getToPos());let i=r.createdAtMapByActor;for(let[t,r]of e.getMaxCreatedAtMapByActor())i[t]=toTimeTicket(r);let n=e.getAttributesToRemove();if(n.length>0)r.attributesToRemove=n;else{let t=r.attributes;for(let[r,i]of e.getAttributes())t[r]=i}r.executedAt=toTimeTicket(e.getExecutedAt()),t.body.case="treeStyle",t.body.value=r}else throw new YorkieError(tA.ErrUnimplemented,"unimplemented operation");return t}function toTreeNodes(e){if(!e)return[];let t=[];return traverseAll(e,(e,r)=>{let i=new eO({id:toTreeNodeID(e.id),type:e.type,removedAt:toTimeTicket(e.removedAt),depth:r});e.isText&&(i.value=e.value),e.insPrevID&&(i.insPrevId=toTreeNodeID(e.insPrevID)),e.insNextID&&(i.insNextId=toTreeNodeID(e.insNextID)),e.attrs&&(i.attributes=function(e){let t={};for(let r of e)t[r.getKey()]=new ex({value:r.getValue(),updatedAt:toTimeTicket(r.getUpdatedAt()),isRemoved:r.isRemoved()});return t}(e.attrs)),t.push(i)}),t}function toArray(e){let t=new eS;return t.body.case="jsonArray",t.body.value=new ek({nodes:function(e){let t=[];for(let r of e)t.push(new eD({element:toElement(r.getValue())}));return t}(e.getElements()),createdAt:toTimeTicket(e.getCreatedAt()),movedAt:toTimeTicket(e.getMovedAt()),removedAt:toTimeTicket(e.getRemovedAt())}),t}function toTree(e){let t=new eS;return t.body.case="tree",t.body.value=new eE({nodes:toTreeNodes(e.getRoot()),createdAt:toTimeTicket(e.getCreatedAt()),movedAt:toTimeTicket(e.getMovedAt()),removedAt:toTimeTicket(e.getRemovedAt())}),t}function toElement(e){if(e instanceof CRDTObject)return function(e){let t=new eS;return t.body.case="jsonObject",t.body.value=new eA({nodes:function(e){let t=[];for(let r of e)t.push(new eN({key:r.getStrKey(),element:toElement(r.getValue())}));return t}(e.getRHT()),createdAt:toTimeTicket(e.getCreatedAt()),movedAt:toTimeTicket(e.getMovedAt()),removedAt:toTimeTicket(e.getRemovedAt())}),t}(e);if(e instanceof CRDTArray)return toArray(e);if(e instanceof Primitive)return function(e){let t=new eS;return t.body.case="primitive",t.body.value=new eI({type:toValueType(e.getType()),value:e.toBytes(),createdAt:toTimeTicket(e.getCreatedAt()),movedAt:toTimeTicket(e.getMovedAt()),removedAt:toTimeTicket(e.getRemovedAt())}),t}(e);if(e instanceof CRDTText)return function(e){let t=new eS;return t.body.case="text",t.body.value=new eC({nodes:function(e){let t=[];for(let i of e){var r;let e=new eR;e.id=(r=i.getID(),new e_({createdAt:toTimeTicket(r.getCreatedAt()),offset:r.getOffset()})),e.value=i.getValue().getContent(),e.removedAt=toTimeTicket(i.getRemovedAt());let n=e.attributes,s=i.getValue().getAttrs();for(let e of s){let t=new ex;t.value=e.getValue(),t.updatedAt=toTimeTicket(e.getUpdatedAt()),n[e.getKey()]=t}t.push(e)}return t}(e.getRGATreeSplit()),createdAt:toTimeTicket(e.getCreatedAt()),movedAt:toTimeTicket(e.getMovedAt()),removedAt:toTimeTicket(e.getRemovedAt())}),t}(e);if(e instanceof CRDTCounter)return function(e){let t=new eS;return t.body.case="counter",t.body.value=new ew({type:toCounterType(e.getType()),value:e.toBytes(),createdAt:toTimeTicket(e.getCreatedAt()),movedAt:toTimeTicket(e.getMovedAt()),removedAt:toTimeTicket(e.getRemovedAt())}),t}(e);if(e instanceof CRDTTree)return toTree(e);throw new YorkieError(tA.ErrUnimplemented,"unimplemented element")}function errorCodeOf(e){let t=e.findDetails(ty);for(let e of t)if(e.metadata.code)return e.metadata.code;return""}function fromChangeID(e){var t;let r;return e.serverSeq&&(r=Long.fromString(e.serverSeq,!0)),ChangeID.of(e.clientSeq,Long.fromString(e.lamport,!0),bytesToHex(e.actorId),r)}function fromTimeTicket(e){if(e){var t;return TimeTicket.of(Long.fromString(e.lamport,!0),e.delimiter,bytesToHex(e.actorId))}}function fromPresence(e){let t={};return Object.entries(e.data).forEach(([e,r])=>{t[e]=JSON.parse(r)}),t}function fromValueType(e){switch(e){case ei.NULL:return t_.Null;case ei.BOOLEAN:return t_.Boolean;case ei.INTEGER:return t_.Integer;case ei.LONG:return t_.Long;case ei.DOUBLE:return t_.Double;case ei.STRING:return t_.String;case ei.BYTES:return t_.Bytes;case ei.DATE:return t_.Date}throw new YorkieError(tA.ErrUnimplemented,`unimplemented value type: ${e}`)}function fromCounterType(e){switch(e){case ei.INTEGER_CNT:return tM.IntegerCnt;case ei.LONG_CNT:return tM.LongCnt}throw new YorkieError(tA.ErrUnimplemented,`unimplemented value type: ${e}`)}function fromElementSimple(e){switch(e.type){case ei.JSON_OBJECT:if(!e.value)return CRDTObject.create(fromTimeTicket(e.createdAt));return bytesToObject(e.value);case ei.JSON_ARRAY:if(!e.value)return CRDTArray.create(fromTimeTicket(e.createdAt));return function(e){if(!e)throw Error("bytes is empty");let t=eS.fromBinary(e);return fromArray(t.body.value)}(e.value);case ei.TEXT:return CRDTText.create(RGATreeSplit.create(),fromTimeTicket(e.createdAt));case ei.TREE:return function(e){if(!e)throw Error("bytes is empty");let t=eS.fromBinary(e);return fromTree(t.body.value)}(e.value);case ei.NULL:case ei.BOOLEAN:case ei.INTEGER:case ei.LONG:case ei.DOUBLE:case ei.STRING:case ei.BYTES:case ei.DATE:return Primitive.of(Primitive.valueFromBytes(fromValueType(e.type),e.value),fromTimeTicket(e.createdAt));case ei.INTEGER_CNT:case ei.LONG_CNT:return CRDTCounter.create(fromCounterType(e.type),CRDTCounter.valueFromBytes(fromCounterType(e.type),e.value),fromTimeTicket(e.createdAt))}}function fromTextNodePos(e){return RGATreeSplitPos.of(RGATreeSplitNodeID.of(fromTimeTicket(e.createdAt),e.offset),e.relativeOffset)}function fromTextNodeID(e){return RGATreeSplitNodeID.of(fromTimeTicket(e.createdAt),e.offset)}function fromTreePos(e){return CRDTTreePos.of(fromTreeNodeID(e.parentId),fromTreeNodeID(e.leftSiblingId))}function fromTreeNodeID(e){return CRDTTreeNodeID.of(fromTimeTicket(e.createdAt),e.offset)}function fromTreeNodes(e){if(0===e.length)return;let t=[];for(let r of e)t.push(function(e){let t=fromTreeNodeID(e.id),r=CRDTTreeNode.create(t,e.type),i=Object.entries(e.attributes);return r.isText?r.value=e.value:i.length&&(r.attrs=function(e){let t=RHT.create();for(let[r,i]of Object.entries(e))t.setInternal(r,i.value,fromTimeTicket(i.updatedAt),i.isRemoved);return t}(e.attributes)),e.insPrevId&&(r.insPrevID=fromTreeNodeID(e.insPrevId)),e.insNextId&&(r.insNextID=fromTreeNodeID(e.insNextId)),r.removedAt=fromTimeTicket(e.removedAt),r}(r));let r=t[t.length-1];for(let r=t.length-2;r>=0;r--){let i;for(let n=r+1;n<t.length;n++)if(e[r].depth-1===e[n].depth){i=t[n];break}i.prepend(t[r])}return r.updateDescendantsSize(),CRDTTree.create(r,tw).getRoot()}function fromOperation(e){if("set"===e.body.case){let t=e.body.value;return SetOperation.create(t.key,fromElementSimple(t.value),fromTimeTicket(t.parentCreatedAt),fromTimeTicket(t.executedAt))}if("add"===e.body.case){let t=e.body.value;return AddOperation.create(fromTimeTicket(t.parentCreatedAt),fromTimeTicket(t.prevCreatedAt),fromElementSimple(t.value),fromTimeTicket(t.executedAt))}if("move"===e.body.case){let t=e.body.value;return MoveOperation.create(fromTimeTicket(t.parentCreatedAt),fromTimeTicket(t.prevCreatedAt),fromTimeTicket(t.createdAt),fromTimeTicket(t.executedAt))}if("remove"===e.body.case){let t=e.body.value;return RemoveOperation.create(fromTimeTicket(t.parentCreatedAt),fromTimeTicket(t.createdAt),fromTimeTicket(t.executedAt))}if("edit"===e.body.case){let t=e.body.value,r=new Map;Object.entries(t.createdAtMapByActor).forEach(([e,t])=>{r.set(e,fromTimeTicket(t))});let i=new Map;return Object.entries(t.attributes).forEach(([e,t])=>{i.set(e,t)}),EditOperation.create(fromTimeTicket(t.parentCreatedAt),fromTextNodePos(t.from),fromTextNodePos(t.to),r,t.content,i,fromTimeTicket(t.executedAt))}if("style"===e.body.case){let t=e.body.value,r=new Map;Object.entries(t.createdAtMapByActor).forEach(([e,t])=>{r.set(e,fromTimeTicket(t))});let i=new Map;return Object.entries(t.attributes).forEach(([e,t])=>{i.set(e,t)}),StyleOperation.create(fromTimeTicket(t.parentCreatedAt),fromTextNodePos(t.from),fromTextNodePos(t.to),r,i,fromTimeTicket(t.executedAt))}if("select"===e.body.case)return;else if("increase"===e.body.case){let t=e.body.value;return IncreaseOperation.create(fromTimeTicket(t.parentCreatedAt),fromElementSimple(t.value),fromTimeTicket(t.executedAt))}else if("treeEdit"===e.body.case){let t=e.body.value,r=new Map;return Object.entries(t.createdAtMapByActor).forEach(([e,t])=>{r.set(e,fromTimeTicket(t))}),TreeEditOperation.create(fromTimeTicket(t.parentCreatedAt),fromTreePos(t.from),fromTreePos(t.to),function(e){if(!e.length)return;let t=[];return e.forEach(e=>{let r=fromTreeNodes(e.content);t.push(r)}),t}(t.contents),t.splitLevel,r,fromTimeTicket(t.executedAt))}else if("treeStyle"===e.body.case){let t=e.body.value,r=new Map,i=t.attributesToRemove,n=new Map;return((null==t?void 0:t.createdAtMapByActor)&&Object.entries(t.createdAtMapByActor).forEach(([e,t])=>{n.set(e,fromTimeTicket(t))}),(null==i?void 0:i.length)>0)?TreeStyleOperation.createTreeRemoveStyleOperation(fromTimeTicket(t.parentCreatedAt),fromTreePos(t.from),fromTreePos(t.to),n,i,fromTimeTicket(t.executedAt)):(Object.entries(t.attributes).forEach(([e,t])=>{r.set(e,t)}),TreeStyleOperation.create(fromTimeTicket(t.parentCreatedAt),fromTreePos(t.from),fromTreePos(t.to),n,r,fromTimeTicket(t.executedAt)))}else throw new YorkieError(tA.ErrUnimplemented,"unimplemented operation")}function fromChanges(e){let t=[];for(let r of e)t.push(Change.create({id:fromChangeID(r.id),operations:function(e){let t=[];for(let r of e){let e=fromOperation(r);e&&t.push(e)}return t}(r.operations),presenceChange:r.presenceChange?function(e){let t=e.type;if(t===eV.PUT){let t=fromPresence(e.presence);return{type:tk.Put,presence:t}}if(t===eV.CLEAR)return{type:tk.Clear};throw new YorkieError(tA.Unsupported,`unsupported type: ${t}`)}(r.presenceChange):void 0,message:r.message}));return t}function fromObject(e){let t=new ElementRHT;for(let r of e.nodes){let e=fromElement(r.element);t.set(r.key,e,e.getPositionedAt())}let r=new CRDTObject(fromTimeTicket(e.createdAt),t);return r.setMovedAt(fromTimeTicket(e.movedAt)),r.setRemovedAt(fromTimeTicket(e.removedAt)),r}function fromArray(e){let t=new RGATreeList;for(let r of e.nodes)t.insert(fromElement(r.element));let r=new CRDTArray(fromTimeTicket(e.createdAt),t);return r.setMovedAt(fromTimeTicket(e.movedAt)),r.setRemovedAt(fromTimeTicket(e.removedAt)),r}function fromTree(e){let t=fromTreeNodes(e.nodes);return CRDTTree.create(t,fromTimeTicket(e.createdAt))}function fromElement(e){if("jsonObject"===e.body.case)return fromObject(e.body.value);if("jsonArray"===e.body.case)return fromArray(e.body.value);if("primitive"===e.body.case)return function(e){let t=Primitive.of(Primitive.valueFromBytes(fromValueType(e.type),e.value),fromTimeTicket(e.createdAt));return t.setMovedAt(fromTimeTicket(e.movedAt)),t.setRemovedAt(fromTimeTicket(e.removedAt)),t}(e.body.value);if("text"===e.body.case)return function(e){let t=new RGATreeSplit,r=t.getHead();for(let i of e.nodes){let e=t.insertAfter(r,function(e){let t=CRDTTextValue.create(e.value);Object.entries(e.attributes).forEach(([e,r])=>{t.setAttr(e,r.value,fromTimeTicket(r.updatedAt))});let r=RGATreeSplitNode.create(fromTextNodeID(e.id),t);return r.remove(fromTimeTicket(e.removedAt)),r}(i));i.insPrevId&&e.setInsPrev(t.findNode(fromTextNodeID(i.insPrevId))),r=e}let i=new CRDTText(t,fromTimeTicket(e.createdAt));return i.setMovedAt(fromTimeTicket(e.movedAt)),i.setRemovedAt(fromTimeTicket(e.removedAt)),i}(e.body.value);if("counter"===e.body.case)return function(e){let t=CRDTCounter.create(fromCounterType(e.type),CRDTCounter.valueFromBytes(fromCounterType(e.type),e.value),fromTimeTicket(e.createdAt));return t.setMovedAt(fromTimeTicket(e.movedAt)),t.setRemovedAt(fromTimeTicket(e.removedAt)),t}(e.body.value);if("tree"===e.body.case)return fromTree(e.body.value);throw new YorkieError(tA.ErrUnimplemented,"unimplemented element")}function bytesToObject(e){if(!e)throw Error("bytes is empty");let t=eS.fromBinary(e);return fromObject(t.body.value)}function objectToBytes(e){return toElement(e).toBinary()}function bytesToHex(e){return e?Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join(""):""}function hexToBytes(e){return new Uint8Array(e.match(/.{1,2}/g).map(e=>parseInt(e,16)))}let tV={fromPresence,toChangePack:function(e){var t;return new eo({documentKey:e.getDocumentKey(),checkpoint:(t=e.getCheckpoint(),new eU({serverSeq:t.getServerSeqAsString(),clientSeq:t.getClientSeq()})),isRemoved:e.getIsRemoved(),changes:function(e){let t=[];for(let r of e)t.push(function(e){let t=new ea({id:toChangeID(e.getID()),message:e.getMessage()});return e.hasOperations()&&(t.operations=function(e){let t=[];for(let r of e)t.push(toOperation(r));return t}(e.getOperations())),e.hasPresenceChange()&&(t.presenceChange=function(e){if(e.type===tk.Put)return new eM({type:eV.PUT,presence:function(e){let t=new e$,r=t.data;for(let[t,i]of Object.entries(e))r[t]=JSON.stringify(i);return t}(e.presence)});if(e.type===tk.Clear)return new eM({type:eV.CLEAR});throw new YorkieError(tA.ErrUnimplemented,"unimplemented type")}(e.getPresenceChange())),t}(r));return t}(e.getChanges()),snapshot:e.getSnapshot(),minSyncedTicket:toTimeTicket(e.getMinSyncedTicket())})},fromChangePack:function(e){var t;return ChangePack.create(e.documentKey,(t=e.checkpoint,Checkpoint.of(Long.fromString(t.serverSeq,!0),t.clientSeq)),e.isRemoved,fromChanges(e.changes),e.snapshot,fromTimeTicket(e.minSyncedTicket))},fromChanges,objectToBytes,bytesToObject,bytesToSnapshot:function(e){if(!e)return{root:CRDTObject.create(tw),presences:new Map};let t=es.fromBinary(e);return{root:fromElement(t.root),presences:function(e){let t=new Map;return Object.entries(e).forEach(([e,r])=>{t.set(e,fromPresence(r))}),t}(t.presences)}},bytesToHex,hexToBytes,toHexString:function(e){return bytesToHex(e)},toUint8Array:function(e){return hexToBytes(e)},toOperation,toChangeID,PbChangeID:el,bytesToChangeID:function(e){let t=el.fromBinary(e);return fromChangeID(t)},bytesToOperation:function(e){let t=eh.fromBinary(e);return fromOperation(t)}};function uuid(){return"xxxxxxxx-xxxx-4xxxy-xxxx-xxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}let Attachment=class Attachment{constructor(e,t,r,i){__publicField(this,"reconnectStreamDelay"),__publicField(this,"doc"),__publicField(this,"docID"),__publicField(this,"syncMode"),__publicField(this,"remoteChangeEventReceived"),__publicField(this,"watchStream"),__publicField(this,"watchLoopTimerID"),__publicField(this,"watchAbortController"),this.reconnectStreamDelay=e,this.doc=t,this.docID=r,this.syncMode=i,this.remoteChangeEventReceived=!1}changeSyncMode(e){this.syncMode=e}needRealtimeSync(){return this.syncMode!==tY.RealtimeSyncOff&&(this.syncMode===tY.RealtimePushOnly?this.doc.hasLocalChanges():this.syncMode!==tY.Manual&&(this.doc.hasLocalChanges()||this.remoteChangeEventReceived))}async runWatchLoop(e){let doLoop=async()=>{if(this.watchStream)return Promise.resolve();this.watchLoopTimerID&&(clearTimeout(this.watchLoopTimerID),this.watchLoopTimerID=void 0);try{[this.watchStream,this.watchAbortController]=await e(()=>{this.watchStream=void 0,this.watchAbortController=void 0,this.watchLoopTimerID=setTimeout(doLoop,this.reconnectStreamDelay)})}catch(e){}};await doLoop()}cancelWatchStream(){this.watchStream&&this.watchAbortController&&(this.watchAbortController.abort(),this.watchStream=void 0,this.watchAbortController=void 0),clearTimeout(this.watchLoopTimerID),this.watchLoopTimerID=void 0}};let Noop=()=>{};let ObserverProxy=class ObserverProxy{constructor(e){__publicField(this,"finalized",!1),__publicField(this,"observers",[]),__publicField(this,"finalError");try{e(this)}catch(e){this.error(e)}}next(e){this.forEachObserver(t=>{t.next(e)})}error(e){this.forEachObserver(t=>{t.error(e)}),this.close(e)}complete(){this.forEachObserver(e=>{e.complete()}),this.close()}subscribe(e,t,r){let i;e||tx.fatal("missing observer"),this.finalized&&tx.fatal("observable is finalized due to previous error"),void 0===(i="object"==typeof e?e:{next:e,error:t,complete:r}).next&&(i.next=Noop),void 0===i.error&&(i.error=Noop),void 0===i.complete&&(i.complete=Noop);let n=uuid(),s=this.unsubscribeOne.bind(this,n);if(this.observers.push({subscriptionID:n,observer:i}),this.finalized)try{this.finalError?i.error(this.finalError):i.complete()}catch(e){tx.warn(e)}return s}unsubscribeOne(e){var t;this.observers=null==(t=this.observers)?void 0:t.filter(t=>t.subscriptionID!==e)}forEachObserver(e){if(!this.finalized)for(let t=0;t<this.observers.length;t++)this.sendOne(t,e)}sendOne(e,t){if(void 0!==this.observers&&void 0!==this.observers[e])try{t(this.observers[e].observer)}catch(e){tx.error(e)}}close(e){this.finalized||(this.finalized=!0,void 0!==e&&(this.finalError=e),this.observers=void 0)}};let ChangeContext=class ChangeContext{constructor(e,t,r,i){__publicField(this,"id"),__publicField(this,"delimiter"),__publicField(this,"message"),__publicField(this,"root"),__publicField(this,"operations"),__publicField(this,"presenceChange"),__publicField(this,"previousPresence"),__publicField(this,"reversePresenceKeys"),this.id=e,this.delimiter=0,this.root=t,this.operations=[],this.previousPresence=deepcopy(r),this.presenceChange=void 0,this.reversePresenceKeys=new Set,this.message=i}static create(e,t,r,i){return new ChangeContext(e,t,r,i)}push(e){this.operations.push(e)}registerElement(e,t){this.root.registerElement(e,t)}registerRemovedElement(e){this.root.registerRemovedElement(e)}registerGCPair(e){this.root.registerGCPair(e)}getChange(){return Change.create({id:this.id,operations:this.operations,presenceChange:this.presenceChange,message:this.message})}hasChange(){return this.operations.length>0||void 0!==this.presenceChange}setPresenceChange(e){this.presenceChange=e}setReversePresence(e,t){for(let r of Object.keys(e))(null==t?void 0:t.addToHistory)?this.reversePresenceKeys.add(r):this.reversePresenceKeys.delete(r)}getReversePresence(){if(0===this.reversePresenceKeys.size)return;let e={};for(let t of this.reversePresenceKeys)e[t]=this.previousPresence[t];return e}issueTimeTicket(){return this.delimiter+=1,this.id.createTimeTicket(this.delimiter)}getLastTimeTicket(){return this.id.createTimeTicket(this.delimiter)}};let CRDTRoot=class CRDTRoot{constructor(e){__publicField(this,"rootObject"),__publicField(this,"elementPairMapByCreatedAt"),__publicField(this,"gcElementSetByCreatedAt"),__publicField(this,"gcPairMap"),this.rootObject=e,this.elementPairMapByCreatedAt=new Map,this.gcElementSetByCreatedAt=new Set,this.gcPairMap=new Map,this.registerElement(e,void 0),e.getDescendants(e=>{if(e.getRemovedAt()&&this.registerRemovedElement(e),e instanceof CRDTText||e instanceof CRDTTree)for(let t of e.getGCPairs())this.registerGCPair(t);return!1})}static create(){return new CRDTRoot(CRDTObject.create(tw))}findByCreatedAt(e){let t=this.elementPairMapByCreatedAt.get(e.toIDString());if(t)return t.element}findElementPairByCreatedAt(e){return this.elementPairMapByCreatedAt.get(e.toIDString())}createSubPaths(e){let t=this.elementPairMapByCreatedAt.get(e.toIDString());if(!t)return[];let r=[];for(;t.parent;){let e=t.element.getCreatedAt(),i=t.parent.subPathOf(e);void 0===i&&tx.fatal(`cant find the given element: ${e.toIDString()}`),r.unshift(i),t=this.elementPairMapByCreatedAt.get(t.parent.getCreatedAt().toIDString())}return r.unshift("$"),r}createPath(e){return this.createSubPaths(e).join(".")}registerElement(e,t){this.elementPairMapByCreatedAt.set(e.getCreatedAt().toIDString(),{parent:t,element:e}),e instanceof CRDTContainer&&e.getDescendants((e,t)=>(this.registerElement(e,t),!1))}deregisterElement(e){let t=0,deregisterElementInternal=e=>{let r=e.getCreatedAt().toIDString();this.elementPairMapByCreatedAt.delete(r),this.gcElementSetByCreatedAt.delete(r),t++};return deregisterElementInternal(e),e instanceof CRDTContainer&&e.getDescendants(e=>(deregisterElementInternal(e),!1)),t}registerRemovedElement(e){this.gcElementSetByCreatedAt.add(e.getCreatedAt().toIDString())}registerGCPair(e){let t=this.gcPairMap.get(e.child.toIDString());if(t){this.gcPairMap.delete(e.child.toIDString());return}this.gcPairMap.set(e.child.toIDString(),e)}getElementMapSize(){return this.elementPairMapByCreatedAt.size}getGarbageElementSetSize(){let e=new Set;for(let t of this.gcElementSetByCreatedAt){e.add(t);let r=this.elementPairMapByCreatedAt.get(t);r.element instanceof CRDTContainer&&r.element.getDescendants(t=>(e.add(t.getCreatedAt().toIDString()),!1))}return e.size}getObject(){return this.rootObject}getGarbageLen(){return this.getGarbageElementSetSize()+this.gcPairMap.size}deepcopy(){return new CRDTRoot(this.rootObject.deepcopy())}garbageCollect(e){let t=0;for(let r of this.gcElementSetByCreatedAt){let i=this.elementPairMapByCreatedAt.get(r);i.element.getRemovedAt()&&e.compare(i.element.getRemovedAt())>=0&&(i.parent.purge(i.element),t+=this.deregisterElement(i.element))}for(let[,r]of this.gcPairMap){let i=r.child.getRemovedAt();void 0!==i&&e.compare(i)>=0&&(r.parent.purge(r.child),this.gcPairMap.delete(r.child.toIDString()),t+=1)}return t}toJSON(){return this.rootObject.toJSON()}toSortedJSON(){return this.rootObject.toSortedJSON()}};function createJSONObject(e,t){let r=new ObjectProxy(e);return new Proxy(t,r.getHandlers())}let ObjectProxy=class ObjectProxy{constructor(e){__publicField(this,"context"),__publicField(this,"handlers"),this.context=e,this.handlers={set:(t,r,i)=>(tx.isEnabled(tN.Trivial)&&tx.trivial(`obj[${r}]=${JSON.stringify(i)}`),ObjectProxy.setInternal(e,t,r,i),!0),get:(t,r)=>(tx.isEnabled(tN.Trivial)&&tx.trivial(`obj[${r}]`),"getID"===r)?()=>t.getCreatedAt():"toJSON"===r||"toString"===r?()=>t.toJSON():"toJS"===r?()=>t.toJS():"toJSForTest"===r?()=>t.toJSForTest():toJSONElement(e,t.get(r)),ownKeys:e=>e.getKeys(),getOwnPropertyDescriptor:()=>({enumerable:!0,configurable:!0}),deleteProperty:(t,r)=>(tx.isEnabled(tN.Trivial)&&tx.trivial(`obj[${r}]`),ObjectProxy.deleteInternal(e,t,r),!0)}}static setInternal(e,t,r,i){if(r.includes("."))throw new YorkieError(tA.ErrInvalidObjectKey,"key must not contain the '.'.");let n=e.issueTimeTicket(),s=buildCRDTElement(e,i,n),o=t.set(r,s,n);e.registerElement(s,t),o&&e.registerRemovedElement(o),e.push(SetOperation.create(r,s.deepcopy(),t.getCreatedAt(),n))}static buildObjectMembers(e,t){let r={};for(let[i,n]of Object.entries(t)){if(i.includes("."))throw new YorkieError(tA.ErrInvalidObjectKey,"key must not contain the '.'.");let t=e.issueTimeTicket(),s=buildCRDTElement(e,n,t);r[i]=s}return r}static deleteInternal(e,t,r){let i=e.issueTimeTicket(),n=t.deleteByKey(r,i);n&&(e.push(RemoveOperation.create(t.getCreatedAt(),n.getCreatedAt(),i)),e.registerRemovedElement(n))}getHandlers(){return this.handlers}};let ArrayProxy=class ArrayProxy{constructor(e,t){__publicField(this,"context"),__publicField(this,"handlers"),__publicField(this,"array"),this.context=e,this.array=t,this.handlers={get:(t,r,i)=>"getID"===r?()=>t.getCreatedAt():"getElementByID"===r?r=>{let i=t.getByID(r);if(!(!i||i.isRemoved()))return toWrappedElement(e,i)}:"getElementByIndex"===r?r=>{let i=t.get(r);return toWrappedElement(e,i)}:"getLast"===r?()=>toWrappedElement(e,t.getLast()):"deleteByID"===r?r=>{let i=ArrayProxy.deleteInternalByID(e,t,r);return toWrappedElement(e,i)}:"insertAfter"===r?(r,i)=>{let n=ArrayProxy.insertAfterInternal(e,t,r,i);return toWrappedElement(e,n)}:"insertBefore"===r?(r,i)=>{let n=ArrayProxy.insertBeforeInternal(e,t,r,i);return toWrappedElement(e,n)}:"moveBefore"===r?(r,i)=>{ArrayProxy.moveBeforeInternal(e,t,r,i)}:"moveAfter"===r?(r,i)=>{ArrayProxy.moveAfterInternal(e,t,r,i)}:"moveFront"===r?r=>{ArrayProxy.moveFrontInternal(e,t,r)}:"moveLast"===r?r=>{ArrayProxy.moveLastInternal(e,t,r)}:("string"==typeof r||r instanceof String)&&!isNaN(r)?toJSONElement(e,t.get(Number(r))):"push"===r?r=>ArrayProxy.pushInternal(e,t,r):"splice"===r?(r,i,...n)=>ArrayProxy.splice(e,t,r,i,...n):"length"===r?t.length:"symbol"==typeof r&&r===Symbol.iterator?ArrayProxy.iteratorInternal.bind(this,e,t):"includes"===r?(r,i)=>ArrayProxy.includes(e,t,r,i):"indexOf"===r?(r,i)=>ArrayProxy.indexOf(e,t,r,i):"lastIndexOf"===r?(r,i)=>ArrayProxy.lastIndexOf(e,t,r,i):"toJSForTest"===r?()=>t.toJSForTest():"toTestString"===r?()=>ArrayProxy.toTestString(t):"string"==typeof r&&["concat","entries","every","filter","find","findIndex","forEach","join","keys","map","reduce","reduceRight","slice","some","toLocaleString","toString","values"].includes(r)?(...i)=>{let n=Array.from(t).map(t=>toJSONElement(e,t));return Array.prototype[r].apply(n,i)}:Reflect.get(t,r,i),deleteProperty:(t,r)=>(tx.isEnabled(tN.Trivial)&&tx.trivial(`array[${r}]`),ArrayProxy.deleteInternalByIndex(e,t,Number.parseInt(r)),!0)}}static*iteratorInternal(e,t){for(let r of t)yield toWrappedElement(e,r)}static buildArrayElements(e,t){let r=[];for(let i of t){let t=e.issueTimeTicket(),n=buildCRDTElement(e,i,t);r.push(n)}return r}static pushInternal(e,t,r){return ArrayProxy.insertAfterInternal(e,t,t.getLastCreatedAt(),r),t.length}static moveBeforeInternal(e,t,r,i){let n=e.issueTimeTicket(),s=t.getPrevCreatedAt(r);t.moveAfter(s,i,n),e.push(MoveOperation.create(t.getCreatedAt(),s,i,n))}static moveAfterInternal(e,t,r,i){let n=e.issueTimeTicket();t.moveAfter(r,i,n),e.push(MoveOperation.create(t.getCreatedAt(),r,i,n))}static moveFrontInternal(e,t,r){let i=e.issueTimeTicket(),n=t.getHead();t.moveAfter(n.getCreatedAt(),r,i),e.push(MoveOperation.create(t.getCreatedAt(),n.getCreatedAt(),r,i))}static moveLastInternal(e,t,r){let i=e.issueTimeTicket(),n=t.getLastCreatedAt();t.moveAfter(n,r,i),e.push(MoveOperation.create(t.getCreatedAt(),n,r,i))}static insertAfterInternal(e,t,r,i){let n=e.issueTimeTicket(),s=buildCRDTElement(e,i,n);return t.insertAfter(r,s),e.registerElement(s,t),e.push(AddOperation.create(t.getCreatedAt(),r,s.deepcopy(),n)),s}static insertBeforeInternal(e,t,r,i){return ArrayProxy.insertAfterInternal(e,t,t.getPrevCreatedAt(r),i)}static deleteInternalByIndex(e,t,r){let i=e.issueTimeTicket(),n=t.deleteByIndex(r,i);if(n)return e.push(RemoveOperation.create(t.getCreatedAt(),n.getCreatedAt(),i)),e.registerRemovedElement(n),n}static deleteInternalByID(e,t,r){let i=e.issueTimeTicket(),n=t.delete(r,i);return e.push(RemoveOperation.create(t.getCreatedAt(),n.getCreatedAt(),i)),e.registerRemovedElement(n),n}static splice(e,t,r,i,...n){let s=t.length,o=r>=0?Math.min(r,s):Math.max(s+r,0),a=void 0===i?s:i<0?o:Math.min(o+i,s),l=[];for(let r=o;r<a;r++){let r=ArrayProxy.deleteInternalByIndex(e,t,o);if(r){let t=r.deepcopy();t.setRemovedAt(),l.push(toJSONElement(e,t))}}if(n){let r=0===o?t.getHead().getID():t.get(o-1).getID();for(let i of n){let n=ArrayProxy.insertAfterInternal(e,t,r,i);r=n.getID()}}return l}static includes(e,t,r,i){var n;let s=t.length,o=void 0===i?0:i<0?Math.max(i+s,0):i;if(o>=s)return!1;if(Primitive.isSupport(r)){let i=Array.from(t).map(t=>toJSONElement(e,t));return i.includes(r,o)}for(let e=o;e<s;e++)if((null==(n=t.get(e))?void 0:n.getID())===r.getID())return!0;return!1}static indexOf(e,t,r,i){var n;let s=t.length,o=void 0===i?0:i<0?Math.max(i+s,0):i;if(o>=s)return -1;if(Primitive.isSupport(r)){let i=Array.from(t).map(t=>toJSONElement(e,t));return i.indexOf(r,o)}for(let e=o;e<s;e++)if((null==(n=t.get(e))?void 0:n.getID())===r.getID())return e;return -1}static lastIndexOf(e,t,r,i){var n;let s=t.length,o=void 0===i||i>=s?s-1:i<0?i+s:i;if(o<0)return -1;if(Primitive.isSupport(r)){let i=Array.from(t).map(t=>toJSONElement(e,t));return i.lastIndexOf(r,o)}for(let e=o;e>0;e--)if((null==(n=t.get(e))?void 0:n.getID())===r.getID())return e;return -1}static toTestString(e){return e.toTestString()}getHandlers(){return this.handlers}};let Text=class Text{constructor(e,t){__publicField(this,"context"),__publicField(this,"text"),this.context=e,this.text=t}initialize(e,t){this.context=e,this.text=t}getID(){return this.text.getID()}edit(e,t,r,i){if(!this.context||!this.text){tx.fatal("it is not initialized yet");return}if(e>t){tx.fatal("from should be less than or equal to to");return}let n=this.text.indexRangeToPosRange(e,t);tx.isEnabled(tN.Debug)&&tx.debug(`EDIT: f:${e}->${n[0].toTestString()}, t:${t}->${n[1].toTestString()} c:${r}`);let s=i?stringifyObjectValues(i):void 0,o=this.context.issueTimeTicket(),[a,,l,h]=this.text.edit(n,r,o,s);for(let e of l)this.context.registerGCPair(e);return this.context.push(new EditOperation(this.text.getCreatedAt(),n[0],n[1],a,r,s?new Map(Object.entries(s)):new Map,o)),this.text.findIndexesFromRange(h)}delete(e,t){return this.edit(e,t,"")}empty(){return this.edit(0,this.length,"")}setStyle(e,t,r){if(!this.context||!this.text)return tx.fatal("it is not initialized yet"),!1;if(e>t)return tx.fatal("from should be less than or equal to to"),!1;let i=this.text.indexRangeToPosRange(e,t);tx.isEnabled(tN.Debug)&&tx.debug(`STYL: f:${e}->${i[0].toTestString()}, t:${t}->${i[1].toTestString()} a:${JSON.stringify(r)}`);let n=stringifyObjectValues(r),s=this.context.issueTimeTicket(),[o,a]=this.text.setStyle(i,n,s);for(let e of a)this.context.registerGCPair(e);return this.context.push(new StyleOperation(this.text.getCreatedAt(),i[0],i[1],o,new Map(Object.entries(n)),s)),!0}indexRangeToPosRange(e){if(!this.context||!this.text){tx.fatal("it is not initialized yet");return}let t=this.text.indexRangeToPosRange(e[0],e[1]);return[t[0].toStruct(),t[1].toStruct()]}posRangeToIndexRange(e){if(!this.context||!this.text){tx.fatal("it is not initialized yet");return}let t=this.text.findIndexesFromRange([RGATreeSplitPos.fromStruct(e[0]),RGATreeSplitPos.fromStruct(e[1])]);return[t[0],t[1]]}toTestString(){if(!this.context||!this.text){tx.fatal("it is not initialized yet");return}return this.text.toTestString()}values(){if(!this.context||!this.text){tx.fatal("it is not initialized yet");return}return this.text.values()}get length(){return this.text.length}getTreeByIndex(){return this.text.getTreeByIndex()}getTreeByID(){return this.text.getTreeByID()}toString(){return this.context&&this.text?this.text.toString():(tx.fatal("it is not initialized yet"),"")}toJSON(){if(!this.context||!this.text)throw Error("it is not initialized yet");return this.text.toJSON()}toJSForTest(){if(!this.context||!this.text)throw Error("it is not initialized yet");return this.text.toJSForTest()}createRangeForTest(e,t){if(!this.context||!this.text){tx.fatal("it is not initialized yet");return}return this.text.indexRangeToPosRange(e,t)}};let Counter=class Counter{constructor(e,t){__publicField(this,"valueType"),__publicField(this,"value"),__publicField(this,"context"),__publicField(this,"counter"),this.valueType=e,this.value=t}initialize(e,t){this.valueType=t.getValueType(),this.context=e,this.counter=t,this.value=t.getValue()}getID(){return this.counter.getID()}getValue(){return this.value}getValueType(){return this.valueType}increase(e){if(!this.context||!this.counter){tx.fatal("it is not initialized yet");return}let t=this.context.issueTimeTicket(),r=Primitive.of(e,t);if(!r.isNumericType())throw TypeError(`Unsupported type of value: ${typeof r.getValue()}`);return this.counter.increase(r),this.context.push(IncreaseOperation.create(this.counter.getCreatedAt(),r,t)),this}toJSForTest(){if(!this.context||!this.counter)throw Error("it is not initialized yet");return this.counter.toJSForTest()}};function buildDescendants(e,t,r){let{type:i}=e,n=r.issueTimeTicket();if(i===tO){validateTextNode(e);let{value:r}=e,s=CRDTTreeNode.create(CRDTTreeNodeID.of(n,0),i,r);t.append(s)}else{let s;let{children:o=[]}=e,{attributes:a}=e;if("object"==typeof a&&!isEmpty(a))for(let[e,t]of(a=stringifyObjectValues(a),s=new RHT,Object.entries(a)))s.set(e,t,n);let l=CRDTTreeNode.create(CRDTTreeNodeID.of(n,0),i,void 0,s);for(let e of(t.append(l),o))buildDescendants(e,l,r)}}function validateTextNode(e){if(!e.value.length)throw Error("text node cannot have empty value");return!0}function validateTreeNodes(e){if(!e.length)return!0;let t=e[0].type;if(t===tO)for(let t of e){let{type:e}=t;if(e!==tO)throw Error("element node and text node cannot be passed together");validateTextNode(t)}else for(let t of e){let{type:e}=t;if(e===tO)throw Error("element node and text node cannot be passed together")}return!0}let Tree=class Tree{constructor(e){__publicField(this,"initialRoot"),__publicField(this,"context"),__publicField(this,"tree"),this.initialRoot=e}initialize(e,t){this.context=e,this.tree=t}getID(){return this.tree.getID()}buildRoot(e){if(!this.initialRoot)return CRDTTreeNode.create(CRDTTreeNodeID.of(e.issueTimeTicket(),0),"root");let t=CRDTTreeNode.create(CRDTTreeNodeID.of(e.issueTimeTicket(),0),this.initialRoot.type);for(let r of this.initialRoot.children)buildDescendants(r,t,e);return t}getSize(){if(!this.context||!this.tree)throw Error("it is not initialized yet");return this.tree.getSize()}getNodeSize(){if(!this.context||!this.tree)throw Error("it is not initialized yet");return this.tree.getNodeSize()}getIndexTree(){if(!this.context||!this.tree)throw Error("it is not initialized yet");return this.tree.getIndexTree()}styleByPath(e,t){if(!this.context||!this.tree)throw Error("it is not initialized yet");if(!e.length)throw Error("path should not be empty");let[r,i]=this.tree.pathToPosRange(e),n=this.context.issueTimeTicket(),s=t?stringifyObjectValues(t):void 0,[o]=this.tree.style([r,i],s,n);this.context.push(TreeStyleOperation.create(this.tree.getCreatedAt(),r,i,o,s?new Map(Object.entries(s)):new Map,n))}style(e,t,r){if(!this.context||!this.tree)throw Error("it is not initialized yet");if(e>t)throw Error("from should be less than or equal to to");let i=this.tree.findPos(e),n=this.tree.findPos(t),s=this.context.issueTimeTicket(),o=r?stringifyObjectValues(r):void 0,[a,l]=this.tree.style([i,n],o,s);for(let e of l)this.context.registerGCPair(e);this.context.push(TreeStyleOperation.create(this.tree.getCreatedAt(),i,n,a,o?new Map(Object.entries(o)):new Map,s))}removeStyle(e,t,r){if(!this.context||!this.tree)throw Error("it is not initialized yet");if(e>t)throw Error("from should be less than or equal to to");let i=this.tree.findPos(e),n=this.tree.findPos(t),s=this.context.issueTimeTicket(),[o,a]=this.tree.removeStyle([i,n],r,s);for(let e of a)this.context.registerGCPair(e);this.context.push(TreeStyleOperation.createTreeRemoveStyleOperation(this.tree.getCreatedAt(),i,n,o,r,s))}editInternal(e,t,r,i=0){var n;if(0!==r.length&&r[0]&&(validateTreeNodes(r),r[0].type!==tO))for(let e of r){let{children:t=[]}=e;validateTreeNodes(t)}let s=this.context.getLastTimeTicket(),o=[];if((null==(n=r[0])?void 0:n.type)===tO){let e="";for(let t of r){let{value:r}=t;e+=r}o.push(CRDTTreeNode.create(CRDTTreeNodeID.of(this.context.issueTimeTicket(),0),tO,e))}else o=r.map(e=>e&&function(e,t){let r;let{type:i}=t,n=e.issueTimeTicket();if(t.type===tO){let{value:e}=t;r=CRDTTreeNode.create(CRDTTreeNodeID.of(n,0),i,e)}else if(t){let s;let{children:o=[]}=t,{attributes:a}=t;if("object"==typeof a&&!isEmpty(a))for(let[e,t]of(a=stringifyObjectValues(a),s=new RHT,Object.entries(a)))s.set(e,t,n);for(let t of(r=CRDTTreeNode.create(CRDTTreeNodeID.of(e.issueTimeTicket(),0),i,void 0,s),o))buildDescendants(t,r,e)}return r}(this.context,e)).filter(e=>e);let[,a,l]=this.tree.edit([e,t],o.length?o.map(e=>null==e?void 0:e.deepcopy()):void 0,i,s,()=>this.context.issueTimeTicket());for(let e of a)this.context.registerGCPair(e);return this.context.push(TreeEditOperation.create(this.tree.getCreatedAt(),e,t,o.length?o:void 0,i,l,s)),!0}editByPath(e,t,r,i=0){if(!this.context||!this.tree)throw Error("it is not initialized yet");if(e.length!==t.length)throw Error("path length should be equal");if(!e.length||!t.length)throw Error("path should not be empty");let n=this.tree.pathToPos(e),s=this.tree.pathToPos(t);return this.editInternal(n,s,r?[r]:[],i)}editBulkByPath(e,t,r,i=0){if(!this.context||!this.tree)throw Error("it is not initialized yet");if(e.length!==t.length)throw Error("path length should be equal");if(!e.length||!t.length)throw Error("path should not be empty");let n=this.tree.pathToPos(e),s=this.tree.pathToPos(t);return this.editInternal(n,s,r,i)}edit(e,t,r,i=0){if(!this.context||!this.tree)throw Error("it is not initialized yet");if(e>t)throw Error("from should be less than or equal to to");let n=this.tree.findPos(e),s=this.tree.findPos(t);return this.editInternal(n,s,r?[r]:[],i)}editBulk(e,t,r,i=0){if(!this.context||!this.tree)throw Error("it is not initialized yet");if(e>t)throw Error("from should be less than or equal to to");let n=this.tree.findPos(e),s=this.tree.findPos(t);return this.editInternal(n,s,r,i)}toXML(){if(!this.context||!this.tree)throw Error("it is not initialized yet");return this.tree.toXML()}toJSON(){if(!this.context||!this.tree)throw Error("it is not initialized yet");return this.tree.toJSON()}toJSForTest(){if(!this.context||!this.tree)throw Error("it is not initialized yet");return this.tree.toJSForTest()}toJSInfoForTest(){if(!this.context||!this.tree)throw Error("it is not initialized yet");return this.tree.toJSInfoForTest()}getRootTreeNode(){if(!this.context||!this.tree)throw Error("it is not initialized yet");return this.tree.getRootTreeNode()}indexToPath(e){if(!this.context||!this.tree)throw Error("it is not initialized yet");return this.tree.indexToPath(e)}pathToIndex(e){if(!this.context||!this.tree)throw Error("it is not initialized yet");return this.tree.pathToIndex(e)}pathRangeToPosRange(e){if(!this.context||!this.tree){tx.fatal("it is not initialized yet");return}let t=[this.tree.pathToIndex(e[0]),this.tree.pathToIndex(e[1])],r=this.tree.indexRangeToPosRange(t);return[r[0].toStruct(),r[1].toStruct()]}indexRangeToPosRange(e){if(!this.context||!this.tree){tx.fatal("it is not initialized yet");return}return this.tree.indexRangeToPosStructRange(e)}posRangeToIndexRange(e){if(!this.context||!this.tree){tx.fatal("it is not initialized yet");return}let t=[CRDTTreePos.fromStruct(e[0]),CRDTTreePos.fromStruct(e[1])];return this.tree.posRangeToIndexRange(t)}posRangeToPathRange(e){if(!this.context||!this.tree){tx.fatal("it is not initialized yet");return}let t=[CRDTTreePos.fromStruct(e[0]),CRDTTreePos.fromStruct(e[1])];return this.tree.posRangeToPathRange(t)}};function toWrappedElement(e,t){if(t){if(t instanceof Primitive)return t;if(t instanceof CRDTObject)return createJSONObject(e,t);if(t instanceof CRDTArray)return function(e,t){let r=new ArrayProxy(e,t);return new Proxy(t,r.getHandlers())}(e,t);if(t instanceof CRDTText)return new Text(e,t);else if(t instanceof CRDTCounter){let r=new Counter(tM.IntegerCnt,0);return r.initialize(e,t),r}else if(t instanceof CRDTTree){let r=new Tree;return r.initialize(e,t),r}throw TypeError(`Unsupported type of element: ${typeof t}`)}}function toJSONElement(e,t){let r=toWrappedElement(e,t);return r instanceof Primitive?r.getValue():r}function buildCRDTElement(e,t,r){let i;if(Primitive.isSupport(t))i=Primitive.of(t,r);else if(Array.isArray(t))i=CRDTArray.create(r,ArrayProxy.buildArrayElements(e,t));else if("object"==typeof t)t instanceof Text?(i=CRDTText.create(RGATreeSplit.create(),r),t.initialize(e,i)):t instanceof Counter?(i=CRDTCounter.create(t.getValueType(),t.getValue(),r),t.initialize(e,i)):t instanceof Tree?(i=CRDTTree.create(t.buildRoot(e),r),t.initialize(e,i)):i=CRDTObject.create(r,ObjectProxy.buildObjectMembers(e,t));else throw TypeError(`Unsupported type of value: ${typeof t}`);return i}let History=class History{constructor(){__publicField(this,"undoStack",[]),__publicField(this,"redoStack",[])}hasUndo(){return this.undoStack.length>0}hasRedo(){return this.redoStack.length>0}pushUndo(e){this.undoStack.length>=50&&this.undoStack.shift(),this.undoStack.push(e)}popUndo(){return this.undoStack.pop()}pushRedo(e){this.redoStack.length>=50&&this.redoStack.shift(),this.redoStack.push(e)}popRedo(){return this.redoStack.pop()}clearRedo(){this.redoStack=[]}getUndoStackForTest(){return this.undoStack}getRedoStackForTest(){return this.redoStack}};let t$="yorkie-devtools-panel",tU="yorkie-devtools-sdk",tJ="disconnected",tj=new Map,tq=new Map;function sendToPanel(e,t){((null==t?void 0:t.force)||"disconnected"!==tJ)&&window.postMessage({source:tU,...e},"*")}"undefined"!=typeof window&&(window.transactionEventsByDocKey=tq);var tz=((m=tz||{}).Detached="detached",m.Attached="attached",m.Removed="removed",m),tK=((p=tK||{}).StatusChanged="status-changed",p.ConnectionChanged="connection-changed",p.SyncStatusChanged="sync-status-changed",p.Snapshot="snapshot",p.LocalChange="local-change",p.RemoteChange="remote-change",p.Initialized="initialized",p.Watched="watched",p.Unwatched="unwatched",p.PresenceChanged="presence-changed",p),tG=((y=tG||{}).Connected="connected",y.Disconnected="disconnected",y),tW=((T=tW||{}).Synced="synced",T.SyncFailed="sync-failed",T);let Document=class Document{constructor(e,t){__publicField(this,"key"),__publicField(this,"status"),__publicField(this,"opts"),__publicField(this,"changeID"),__publicField(this,"checkpoint"),__publicField(this,"localChanges"),__publicField(this,"root"),__publicField(this,"clone"),__publicField(this,"eventStream"),__publicField(this,"eventStreamObserver"),__publicField(this,"onlineClients"),__publicField(this,"presences"),__publicField(this,"history"),__publicField(this,"internalHistory"),__publicField(this,"isUpdating"),this.opts=t||{},this.key=e,this.status="detached",this.root=CRDTRoot.create(),this.changeID=tF,this.checkpoint=tB,this.localChanges=[],this.eventStream=function(e){let t=new ObserverProxy(e);return{subscribe:t.subscribe.bind(t),getProxy:()=>t}}(e=>{this.eventStreamObserver=e}),this.onlineClients=new Set,this.presences=new Map,this.isUpdating=!1,this.internalHistory=new History,this.history={canUndo:this.canUndo.bind(this),canRedo:this.canRedo.bind(this),undo:this.undo.bind(this),redo:this.redo.bind(this)},function(e){if(!e.isEnableDevtools()||"undefined"==typeof window||tj.has(e.getKey()))return;tq.set(e.getKey(),[]);let t=e.subscribe("all",t=>{t.some(e=>e.type!==tK.StatusChanged&&e.type!==tK.Snapshot&&e.type!==tK.LocalChange&&e.type!==tK.RemoteChange&&e.type!==tK.Initialized&&e.type!==tK.Watched&&e.type!==tK.Unwatched&&e.type!==tK.PresenceChanged)||(tq.get(e.getKey()).push(t),"synced"===tJ&&sendToPanel({msg:"doc::sync::partial",docKey:e.getKey(),event:t}))});tj.set(e.getKey(),[t]),sendToPanel({msg:"refresh-devtools"},{force:!0}),window.addEventListener("message",t=>{var r;if((null==(r=t.data)?void 0:r.source)!==t$)return;let i=t.data;switch(i.msg){case"devtools::connect":if("disconnected"!==tJ)break;tJ="connected",sendToPanel({msg:"doc::available",docKey:e.getKey()}),tx.info(`[YD] Devtools connected. Doc: ${e.getKey()}`);break;case"devtools::disconnect":tJ="disconnected",tx.info(`[YD] Devtools disconnected. Doc: ${e.getKey()}`);break;case"devtools::subscribe":tJ="synced",sendToPanel({msg:"doc::sync::full",docKey:e.getKey(),events:tq.get(e.getKey())}),tx.info(`[YD] Devtools subscribed. Doc: ${e.getKey()}`)}})}(this)}update(e,t){if("removed"===this.getStatus())throw new YorkieError(tA.ErrDocumentRemoved,`${this.key} is removed`);this.ensureClone();let r=this.changeID.getActorID(),i=ChangeContext.create(this.changeID.next(),this.clone.root,this.clone.presences.get(r)||{},t);try{var n;let t=(n=this.clone.root.getObject(),createJSONObject(i,n));this.presences.has(r)||this.clone.presences.set(r,{}),this.isUpdating=!0,e(t,new Presence(i,this.clone.presences.get(r)))}catch(e){throw this.clone=void 0,tx.error(e),e}finally{this.isUpdating=!1}if(i.hasChange()){tx.isEnabled(tN.Trivial)&&tx.trivial(`trying to update a local change: ${this.toJSON()}`);let e=i.getChange(),{opInfos:t,reverseOps:n}=e.execute(this.root,this.presences,tR.Local),s=i.getReversePresence();s&&n.push({type:"presence",value:s}),this.localChanges.push(e),n.length>0&&this.internalHistory.pushUndo(n),t.length>0&&this.internalHistory.clearRedo(),this.changeID=e.getID();let o=[];t.length>0&&o.push({type:"local-change",source:tR.Local,value:{message:e.getMessage()||"",operations:t,actor:r,clientSeq:e.getID().getClientSeq(),serverSeq:e.getID().getServerSeq()},rawChange:this.isEnableDevtools()?e.toStruct():void 0}),e.hasPresenceChange()&&o.push({type:"presence-changed",source:tR.Local,value:{clientID:r,presence:this.getPresence(r)}}),this.publish(o),tx.isEnabled(tN.Trivial)&&tx.trivial(`after update a local change: ${this.toJSON()}`)}}subscribe(e,t,r,i){if("string"==typeof e){if("function"!=typeof t)throw Error("Second argument must be a callback function");return"presence"===e?this.eventStream.subscribe(e=>{for(let r of e)("initialized"===r.type||"watched"===r.type||"unwatched"===r.type||"presence-changed"===r.type)&&t(r)},r,i):"my-presence"===e?this.eventStream.subscribe(e=>{for(let r of e)("initialized"===r.type||"presence-changed"===r.type)&&("presence-changed"!==r.type||r.value.clientID===this.changeID.getActorID())&&t(r)},r,i):"others"===e?this.eventStream.subscribe(e=>{for(let r of e)("watched"===r.type||"unwatched"===r.type||"presence-changed"===r.type)&&r.value.clientID!==this.changeID.getActorID()&&t(r)},r,i):"connection"===e?this.eventStream.subscribe(e=>{for(let r of e)"connection-changed"===r.type&&t(r)},r,i):"status"===e?this.eventStream.subscribe(e=>{for(let r of e)"status-changed"===r.type&&t(r)},r,i):"sync"===e?this.eventStream.subscribe(e=>{for(let r of e)"sync-status-changed"===r.type&&t(r)},r,i):"all"===e?this.eventStream.subscribe(t,r,i):this.eventStream.subscribe(r=>{for(let i of r){if("local-change"!==i.type&&"remote-change"!==i.type)continue;let r=[];for(let t of i.value.operations)this.isSameElementOrChildOf(t.path,e)&&r.push(t);r.length&&t({...i,value:{...i.value,operations:r}})}},r,i)}if("function"==typeof e)return this.eventStream.subscribe(t=>{for(let r of t)("snapshot"===r.type||"local-change"===r.type||"remote-change"===r.type)&&e(r)},t,r);throw Error(`"${e}" is not a valid`)}publish(e){this.eventStreamObserver&&this.eventStreamObserver.next(e)}isSameElementOrChildOf(e,t){if(t===e)return!0;let r=e.split("."),i=t.split(".");return i.every((e,t)=>e===r[t])}applyChangePack(e){for(e.hasSnapshot()?this.applySnapshot(e.getCheckpoint().getServerSeq(),e.getSnapshot()):e.hasChanges()&&this.applyChanges(e.getChanges(),tR.Remote);this.localChanges.length;){let t=this.localChanges[0];if(t.getID().getClientSeq()>e.getCheckpoint().getClientSeq())break;this.localChanges.shift()}e.hasSnapshot()&&this.applyChanges(this.localChanges,tR.Remote),this.checkpoint=this.checkpoint.forward(e.getCheckpoint()),this.garbageCollect(e.getMinSyncedTicket()),e.getIsRemoved()&&this.applyStatus("removed"),tx.isEnabled(tN.Trivial)&&tx.trivial(`${this.root.toJSON()}`)}getCheckpoint(){return this.checkpoint}getChangeID(){return this.changeID}hasLocalChanges(){return this.localChanges.length>0}ensureClone(){this.clone||(this.clone={root:this.root.deepcopy(),presences:deepcopy(this.presences)})}createChangePack(){let e=Array.from(this.localChanges),t=this.checkpoint.increaseClientSeq(e.length);return ChangePack.create(this.key,t,!1,e)}setActor(e){for(let t of this.localChanges)t.setActor(e);this.changeID=this.changeID.setActor(e)}isEnableDevtools(){return!!this.opts.enableDevtools}getKey(){return this.key}getStatus(){return this.status}getCloneRoot(){if(this.clone)return this.clone.root.getObject()}getRoot(){this.ensureClone();let e=ChangeContext.create(this.changeID.next(),this.clone.root,this.clone.presences.get(this.changeID.getActorID())||{});return createJSONObject(e,this.clone.root.getObject())}garbageCollect(e){return this.opts.disableGC?0:(this.clone&&this.clone.root.garbageCollect(e),this.root.garbageCollect(e))}getRootObject(){return this.root.getObject()}getGarbageLen(){return this.root.getGarbageLen()}getGarbageLenFromClone(){return this.clone.root.getGarbageLen()}toJSON(){return this.root.toJSON()}toSortedJSON(){return this.root.toSortedJSON()}toJSForTest(){return{...this.getRoot().toJSForTest(),key:"root"}}applySnapshot(e,t){let{root:r,presences:i}=tV.bytesToSnapshot(t);this.root=new CRDTRoot(r),this.presences=i,this.changeID=this.changeID.syncLamport(e),this.clone=void 0,this.publish([{type:"snapshot",source:tR.Remote,value:{snapshot:this.isEnableDevtools()?tV.bytesToHex(t):void 0,serverSeq:e.toString()}}])}applyChanges(e,t){for(let r of(tx.isEnabled(tN.Debug)&&tx.debug(`trying to apply ${e.length} remote changes.elements:${this.root.getElementMapSize()}, removeds:${this.root.getGarbageElementSetSize()}`),tx.isEnabled(tN.Trivial)&&tx.trivial(e.map(e=>`${e.getID().toTestString()}	${e.toTestString()}`).join("\n")),e))this.applyChange(r,t);tx.isEnabled(tN.Debug)&&tx.debug(`after appling ${e.length} remote changes.elements:${this.root.getElementMapSize()},  removeds:${this.root.getGarbageElementSetSize()}`)}applyChange(e,t){this.ensureClone(),e.execute(this.clone.root,this.clone.presences,t);let r=[],i=e.getID().getActorID();if(e.hasPresenceChange()&&this.onlineClients.has(i)){let n=e.getPresenceChange();switch(n.type){case tk.Put:r.push(this.presences.has(i)?{type:"presence-changed",source:t,value:{clientID:i,presence:n.presence}}:{type:"watched",source:tR.Remote,value:{clientID:i,presence:n.presence}});break;case tk.Clear:r.push({type:"unwatched",source:tR.Remote,value:{clientID:i,presence:this.getPresence(i)}}),this.removeOnlineClient(i)}}let{opInfos:n}=e.execute(this.root,this.presences,t);if(this.changeID=this.changeID.syncLamport(e.getID().getLamport()),n.length>0){let s=this.isEnableDevtools()?e.toStruct():void 0;r.push(t===tR.Remote?{type:"remote-change",source:t,value:{actor:i,clientSeq:e.getID().getClientSeq(),serverSeq:e.getID().getServerSeq(),message:e.getMessage()||"",operations:n},rawChange:s}:{type:"local-change",source:t,value:{actor:i,clientSeq:e.getID().getClientSeq(),serverSeq:e.getID().getServerSeq(),message:e.getMessage()||"",operations:n},rawChange:s})}r.length>0&&this.publish(r)}applyWatchStream(e){if("initialization"===e.body.case){let t=e.body.value.clientIds,r=new Set;for(let e of t)e!==this.changeID.getActorID()&&r.add(e);this.setOnlineClients(r),this.publish([{type:"initialized",source:tR.Local,value:this.getPresences()}]);return}if("event"===e.body.case){let{type:t,publisher:r}=e.body.value,i=[];if(t===en.DOCUMENT_WATCHED)this.addOnlineClient(r),this.hasPresence(r)&&i.push({type:"watched",source:tR.Remote,value:{clientID:r,presence:this.getPresence(r)}});else if(t===en.DOCUMENT_UNWATCHED){let e=this.getPresence(r);this.removeOnlineClient(r),e&&i.push({type:"unwatched",source:tR.Remote,value:{clientID:r,presence:e}})}i.length>0&&this.publish(i)}}applyStatus(e){this.status=e,"detached"===e&&this.setActor(tI),this.publish([{source:"removed"===e?tR.Remote:tR.Local,type:"status-changed",value:"attached"===e?{status:e,actorID:this.changeID.getActorID()}:{status:e}}])}applyDocEvent(e){if("status-changed"===e.type){this.applyStatus(e.value.status),"attached"===e.value.status&&this.setActor(e.value.actorID);return}if("snapshot"===e.type){let{snapshot:t,serverSeq:r}=e.value;if(!t)return;this.applySnapshot(Long.fromString(r),tV.hexToBytes(t));return}if("local-change"===e.type||"remote-change"===e.type){if(!e.rawChange)return;let t=Change.fromStruct(e.rawChange);this.applyChange(t,e.source)}if("initialized"===e.type){let t=new Set;for(let{clientID:r,presence:i}of e.value)t.add(r),this.presences.set(r,i);this.setOnlineClients(t);return}if("watched"===e.type){let{clientID:t,presence:r}=e.value;this.addOnlineClient(t),this.presences.set(t,r);return}if("unwatched"===e.type){let{clientID:t}=e.value;this.removeOnlineClient(t),this.presences.delete(t)}if("presence-changed"===e.type){let{clientID:t,presence:r}=e.value;this.presences.set(t,r)}}applyTransactionEvent(e){for(let t of e)this.applyDocEvent(t)}getValueByPath(e){if(!e.startsWith("$"))throw new YorkieError(tA.ErrInvalidArgument,'path must start with "$"');let t=e.split(".");t.shift();let r=this.getRoot();for(let e of t)if(void 0===(r=r[e]))return;return r}setOnlineClients(e){this.onlineClients=e}resetOnlineClients(){this.onlineClients=new Set}addOnlineClient(e){this.onlineClients.add(e)}removeOnlineClient(e){this.onlineClients.delete(e)}hasPresence(e){return this.presences.has(e)}getMyPresence(){if("attached"!==this.status)return{};let e=this.presences.get(this.changeID.getActorID());return e?deepcopy(e):{}}getPresence(e){if(e===this.changeID.getActorID())return this.getMyPresence();if(!this.onlineClients.has(e))return;let t=this.presences.get(e);return t?deepcopy(t):void 0}getPresenceForTest(e){let t=this.presences.get(e);return t?deepcopy(t):void 0}getPresences(){let e=[];for(let t of(e.push({clientID:this.changeID.getActorID(),presence:deepcopy(this.getMyPresence())}),this.onlineClients))this.presences.has(t)&&e.push({clientID:t,presence:deepcopy(this.presences.get(t))});return e}getSelfForTest(){return{clientID:this.getChangeID().getActorID(),presence:this.getMyPresence()}}getOthersForTest(){let e=this.getChangeID().getActorID();return this.getPresences().filter(t=>t.clientID!==e).sort((e,t)=>e.clientID>t.clientID?1:-1)}canUndo(){return this.internalHistory.hasUndo()&&!this.isUpdating}canRedo(){return this.internalHistory.hasRedo()&&!this.isUpdating}undo(){if(this.isUpdating)throw Error("Undo is not allowed during an update");let e=this.internalHistory.popUndo();if(void 0===e)throw Error("There is no operation to be undone");this.ensureClone();let t=ChangeContext.create(this.changeID.next(),this.clone.root,this.clone.presences.get(this.changeID.getActorID())||{});for(let r of e){if(!(r instanceof Operation)){let e=new Presence(t,deepcopy(this.clone.presences.get(this.changeID.getActorID())));e.set(r.value,{addToHistory:!0});continue}let e=t.issueTimeTicket();r.setExecutedAt(e),t.push(r)}let r=t.getChange();r.execute(this.clone.root,this.clone.presences,tR.UndoRedo);let{opInfos:i,reverseOps:n}=r.execute(this.root,this.presences,tR.UndoRedo),s=t.getReversePresence();if(s&&n.push({type:"presence",value:s}),n.length>0&&this.internalHistory.pushRedo(n),!r.hasPresenceChange()&&0===i.length)return;this.localChanges.push(r),this.changeID=r.getID();let o=this.changeID.getActorID(),a=[];i.length>0&&a.push({type:"local-change",source:tR.UndoRedo,value:{message:r.getMessage()||"",operations:i,actor:o,clientSeq:r.getID().getClientSeq(),serverSeq:r.getID().getServerSeq()},rawChange:this.isEnableDevtools()?r.toStruct():void 0}),r.hasPresenceChange()&&a.push({type:"presence-changed",source:tR.UndoRedo,value:{clientID:o,presence:this.getPresence(o)}}),this.publish(a)}redo(){if(this.isUpdating)throw Error("Redo is not allowed during an update");let e=this.internalHistory.popRedo();if(void 0===e)throw Error("There is no operation to be redone");this.ensureClone();let t=ChangeContext.create(this.changeID.next(),this.clone.root,this.clone.presences.get(this.changeID.getActorID())||{});for(let r of e){if(!(r instanceof Operation)){let e=new Presence(t,deepcopy(this.clone.presences.get(this.changeID.getActorID())));e.set(r.value,{addToHistory:!0});continue}let e=t.issueTimeTicket();r.setExecutedAt(e),t.push(r)}let r=t.getChange();r.execute(this.clone.root,this.clone.presences,tR.UndoRedo);let{opInfos:i,reverseOps:n}=r.execute(this.root,this.presences,tR.UndoRedo),s=t.getReversePresence();if(s&&n.push({type:"presence",value:s}),n.length>0&&this.internalHistory.pushUndo(n),!r.hasPresenceChange()&&0===i.length)return;this.localChanges.push(r),this.changeID=r.getID();let o=this.changeID.getActorID(),a=[];i.length>0&&a.push({type:"local-change",source:tR.UndoRedo,value:{message:r.getMessage()||"",operations:i,actor:o,clientSeq:r.getID().getClientSeq(),serverSeq:r.getID().getServerSeq()},rawChange:this.isEnableDevtools()?r.toStruct():void 0}),r.hasPresenceChange()&&a.push({type:"presence-changed",source:tR.UndoRedo,value:{clientID:o,presence:this.getPresence(o)}}),this.publish(a)}getUndoStackForTest(){return this.internalHistory.getUndoStackForTest()}getRedoStackForTest(){return this.internalHistory.getRedoStackForTest()}};var tY=((v=tY||{}).Manual="manual",v.Realtime="realtime",v.RealtimePushOnly="realtime-pushonly",v.RealtimeSyncOff="realtime-syncoff",v),tH=((b=tH||{}).Deactivated="deactivated",b.Activated="activated",b),tX=((S=tX||{}).SyncLoop="SyncLoop",S.WatchLoop="WatchLoop",S);let tZ={syncLoopDuration:50,retrySyncLoopDelay:1e3,reconnectStreamDelay:1e3};let Client=class Client{constructor(e,t){var r,i,n;__publicField(this,"id"),__publicField(this,"key"),__publicField(this,"status"),__publicField(this,"attachmentMap"),__publicField(this,"apiKey"),__publicField(this,"conditions"),__publicField(this,"syncLoopDuration"),__publicField(this,"reconnectStreamDelay"),__publicField(this,"retrySyncLoopDelay"),__publicField(this,"rpcClient"),__publicField(this,"taskQueue"),__publicField(this,"processing",!1),t=t||tZ,this.key=t.key?t.key:uuid(),this.status="deactivated",this.attachmentMap=new Map,this.apiKey=t.apiKey||"",this.conditions={SyncLoop:!1,WatchLoop:!1},this.syncLoopDuration=t.syncLoopDuration||tZ.syncLoopDuration,this.reconnectStreamDelay=t.reconnectStreamDelay||tZ.reconnectStreamDelay,this.retrySyncLoopDelay=t.retrySyncLoopDelay||tZ.retrySyncLoopDelay,this.rpcClient=(n=function(e){var t;!function(){try{new Headers}catch(e){throw Error("connect-web requires the fetch API. Are you running on an old version of Node.js? Node.js is not supported in Connect for Web - please stay tuned for Connect for Node.")}}();let r=null===(t=e.useBinaryFormat)||void 0===t||t;return{async unary(t,i,n,s,o,a,l){var h;let{serialize:c,parse:u}=createClientMethodSerializers(i,r,e.jsonOptions,e.binaryOptions);return s=void 0===s?e.defaultTimeoutMs:s<=0?void 0:s,await function(e){let t=applyInterceptors(e.next,e.interceptors),[r,i,n]=setupSignal(e),s=Object.assign(Object.assign({},e.req),{message:normalize(e.req.method.I,e.req.message),signal:r});return t(s).then(e=>(n(),e),i)}({interceptors:e.interceptors,signal:n,timeoutMs:s,req:{stream:!1,service:t,method:i,url:createMethodUrl(e.baseUrl,t,i),init:{method:"POST",credentials:null!==(h=e.credentials)&&void 0!==h?h:"same-origin",redirect:"error",mode:"cors"},header:requestHeader(r,s,o,!1),contextValues:null!=l?l:createContextValues(),message:a},next:async r=>{var n;let s,o;let a=null!==(n=e.fetch)&&void 0!==n?n:globalThis.fetch,l=await a(r.url,Object.assign(Object.assign({},r.init),{headers:r.header,signal:r.signal,body:encodeEnvelope(0,c(r.message))}));if(validateResponse(l.status,l.headers),!l.body)throw"missing response body";let h=createEnvelopeReadableStream(l.body).getReader();for(;;){let e=await h.read();if(e.done)break;let{flags:t,data:r}=e.value;if(128===t){if(void 0!==s)throw"extra trailer";s=trailerParse(r);continue}if(void 0!==o)throw"extra message";o=u(r)}if(void 0===s)throw"missing trailer";if(validateTrailer(s,l.headers),void 0===o)throw"missing message";return{stream:!1,service:t,method:i,header:l.headers,message:o,trailer:s}}})},async stream(t,i,n,s,o,a,l){var h;let{serialize:c,parse:u}=createClientMethodSerializers(i,r,e.jsonOptions,e.binaryOptions);async function createRequestBody(e){if(i.kind!=w.ServerStreaming)throw"The fetch API does not support streaming request bodies";let t=await e[Symbol.asyncIterator]().next();if(!0==t.done)throw"missing request message";return encodeEnvelope(0,c(t.value))}return s=void 0===s?e.defaultTimeoutMs:s<=0?void 0:s,function(e){let t=applyInterceptors(e.next,e.interceptors),[r,i,n]=setupSignal(e),s=Object.assign(Object.assign({},e.req),{message:function(e,t){function transform(t){return!0===t.done?t:{done:t.done,value:normalize(e,t.value)}}return{[Symbol.asyncIterator](){let e=t[Symbol.asyncIterator](),r={next:()=>e.next().then(transform)};return void 0!==e.throw&&(r.throw=t=>e.throw(t).then(transform)),void 0!==e.return&&(r.return=t=>e.return(t).then(transform)),r}}}(e.req.method.I,e.req.message),signal:r}),o=!1;return r.addEventListener("abort",function(){var t,r;let i=e.req.message[Symbol.asyncIterator]();o||null===(t=i.throw)||void 0===t||t.call(i,this.reason).catch(()=>{}),null===(r=i.return)||void 0===r||r.call(i).catch(()=>{})}),t(s).then(e=>Object.assign(Object.assign({},e),{message:{[Symbol.asyncIterator](){let t=e.message[Symbol.asyncIterator]();return{next:()=>t.next().then(e=>(!0==e.done&&(o=!0,n()),e),i)}}}}),i)}({interceptors:e.interceptors,signal:n,timeoutMs:s,req:{stream:!0,service:t,method:i,url:createMethodUrl(e.baseUrl,t,i),init:{method:"POST",credentials:null!==(h=e.credentials)&&void 0!==h?h:"same-origin",redirect:"error",mode:"cors"},header:requestHeader(r,s,o,!1),contextValues:null!=l?l:createContextValues(),message:a},next:async t=>{var r;let i=null!==(r=e.fetch)&&void 0!==r?r:globalThis.fetch,n=await i(t.url,Object.assign(Object.assign({},t.init),{headers:t.header,signal:t.signal,body:await createRequestBody(t.message)})),{foundStatus:s}=validateResponse(n.status,n.headers);if(!n.body)throw"missing response body";let o=new Headers,a=Object.assign(Object.assign({},t),{header:n.headers,trailer:o,message:function(e,t,r,i){return er(this,arguments,function*(){let n=createEnvelopeReadableStream(e).getReader();if(t){if(!(yield et(n.read())).done)throw"extra data for trailers-only";return yield et(void 0)}let s=!1;for(;;){let e=yield et(n.read());if(e.done)break;let{flags:t,data:o}=e.value;if((128&t)==128){if(s)throw"extra trailer";s=!0;let e=trailerParse(o);validateTrailer(e,i),e.forEach((e,t)=>r.set(t,e));continue}if(s)throw"extra message";yield yield et(u(o))}if(!s)throw"missing trailer"})}(n.body,s,o,n.headers)});return a}})}}}({baseUrl:e,interceptors:[(r=t.apiKey,i=t.token,e=>async t=>(r&&t.header.set("x-api-key",r),i&&t.header.set("authorization",i),await e(t))),e=>async t=>(t.header.set("x-yorkie-user-agent","yorkie-js-sdk/0.4.27"),await e(t))]}),function(e,t){let r={};for(let[i,n]of Object.entries(e.methods)){let s=t(Object.assign(Object.assign({},n),{localName:i,service:e}));null!=s&&(r[i]=s)}return r}(e7,e=>{switch(e.kind){case w.Unary:return async function(t,r){var i,s;let o=await n.unary(e7,e,null==r?void 0:r.signal,null==r?void 0:r.timeoutMs,null==r?void 0:r.headers,t,null==r?void 0:r.contextValues);return null===(i=null==r?void 0:r.onHeader)||void 0===i||i.call(r,o.header),null===(s=null==r?void 0:r.onTrailer)||void 0===s||s.call(r,o.trailer),o.message};case w.ServerStreaming:return function(t,r){return handleStreamResponse(n.stream(e7,e,null==r?void 0:r.signal,null==r?void 0:r.timeoutMs,null==r?void 0:r.headers,function(e){return G(this,arguments,function*(){yield K((yield*W(z(e))))})}([t]),null==r?void 0:r.contextValues),r)};case w.ClientStreaming:return async function(t,r){let i;let s=await n.stream(e7,e,null==r?void 0:r.signal,null==r?void 0:r.timeoutMs,null==r?void 0:r.headers,t,null==r?void 0:r.contextValues);null===(c=null==r?void 0:r.onHeader)||void 0===c||c.call(r,s.header);try{for(var o,a,l,h,c,u,d,g=!0,f=Y(s.message);!(o=(d=await f.next()).done);g=!0)h=d.value,g=!1,i=h}catch(e){a={error:e}}finally{try{!g&&!o&&(l=f.return)&&await l.call(f)}finally{if(a)throw a.error}}if(!i)throw new ConnectError("protocol error: missing response message",A.Internal);return null===(u=null==r?void 0:r.onTrailer)||void 0===u||u.call(r,s.trailer),i};case w.BiDiStreaming:return function(t,r){return handleStreamResponse(n.stream(e7,e,null==r?void 0:r.signal,null==r?void 0:r.timeoutMs,null==r?void 0:r.headers,t,null==r?void 0:r.contextValues),r)};default:return null}})),this.taskQueue=[]}activate(){return this.isActive()?Promise.resolve():this.enqueueTask(async()=>this.rpcClient.activateClient({clientKey:this.key},{headers:{"x-shard-key":this.apiKey}}).then(e=>{this.id=e.clientId,this.status="activated",this.runSyncLoop(),tx.info(`[AC] c:"${this.getKey()}" activated, id:"${this.id}"`)}).catch(e=>{throw tx.error(`[AC] c:"${this.getKey()}" err :`,e),this.handleConnectError(e),e}))}deactivate(){return"deactivated"===this.status?Promise.resolve():this.enqueueTask(async()=>this.rpcClient.deactivateClient({clientId:this.id},{headers:{"x-shard-key":this.apiKey}}).then(()=>{this.deactivateInternal(),tx.info(`[DC] c"${this.getKey()}" deactivated`)}).catch(e=>{throw tx.error(`[DC] c:"${this.getKey()}" err :`,e),this.handleConnectError(e),e}))}attach(e,t={}){if(!this.isActive())throw new YorkieError(tA.ErrClientNotActivated,`${this.key} is not active`);if(e.getStatus()!==tz.Detached)throw new YorkieError(tA.ErrDocumentNotDetached,`${e.getKey()} is not detached`);e.setActor(this.id),e.update((e,r)=>r.set(t.initialPresence||{}));let r=t.syncMode??"realtime";return this.enqueueTask(async()=>this.rpcClient.attachDocument({clientId:this.id,changePack:tV.toChangePack(e.createChangePack())},{headers:{"x-shard-key":`${this.apiKey}/${e.getKey()}`}}).then(async t=>{let i=tV.fromChangePack(t.changePack);return e.applyChangePack(i),e.getStatus()===tz.Removed||(e.applyStatus(tz.Attached),this.attachmentMap.set(e.getKey(),new Attachment(this.reconnectStreamDelay,e,t.documentId,r)),"manual"!==r&&await this.runWatchLoop(e.getKey()),tx.info(`[AD] c:"${this.getKey()}" attaches d:"${e.getKey()}"`)),e}).catch(e=>{throw tx.error(`[AD] c:"${this.getKey()}" err :`,e),this.handleConnectError(e),e}))}detach(e,t={}){if(!this.isActive())throw new YorkieError(tA.ErrClientNotActivated,`${this.key} is not active`);let r=this.attachmentMap.get(e.getKey());if(!r)throw new YorkieError(tA.ErrDocumentNotAttached,`${e.getKey()} is not attached`);return e.update((e,t)=>t.clear()),this.enqueueTask(async()=>this.rpcClient.detachDocument({clientId:this.id,documentId:r.docID,changePack:tV.toChangePack(e.createChangePack()),removeIfNotAttached:t.removeIfNotAttached??!1},{headers:{"x-shard-key":`${this.apiKey}/${e.getKey()}`}}).then(t=>{let r=tV.fromChangePack(t.changePack);return e.applyChangePack(r),e.getStatus()!==tz.Removed&&e.applyStatus(tz.Detached),this.detachInternal(e.getKey()),tx.info(`[DD] c:"${this.getKey()}" detaches d:"${e.getKey()}"`),e}).catch(e=>{throw tx.error(`[DD] c:"${this.getKey()}" err :`,e),this.handleConnectError(e),e}))}async changeSyncMode(e,t){if(!this.isActive())throw new YorkieError(tA.ErrClientNotActivated,`${this.key} is not active`);let r=this.attachmentMap.get(e.getKey());if(!r)throw new YorkieError(tA.ErrDocumentNotAttached,`${e.getKey()} is not attached`);let i=r.syncMode;return i===t||((r.changeSyncMode(t),"manual"===t)?r.cancelWatchStream():("realtime"===t&&(r.remoteChangeEventReceived=!0),"manual"===i&&await this.runWatchLoop(e.getKey()))),e}sync(e){if(!this.isActive())throw new YorkieError(tA.ErrClientNotActivated,`${this.key} is not active`);if(e){let t=this.attachmentMap.get(e.getKey());if(!t)throw new YorkieError(tA.ErrDocumentNotAttached,`${e.getKey()} is not attached`);return this.enqueueTask(async()=>this.syncInternal(t,"realtime").catch(e=>{throw tx.error(`[SY] c:"${this.getKey()}" err :`,e),this.handleConnectError(e),e}))}return this.enqueueTask(async()=>{let e=[];for(let[,t]of this.attachmentMap)e.push(this.syncInternal(t,t.syncMode));return Promise.all(e).catch(e=>{throw tx.error(`[SY] c:"${this.getKey()}" err :`,e),this.handleConnectError(e),e})})}remove(e){if(!this.isActive())throw new YorkieError(tA.ErrClientNotActivated,`${this.key} is not active`);let t=this.attachmentMap.get(e.getKey());if(!t)throw new YorkieError(tA.ErrDocumentNotAttached,`${e.getKey()} is not attached`);e.setActor(this.id);let r=tV.toChangePack(e.createChangePack());return r.isRemoved=!0,this.enqueueTask(async()=>this.rpcClient.removeDocument({clientId:this.id,documentId:t.docID,changePack:r},{headers:{"x-shard-key":`${this.apiKey}/${e.getKey()}`}}).then(t=>{let r=tV.fromChangePack(t.changePack);e.applyChangePack(r),this.detachInternal(e.getKey()),tx.info(`[RD] c:"${this.getKey()}" removes d:"${e.getKey()}"`)}).catch(e=>{throw tx.error(`[RD] c:"${this.getKey()}" err :`,e),this.handleConnectError(e),e}))}getID(){return this.id}getKey(){return this.key}isActive(){return"activated"===this.status}getStatus(){return this.status}getCondition(e){return this.conditions[e]}runSyncLoop(){let doLoop=()=>{if(!this.isActive()){tx.debug(`[SL] c:"${this.getKey()}" exit sync loop`),this.conditions.SyncLoop=!1;return}let e=[];for(let[,t]of this.attachmentMap)t.needRealtimeSync()&&(t.remoteChangeEventReceived=!1,e.push(this.syncInternal(t,t.syncMode)));Promise.all(e).then(()=>setTimeout(doLoop,this.syncLoopDuration)).catch(e=>{tx.error(`[SL] c:"${this.getKey()}" sync failed:`,e),this.handleConnectError(e)?setTimeout(doLoop,this.retrySyncLoopDelay):this.conditions.SyncLoop=!1})};tx.debug(`[SL] c:"${this.getKey()}" run sync loop`),this.conditions.SyncLoop=!0,doLoop()}async runWatchLoop(e){let t=this.attachmentMap.get(e);if(!t)throw new YorkieError(tA.ErrDocumentNotAttached,`${e} is not attached`);return this.conditions.WatchLoop=!0,t.runWatchLoop(r=>{if(!this.isActive())return this.conditions.WatchLoop=!1,Promise.reject(new YorkieError(tA.ErrClientNotActivated,`${this.key} is not active`));let i=new AbortController,n=this.rpcClient.watchDocument({clientId:this.id,documentId:t.docID},{headers:{"x-shard-key":`${this.apiKey}/${e}`},signal:i.signal});return t.doc.publish([{type:tK.ConnectionChanged,value:tG.Connected}]),tx.info(`[WD] c:"${this.getKey()}" watches d:"${e}"`),new Promise((e,s)=>{let handleStream=async()=>{try{for await(let r of n)this.handleWatchDocumentsResponse(t,r),"initialization"===r.body.case&&e([n,i])}catch(e){t.doc.resetOnlineClients(),t.doc.publish([{type:tK.Initialized,source:tR.Local,value:t.doc.getPresences()}]),t.doc.publish([{type:tK.ConnectionChanged,value:tG.Disconnected}]),tx.debug(`[WD] c:"${this.getKey()}" unwatches`),this.handleConnectError(e)?r():this.conditions.WatchLoop=!1,s(e)}};handleStream()})})}handleWatchDocumentsResponse(e,t){if("event"===t.body.case&&t.body.value.type===en.DOCUMENT_CHANGED){e.remoteChangeEventReceived=!0;return}e.doc.applyWatchStream(t)}deactivateInternal(){for(let[e,t]of(this.status="deactivated",this.attachmentMap))this.detachInternal(e),t.doc.applyStatus(tz.Detached)}detachInternal(e){let t=this.attachmentMap.get(e);t&&(t.cancelWatchStream(),this.attachmentMap.delete(e))}syncInternal(e,t){let{doc:r,docID:i}=e,n=r.createChangePack();return this.rpcClient.pushPullChanges({clientId:this.id,documentId:i,changePack:tV.toChangePack(n),pushOnly:"realtime-pushonly"===t},{headers:{"x-shard-key":`${this.apiKey}/${r.getKey()}`}}).then(t=>{let i=tV.fromChangePack(t.changePack);if(i.hasChanges()&&("realtime-pushonly"===e.syncMode||"realtime-syncoff"===e.syncMode))return r;r.applyChangePack(i),e.doc.publish([{type:tK.SyncStatusChanged,value:tW.Synced}]),r.getStatus()===tz.Removed&&this.detachInternal(r.getKey());let s=r.getKey(),o=i.getChangeSize();return tx.info(`[PP] c:"${this.getKey()}" sync d:"${s}", push:${n.getChangeSize()} pull:${o} cp:${i.getCheckpoint().toTestString()}`),r}).catch(e=>{throw r.publish([{type:tK.SyncStatusChanged,value:tW.SyncFailed}]),tx.error(`[PP] c:"${this.getKey()}" err :`,e),e})}handleConnectError(e){return e instanceof ConnectError&&(e.code===A.Canceled||e.code===A.Unknown||e.code===A.ResourceExhausted||e.code===A.Unavailable||((errorCodeOf(e)===tA.ErrClientNotActivated||errorCodeOf(e)===tA.ErrClientNotFound)&&this.deactivateInternal(),!1))}enqueueTask(e){return new Promise((t,r)=>{this.taskQueue.push(()=>e().then(t).catch(r)),this.processing||this.processNext()})}async processNext(){if(0===this.taskQueue.length){this.processing=!1;return}try{this.processing=!0;let e=this.taskQueue.shift();await e()}catch(e){tx.error(`[TQ] c:"${this.getKey()}" process failed, id:"${this.id}"`)}this.processNext()}};let tQ=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"})),t0={Client,Document,Primitive,Text,Counter,Tree,LogLevel:tN,setLogLevel,IntType:tM.IntegerCnt,LongType:tM.LongCnt};"undefined"!=typeof globalThis&&(globalThis.yorkie={Client,Document,Primitive,Text,Counter,Tree,LogLevel:tN,setLogLevel,IntType:tM.IntegerCnt,LongType:tM.LongCnt}),e.Change=Change,e.Client=Client,e.ClientCondition=tX,e.ClientStatus=tH,e.Counter=Counter,e.Devtools=tQ,e.DocEventType=tK,e.Document=Document,e.DocumentStatus=tz,e.DocumentSyncStatus=tW,e.EventSourceDevPanel=t$,e.EventSourceSDK=tU,e.LogLevel=tN,e.OpSource=tR,e.Primitive=Primitive,e.StreamConnectionStatus=tG,e.SyncMode=tY,e.Text=Text,e.TimeTicket=TimeTicket,e.Tree=Tree,e.converter=tV,e.default=t0,e.setLogLevel=setLogLevel,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}(t)}}]);