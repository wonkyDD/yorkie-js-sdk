(function(){const ee=document.createElement("link").relList;if(ee&&ee.supports&&ee.supports("modulepreload"))return;for(const K of document.querySelectorAll('link[rel="modulepreload"]'))se(K);new MutationObserver(K=>{for(const u of K)if(u.type==="childList")for(const P of u.addedNodes)P.tagName==="LINK"&&P.rel==="modulepreload"&&se(P)}).observe(document,{childList:!0,subtree:!0});function O(K){const u={};return K.integrity&&(u.integrity=K.integrity),K.referrerpolicy&&(u.referrerPolicy=K.referrerpolicy),K.crossorigin==="use-credentials"?u.credentials="include":K.crossorigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function se(K){if(K.ep)return;K.ep=!0;const u=O(K);fetch(K.href,u)}})();var lc=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function fc(F){return F&&F.__esModule&&Object.prototype.hasOwnProperty.call(F,"default")?F.default:F}var Nn={exports:{}};(function(F,ee){(function(O,se){se(ee)})(lc,function(O){var se=Object.defineProperty,K=(r,e,t)=>e in r?se(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,u=(r,e,t)=>(K(r,typeof e!="symbol"?e+"":e,t),t),P;(function(r){r[r.Canceled=1]="Canceled",r[r.Unknown=2]="Unknown",r[r.InvalidArgument=3]="InvalidArgument",r[r.DeadlineExceeded=4]="DeadlineExceeded",r[r.NotFound=5]="NotFound",r[r.AlreadyExists=6]="AlreadyExists",r[r.PermissionDenied=7]="PermissionDenied",r[r.ResourceExhausted=8]="ResourceExhausted",r[r.FailedPrecondition=9]="FailedPrecondition",r[r.Aborted=10]="Aborted",r[r.OutOfRange=11]="OutOfRange",r[r.Unimplemented=12]="Unimplemented",r[r.Internal=13]="Internal",r[r.Unavailable=14]="Unavailable",r[r.DataLoss=15]="DataLoss",r[r.Unauthenticated=16]="Unauthenticated"})(P||(P={}));function Y(r,e){if(!r)throw new Error(e)}const Qt=34028234663852886e22,fe=-34028234663852886e22,lt=4294967295,en=2147483647,tn=-2147483648;function ft(r){if(typeof r!="number")throw new Error("invalid int 32: "+typeof r);if(!Number.isInteger(r)||r>en||r<tn)throw new Error("invalid int 32: "+r)}function Nt(r){if(typeof r!="number")throw new Error("invalid uint 32: "+typeof r);if(!Number.isInteger(r)||r>lt||r<0)throw new Error("invalid uint 32: "+r)}function ar(r){if(typeof r!="number")throw new Error("invalid float 32: "+typeof r);if(!!Number.isFinite(r)&&(r>Qt||r<fe))throw new Error("invalid float 32: "+r)}const cr=Symbol("@bufbuild/protobuf/enum-type");function gi(r){const e=r[cr];return Y(e,"missing enum type on enum object"),e}function hr(r,e,t,n){r[cr]=ur(e,t.map(s=>({no:s.no,name:s.name,localName:r[s.no]})))}function ur(r,e,t){const n=Object.create(null),s=Object.create(null),i=[];for(const o of e){const a=lr(o);i.push(a),n[o.name]=a,s[o.no]=a}return{typeName:r,values:i,findName(o){return n[o]},findNumber(o){return s[o]}}}function mi(r,e,t){const n={};for(const s of e){const i=lr(s);n[i.localName]=i.no,n[i.no]=i.localName}return hr(n,r,e),n}function lr(r){return"localName"in r?r:Object.assign(Object.assign({},r),{localName:r.name})}class W{equals(e){return this.getType().runtime.util.equals(this.getType(),this,e)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(e,t){const n=this.getType(),s=n.runtime.bin,i=s.makeReadOptions(t);return s.readMessage(this,i.readerFactory(e),e.byteLength,i),this}fromJson(e,t){const n=this.getType(),s=n.runtime.json,i=s.makeReadOptions(t);return s.readMessage(n,e,i,this),this}fromJsonString(e,t){let n;try{n=JSON.parse(e)}catch(s){throw new Error(`cannot decode ${this.getType().typeName} from JSON: ${s instanceof Error?s.message:String(s)}`)}return this.fromJson(n,t)}toBinary(e){const t=this.getType(),n=t.runtime.bin,s=n.makeWriteOptions(e),i=s.writerFactory();return n.writeMessage(this,i,s),i.finish()}toJson(e){const t=this.getType(),n=t.runtime.json,s=n.makeWriteOptions(e);return n.writeMessage(this,s)}toJsonString(e){var t;const n=this.toJson(e);return JSON.stringify(n,null,(t=e==null?void 0:e.prettySpaces)!==null&&t!==void 0?t:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}function pi(r,e,t,n){var s;const i=(s=n==null?void 0:n.localName)!==null&&s!==void 0?s:e.substring(e.lastIndexOf(".")+1),o={[i]:function(a){r.util.initFields(this),r.util.initPartial(a,this)}}[i];return Object.setPrototypeOf(o.prototype,new W),Object.assign(o,{runtime:r,typeName:e,fields:r.util.newFieldList(t),fromBinary(a,c){return new o().fromBinary(a,c)},fromJson(a,c){return new o().fromJson(a,c)},fromJsonString(a,c){return new o().fromJsonString(a,c)},equals(a,c){return r.util.equals(o,a,c)}}),o}function yi(r,e,t,n){return{syntax:r,json:e,bin:t,util:n,makeMessageType(s,i,o){return pi(this,s,i,o)},makeEnum:mi,makeEnumType:ur,getEnumType:gi}}var g;(function(r){r[r.DOUBLE=1]="DOUBLE",r[r.FLOAT=2]="FLOAT",r[r.INT64=3]="INT64",r[r.UINT64=4]="UINT64",r[r.INT32=5]="INT32",r[r.FIXED64=6]="FIXED64",r[r.FIXED32=7]="FIXED32",r[r.BOOL=8]="BOOL",r[r.STRING=9]="STRING",r[r.BYTES=12]="BYTES",r[r.UINT32=13]="UINT32",r[r.SFIXED32=15]="SFIXED32",r[r.SFIXED64=16]="SFIXED64",r[r.SINT32=17]="SINT32",r[r.SINT64=18]="SINT64"})(g||(g={}));var et;(function(r){r[r.BIGINT=0]="BIGINT",r[r.STRING=1]="STRING"})(et||(et={}));function vi(){let r=0,e=0;for(let n=0;n<28;n+=7){let s=this.buf[this.pos++];if(r|=(s&127)<<n,(s&128)==0)return this.assertBounds(),[r,e]}let t=this.buf[this.pos++];if(r|=(t&15)<<28,e=(t&112)>>4,(t&128)==0)return this.assertBounds(),[r,e];for(let n=3;n<=31;n+=7){let s=this.buf[this.pos++];if(e|=(s&127)<<n,(s&128)==0)return this.assertBounds(),[r,e]}throw new Error("invalid varint")}function Cn(r,e,t){for(let i=0;i<28;i=i+7){const o=r>>>i,a=!(o>>>7==0&&e==0),c=(a?o|128:o)&255;if(t.push(c),!a)return}const n=r>>>28&15|(e&7)<<4,s=e>>3!=0;if(t.push((s?n|128:n)&255),!!s){for(let i=3;i<31;i=i+7){const o=e>>>i,a=o>>>7!=0,c=(a?o|128:o)&255;if(t.push(c),!a)return}t.push(e>>>31&1)}}const nn=4294967296;function fr(r){const e=r[0]==="-";e&&(r=r.slice(1));const t=1e6;let n=0,s=0;function i(o,a){const c=Number(r.slice(o,a));s*=t,n=n*t+c,n>=nn&&(s=s+(n/nn|0),n=n%nn)}return i(-24,-18),i(-18,-12),i(-12,-6),i(-6),e?gr(n,s):En(n,s)}function Ti(r,e){let t=En(r,e);const n=t.hi&2147483648;n&&(t=gr(t.lo,t.hi));const s=dr(t.lo,t.hi);return n?"-"+s:s}function dr(r,e){if({lo:r,hi:e}=wi(r,e),e<=2097151)return String(nn*e+r);const t=r&16777215,n=(r>>>24|e<<8)&16777215,s=e>>16&65535;let i=t+n*6777216+s*6710656,o=n+s*8147497,a=s*2;const c=1e7;return i>=c&&(o+=Math.floor(i/c),i%=c),o>=c&&(a+=Math.floor(o/c),o%=c),a.toString()+mr(o)+mr(i)}function wi(r,e){return{lo:r>>>0,hi:e>>>0}}function En(r,e){return{lo:r|0,hi:e|0}}function gr(r,e){return e=~e,r?r=~r+1:e+=1,En(r,e)}const mr=r=>{const e=String(r);return"0000000".slice(e.length)+e};function pr(r,e){if(r>=0){for(;r>127;)e.push(r&127|128),r=r>>>7;e.push(r)}else{for(let t=0;t<9;t++)e.push(r&127|128),r=r>>7;e.push(1)}}function bi(){let r=this.buf[this.pos++],e=r&127;if((r&128)==0)return this.assertBounds(),e;if(r=this.buf[this.pos++],e|=(r&127)<<7,(r&128)==0)return this.assertBounds(),e;if(r=this.buf[this.pos++],e|=(r&127)<<14,(r&128)==0)return this.assertBounds(),e;if(r=this.buf[this.pos++],e|=(r&127)<<21,(r&128)==0)return this.assertBounds(),e;r=this.buf[this.pos++],e|=(r&15)<<28;for(let t=5;(r&128)!==0&&t<10;t++)r=this.buf[this.pos++];if((r&128)!=0)throw new Error("invalid varint");return this.assertBounds(),e>>>0}function Ai(){const r=new DataView(new ArrayBuffer(8));if(typeof BigInt=="function"&&typeof r.getBigInt64=="function"&&typeof r.getBigUint64=="function"&&typeof r.setBigInt64=="function"&&typeof r.setBigUint64=="function"&&(typeof process!="object"||typeof process.env!="object"||{}.BUF_BIGINT_DISABLE!=="1")){const s=BigInt("-9223372036854775808"),i=BigInt("9223372036854775807"),o=BigInt("0"),a=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(c){const h=typeof c=="bigint"?c:BigInt(c);if(h>i||h<s)throw new Error(`int64 invalid: ${c}`);return h},uParse(c){const h=typeof c=="bigint"?c:BigInt(c);if(h>a||h<o)throw new Error(`uint64 invalid: ${c}`);return h},enc(c){return r.setBigInt64(0,this.parse(c),!0),{lo:r.getInt32(0,!0),hi:r.getInt32(4,!0)}},uEnc(c){return r.setBigInt64(0,this.uParse(c),!0),{lo:r.getInt32(0,!0),hi:r.getInt32(4,!0)}},dec(c,h){return r.setInt32(0,c,!0),r.setInt32(4,h,!0),r.getBigInt64(0,!0)},uDec(c,h){return r.setInt32(0,c,!0),r.setInt32(4,h,!0),r.getBigUint64(0,!0)}}}const t=s=>Y(/^-?[0-9]+$/.test(s),`int64 invalid: ${s}`),n=s=>Y(/^[0-9]+$/.test(s),`uint64 invalid: ${s}`);return{zero:"0",supported:!1,parse(s){return typeof s!="string"&&(s=s.toString()),t(s),s},uParse(s){return typeof s!="string"&&(s=s.toString()),n(s),s},enc(s){return typeof s!="string"&&(s=s.toString()),t(s),fr(s)},uEnc(s){return typeof s!="string"&&(s=s.toString()),n(s),fr(s)},dec(s,i){return Ti(s,i)},uDec(s,i){return dr(s,i)}}}const q=Ai();var _;(function(r){r[r.Varint=0]="Varint",r[r.Bit64=1]="Bit64",r[r.LengthDelimited=2]="LengthDelimited",r[r.StartGroup=3]="StartGroup",r[r.EndGroup=4]="EndGroup",r[r.Bit32=5]="Bit32"})(_||(_={}));class Si{constructor(e){this.stack=[],this.textEncoder=e!=null?e:new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let s=0;s<this.chunks.length;s++)e+=this.chunks[s].length;let t=new Uint8Array(e),n=0;for(let s=0;s<this.chunks.length;s++)t.set(this.chunks[s],n),n+=this.chunks[s].length;return this.chunks=[],t}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),t=this.stack.pop();if(!t)throw new Error("invalid state, fork stack empty");return this.chunks=t.chunks,this.buf=t.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(Nt(e);e>127;)this.buf.push(e&127|128),e=e>>>7;return this.buf.push(e),this}int32(e){return ft(e),pr(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let t=this.textEncoder.encode(e);return this.uint32(t.byteLength),this.raw(t)}float(e){ar(e);let t=new Uint8Array(4);return new DataView(t.buffer).setFloat32(0,e,!0),this.raw(t)}double(e){let t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),this.raw(t)}fixed32(e){Nt(e);let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),this.raw(t)}sfixed32(e){ft(e);let t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),this.raw(t)}sint32(e){return ft(e),e=(e<<1^e>>31)>>>0,pr(e,this.buf),this}sfixed64(e){let t=new Uint8Array(8),n=new DataView(t.buffer),s=q.enc(e);return n.setInt32(0,s.lo,!0),n.setInt32(4,s.hi,!0),this.raw(t)}fixed64(e){let t=new Uint8Array(8),n=new DataView(t.buffer),s=q.uEnc(e);return n.setInt32(0,s.lo,!0),n.setInt32(4,s.hi,!0),this.raw(t)}int64(e){let t=q.enc(e);return Cn(t.lo,t.hi,this.buf),this}sint64(e){let t=q.enc(e),n=t.hi>>31,s=t.lo<<1^n,i=(t.hi<<1|t.lo>>>31)^n;return Cn(s,i,this.buf),this}uint64(e){let t=q.uEnc(e);return Cn(t.lo,t.hi,this.buf),this}}class Ii{constructor(e,t){this.varint64=vi,this.uint32=bi,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=t!=null?t:new TextDecoder}tag(){let e=this.uint32(),t=e>>>3,n=e&7;if(t<=0||n<0||n>5)throw new Error("illegal tag: field no "+t+" wire type "+n);return[t,n]}skip(e){let t=this.pos;switch(e){case _.Varint:for(;this.buf[this.pos++]&128;);break;case _.Bit64:this.pos+=4;case _.Bit32:this.pos+=4;break;case _.LengthDelimited:let n=this.uint32();this.pos+=n;break;case _.StartGroup:let s;for(;(s=this.tag()[1])!==_.EndGroup;)this.skip(s);break;default:throw new Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(t,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)}int64(){return q.dec(...this.varint64())}uint64(){return q.uDec(...this.varint64())}sint64(){let[e,t]=this.varint64(),n=-(e&1);return e=(e>>>1|(t&1)<<31)^n,t=t>>>1^n,q.dec(e,t)}bool(){let[e,t]=this.varint64();return e!==0||t!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return q.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return q.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),t=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}}function Pn(r,e){return e instanceof W||!r.fieldWrapper?e:r.fieldWrapper.wrapField(e)}g.DOUBLE,g.FLOAT,g.INT64,g.UINT64,g.INT32,g.UINT32,g.BOOL,g.STRING,g.BYTES;function Ke(r,e,t){if(e===t)return!0;if(r==g.BYTES){if(!(e instanceof Uint8Array)||!(t instanceof Uint8Array)||e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}switch(r){case g.UINT64:case g.FIXED64:case g.INT64:case g.SFIXED64:case g.SINT64:return e==t}return!1}function On(r,e){switch(r){case g.BOOL:return!1;case g.UINT64:case g.FIXED64:case g.INT64:case g.SFIXED64:case g.SINT64:return e==0?q.zero:"0";case g.DOUBLE:case g.FLOAT:return 0;case g.BYTES:return new Uint8Array(0);case g.STRING:return"";default:return 0}}function yr(r,e){const t=e===void 0;let n=_.Varint,s=e===0;switch(r){case g.STRING:s=t||!e.length,n=_.LengthDelimited;break;case g.BOOL:s=e===!1;break;case g.DOUBLE:n=_.Bit64;break;case g.FLOAT:n=_.Bit32;break;case g.INT64:s=t||e==0;break;case g.UINT64:s=t||e==0;break;case g.FIXED64:s=t||e==0,n=_.Bit64;break;case g.BYTES:s=t||!e.byteLength,n=_.LengthDelimited;break;case g.FIXED32:n=_.Bit32;break;case g.SFIXED32:n=_.Bit32;break;case g.SFIXED64:s=t||e==0,n=_.Bit64;break;case g.SINT64:s=t||e==0;break}const i=g[r].toLowerCase();return[n,i,t||s]}const dt=Symbol("@bufbuild/protobuf/unknown-fields"),vr={readUnknownFields:!0,readerFactory:r=>new Ii(r)},Tr={writeUnknownFields:!0,writerFactory:()=>new Si};function ki(r){return r?Object.assign(Object.assign({},vr),r):vr}function Ni(r){return r?Object.assign(Object.assign({},Tr),r):Tr}function Ci(){return{makeReadOptions:ki,makeWriteOptions:Ni,listUnknownFields(r){var e;return(e=r[dt])!==null&&e!==void 0?e:[]},discardUnknownFields(r){delete r[dt]},writeUnknownFields(r,e){const n=r[dt];if(n)for(const s of n)e.tag(s.no,s.wireType).raw(s.data)},onUnknownField(r,e,t,n){const s=r;Array.isArray(s[dt])||(s[dt]=[]),s[dt].push({no:e,wireType:t,data:n})},readMessage(r,e,t,n,s){const i=r.getType(),o=s?e.len:e.pos+t;let a,c;for(;e.pos<o&&([a,c]=e.tag(),c!=_.EndGroup);){const h=i.fields.find(a);if(!h){const m=e.skip(c);n.readUnknownFields&&this.onUnknownField(r,a,c,m);continue}let f=r,p=h.repeated,l=h.localName;switch(h.oneof&&(f=f[h.oneof.localName],f.case!=l&&delete f.value,f.case=l,l="value"),h.kind){case"scalar":case"enum":const m=h.kind=="enum"?g.INT32:h.T;let T=sn;if(h.kind=="scalar"&&h.L>0&&(T=Pi),p){let L=f[l];if(c==_.LengthDelimited&&m!=g.STRING&&m!=g.BYTES){let E=e.uint32()+e.pos;for(;e.pos<E;)L.push(T(e,m))}else L.push(T(e,m))}else f[l]=T(e,m);break;case"message":const w=h.T;p?f[l].push(rn(e,new w,n,h)):f[l]instanceof W?rn(e,f[l],n,h):(f[l]=rn(e,new w,n,h),w.fieldWrapper&&!h.oneof&&!h.repeated&&(f[l]=w.fieldWrapper.unwrapField(f[l])));break;case"map":let[b,C]=Ei(h,e,n);f[l][b]=C;break}}if(s&&(c!=_.EndGroup||a!==t))throw new Error("invalid end group tag")}}}function rn(r,e,t,n){const s=e.getType().runtime.bin,i=n==null?void 0:n.delimited;return s.readMessage(e,r,i?n==null?void 0:n.no:r.uint32(),t,i),e}function Ei(r,e,t){const n=e.uint32(),s=e.pos+n;let i,o;for(;e.pos<s;){let[a]=e.tag();switch(a){case 1:i=sn(e,r.K);break;case 2:switch(r.V.kind){case"scalar":o=sn(e,r.V.T);break;case"enum":o=e.int32();break;case"message":o=rn(e,new r.V.T,t,void 0);break}break}}if(i===void 0){let a=On(r.K,et.BIGINT);i=r.K==g.BOOL?a.toString():a}if(typeof i!="string"&&typeof i!="number"&&(i=i.toString()),o===void 0)switch(r.V.kind){case"scalar":o=On(r.V.T,et.BIGINT);break;case"enum":o=0;break;case"message":o=new r.V.T;break}return[i,o]}function Pi(r,e){const t=sn(r,e);return typeof t=="bigint"?t.toString():t}function sn(r,e){switch(e){case g.STRING:return r.string();case g.BOOL:return r.bool();case g.DOUBLE:return r.double();case g.FLOAT:return r.float();case g.INT32:return r.int32();case g.INT64:return r.int64();case g.UINT64:return r.uint64();case g.FIXED64:return r.fixed64();case g.BYTES:return r.bytes();case g.FIXED32:return r.fixed32();case g.SFIXED32:return r.sfixed32();case g.SFIXED64:return r.sfixed64();case g.SINT64:return r.sint64();case g.UINT32:return r.uint32();case g.SINT32:return r.sint32()}}function Oi(r,e,t,n,s){r.tag(t.no,_.LengthDelimited),r.fork();let i=n;switch(t.K){case g.INT32:case g.FIXED32:case g.UINT32:case g.SFIXED32:case g.SINT32:i=Number.parseInt(n);break;case g.BOOL:Y(n=="true"||n=="false"),i=n=="true";break}switch(Ct(r,t.K,1,i,!0),t.V.kind){case"scalar":Ct(r,t.V.T,2,s,!0);break;case"enum":Ct(r,g.INT32,2,s,!0);break;case"message":r.tag(2,_.LengthDelimited).bytes(s.toBinary(e));break}r.join()}function wr(r,e,t,n){if(n!==void 0){const s=Pn(t.T,n);t!=null&&t.delimited?r.tag(t.no,_.StartGroup).raw(s.toBinary(e)).tag(t.no,_.EndGroup):r.tag(t.no,_.LengthDelimited).bytes(s.toBinary(e))}}function Ct(r,e,t,n,s){let[i,o,a]=yr(e,n);(!a||s)&&r.tag(t,i)[o](n)}function Di(r,e,t,n){if(!n.length)return;r.tag(t,_.LengthDelimited).fork();let[,s]=yr(e);for(let i=0;i<n.length;i++)r[s](n[i]);r.join()}function xi(){return Object.assign(Object.assign({},Ci()),{writeMessage(r,e,t){const n=r.getType();for(const s of n.fields.byNumber()){let i,o=s.repeated,a=s.localName;if(s.oneof){const c=r[s.oneof.localName];if(c.case!==a)continue;i=c.value}else i=r[a];switch(s.kind){case"scalar":case"enum":let c=s.kind=="enum"?g.INT32:s.T;if(o)if(s.packed)Di(e,c,s.no,i);else for(const h of i)Ct(e,c,s.no,h,!0);else i!==void 0&&Ct(e,c,s.no,i,!!s.oneof||s.opt);break;case"message":if(o)for(const h of i)wr(e,t,s,h);else wr(e,t,s,i);break;case"map":for(const[h,f]of Object.entries(i))Oi(e,t,s,h,f);break}}return t.writeUnknownFields&&this.writeUnknownFields(r,e),e}})}let $e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),on=[];for(let r=0;r<$e.length;r++)on[$e[r].charCodeAt(0)]=r;on["-".charCodeAt(0)]=$e.indexOf("+"),on["_".charCodeAt(0)]=$e.indexOf("/");const Dn={dec(r){let e=r.length*3/4;r[r.length-2]=="="?e-=2:r[r.length-1]=="="&&(e-=1);let t=new Uint8Array(e),n=0,s=0,i,o=0;for(let a=0;a<r.length;a++){if(i=on[r.charCodeAt(a)],i===void 0)switch(r[a]){case"=":s=0;case`
`:case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(s){case 0:o=i,s=1;break;case 1:t[n++]=o<<2|(i&48)>>4,o=i,s=2;break;case 2:t[n++]=(o&15)<<4|(i&60)>>2,o=i,s=3;break;case 3:t[n++]=(o&3)<<6|i,s=0;break}}if(s==1)throw Error("invalid base64 string.");return t.subarray(0,n)},enc(r){let e="",t=0,n,s=0;for(let i=0;i<r.length;i++)switch(n=r[i],t){case 0:e+=$e[n>>2],s=(n&3)<<4,t=1;break;case 1:e+=$e[s|n>>4],s=(n&15)<<2,t=2;break;case 2:e+=$e[s|n>>6],e+=$e[n&63],t=0;break}return t&&(e+=$e[s],e+="=",t==1&&(e+="=")),e}},br={ignoreUnknownFields:!1},Ar={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};function Ri(r){return r?Object.assign(Object.assign({},br),r):br}function Bi(r){return r?Object.assign(Object.assign({},Ar),r):Ar}function Mi(r){const e=r(Li,Ir);return{makeReadOptions:Ri,makeWriteOptions:Bi,readMessage(t,n,s,i){if(n==null||Array.isArray(n)||typeof n!="object")throw new Error(`cannot decode message ${t.typeName} from JSON: ${this.debug(n)}`);i=i!=null?i:new t;const o={};for(const[a,c]of Object.entries(n)){const h=t.fields.findJsonName(a);if(!h){if(!s.ignoreUnknownFields)throw new Error(`cannot decode message ${t.typeName} from JSON: key "${a}" is unknown`);continue}let f=h.localName,p=i;if(h.oneof){if(c===null&&h.kind=="scalar")continue;const l=o[h.oneof.localName];if(l)throw new Error(`cannot decode message ${t.typeName} from JSON: multiple keys for oneof "${h.oneof.name}" present: "${l}", "${a}"`);o[h.oneof.localName]=a,p=p[h.oneof.localName]={case:f},f="value"}if(h.repeated){if(c===null)continue;if(!Array.isArray(c))throw new Error(`cannot decode field ${t.typeName}.${h.name} from JSON: ${this.debug(c)}`);const l=p[f];for(const m of c){if(m===null)throw new Error(`cannot decode field ${t.typeName}.${h.name} from JSON: ${this.debug(m)}`);let T;switch(h.kind){case"message":T=h.T.fromJson(m,s);break;case"enum":if(T=xn(h.T,m,s.ignoreUnknownFields),T===void 0)continue;break;case"scalar":try{T=Et(h.T,m,h.L)}catch(w){let b=`cannot decode field ${t.typeName}.${h.name} from JSON: ${this.debug(m)}`;throw w instanceof Error&&w.message.length>0&&(b+=`: ${w.message}`),new Error(b)}break}l.push(T)}}else if(h.kind=="map"){if(c===null)continue;if(Array.isArray(c)||typeof c!="object")throw new Error(`cannot decode field ${t.typeName}.${h.name} from JSON: ${this.debug(c)}`);const l=p[f];for(const[m,T]of Object.entries(c)){if(T===null)throw new Error(`cannot decode field ${t.typeName}.${h.name} from JSON: map value null`);let w;switch(h.V.kind){case"message":w=h.V.T.fromJson(T,s);break;case"enum":if(w=xn(h.V.T,T,s.ignoreUnknownFields),w===void 0)continue;break;case"scalar":try{w=Et(h.V.T,T,et.BIGINT)}catch(b){let C=`cannot decode map value for field ${t.typeName}.${h.name} from JSON: ${this.debug(c)}`;throw b instanceof Error&&b.message.length>0&&(C+=`: ${b.message}`),new Error(C)}break}try{l[Et(h.K,h.K==g.BOOL?m=="true"?!0:m=="false"?!1:m:m,et.BIGINT).toString()]=w}catch(b){let C=`cannot decode map key for field ${t.typeName}.${h.name} from JSON: ${this.debug(c)}`;throw b instanceof Error&&b.message.length>0&&(C+=`: ${b.message}`),new Error(C)}}}else switch(h.kind){case"message":const l=h.T;if(c===null&&l.typeName!="google.protobuf.Value"){if(h.oneof)throw new Error(`cannot decode field ${t.typeName}.${h.name} from JSON: null is invalid for oneof field "${a}"`);continue}p[f]instanceof W?p[f].fromJson(c,s):(p[f]=l.fromJson(c,s),l.fieldWrapper&&!h.oneof&&(p[f]=l.fieldWrapper.unwrapField(p[f])));break;case"enum":const m=xn(h.T,c,s.ignoreUnknownFields);m!==void 0&&(p[f]=m);break;case"scalar":try{p[f]=Et(h.T,c,h.L)}catch(T){let w=`cannot decode field ${t.typeName}.${h.name} from JSON: ${this.debug(c)}`;throw T instanceof Error&&T.message.length>0&&(w+=`: ${T.message}`),new Error(w)}break}}return i},writeMessage(t,n){const s=t.getType(),i={};let o;try{for(const a of s.fields.byMember()){let c;if(a.kind=="oneof"){const h=t[a.localName];if(h.value===void 0)continue;if(o=a.findField(h.case),!o)throw"oneof case not found: "+h.case;c=e(o,h.value,n)}else o=a,c=e(o,t[o.localName],n);c!==void 0&&(i[n.useProtoFieldName?o.name:o.jsonName]=c)}}catch(a){const c=o?`cannot encode field ${s.typeName}.${o.name} to JSON`:`cannot encode message ${s.typeName} to JSON`,h=a instanceof Error?a.message:String(a);throw new Error(c+(h.length>0?`: ${h}`:""))}return i},readScalar:Et,writeScalar:Ir,debug:Sr}}function Sr(r){if(r===null)return"null";switch(typeof r){case"object":return Array.isArray(r)?"array":"object";case"string":return r.length>100?"string":`"${r.split('"').join('\\"')}"`;default:return String(r)}}function Et(r,e,t){switch(r){case g.DOUBLE:case g.FLOAT:if(e===null)return 0;if(e==="NaN")return Number.NaN;if(e==="Infinity")return Number.POSITIVE_INFINITY;if(e==="-Infinity")return Number.NEGATIVE_INFINITY;if(e===""||typeof e=="string"&&e.trim().length!==e.length||typeof e!="string"&&typeof e!="number")break;const n=Number(e);if(Number.isNaN(n)||!Number.isFinite(n))break;return r==g.FLOAT&&ar(n),n;case g.INT32:case g.FIXED32:case g.SFIXED32:case g.SINT32:case g.UINT32:if(e===null)return 0;let s;if(typeof e=="number"?s=e:typeof e=="string"&&e.length>0&&e.trim().length===e.length&&(s=Number(e)),s===void 0)break;return r==g.UINT32?Nt(s):ft(s),s;case g.INT64:case g.SFIXED64:case g.SINT64:if(e===null)return q.zero;if(typeof e!="number"&&typeof e!="string")break;const i=q.parse(e);return t?i.toString():i;case g.FIXED64:case g.UINT64:if(e===null)return q.zero;if(typeof e!="number"&&typeof e!="string")break;const o=q.uParse(e);return t?o.toString():o;case g.BOOL:if(e===null)return!1;if(typeof e!="boolean")break;return e;case g.STRING:if(e===null)return"";if(typeof e!="string")break;try{encodeURIComponent(e)}catch{throw new Error("invalid UTF8")}return e;case g.BYTES:if(e===null||e==="")return new Uint8Array(0);if(typeof e!="string")break;return Dn.dec(e)}throw new Error}function xn(r,e,t){if(e===null)return 0;switch(typeof e){case"number":if(Number.isInteger(e))return e;break;case"string":const n=r.findName(e);if(n||t)return n==null?void 0:n.no;break}throw new Error(`cannot decode enum ${r.typeName} from JSON: ${Sr(e)}`)}function Li(r,e,t,n){var s;if(e===void 0)return e;if(e===0&&!t)return;if(n)return e;if(r.typeName=="google.protobuf.NullValue")return null;const i=r.findNumber(e);return(s=i==null?void 0:i.name)!==null&&s!==void 0?s:e}function Ir(r,e,t){if(e!==void 0)switch(r){case g.INT32:case g.SFIXED32:case g.SINT32:case g.FIXED32:case g.UINT32:return Y(typeof e=="number"),e!=0||t?e:void 0;case g.FLOAT:case g.DOUBLE:return Y(typeof e=="number"),Number.isNaN(e)?"NaN":e===Number.POSITIVE_INFINITY?"Infinity":e===Number.NEGATIVE_INFINITY?"-Infinity":e!==0||t?e:void 0;case g.STRING:return Y(typeof e=="string"),e.length>0||t?e:void 0;case g.BOOL:return Y(typeof e=="boolean"),e||t?e:void 0;case g.UINT64:case g.FIXED64:case g.INT64:case g.SFIXED64:case g.SINT64:return Y(typeof e=="bigint"||typeof e=="string"||typeof e=="number"),t||e!=0?e.toString(10):void 0;case g.BYTES:return Y(e instanceof Uint8Array),t||e.byteLength>0?Dn.enc(e):void 0}}function $i(){return Mi((r,e)=>function(n,s,i){if(n.kind=="map"){const o={};switch(n.V.kind){case"scalar":for(const[c,h]of Object.entries(s)){const f=e(n.V.T,h,!0);Y(f!==void 0),o[c.toString()]=f}break;case"message":for(const[c,h]of Object.entries(s))o[c.toString()]=h.toJson(i);break;case"enum":const a=n.V.T;for(const[c,h]of Object.entries(s)){Y(h===void 0||typeof h=="number");const f=r(a,h,!0,i.enumAsInteger);Y(f!==void 0),o[c.toString()]=f}break}return i.emitDefaultValues||Object.keys(o).length>0?o:void 0}else if(n.repeated){const o=[];switch(n.kind){case"scalar":for(let a=0;a<s.length;a++)o.push(e(n.T,s[a],!0));break;case"enum":for(let a=0;a<s.length;a++)o.push(r(n.T,s[a],!0,i.enumAsInteger));break;case"message":for(let a=0;a<s.length;a++)o.push(Pn(n.T,s[a]).toJson(i));break}return i.emitDefaultValues||o.length>0?o:void 0}else switch(n.kind){case"scalar":return e(n.T,s,!!n.oneof||n.opt||i.emitDefaultValues);case"enum":return r(n.T,s,!!n.oneof||n.opt||i.emitDefaultValues,i.enumAsInteger);case"message":return s!==void 0?Pn(n.T,s).toJson(i):void 0}})}function _i(){return{setEnumType:hr,initPartial(r,e){if(r===void 0)return;const t=e.getType();for(const n of t.fields.byMember()){const s=n.localName,i=e,o=r;if(o[s]!==void 0)switch(n.kind){case"oneof":const a=o[s].case;if(a===void 0)continue;const c=n.findField(a);let h=o[s].value;c&&c.kind=="message"&&!(h instanceof c.T)?h=new c.T(h):c&&c.kind==="scalar"&&c.T===g.BYTES&&(h=Pt(h)),i[s]={case:a,value:h};break;case"scalar":case"enum":let f=o[s];n.T===g.BYTES&&(f=n.repeated?f.map(Pt):Pt(f)),i[s]=f;break;case"map":switch(n.V.kind){case"scalar":case"enum":if(n.V.T===g.BYTES)for(const[m,T]of Object.entries(o[s]))i[s][m]=Pt(T);else Object.assign(i[s],o[s]);break;case"message":const l=n.V.T;for(const m of Object.keys(o[s])){let T=o[s][m];l.fieldWrapper||(T=new l(T)),i[s][m]=T}break}break;case"message":const p=n.T;if(n.repeated)i[s]=o[s].map(l=>l instanceof p?l:new p(l));else if(o[s]!==void 0){const l=o[s];p.fieldWrapper?p.typeName==="google.protobuf.BytesValue"?i[s]=Pt(l):i[s]=l:i[s]=l instanceof p?l:new p(l)}break}}},equals(r,e,t){return e===t?!0:!e||!t?!1:r.fields.byMember().every(n=>{const s=e[n.localName],i=t[n.localName];if(n.repeated){if(s.length!==i.length)return!1;switch(n.kind){case"message":return s.every((o,a)=>n.T.equals(o,i[a]));case"scalar":return s.every((o,a)=>Ke(n.T,o,i[a]));case"enum":return s.every((o,a)=>Ke(g.INT32,o,i[a]))}throw new Error(`repeated cannot contain ${n.kind}`)}switch(n.kind){case"message":return n.T.equals(s,i);case"enum":return Ke(g.INT32,s,i);case"scalar":return Ke(n.T,s,i);case"oneof":if(s.case!==i.case)return!1;const o=n.findField(s.case);if(o===void 0)return!0;switch(o.kind){case"message":return o.T.equals(s.value,i.value);case"enum":return Ke(g.INT32,s.value,i.value);case"scalar":return Ke(o.T,s.value,i.value)}throw new Error(`oneof cannot contain ${o.kind}`);case"map":const a=Object.keys(s).concat(Object.keys(i));switch(n.V.kind){case"message":const c=n.V.T;return a.every(f=>c.equals(s[f],i[f]));case"enum":return a.every(f=>Ke(g.INT32,s[f],i[f]));case"scalar":const h=n.V.T;return a.every(f=>Ke(h,s[f],i[f]))}break}})},clone(r){const e=r.getType(),t=new e,n=t;for(const s of e.fields.byMember()){const i=r[s.localName];let o;if(s.repeated)o=i.map(an);else if(s.kind=="map"){o=n[s.localName];for(const[a,c]of Object.entries(i))o[a]=an(c)}else s.kind=="oneof"?o=s.findField(i.case)?{case:i.case,value:an(i.value)}:{case:void 0}:o=an(i);n[s.localName]=o}return t}}}function an(r){if(r===void 0)return r;if(r instanceof W)return r.clone();if(r instanceof Uint8Array){const e=new Uint8Array(r.byteLength);return e.set(r),e}return r}function Pt(r){return r instanceof Uint8Array?r:new Uint8Array(r)}class Ui{constructor(e,t){this._fields=e,this._normalizer=t}findJsonName(e){if(!this.jsonNames){const t={};for(const n of this.list())t[n.jsonName]=t[n.name]=n;this.jsonNames=t}return this.jsonNames[e]}find(e){if(!this.numbers){const t={};for(const n of this.list())t[n.no]=n;this.numbers=t}return this.numbers[e]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort((e,t)=>e.no-t.no)),this.numbersAsc}byMember(){if(!this.members){this.members=[];const e=this.members;let t;for(const n of this.list())n.oneof?n.oneof!==t&&(t=n.oneof,e.push(t)):e.push(n)}return this.members}}function kr(r,e){const t=Nr(r);return e?t:zi(ji(t))}function Ji(r){return kr(r,!1)}const Fi=Nr;function Nr(r){let e=!1;const t=[];for(let n=0;n<r.length;n++){let s=r.charAt(n);switch(s){case"_":e=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":t.push(s),e=!1;break;default:e&&(e=!1,s=s.toUpperCase()),t.push(s);break}}return t.join("")}const Vi=new Set(["constructor","toString","toJSON","valueOf"]),qi=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),Cr=r=>`${r}$`,ji=r=>qi.has(r)?Cr(r):r,zi=r=>Vi.has(r)?Cr(r):r;class Ki{constructor(e){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.default=void 0,this.fields=[],this.name=e,this.localName=Ji(e)}addField(e){Y(e.oneof===this,`field ${e.name} not one of ${this.name}`),this.fields.push(e)}findField(e){if(!this._lookup){this._lookup=Object.create(null);for(let t=0;t<this.fields.length;t++)this._lookup[this.fields[t].localName]=this.fields[t]}return this._lookup[e]}}const d=yi("proto3",$i(),xi(),Object.assign(Object.assign({},_i()),{newFieldList(r){return new Ui(r,Wi)},initFields(r){for(const e of r.getType().fields.byMember()){if(e.opt)continue;const t=e.localName,n=r;if(e.repeated){n[t]=[];continue}switch(e.kind){case"oneof":n[t]={case:void 0};break;case"enum":n[t]=0;break;case"map":n[t]={};break;case"scalar":n[t]=On(e.T,e.L);break}}}}));function Wi(r){var e,t,n,s;const i=[];let o;for(const a of typeof r=="function"?r():r){const c=a;if(c.localName=kr(a.name,a.oneof!==void 0),c.jsonName=(e=a.jsonName)!==null&&e!==void 0?e:Fi(a.name),c.repeated=(t=a.repeated)!==null&&t!==void 0?t:!1,a.kind=="scalar"&&(c.L=(n=a.L)!==null&&n!==void 0?n:et.BIGINT),a.oneof!==void 0){const h=typeof a.oneof=="string"?a.oneof:a.oneof.name;(!o||o.name!=h)&&(o=new Ki(h)),c.oneof=o,o.addField(c)}a.kind=="message"&&(c.delimited=!1),c.packed=(s=a.packed)!==null&&s!==void 0?s:a.kind=="enum"||a.kind=="scalar"&&a.T!=g.BYTES&&a.T!=g.STRING,i.push(c)}return i}var te;(function(r){r[r.Unary=0]="Unary",r[r.ServerStreaming=1]="ServerStreaming",r[r.ClientStreaming=2]="ClientStreaming",r[r.BiDiStreaming=3]="BiDiStreaming"})(te||(te={}));var Er;(function(r){r[r.NoSideEffects=1]="NoSideEffects",r[r.Idempotent=2]="Idempotent"})(Er||(Er={}));class Z extends W{constructor(e){super(),this.seconds=q.zero,this.nanos=0,d.util.initPartial(e,this)}fromJson(e,t){if(typeof e!="string")throw new Error(`cannot decode google.protobuf.Timestamp from JSON: ${d.json.debug(e)}`);const n=e.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!n)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const s=Date.parse(n[1]+"-"+n[2]+"-"+n[3]+"T"+n[4]+":"+n[5]+":"+n[6]+(n[8]?n[8]:"Z"));if(Number.isNaN(s))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(s<Date.parse("0001-01-01T00:00:00Z")||s>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=q.parse(s/1e3),this.nanos=0,n[7]&&(this.nanos=parseInt("1"+n[7]+"0".repeat(9-n[7].length))-1e9),this}toJson(e){const t=Number(this.seconds)*1e3;if(t<Date.parse("0001-01-01T00:00:00Z")||t>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let n="Z";if(this.nanos>0){const s=(this.nanos+1e9).toString().substring(1);s.substring(3)==="000000"?n="."+s.substring(0,3)+"Z":s.substring(6)==="000"?n="."+s.substring(0,6)+"Z":n="."+s+"Z"}return new Date(t).toISOString().replace(".000Z",n)}toDate(){return new Date(Number(this.seconds)*1e3+Math.ceil(this.nanos/1e6))}static now(){return Z.fromDate(new Date)}static fromDate(e){const t=e.getTime();return new Z({seconds:q.parse(Math.floor(t/1e3)),nanos:t%1e3*1e6})}static fromBinary(e,t){return new Z().fromBinary(e,t)}static fromJson(e,t){return new Z().fromJson(e,t)}static fromJsonString(e,t){return new Z().fromJsonString(e,t)}static equals(e,t){return d.util.equals(Z,e,t)}}Z.runtime=d,Z.typeName="google.protobuf.Timestamp",Z.fields=d.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);class ke extends W{constructor(e){super(),this.typeUrl="",this.value=new Uint8Array(0),d.util.initPartial(e,this)}toJson(e){var t;if(this.typeUrl==="")return{};const n=this.typeUrlToName(this.typeUrl),s=(t=e==null?void 0:e.typeRegistry)===null||t===void 0?void 0:t.findMessage(n);if(!s)throw new Error(`cannot encode message google.protobuf.Any to JSON: "${this.typeUrl}" is not in the type registry`);let o=s.fromBinary(this.value).toJson(e);return(n.startsWith("google.protobuf.")||o===null||Array.isArray(o)||typeof o!="object")&&(o={value:o}),o["@type"]=this.typeUrl,o}fromJson(e,t){var n;if(e===null||Array.isArray(e)||typeof e!="object")throw new Error(`cannot decode message google.protobuf.Any from JSON: expected object but got ${e===null?"null":Array.isArray(e)?"array":typeof e}`);if(Object.keys(e).length==0)return this;const s=e["@type"];if(typeof s!="string"||s=="")throw new Error('cannot decode message google.protobuf.Any from JSON: "@type" is empty');const i=this.typeUrlToName(s),o=(n=t==null?void 0:t.typeRegistry)===null||n===void 0?void 0:n.findMessage(i);if(!o)throw new Error(`cannot decode message google.protobuf.Any from JSON: ${s} is not in the type registry`);let a;if(i.startsWith("google.protobuf.")&&Object.prototype.hasOwnProperty.call(e,"value"))a=o.fromJson(e.value,t);else{const c=Object.assign({},e);delete c["@type"],a=o.fromJson(c,t)}return this.packFrom(a),this}packFrom(e){this.value=e.toBinary(),this.typeUrl=this.typeNameToUrl(e.getType().typeName)}unpackTo(e){return this.is(e.getType())?(e.fromBinary(this.value),!0):!1}unpack(e){if(this.typeUrl==="")return;const t=e.findMessage(this.typeUrlToName(this.typeUrl));if(!!t)return t.fromBinary(this.value)}is(e){if(this.typeUrl==="")return!1;const t=this.typeUrlToName(this.typeUrl);let n="";return typeof e=="string"?n=e:n=e.typeName,t===n}typeNameToUrl(e){return`type.googleapis.com/${e}`}typeUrlToName(e){if(!e.length)throw new Error(`invalid type url: ${e}`);const t=e.lastIndexOf("/"),n=t>=0?e.substring(t+1):e;if(!n.length)throw new Error(`invalid type url: ${e}`);return n}static pack(e){const t=new ke;return t.packFrom(e),t}static fromBinary(e,t){return new ke().fromBinary(e,t)}static fromJson(e,t){return new ke().fromJson(e,t)}static fromJsonString(e,t){return new ke().fromJsonString(e,t)}static equals(e,t){return d.util.equals(ke,e,t)}}ke.runtime=d,ke.typeName="google.protobuf.Any",ke.fields=d.util.newFieldList(()=>[{no:1,name:"type_url",kind:"scalar",T:9},{no:2,name:"value",kind:"scalar",T:12}]);class Ne extends W{constructor(e){super(),this.value=0,d.util.initPartial(e,this)}toJson(e){return d.json.writeScalar(g.DOUBLE,this.value,!0)}fromJson(e,t){try{this.value=d.json.readScalar(g.DOUBLE,e)}catch(n){let s='cannot decode message google.protobuf.DoubleValue from JSON"';throw n instanceof Error&&n.message.length>0&&(s+=`: ${n.message}`),new Error(s)}return this}static fromBinary(e,t){return new Ne().fromBinary(e,t)}static fromJson(e,t){return new Ne().fromJson(e,t)}static fromJsonString(e,t){return new Ne().fromJsonString(e,t)}static equals(e,t){return d.util.equals(Ne,e,t)}}Ne.runtime=d,Ne.typeName="google.protobuf.DoubleValue",Ne.fields=d.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:1}]),Ne.fieldWrapper={wrapField(r){return new Ne({value:r})},unwrapField(r){return r.value}};class Ce extends W{constructor(e){super(),this.value=0,d.util.initPartial(e,this)}toJson(e){return d.json.writeScalar(g.FLOAT,this.value,!0)}fromJson(e,t){try{this.value=d.json.readScalar(g.FLOAT,e)}catch(n){let s='cannot decode message google.protobuf.FloatValue from JSON"';throw n instanceof Error&&n.message.length>0&&(s+=`: ${n.message}`),new Error(s)}return this}static fromBinary(e,t){return new Ce().fromBinary(e,t)}static fromJson(e,t){return new Ce().fromJson(e,t)}static fromJsonString(e,t){return new Ce().fromJsonString(e,t)}static equals(e,t){return d.util.equals(Ce,e,t)}}Ce.runtime=d,Ce.typeName="google.protobuf.FloatValue",Ce.fields=d.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:2}]),Ce.fieldWrapper={wrapField(r){return new Ce({value:r})},unwrapField(r){return r.value}};class Ee extends W{constructor(e){super(),this.value=q.zero,d.util.initPartial(e,this)}toJson(e){return d.json.writeScalar(g.INT64,this.value,!0)}fromJson(e,t){try{this.value=d.json.readScalar(g.INT64,e)}catch(n){let s='cannot decode message google.protobuf.Int64Value from JSON"';throw n instanceof Error&&n.message.length>0&&(s+=`: ${n.message}`),new Error(s)}return this}static fromBinary(e,t){return new Ee().fromBinary(e,t)}static fromJson(e,t){return new Ee().fromJson(e,t)}static fromJsonString(e,t){return new Ee().fromJsonString(e,t)}static equals(e,t){return d.util.equals(Ee,e,t)}}Ee.runtime=d,Ee.typeName="google.protobuf.Int64Value",Ee.fields=d.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:3}]),Ee.fieldWrapper={wrapField(r){return new Ee({value:r})},unwrapField(r){return r.value}};class Pe extends W{constructor(e){super(),this.value=q.zero,d.util.initPartial(e,this)}toJson(e){return d.json.writeScalar(g.UINT64,this.value,!0)}fromJson(e,t){try{this.value=d.json.readScalar(g.UINT64,e)}catch(n){let s='cannot decode message google.protobuf.UInt64Value from JSON"';throw n instanceof Error&&n.message.length>0&&(s+=`: ${n.message}`),new Error(s)}return this}static fromBinary(e,t){return new Pe().fromBinary(e,t)}static fromJson(e,t){return new Pe().fromJson(e,t)}static fromJsonString(e,t){return new Pe().fromJsonString(e,t)}static equals(e,t){return d.util.equals(Pe,e,t)}}Pe.runtime=d,Pe.typeName="google.protobuf.UInt64Value",Pe.fields=d.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:4}]),Pe.fieldWrapper={wrapField(r){return new Pe({value:r})},unwrapField(r){return r.value}};class Oe extends W{constructor(e){super(),this.value=0,d.util.initPartial(e,this)}toJson(e){return d.json.writeScalar(g.INT32,this.value,!0)}fromJson(e,t){try{this.value=d.json.readScalar(g.INT32,e)}catch(n){let s='cannot decode message google.protobuf.Int32Value from JSON"';throw n instanceof Error&&n.message.length>0&&(s+=`: ${n.message}`),new Error(s)}return this}static fromBinary(e,t){return new Oe().fromBinary(e,t)}static fromJson(e,t){return new Oe().fromJson(e,t)}static fromJsonString(e,t){return new Oe().fromJsonString(e,t)}static equals(e,t){return d.util.equals(Oe,e,t)}}Oe.runtime=d,Oe.typeName="google.protobuf.Int32Value",Oe.fields=d.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:5}]),Oe.fieldWrapper={wrapField(r){return new Oe({value:r})},unwrapField(r){return r.value}};class De extends W{constructor(e){super(),this.value=0,d.util.initPartial(e,this)}toJson(e){return d.json.writeScalar(g.UINT32,this.value,!0)}fromJson(e,t){try{this.value=d.json.readScalar(g.UINT32,e)}catch(n){let s='cannot decode message google.protobuf.UInt32Value from JSON"';throw n instanceof Error&&n.message.length>0&&(s+=`: ${n.message}`),new Error(s)}return this}static fromBinary(e,t){return new De().fromBinary(e,t)}static fromJson(e,t){return new De().fromJson(e,t)}static fromJsonString(e,t){return new De().fromJsonString(e,t)}static equals(e,t){return d.util.equals(De,e,t)}}De.runtime=d,De.typeName="google.protobuf.UInt32Value",De.fields=d.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:13}]),De.fieldWrapper={wrapField(r){return new De({value:r})},unwrapField(r){return r.value}};class xe extends W{constructor(e){super(),this.value=!1,d.util.initPartial(e,this)}toJson(e){return d.json.writeScalar(g.BOOL,this.value,!0)}fromJson(e,t){try{this.value=d.json.readScalar(g.BOOL,e)}catch(n){let s='cannot decode message google.protobuf.BoolValue from JSON"';throw n instanceof Error&&n.message.length>0&&(s+=`: ${n.message}`),new Error(s)}return this}static fromBinary(e,t){return new xe().fromBinary(e,t)}static fromJson(e,t){return new xe().fromJson(e,t)}static fromJsonString(e,t){return new xe().fromJsonString(e,t)}static equals(e,t){return d.util.equals(xe,e,t)}}xe.runtime=d,xe.typeName="google.protobuf.BoolValue",xe.fields=d.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:8}]),xe.fieldWrapper={wrapField(r){return new xe({value:r})},unwrapField(r){return r.value}};class ae extends W{constructor(e){super(),this.value="",d.util.initPartial(e,this)}toJson(e){return d.json.writeScalar(g.STRING,this.value,!0)}fromJson(e,t){try{this.value=d.json.readScalar(g.STRING,e)}catch(n){let s='cannot decode message google.protobuf.StringValue from JSON"';throw n instanceof Error&&n.message.length>0&&(s+=`: ${n.message}`),new Error(s)}return this}static fromBinary(e,t){return new ae().fromBinary(e,t)}static fromJson(e,t){return new ae().fromJson(e,t)}static fromJsonString(e,t){return new ae().fromJsonString(e,t)}static equals(e,t){return d.util.equals(ae,e,t)}}ae.runtime=d,ae.typeName="google.protobuf.StringValue",ae.fields=d.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:9}]),ae.fieldWrapper={wrapField(r){return new ae({value:r})},unwrapField(r){return r.value}};class Re extends W{constructor(e){super(),this.value=new Uint8Array(0),d.util.initPartial(e,this)}toJson(e){return d.json.writeScalar(g.BYTES,this.value,!0)}fromJson(e,t){try{this.value=d.json.readScalar(g.BYTES,e)}catch(n){let s='cannot decode message google.protobuf.BytesValue from JSON"';throw n instanceof Error&&n.message.length>0&&(s+=`: ${n.message}`),new Error(s)}return this}static fromBinary(e,t){return new Re().fromBinary(e,t)}static fromJson(e,t){return new Re().fromJson(e,t)}static fromJsonString(e,t){return new Re().fromJsonString(e,t)}static equals(e,t){return d.util.equals(Re,e,t)}}Re.runtime=d,Re.typeName="google.protobuf.BytesValue",Re.fields=d.util.newFieldList(()=>[{no:1,name:"value",kind:"scalar",T:12}]),Re.fieldWrapper={wrapField(r){return new Re({value:r})},unwrapField(r){return r.value}};function Pr(r){const e=P[r];return typeof e!="string"?r.toString():e[0].toLowerCase()+e.substring(1).replace(/[A-Z]/g,t=>"_"+t.toLowerCase())}class G extends Error{constructor(e,t=P.Unknown,n,s,i){super(Gi(e,t)),this.name="ConnectError",Object.setPrototypeOf(this,new.target.prototype),this.rawMessage=e,this.code=t,this.metadata=new Headers(n!=null?n:{}),this.details=s!=null?s:[],this.cause=i}static from(e,t=P.Unknown){return e instanceof G?e:e instanceof Error?e.name=="AbortError"?new G(e.message,P.Canceled):new G(e.message,t,void 0,void 0,e):new G(String(e),t,void 0,void 0,e)}findDetails(e){const t="typeName"in e?{findMessage:s=>s===e.typeName?e:void 0}:e,n=[];for(const s of this.details){if(s instanceof W){t.findMessage(s.getType().typeName)&&n.push(s);continue}const i=t.findMessage(s.type);if(i)try{n.push(i.fromBinary(s.value))}catch{}}return n}}function Gi(r,e){return r.length?`[${Pr(e)}] ${r}`:`[${Pr(e)}]`}function Hi(r,e,t){try{const n=Dn.dec(r);return e?e.fromBinary(n,t):n}catch(n){throw G.from(n,P.DataLoss)}}function Yi(r,e){const t={};for(const[n,s]of Object.entries(r.methods)){const i=e(Object.assign(Object.assign({},s),{localName:n,service:r}));i!=null&&(t[n]=i)}return t}function Or(r){let e,t=new Uint8Array(0);function n(s){const i=new Uint8Array(t.length+s.length);i.set(t),i.set(s,t.length),t=i}return new ReadableStream({start(){e=r.getReader()},async pull(s){let i;for(;;){if(i===void 0&&t.byteLength>=5){let c=0;for(let h=1;h<5;h++)c=(c<<8)+t[h];i={flags:t[0],length:c}}if(i!==void 0&&t.byteLength>=i.length+5)break;const a=await e.read();if(a.done)break;n(a.value)}if(i===void 0){if(t.byteLength==0){s.close();return}s.error(new G("premature end of stream",P.DataLoss));return}const o=t.subarray(5,5+i.length);t=t.subarray(5+i.length),s.enqueue({flags:i.flags,data:o})}})}function Dr(r,e){const t=new Uint8Array(e.length+5);t.set(e,5);const n=new DataView(t.buffer,t.byteOffset,t.byteLength);return n.setUint8(0,r),n.setUint32(1,e.length),t}var Xi=globalThis&&globalThis.__asyncValues||function(r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=r[Symbol.asyncIterator],t;return e?e.call(r):(r=typeof __values=="function"?__values(r):r[Symbol.iterator](),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(i){t[i]=r[i]&&function(o){return new Promise(function(a,c){o=r[i](o),s(a,c,o.done,o.value)})}}function s(i,o,a,c){Promise.resolve(c).then(function(h){i({value:h,done:a})},o)}},Ot=globalThis&&globalThis.__await||function(r){return this instanceof Ot?(this.v=r,this):new Ot(r)},Zi=globalThis&&globalThis.__asyncGenerator||function(r,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=t.apply(r,e||[]),s,i=[];return s={},o("next"),o("throw"),o("return"),s[Symbol.asyncIterator]=function(){return this},s;function o(l){n[l]&&(s[l]=function(m){return new Promise(function(T,w){i.push([l,m,T,w])>1||a(l,m)})})}function a(l,m){try{c(n[l](m))}catch(T){p(i[0][3],T)}}function c(l){l.value instanceof Ot?Promise.resolve(l.value.v).then(h,f):p(i[0][2],l)}function h(l){a("next",l)}function f(l){a("throw",l)}function p(l,m){l(m),i.shift(),i.length&&a(i[0][0],i[0][1])}},Qi=globalThis&&globalThis.__asyncDelegator||function(r){var e,t;return e={},n("next"),n("throw",function(s){throw s}),n("return"),e[Symbol.iterator]=function(){return this},e;function n(s,i){e[s]=r[s]?function(o){return(t=!t)?{value:Ot(r[s](o)),done:!1}:i?i(o):o}:i}};function eo(r){return Zi(this,arguments,function*(){yield Ot(yield*Qi(Xi(r)))})}var xr=globalThis&&globalThis.__asyncValues||function(r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=r[Symbol.asyncIterator],t;return e?e.call(r):(r=typeof __values=="function"?__values(r):r[Symbol.iterator](),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(i){t[i]=r[i]&&function(o){return new Promise(function(a,c){o=r[i](o),s(a,c,o.done,o.value)})}}function s(i,o,a,c){Promise.resolve(c).then(function(h){i({value:h,done:a})},o)}},gt=globalThis&&globalThis.__await||function(r){return this instanceof gt?(this.v=r,this):new gt(r)},to=globalThis&&globalThis.__asyncDelegator||function(r){var e,t;return e={},n("next"),n("throw",function(s){throw s}),n("return"),e[Symbol.iterator]=function(){return this},e;function n(s,i){e[s]=r[s]?function(o){return(t=!t)?{value:gt(r[s](o)),done:!1}:i?i(o):o}:i}},no=globalThis&&globalThis.__asyncGenerator||function(r,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=t.apply(r,e||[]),s,i=[];return s={},o("next"),o("throw"),o("return"),s[Symbol.asyncIterator]=function(){return this},s;function o(l){n[l]&&(s[l]=function(m){return new Promise(function(T,w){i.push([l,m,T,w])>1||a(l,m)})})}function a(l,m){try{c(n[l](m))}catch(T){p(i[0][3],T)}}function c(l){l.value instanceof gt?Promise.resolve(l.value.v).then(h,f):p(i[0][2],l)}function h(l){a("next",l)}function f(l){a("throw",l)}function p(l,m){l(m),i.shift(),i.length&&a(i[0][0],i[0][1])}};function ro(r,e){return Yi(r,t=>{switch(t.kind){case te.Unary:return so(e,r,t);case te.ServerStreaming:return io(e,r,t);case te.ClientStreaming:return oo(e,r,t);case te.BiDiStreaming:return ao(e,r,t);default:return null}})}function so(r,e,t){return async function(n,s){var i,o;const a=await r.unary(e,t,s==null?void 0:s.signal,s==null?void 0:s.timeoutMs,s==null?void 0:s.headers,n,s==null?void 0:s.contextValues);return(i=s==null?void 0:s.onHeader)===null||i===void 0||i.call(s,a.header),(o=s==null?void 0:s.onTrailer)===null||o===void 0||o.call(s,a.trailer),a.message}}function io(r,e,t){return function(n,s){return Rr(r.stream(e,t,s==null?void 0:s.signal,s==null?void 0:s.timeoutMs,s==null?void 0:s.headers,eo([n]),s==null?void 0:s.contextValues),s)}}function oo(r,e,t){return async function(n,s){var i,o,a,c,h,f;const p=await r.stream(e,t,s==null?void 0:s.signal,s==null?void 0:s.timeoutMs,s==null?void 0:s.headers,n,s==null?void 0:s.contextValues);(h=s==null?void 0:s.onHeader)===null||h===void 0||h.call(s,p.header);let l;try{for(var m=!0,T=xr(p.message),w;w=await T.next(),i=w.done,!i;m=!0)c=w.value,m=!1,l=c}catch(b){o={error:b}}finally{try{!m&&!i&&(a=T.return)&&await a.call(T)}finally{if(o)throw o.error}}if(!l)throw new G("protocol error: missing response message",P.Internal);return(f=s==null?void 0:s.onTrailer)===null||f===void 0||f.call(s,p.trailer),l}}function ao(r,e,t){return function(n,s){return Rr(r.stream(e,t,s==null?void 0:s.signal,s==null?void 0:s.timeoutMs,s==null?void 0:s.headers,n,s==null?void 0:s.contextValues),s)}}function Rr(r,e){const t=function(){var n,s;return no(this,arguments,function*(){const i=yield gt(r);(n=e==null?void 0:e.onHeader)===null||n===void 0||n.call(e,i.header),yield gt(yield*to(xr(i.message))),(s=e==null?void 0:e.onTrailer)===null||s===void 0||s.call(e,i.trailer)})}()[Symbol.asyncIterator]();return{[Symbol.asyncIterator]:()=>({next:()=>t.next()})}}function co(...r){const e=new AbortController,t=r.filter(s=>s!==void 0).concat(e.signal);for(const s of t){if(s.aborted){n.apply(s);break}s.addEventListener("abort",n)}function n(){e.signal.aborted||e.abort(Br(this));for(const s of t)s.removeEventListener("abort",n)}return e}function ho(r){const e=new AbortController,t=()=>{e.abort(new G("the operation timed out",P.DeadlineExceeded))};let n;return r!==void 0&&(r<=0?t():n=setTimeout(t,r)),{signal:e.signal,cleanup:()=>clearTimeout(n)}}function Br(r){if(!r.aborted)return;if(r.reason!==void 0)return r.reason;const e=new Error("This operation was aborted");return e.name="AbortError",e}function Mr(){return{get(r){return r.id in this?this[r.id]:r.defaultValue},set(r,e){return this[r.id]=e,this},delete(r){return delete this[r.id],this}}}const Rn=128;function Lr(r){const e=new Headers,t=new TextDecoder().decode(r).split(`\r
`);for(const n of t){if(n==="")continue;const s=n.indexOf(":");if(s>0){const i=n.substring(0,s).trim(),o=n.substring(s+1).trim();e.append(i,o)}}return e}const uo="Content-Type",lo="Grpc-Timeout",$r="Grpc-Status",_r="Grpc-Message",fo="Grpc-Status-Details-Bin",go="User-Agent",mo="X-User-Agent",po="X-Grpc-Web",yo="application/grpc-web+proto",vo="application/grpc-web+json";class _e extends W{constructor(e){super(),this.code=0,this.message="",this.details=[],d.util.initPartial(e,this)}static fromBinary(e,t){return new _e().fromBinary(e,t)}static fromJson(e,t){return new _e().fromJson(e,t)}static fromJsonString(e,t){return new _e().fromJsonString(e,t)}static equals(e,t){return d.util.equals(_e,e,t)}}_e.runtime=d,_e.typeName="google.rpc.Status",_e.fields=d.util.newFieldList(()=>[{no:1,name:"code",kind:"scalar",T:5},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"details",kind:"message",T:ke,repeated:!0}]);const To="0";function Ur(r){var e;const t=r.get(fo);if(t!=null){const s=Hi(t,_e);if(s.code==0)return;const i=new G(s.message,s.code,r);return i.details=s.details.map(o=>({type:o.typeUrl.substring(o.typeUrl.lastIndexOf("/")+1),value:o.value})),i}const n=r.get($r);if(n!=null){if(n===To)return;const s=parseInt(n,10);return s in P?new G(decodeURIComponent((e=r.get(_r))!==null&&e!==void 0?e:""),s,r):new G(`invalid grpc-status: ${n}`,P.Internal,r)}}function Jr(r,e,t){const n=typeof e=="string"?e:e.typeName,s=typeof t=="string"?t:t.name;return r.toString().replace(/\/?$/,`/${n}/${s}`)}function Fr(r,e){return e instanceof W?e:new r(e)}function wo(r,e){function t(n){return n.done===!0?n:{done:n.done,value:Fr(r,n.value)}}return{[Symbol.asyncIterator](){const n=e[Symbol.asyncIterator](),s={next:()=>n.next().then(t)};return n.throw!==void 0&&(s.throw=i=>n.throw(i).then(t)),n.return!==void 0&&(s.return=i=>n.return(i).then(t)),s}}}function bo(r){var e;const t=Object.assign({},r);return(e=t.ignoreUnknownFields)!==null&&e!==void 0||(t.ignoreUnknownFields=!0),t}function Vr(r,e,t,n){const s=e?qr(r.I,n):jr(r.I,t);return{parse:(e?qr(r.O,n):jr(r.O,t)).parse,serialize:s.serialize}}function qr(r,e){return{parse(t){try{return r.fromBinary(t,e)}catch(n){const s=n instanceof Error?n.message:String(n);throw new G(`parse binary: ${s}`,P.InvalidArgument)}},serialize(t){try{return t.toBinary(e)}catch(n){const s=n instanceof Error?n.message:String(n);throw new G(`serialize binary: ${s}`,P.Internal)}}}}function jr(r,e){var t,n;const s=(t=e==null?void 0:e.textEncoder)!==null&&t!==void 0?t:new TextEncoder,i=(n=e==null?void 0:e.textDecoder)!==null&&n!==void 0?n:new TextDecoder,o=bo(e);return{parse(a){try{const c=i.decode(a);return r.fromJsonString(c,o)}catch(c){throw G.from(c,P.InvalidArgument)}},serialize(a){try{const c=a.toJsonString(o);return s.encode(c)}catch(c){throw G.from(c,P.Internal)}}}}function Ao(r){const e=Kr(r.next,r.interceptors),[t,n,s]=zr(r),i=Object.assign(Object.assign({},r.req),{message:Fr(r.req.method.I,r.req.message),signal:t});return e(i).then(o=>(s(),o),n)}function So(r){const e=Kr(r.next,r.interceptors),[t,n,s]=zr(r),i=Object.assign(Object.assign({},r.req),{message:wo(r.req.method.I,r.req.message),signal:t});let o=!1;return t.addEventListener("abort",function(){var a,c;const h=r.req.message[Symbol.asyncIterator]();o||(a=h.throw)===null||a===void 0||a.call(h,this.reason).catch(()=>{}),(c=h.return)===null||c===void 0||c.call(h).catch(()=>{})}),e(i).then(a=>Object.assign(Object.assign({},a),{message:{[Symbol.asyncIterator](){const c=a.message[Symbol.asyncIterator]();return{next(){return c.next().then(h=>(h.done==!0&&(o=!0,s()),h),n)}}}}}),n)}function zr(r){const{signal:e,cleanup:t}=ho(r.timeoutMs),n=co(r.signal,e);return[n.signal,function(i){const o=G.from(e.aborted?Br(e):i);return n.abort(o),t(),Promise.reject(o)},function(){t(),n.abort()}]}function Kr(r,e){var t;return(t=e==null?void 0:e.concat().reverse().reduce((n,s)=>s(n),r))!==null&&t!==void 0?t:r}function Io(){try{new Headers}catch{throw new Error("connect-web requires the fetch API. Are you running on an old version of Node.js? Node.js is not supported in Connect for Web - please stay tuned for Connect for Node.")}}function Wr(r,e){const t=Ur(r);if(t)throw e.forEach((n,s)=>{t.metadata.append(s,n)}),t}function Gr(r,e,t,n){const s=new Headers(t!=null?t:{});return s.set(uo,r?yo:vo),s.set(po,"1"),s.set(mo,"connect-es/1.2.0"),n&&s.set(go,"connect-es/1.2.0"),e!==void 0&&s.set(lo,`${e}m`),s}function ko(r){switch(r){case 400:return P.Internal;case 401:return P.Unauthenticated;case 403:return P.PermissionDenied;case 404:return P.Unimplemented;case 429:return P.Unavailable;case 502:return P.Unavailable;case 503:return P.Unavailable;case 504:return P.Unavailable;default:return P.Unknown}}function Hr(r,e){var t;if(r>=200&&r<300){const n=Ur(e);if(n)throw n;return{foundStatus:e.has($r)}}throw new G(decodeURIComponent((t=e.get(_r))!==null&&t!==void 0?t:`HTTP ${r}`),ko(r),e)}var tt=globalThis&&globalThis.__await||function(r){return this instanceof tt?(this.v=r,this):new tt(r)},No=globalThis&&globalThis.__asyncGenerator||function(r,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=t.apply(r,e||[]),s,i=[];return s={},o("next"),o("throw"),o("return"),s[Symbol.asyncIterator]=function(){return this},s;function o(l){n[l]&&(s[l]=function(m){return new Promise(function(T,w){i.push([l,m,T,w])>1||a(l,m)})})}function a(l,m){try{c(n[l](m))}catch(T){p(i[0][3],T)}}function c(l){l.value instanceof tt?Promise.resolve(l.value.v).then(h,f):p(i[0][2],l)}function h(l){a("next",l)}function f(l){a("throw",l)}function p(l,m){l(m),i.shift(),i.length&&a(i[0][0],i[0][1])}};function Co(r){var e;Io();const t=(e=r.useBinaryFormat)!==null&&e!==void 0?e:!0;return{async unary(n,s,i,o,a,c,h){var f;const{serialize:p,parse:l}=Vr(s,t,r.jsonOptions,r.binaryOptions);return o=o===void 0?r.defaultTimeoutMs:o<=0?void 0:o,await Ao({interceptors:r.interceptors,signal:i,timeoutMs:o,req:{stream:!1,service:n,method:s,url:Jr(r.baseUrl,n,s),init:{method:"POST",credentials:(f=r.credentials)!==null&&f!==void 0?f:"same-origin",redirect:"error",mode:"cors"},header:Gr(t,o,a,!1),contextValues:h!=null?h:Mr(),message:c},next:async m=>{var T;const b=await((T=r.fetch)!==null&&T!==void 0?T:globalThis.fetch)(m.url,Object.assign(Object.assign({},m.init),{headers:m.header,signal:m.signal,body:Dr(0,p(m.message))}));if(Hr(b.status,b.headers),!b.body)throw"missing response body";const C=Or(b.body).getReader();let L,E;for(;;){const B=await C.read();if(B.done)break;const{flags:$,data:J}=B.value;if($===Rn){if(L!==void 0)throw"extra trailer";L=Lr(J);continue}if(E!==void 0)throw"extra message";E=l(J)}if(L===void 0)throw"missing trailer";if(Wr(L,b.headers),E===void 0)throw"missing message";return{stream:!1,header:b.headers,message:E,trailer:L}}})},async stream(n,s,i,o,a,c,h){var f;const{serialize:p,parse:l}=Vr(s,t,r.jsonOptions,r.binaryOptions);function m(w,b,C,L){return No(this,arguments,function*(){const B=Or(w).getReader();if(b){if(!(yield tt(B.read())).done)throw"extra data for trailers-only";return yield tt(void 0)}let $=!1;for(;;){const J=yield tt(B.read());if(J.done)break;const{flags:ht,data:ut}=J.value;if((ht&Rn)===Rn){if($)throw"extra trailer";$=!0;const Zt=Lr(ut);Wr(Zt,L),Zt.forEach((hc,uc)=>C.set(uc,hc));continue}if($)throw"extra message";yield yield tt(l(ut))}if(!$)throw"missing trailer"})}async function T(w){if(s.kind!=te.ServerStreaming)throw"The fetch API does not support streaming request bodies";const b=await w[Symbol.asyncIterator]().next();if(b.done==!0)throw"missing request message";return Dr(0,p(b.value))}return o=o===void 0?r.defaultTimeoutMs:o<=0?void 0:o,So({interceptors:r.interceptors,signal:i,timeoutMs:o,req:{stream:!0,service:n,method:s,url:Jr(r.baseUrl,n,s),init:{method:"POST",credentials:(f=r.credentials)!==null&&f!==void 0?f:"same-origin",redirect:"error",mode:"cors"},header:Gr(t,o,a,!1),contextValues:h!=null?h:Mr(),message:c},next:async w=>{var b;const L=await((b=r.fetch)!==null&&b!==void 0?b:globalThis.fetch)(w.url,Object.assign(Object.assign({},w.init),{headers:w.header,signal:w.signal,body:await T(w.message)})),{foundStatus:E}=Hr(L.status,L.headers);if(!L.body)throw"missing response body";const B=new Headers;return Object.assign(Object.assign({},w),{header:L.headers,trailer:B,message:m(L.body,E,B,L.headers)})}})}}}const N=d.makeEnum("yorkie.v1.ValueType",[{no:0,name:"VALUE_TYPE_NULL",localName:"NULL"},{no:1,name:"VALUE_TYPE_BOOLEAN",localName:"BOOLEAN"},{no:2,name:"VALUE_TYPE_INTEGER",localName:"INTEGER"},{no:3,name:"VALUE_TYPE_LONG",localName:"LONG"},{no:4,name:"VALUE_TYPE_DOUBLE",localName:"DOUBLE"},{no:5,name:"VALUE_TYPE_STRING",localName:"STRING"},{no:6,name:"VALUE_TYPE_BYTES",localName:"BYTES"},{no:7,name:"VALUE_TYPE_DATE",localName:"DATE"},{no:8,name:"VALUE_TYPE_JSON_OBJECT",localName:"JSON_OBJECT"},{no:9,name:"VALUE_TYPE_JSON_ARRAY",localName:"JSON_ARRAY"},{no:10,name:"VALUE_TYPE_TEXT",localName:"TEXT"},{no:11,name:"VALUE_TYPE_INTEGER_CNT",localName:"INTEGER_CNT"},{no:12,name:"VALUE_TYPE_LONG_CNT",localName:"LONG_CNT"},{no:13,name:"VALUE_TYPE_TREE",localName:"TREE"}]),cn=d.makeEnum("yorkie.v1.DocEventType",[{no:0,name:"DOC_EVENT_TYPE_DOCUMENT_CHANGED",localName:"DOCUMENT_CHANGED"},{no:1,name:"DOC_EVENT_TYPE_DOCUMENT_WATCHED",localName:"DOCUMENT_WATCHED"},{no:2,name:"DOC_EVENT_TYPE_DOCUMENT_UNWATCHED",localName:"DOCUMENT_UNWATCHED"},{no:3,name:"DOC_EVENT_TYPE_DOCUMENT_BROADCAST",localName:"DOCUMENT_BROADCAST"}]),Eo=d.makeMessageType("yorkie.v1.Snapshot",()=>[{no:1,name:"root",kind:"message",T:de},{no:2,name:"presences",kind:"map",K:9,V:{kind:"message",T:Un}}]),Ue=d.makeMessageType("yorkie.v1.ChangePack",()=>[{no:1,name:"document_key",kind:"scalar",T:9},{no:2,name:"checkpoint",kind:"message",T:ms},{no:3,name:"snapshot",kind:"scalar",T:12},{no:4,name:"changes",kind:"message",T:Yr,repeated:!0},{no:5,name:"min_synced_ticket",kind:"message",T:S},{no:6,name:"is_removed",kind:"scalar",T:8}]),Yr=d.makeMessageType("yorkie.v1.Change",()=>[{no:1,name:"id",kind:"message",T:hn},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"operations",kind:"message",T:Bn,repeated:!0},{no:4,name:"presence_change",kind:"message",T:_n}]),hn=d.makeMessageType("yorkie.v1.ChangeID",()=>[{no:1,name:"client_seq",kind:"scalar",T:13},{no:2,name:"server_seq",kind:"scalar",T:3,L:1},{no:3,name:"lamport",kind:"scalar",T:3,L:1},{no:4,name:"actor_id",kind:"scalar",T:12}]),Bn=d.makeMessageType("yorkie.v1.Operation",()=>[{no:1,name:"set",kind:"message",T:Xr,oneof:"body"},{no:2,name:"add",kind:"message",T:Zr,oneof:"body"},{no:3,name:"move",kind:"message",T:Qr,oneof:"body"},{no:4,name:"remove",kind:"message",T:es,oneof:"body"},{no:5,name:"edit",kind:"message",T:ts,oneof:"body"},{no:6,name:"select",kind:"message",T:Po,oneof:"body"},{no:7,name:"style",kind:"message",T:ns,oneof:"body"},{no:8,name:"increase",kind:"message",T:rs,oneof:"body"},{no:9,name:"tree_edit",kind:"message",T:ss,oneof:"body"},{no:10,name:"tree_style",kind:"message",T:is,oneof:"body"}]),Xr=d.makeMessageType("yorkie.v1.Operation.Set",()=>[{no:1,name:"parent_created_at",kind:"message",T:S},{no:2,name:"key",kind:"scalar",T:9},{no:3,name:"value",kind:"message",T:Je},{no:4,name:"executed_at",kind:"message",T:S}],{localName:"Operation_Set"}),Zr=d.makeMessageType("yorkie.v1.Operation.Add",()=>[{no:1,name:"parent_created_at",kind:"message",T:S},{no:2,name:"prev_created_at",kind:"message",T:S},{no:3,name:"value",kind:"message",T:Je},{no:4,name:"executed_at",kind:"message",T:S}],{localName:"Operation_Add"}),Qr=d.makeMessageType("yorkie.v1.Operation.Move",()=>[{no:1,name:"parent_created_at",kind:"message",T:S},{no:2,name:"prev_created_at",kind:"message",T:S},{no:3,name:"created_at",kind:"message",T:S},{no:4,name:"executed_at",kind:"message",T:S}],{localName:"Operation_Move"}),es=d.makeMessageType("yorkie.v1.Operation.Remove",()=>[{no:1,name:"parent_created_at",kind:"message",T:S},{no:2,name:"created_at",kind:"message",T:S},{no:3,name:"executed_at",kind:"message",T:S}],{localName:"Operation_Remove"}),ts=d.makeMessageType("yorkie.v1.Operation.Edit",()=>[{no:1,name:"parent_created_at",kind:"message",T:S},{no:2,name:"from",kind:"message",T:nt},{no:3,name:"to",kind:"message",T:nt},{no:4,name:"created_at_map_by_actor",kind:"map",K:9,V:{kind:"message",T:S}},{no:5,name:"content",kind:"scalar",T:9},{no:6,name:"executed_at",kind:"message",T:S},{no:7,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}}],{localName:"Operation_Edit"}),Po=d.makeMessageType("yorkie.v1.Operation.Select",()=>[{no:1,name:"parent_created_at",kind:"message",T:S},{no:2,name:"from",kind:"message",T:nt},{no:3,name:"to",kind:"message",T:nt},{no:4,name:"executed_at",kind:"message",T:S}],{localName:"Operation_Select"}),ns=d.makeMessageType("yorkie.v1.Operation.Style",()=>[{no:1,name:"parent_created_at",kind:"message",T:S},{no:2,name:"from",kind:"message",T:nt},{no:3,name:"to",kind:"message",T:nt},{no:4,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:5,name:"executed_at",kind:"message",T:S},{no:6,name:"created_at_map_by_actor",kind:"map",K:9,V:{kind:"message",T:S}}],{localName:"Operation_Style"}),rs=d.makeMessageType("yorkie.v1.Operation.Increase",()=>[{no:1,name:"parent_created_at",kind:"message",T:S},{no:2,name:"value",kind:"message",T:Je},{no:3,name:"executed_at",kind:"message",T:S}],{localName:"Operation_Increase"}),ss=d.makeMessageType("yorkie.v1.Operation.TreeEdit",()=>[{no:1,name:"parent_created_at",kind:"message",T:S},{no:2,name:"from",kind:"message",T:Dt},{no:3,name:"to",kind:"message",T:Dt},{no:4,name:"created_at_map_by_actor",kind:"map",K:9,V:{kind:"message",T:S}},{no:5,name:"contents",kind:"message",T:gs,repeated:!0},{no:7,name:"split_level",kind:"scalar",T:5},{no:6,name:"executed_at",kind:"message",T:S}],{localName:"Operation_TreeEdit"}),is=d.makeMessageType("yorkie.v1.Operation.TreeStyle",()=>[{no:1,name:"parent_created_at",kind:"message",T:S},{no:2,name:"from",kind:"message",T:Dt},{no:3,name:"to",kind:"message",T:Dt},{no:4,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:5,name:"executed_at",kind:"message",T:S},{no:6,name:"attributes_to_remove",kind:"scalar",T:9,repeated:!0},{no:7,name:"created_at_map_by_actor",kind:"map",K:9,V:{kind:"message",T:S}}],{localName:"Operation_TreeStyle"}),Je=d.makeMessageType("yorkie.v1.JSONElementSimple",()=>[{no:1,name:"created_at",kind:"message",T:S},{no:2,name:"moved_at",kind:"message",T:S},{no:3,name:"removed_at",kind:"message",T:S},{no:4,name:"type",kind:"enum",T:d.getEnumType(N)},{no:5,name:"value",kind:"scalar",T:12}]),de=d.makeMessageType("yorkie.v1.JSONElement",()=>[{no:1,name:"json_object",kind:"message",T:os,oneof:"body"},{no:2,name:"json_array",kind:"message",T:as,oneof:"body"},{no:3,name:"primitive",kind:"message",T:cs,oneof:"body"},{no:5,name:"text",kind:"message",T:hs,oneof:"body"},{no:6,name:"counter",kind:"message",T:us,oneof:"body"},{no:7,name:"tree",kind:"message",T:ls,oneof:"body"}]),os=d.makeMessageType("yorkie.v1.JSONElement.JSONObject",()=>[{no:1,name:"nodes",kind:"message",T:fs,repeated:!0},{no:2,name:"created_at",kind:"message",T:S},{no:3,name:"moved_at",kind:"message",T:S},{no:4,name:"removed_at",kind:"message",T:S}],{localName:"JSONElement_JSONObject"}),as=d.makeMessageType("yorkie.v1.JSONElement.JSONArray",()=>[{no:1,name:"nodes",kind:"message",T:Mn,repeated:!0},{no:2,name:"created_at",kind:"message",T:S},{no:3,name:"moved_at",kind:"message",T:S},{no:4,name:"removed_at",kind:"message",T:S}],{localName:"JSONElement_JSONArray"}),cs=d.makeMessageType("yorkie.v1.JSONElement.Primitive",()=>[{no:1,name:"type",kind:"enum",T:d.getEnumType(N)},{no:2,name:"value",kind:"scalar",T:12},{no:3,name:"created_at",kind:"message",T:S},{no:4,name:"moved_at",kind:"message",T:S},{no:5,name:"removed_at",kind:"message",T:S}],{localName:"JSONElement_Primitive"}),hs=d.makeMessageType("yorkie.v1.JSONElement.Text",()=>[{no:1,name:"nodes",kind:"message",T:ds,repeated:!0},{no:2,name:"created_at",kind:"message",T:S},{no:3,name:"moved_at",kind:"message",T:S},{no:4,name:"removed_at",kind:"message",T:S}],{localName:"JSONElement_Text"}),us=d.makeMessageType("yorkie.v1.JSONElement.Counter",()=>[{no:1,name:"type",kind:"enum",T:d.getEnumType(N)},{no:2,name:"value",kind:"scalar",T:12},{no:3,name:"created_at",kind:"message",T:S},{no:4,name:"moved_at",kind:"message",T:S},{no:5,name:"removed_at",kind:"message",T:S}],{localName:"JSONElement_Counter"}),ls=d.makeMessageType("yorkie.v1.JSONElement.Tree",()=>[{no:1,name:"nodes",kind:"message",T:$n,repeated:!0},{no:2,name:"created_at",kind:"message",T:S},{no:3,name:"moved_at",kind:"message",T:S},{no:4,name:"removed_at",kind:"message",T:S}],{localName:"JSONElement_Tree"}),fs=d.makeMessageType("yorkie.v1.RHTNode",()=>[{no:1,name:"key",kind:"scalar",T:9},{no:2,name:"element",kind:"message",T:de}]),Mn=d.makeMessageType("yorkie.v1.RGANode",()=>[{no:1,name:"next",kind:"message",T:Mn},{no:2,name:"element",kind:"message",T:de}]),un=d.makeMessageType("yorkie.v1.NodeAttr",()=>[{no:1,name:"value",kind:"scalar",T:9},{no:2,name:"updated_at",kind:"message",T:S},{no:3,name:"is_removed",kind:"scalar",T:8}]),ds=d.makeMessageType("yorkie.v1.TextNode",()=>[{no:1,name:"id",kind:"message",T:Ln},{no:2,name:"value",kind:"scalar",T:9},{no:3,name:"removed_at",kind:"message",T:S},{no:4,name:"ins_prev_id",kind:"message",T:Ln},{no:5,name:"attributes",kind:"map",K:9,V:{kind:"message",T:un}}]),Ln=d.makeMessageType("yorkie.v1.TextNodeID",()=>[{no:1,name:"created_at",kind:"message",T:S},{no:2,name:"offset",kind:"scalar",T:5}]),$n=d.makeMessageType("yorkie.v1.TreeNode",()=>[{no:1,name:"id",kind:"message",T:mt},{no:2,name:"type",kind:"scalar",T:9},{no:3,name:"value",kind:"scalar",T:9},{no:4,name:"removed_at",kind:"message",T:S},{no:5,name:"ins_prev_id",kind:"message",T:mt},{no:6,name:"ins_next_id",kind:"message",T:mt},{no:7,name:"depth",kind:"scalar",T:5},{no:8,name:"attributes",kind:"map",K:9,V:{kind:"message",T:un}}]),gs=d.makeMessageType("yorkie.v1.TreeNodes",()=>[{no:1,name:"content",kind:"message",T:$n,repeated:!0}]),mt=d.makeMessageType("yorkie.v1.TreeNodeID",()=>[{no:1,name:"created_at",kind:"message",T:S},{no:2,name:"offset",kind:"scalar",T:5}]),Dt=d.makeMessageType("yorkie.v1.TreePos",()=>[{no:1,name:"parent_id",kind:"message",T:mt},{no:2,name:"left_sibling_id",kind:"message",T:mt}]);d.makeMessageType("yorkie.v1.User",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"created_at",kind:"message",T:Z}]),d.makeMessageType("yorkie.v1.Project",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"public_key",kind:"scalar",T:9},{no:4,name:"secret_key",kind:"scalar",T:9},{no:5,name:"auth_webhook_url",kind:"scalar",T:9},{no:6,name:"auth_webhook_methods",kind:"scalar",T:9,repeated:!0},{no:7,name:"client_deactivate_threshold",kind:"scalar",T:9},{no:8,name:"created_at",kind:"message",T:Z},{no:9,name:"updated_at",kind:"message",T:Z}]),d.makeMessageType("yorkie.v1.UpdatableProjectFields",()=>[{no:1,name:"name",kind:"message",T:ae},{no:2,name:"auth_webhook_url",kind:"message",T:ae},{no:3,name:"auth_webhook_methods",kind:"message",T:Oo},{no:4,name:"client_deactivate_threshold",kind:"message",T:ae}]);const Oo=d.makeMessageType("yorkie.v1.UpdatableProjectFields.AuthWebhookMethods",()=>[{no:1,name:"methods",kind:"scalar",T:9,repeated:!0}],{localName:"UpdatableProjectFields_AuthWebhookMethods"});d.makeMessageType("yorkie.v1.DocumentSummary",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"key",kind:"scalar",T:9},{no:3,name:"snapshot",kind:"scalar",T:9},{no:4,name:"created_at",kind:"message",T:Z},{no:5,name:"accessed_at",kind:"message",T:Z},{no:6,name:"updated_at",kind:"message",T:Z}]);const _n=d.makeMessageType("yorkie.v1.PresenceChange",()=>[{no:1,name:"type",kind:"enum",T:d.getEnumType(xt)},{no:2,name:"presence",kind:"message",T:Un}]),xt=d.makeEnum("yorkie.v1.PresenceChange.ChangeType",[{no:0,name:"CHANGE_TYPE_UNSPECIFIED",localName:"UNSPECIFIED"},{no:1,name:"CHANGE_TYPE_PUT",localName:"PUT"},{no:2,name:"CHANGE_TYPE_DELETE",localName:"DELETE"},{no:3,name:"CHANGE_TYPE_CLEAR",localName:"CLEAR"}]),Un=d.makeMessageType("yorkie.v1.Presence",()=>[{no:1,name:"data",kind:"map",K:9,V:{kind:"scalar",T:9}}]),ms=d.makeMessageType("yorkie.v1.Checkpoint",()=>[{no:1,name:"server_seq",kind:"scalar",T:3,L:1},{no:2,name:"client_seq",kind:"scalar",T:13}]),nt=d.makeMessageType("yorkie.v1.TextNodePos",()=>[{no:1,name:"created_at",kind:"message",T:S},{no:2,name:"offset",kind:"scalar",T:5},{no:3,name:"relative_offset",kind:"scalar",T:5}]),S=d.makeMessageType("yorkie.v1.TimeTicket",()=>[{no:1,name:"lamport",kind:"scalar",T:3,L:1},{no:2,name:"delimiter",kind:"scalar",T:13},{no:3,name:"actor_id",kind:"scalar",T:12}]),Do=d.makeMessageType("yorkie.v1.DocEventBody",()=>[{no:1,name:"topic",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12}]),xo=d.makeMessageType("yorkie.v1.DocEvent",()=>[{no:1,name:"type",kind:"enum",T:d.getEnumType(cn)},{no:2,name:"publisher",kind:"scalar",T:9},{no:3,name:"body",kind:"message",T:Do}]),Ro=d.makeMessageType("yorkie.v1.ActivateClientRequest",()=>[{no:1,name:"client_key",kind:"scalar",T:9}]),Bo=d.makeMessageType("yorkie.v1.ActivateClientResponse",()=>[{no:1,name:"client_id",kind:"scalar",T:9}]),Mo=d.makeMessageType("yorkie.v1.DeactivateClientRequest",()=>[{no:1,name:"client_id",kind:"scalar",T:9}]),Lo=d.makeMessageType("yorkie.v1.DeactivateClientResponse",[]),$o=d.makeMessageType("yorkie.v1.AttachDocumentRequest",()=>[{no:1,name:"client_id",kind:"scalar",T:9},{no:2,name:"change_pack",kind:"message",T:Ue}]),_o=d.makeMessageType("yorkie.v1.AttachDocumentResponse",()=>[{no:1,name:"document_id",kind:"scalar",T:9},{no:2,name:"change_pack",kind:"message",T:Ue}]),Uo=d.makeMessageType("yorkie.v1.DetachDocumentRequest",()=>[{no:1,name:"client_id",kind:"scalar",T:9},{no:2,name:"document_id",kind:"scalar",T:9},{no:3,name:"change_pack",kind:"message",T:Ue},{no:4,name:"remove_if_not_attached",kind:"scalar",T:8}]),Jo=d.makeMessageType("yorkie.v1.DetachDocumentResponse",()=>[{no:2,name:"change_pack",kind:"message",T:Ue}]),Fo=d.makeMessageType("yorkie.v1.WatchDocumentRequest",()=>[{no:1,name:"client_id",kind:"scalar",T:9},{no:2,name:"document_id",kind:"scalar",T:9}]),Vo=d.makeMessageType("yorkie.v1.WatchDocumentResponse",()=>[{no:1,name:"initialization",kind:"message",T:qo,oneof:"body"},{no:2,name:"event",kind:"message",T:xo,oneof:"body"}]),qo=d.makeMessageType("yorkie.v1.WatchDocumentResponse.Initialization",()=>[{no:1,name:"client_ids",kind:"scalar",T:9,repeated:!0}],{localName:"WatchDocumentResponse_Initialization"}),jo=d.makeMessageType("yorkie.v1.RemoveDocumentRequest",()=>[{no:1,name:"client_id",kind:"scalar",T:9},{no:2,name:"document_id",kind:"scalar",T:9},{no:3,name:"change_pack",kind:"message",T:Ue}]),zo=d.makeMessageType("yorkie.v1.RemoveDocumentResponse",()=>[{no:1,name:"change_pack",kind:"message",T:Ue}]),Ko=d.makeMessageType("yorkie.v1.PushPullChangesRequest",()=>[{no:1,name:"client_id",kind:"scalar",T:9},{no:2,name:"document_id",kind:"scalar",T:9},{no:3,name:"change_pack",kind:"message",T:Ue},{no:4,name:"push_only",kind:"scalar",T:8}]),Wo=d.makeMessageType("yorkie.v1.PushPullChangesResponse",()=>[{no:1,name:"change_pack",kind:"message",T:Ue}]),Go=d.makeMessageType("yorkie.v1.BroadcastRequest",()=>[{no:1,name:"client_id",kind:"scalar",T:9},{no:2,name:"document_id",kind:"scalar",T:9},{no:3,name:"topic",kind:"scalar",T:9},{no:4,name:"payload",kind:"scalar",T:12}]),Ho=d.makeMessageType("yorkie.v1.BroadcastResponse",[]),Yo={typeName:"yorkie.v1.YorkieService",methods:{activateClient:{name:"ActivateClient",I:Ro,O:Bo,kind:te.Unary},deactivateClient:{name:"DeactivateClient",I:Mo,O:Lo,kind:te.Unary},attachDocument:{name:"AttachDocument",I:$o,O:_o,kind:te.Unary},detachDocument:{name:"DetachDocument",I:Uo,O:Jo,kind:te.Unary},removeDocument:{name:"RemoveDocument",I:jo,O:zo,kind:te.Unary},pushPullChanges:{name:"PushPullChanges",I:Ko,O:Wo,kind:te.Unary},watchDocument:{name:"WatchDocument",I:Fo,O:Vo,kind:te.ServerStreaming},broadcast:{name:"Broadcast",I:Go,O:Ho,kind:te.Unary}}};/**
 * @license
 * Copyright 2009 The Closure Library Authors
 * Copyright 2020 Daniel Wirtz / The long.js Authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */var ge=null;try{ge=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch{}function k(r,e,t){this.low=r|0,this.high=e|0,this.unsigned=!!t}k.prototype.__isLong__,Object.defineProperty(k.prototype,"__isLong__",{value:!0});function Q(r){return(r&&r.__isLong__)===!0}function ps(r){var e=Math.clz32(r&-r);return r?31-e:e}k.isLong=Q;var ys={},vs={};function rt(r,e){var t,n,s;return e?(r>>>=0,(s=0<=r&&r<256)&&(n=vs[r],n)?n:(t=x(r,0,!0),s&&(vs[r]=t),t)):(r|=0,(s=-128<=r&&r<128)&&(n=ys[r],n)?n:(t=x(r,r<0?-1:0,!1),s&&(ys[r]=t),t))}k.fromInt=rt;function me(r,e){if(isNaN(r))return e?Fe:Te;if(e){if(r<0)return Fe;if(r>=ws)return ks}else{if(r<=-bs)return ie;if(r+1>=bs)return Is}return r<0?me(-r,e).neg():x(r%pt|0,r/pt|0,e)}k.fromNumber=me;function x(r,e,t){return new k(r,e,t)}k.fromBits=x;var ln=Math.pow;function Jn(r,e,t){if(r.length===0)throw Error("empty string");if(typeof e=="number"?(t=e,e=!1):e=!!e,r==="NaN"||r==="Infinity"||r==="+Infinity"||r==="-Infinity")return e?Fe:Te;if(t=t||10,t<2||36<t)throw RangeError("radix");var n;if((n=r.indexOf("-"))>0)throw Error("interior hyphen");if(n===0)return Jn(r.substring(1),e,t).neg();for(var s=me(ln(t,8)),i=Te,o=0;o<r.length;o+=8){var a=Math.min(8,r.length-o),c=parseInt(r.substring(o,o+a),t);if(a<8){var h=me(ln(t,a));i=i.mul(h).add(me(c))}else i=i.mul(s),i=i.add(me(c))}return i.unsigned=e,i}k.fromString=Jn;function ve(r,e){return typeof r=="number"?me(r,e):typeof r=="string"?Jn(r,e):x(r.low,r.high,typeof e=="boolean"?e:r.unsigned)}k.fromValue=ve;var Ts=1<<16,Xo=1<<24,pt=Ts*Ts,ws=pt*pt,bs=ws/2,As=rt(Xo),Te=rt(0);k.ZERO=Te;var Fe=rt(0,!0);k.UZERO=Fe;var yt=rt(1);k.ONE=yt;var Ss=rt(1,!0);k.UONE=Ss;var Fn=rt(-1);k.NEG_ONE=Fn;var Is=x(-1,2147483647,!1);k.MAX_VALUE=Is;var ks=x(-1,-1,!0);k.MAX_UNSIGNED_VALUE=ks;var ie=x(0,-2147483648,!1);k.MIN_VALUE=ie;var v=k.prototype;v.toInt=function(){return this.unsigned?this.low>>>0:this.low},v.toNumber=function(){return this.unsigned?(this.high>>>0)*pt+(this.low>>>0):this.high*pt+(this.low>>>0)},v.toString=function(e){if(e=e||10,e<2||36<e)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative())if(this.eq(ie)){var t=me(e),n=this.div(t),s=n.mul(t).sub(this);return n.toString(e)+s.toInt().toString(e)}else return"-"+this.neg().toString(e);for(var i=me(ln(e,6),this.unsigned),o=this,a="";;){var c=o.div(i),h=o.sub(c.mul(i)).toInt()>>>0,f=h.toString(e);if(o=c,o.isZero())return f+a;for(;f.length<6;)f="0"+f;a=""+f+a}},v.getHighBits=function(){return this.high},v.getHighBitsUnsigned=function(){return this.high>>>0},v.getLowBits=function(){return this.low},v.getLowBitsUnsigned=function(){return this.low>>>0},v.getNumBitsAbs=function(){if(this.isNegative())return this.eq(ie)?64:this.neg().getNumBitsAbs();for(var e=this.high!=0?this.high:this.low,t=31;t>0&&(e&1<<t)==0;t--);return this.high!=0?t+33:t+1},v.isZero=function(){return this.high===0&&this.low===0},v.eqz=v.isZero,v.isNegative=function(){return!this.unsigned&&this.high<0},v.isPositive=function(){return this.unsigned||this.high>=0},v.isOdd=function(){return(this.low&1)===1},v.isEven=function(){return(this.low&1)===0},v.equals=function(e){return Q(e)||(e=ve(e)),this.unsigned!==e.unsigned&&this.high>>>31===1&&e.high>>>31===1?!1:this.high===e.high&&this.low===e.low},v.eq=v.equals,v.notEquals=function(e){return!this.eq(e)},v.neq=v.notEquals,v.ne=v.notEquals,v.lessThan=function(e){return this.comp(e)<0},v.lt=v.lessThan,v.lessThanOrEqual=function(e){return this.comp(e)<=0},v.lte=v.lessThanOrEqual,v.le=v.lessThanOrEqual,v.greaterThan=function(e){return this.comp(e)>0},v.gt=v.greaterThan,v.greaterThanOrEqual=function(e){return this.comp(e)>=0},v.gte=v.greaterThanOrEqual,v.ge=v.greaterThanOrEqual,v.compare=function(e){if(Q(e)||(e=ve(e)),this.eq(e))return 0;var t=this.isNegative(),n=e.isNegative();return t&&!n?-1:!t&&n?1:this.unsigned?e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1:this.sub(e).isNegative()?-1:1},v.comp=v.compare,v.negate=function(){return!this.unsigned&&this.eq(ie)?ie:this.not().add(yt)},v.neg=v.negate,v.add=function(e){Q(e)||(e=ve(e));var t=this.high>>>16,n=this.high&65535,s=this.low>>>16,i=this.low&65535,o=e.high>>>16,a=e.high&65535,c=e.low>>>16,h=e.low&65535,f=0,p=0,l=0,m=0;return m+=i+h,l+=m>>>16,m&=65535,l+=s+c,p+=l>>>16,l&=65535,p+=n+a,f+=p>>>16,p&=65535,f+=t+o,f&=65535,x(l<<16|m,f<<16|p,this.unsigned)},v.subtract=function(e){return Q(e)||(e=ve(e)),this.add(e.neg())},v.sub=v.subtract,v.multiply=function(e){if(this.isZero())return this;if(Q(e)||(e=ve(e)),ge){var t=ge.mul(this.low,this.high,e.low,e.high);return x(t,ge.get_high(),this.unsigned)}if(e.isZero())return this.unsigned?Fe:Te;if(this.eq(ie))return e.isOdd()?ie:Te;if(e.eq(ie))return this.isOdd()?ie:Te;if(this.isNegative())return e.isNegative()?this.neg().mul(e.neg()):this.neg().mul(e).neg();if(e.isNegative())return this.mul(e.neg()).neg();if(this.lt(As)&&e.lt(As))return me(this.toNumber()*e.toNumber(),this.unsigned);var n=this.high>>>16,s=this.high&65535,i=this.low>>>16,o=this.low&65535,a=e.high>>>16,c=e.high&65535,h=e.low>>>16,f=e.low&65535,p=0,l=0,m=0,T=0;return T+=o*f,m+=T>>>16,T&=65535,m+=i*f,l+=m>>>16,m&=65535,m+=o*h,l+=m>>>16,m&=65535,l+=s*f,p+=l>>>16,l&=65535,l+=i*h,p+=l>>>16,l&=65535,l+=o*c,p+=l>>>16,l&=65535,p+=n*f+s*h+i*c+o*a,p&=65535,x(m<<16|T,p<<16|l,this.unsigned)},v.mul=v.multiply,v.divide=function(e){if(Q(e)||(e=ve(e)),e.isZero())throw Error("division by zero");if(ge){if(!this.unsigned&&this.high===-2147483648&&e.low===-1&&e.high===-1)return this;var t=(this.unsigned?ge.div_u:ge.div_s)(this.low,this.high,e.low,e.high);return x(t,ge.get_high(),this.unsigned)}if(this.isZero())return this.unsigned?Fe:Te;var n,s,i;if(this.unsigned){if(e.unsigned||(e=e.toUnsigned()),e.gt(this))return Fe;if(e.gt(this.shru(1)))return Ss;i=Fe}else{if(this.eq(ie)){if(e.eq(yt)||e.eq(Fn))return ie;if(e.eq(ie))return yt;var o=this.shr(1);return n=o.div(e).shl(1),n.eq(Te)?e.isNegative()?yt:Fn:(s=this.sub(e.mul(n)),i=n.add(s.div(e)),i)}else if(e.eq(ie))return this.unsigned?Fe:Te;if(this.isNegative())return e.isNegative()?this.neg().div(e.neg()):this.neg().div(e).neg();if(e.isNegative())return this.div(e.neg()).neg();i=Te}for(s=this;s.gte(e);){n=Math.max(1,Math.floor(s.toNumber()/e.toNumber()));for(var a=Math.ceil(Math.log(n)/Math.LN2),c=a<=48?1:ln(2,a-48),h=me(n),f=h.mul(e);f.isNegative()||f.gt(s);)n-=c,h=me(n,this.unsigned),f=h.mul(e);h.isZero()&&(h=yt),i=i.add(h),s=s.sub(f)}return i},v.div=v.divide,v.modulo=function(e){if(Q(e)||(e=ve(e)),ge){var t=(this.unsigned?ge.rem_u:ge.rem_s)(this.low,this.high,e.low,e.high);return x(t,ge.get_high(),this.unsigned)}return this.sub(this.div(e).mul(e))},v.mod=v.modulo,v.rem=v.modulo,v.not=function(){return x(~this.low,~this.high,this.unsigned)},v.countLeadingZeros=function(){return this.high?Math.clz32(this.high):Math.clz32(this.low)+32},v.clz=v.countLeadingZeros,v.countTrailingZeros=function(){return this.low?ps(this.low):ps(this.high)+32},v.ctz=v.countTrailingZeros,v.and=function(e){return Q(e)||(e=ve(e)),x(this.low&e.low,this.high&e.high,this.unsigned)},v.or=function(e){return Q(e)||(e=ve(e)),x(this.low|e.low,this.high|e.high,this.unsigned)},v.xor=function(e){return Q(e)||(e=ve(e)),x(this.low^e.low,this.high^e.high,this.unsigned)},v.shiftLeft=function(e){return Q(e)&&(e=e.toInt()),(e&=63)===0?this:e<32?x(this.low<<e,this.high<<e|this.low>>>32-e,this.unsigned):x(0,this.low<<e-32,this.unsigned)},v.shl=v.shiftLeft,v.shiftRight=function(e){return Q(e)&&(e=e.toInt()),(e&=63)===0?this:e<32?x(this.low>>>e|this.high<<32-e,this.high>>e,this.unsigned):x(this.high>>e-32,this.high>=0?0:-1,this.unsigned)},v.shr=v.shiftRight,v.shiftRightUnsigned=function(e){return Q(e)&&(e=e.toInt()),(e&=63)===0?this:e<32?x(this.low>>>e|this.high<<32-e,this.high>>>e,this.unsigned):e===32?x(this.high,0,this.unsigned):x(this.high>>>e-32,0,this.unsigned)},v.shru=v.shiftRightUnsigned,v.shr_u=v.shiftRightUnsigned,v.rotateLeft=function(e){var t;return Q(e)&&(e=e.toInt()),(e&=63)===0?this:e===32?x(this.high,this.low,this.unsigned):e<32?(t=32-e,x(this.low<<e|this.high>>>t,this.high<<e|this.low>>>t,this.unsigned)):(e-=32,t=32-e,x(this.high<<e|this.low>>>t,this.low<<e|this.high>>>t,this.unsigned))},v.rotl=v.rotateLeft,v.rotateRight=function(e){var t;return Q(e)&&(e=e.toInt()),(e&=63)===0?this:e===32?x(this.high,this.low,this.unsigned):e<32?(t=32-e,x(this.high<<t|this.low>>>e,this.low<<t|this.high>>>e,this.unsigned)):(e-=32,t=32-e,x(this.low<<t|this.high>>>e,this.high<<t|this.low>>>e,this.unsigned))},v.rotr=v.rotateRight,v.toSigned=function(){return this.unsigned?x(this.low,this.high,!1):this},v.toUnsigned=function(){return this.unsigned?this:x(this.low,this.high,!0)},v.toBytes=function(e){return e?this.toBytesLE():this.toBytesBE()},v.toBytesLE=function(){var e=this.high,t=this.low;return[t&255,t>>>8&255,t>>>16&255,t>>>24,e&255,e>>>8&255,e>>>16&255,e>>>24]},v.toBytesBE=function(){var e=this.high,t=this.low;return[e>>>24,e>>>16&255,e>>>8&255,e&255,t>>>24,t>>>16&255,t>>>8&255,t&255]},k.fromBytes=function(e,t,n){return n?k.fromBytesLE(e,t):k.fromBytesBE(e,t)},k.fromBytesLE=function(e,t){return new k(e[0]|e[1]<<8|e[2]<<16|e[3]<<24,e[4]|e[5]<<8|e[6]<<16|e[7]<<24,t)},k.fromBytesBE=function(e,t){return new k(e[4]<<24|e[5]<<16|e[6]<<8|e[7],e[0]<<24|e[1]<<16|e[2]<<8|e[3],t)};var D=(r=>(r.Ok="ok",r.ClientNotActive="client-not-active",r.Unimplemented="unimplemented",r.Unsupported="unsupported",r.DocumentNotAttached="document-not-attached",r.DocumentNotDetached="document-not-detached",r.DocumentRemoved="document-removed",r.InvalidObjectKey="invalid-object-key",r.InvalidArgument="invalid-argument",r))(D||{});class R extends Error{constructor(e,t){super(t),u(this,"name","YorkieError"),u(this,"stack"),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}function we(r){if(r instanceof Map){const e=Array.from(r);return new Map(JSON.parse(JSON.stringify(e)))}return JSON.parse(JSON.stringify(r))}const Ns=r=>r?Object.entries(r).length===0:!0,vt=r=>{const e={};for(const[t,n]of Object.entries(r))e[t]=JSON.stringify(n);return e},Tt=r=>{const e={};for(const[t,n]of Object.entries(r))e[t]=JSON.parse(n);return e};var We=(r=>(r.Put="put",r.Clear="clear",r))(We||{});class Vn{constructor(e,t){u(this,"context"),u(this,"presence"),this.context=e,this.presence=t}set(e,t){for(const n of Object.keys(e))this.presence[n]=e[n];this.context.setPresenceChange({type:"put",presence:we(this.presence)}),this.context.setReversePresence(e,t)}get(e){return this.presence[e]}clear(){this.presence={},this.context.setPresenceChange({type:"clear"})}}const fn="000000000000000000000000",Zo="FFFFFFFFFFFFFFFFFFFFFFFF";class ne{constructor(e,t,n){u(this,"lamport"),u(this,"delimiter"),u(this,"actorID"),this.lamport=e,this.delimiter=t,this.actorID=n}static of(e,t,n){return new ne(e,t,n)}static fromStruct(e){return ne.of(k.fromString(e.lamport,!0),e.delimiter,e.actorID)}toIDString(){return`${this.lamport.toString()}:${this.actorID}:${this.delimiter}`}toStruct(){return{lamport:this.getLamportAsString(),delimiter:this.getDelimiter(),actorID:this.getActorID()}}toTestString(){return`${this.lamport.toString()}:${this.actorID.slice(-2)}:${this.delimiter}`}setActor(e){return new ne(this.lamport,this.delimiter,e)}getLamportAsString(){return this.lamport.toString()}getLamport(){return this.lamport}getDelimiter(){return this.delimiter}getActorID(){return this.actorID}after(e){return this.compare(e)>0}equals(e){return this.compare(e)===0}compare(e){if(this.lamport.greaterThan(e.lamport))return 1;if(e.lamport.greaterThan(this.lamport))return-1;const t=this.actorID.localeCompare(e.actorID);return t!==0?t:this.delimiter>e.delimiter?1:e.delimiter>this.delimiter?-1:0}}const qn=0,Qo=4294967295,ea=k.MAX_VALUE,be=new ne(k.fromNumber(0),qn,fn);new ne(k.fromNumber(1),qn+1,fn);const Rt=new ne(ea,Qo,Zo);var ce=(r=>(r[r.Trivial=0]="Trivial",r[r.Debug=1]="Debug",r[r.Info=2]="Info",r[r.Warn=3]="Warn",r[r.Error=4]="Error",r[r.Fatal=5]="Fatal",r))(ce||{});let st=2;function ta(r){st=r}const y={trivial:(...r)=>{st>0||typeof console<"u"&&console.log("YORKIE T:",...r)},debug:(...r)=>{st>1||typeof console<"u"&&console.log("YORKIE D:",...r)},info:(...r)=>{st>2||typeof console<"u"&&console.log("YORKIE I:",...r)},warn:(...r)=>{st>3||typeof console<"u"&&(typeof console.warn<"u"?console.warn("YORKIE W:",...r):console.log("YORKIE W:",...r))},error:(...r)=>{st>4||typeof console<"u"&&(typeof console.error<"u"?console.error("YORKIE E:",...r):console.log("YORKIE E:",...r))},fatal:(r,...e)=>{throw typeof console<"u"&&(typeof console.error<"u"?console.error("YORKIE F:",...e):console.log("YORKIE F:",...e)),new Error(`YORKIE F: ${r}`)},isEnabled:r=>st<=r};function Be(r){return r.replace(/["'\\\n\r\f\b\t\u2028\u2029]/g,function(e){switch(e){case'"':case"\\":return"\\"+e;case`
`:return"\\n";case"\r":return"\\r";case"\f":return"\\f";case"\b":return"\\b";case"	":return"\\t";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:return e}})}class Bt{constructor(e){u(this,"createdAt"),u(this,"movedAt"),u(this,"removedAt"),this.createdAt=e}getCreatedAt(){return this.createdAt}getID(){return this.createdAt}getMovedAt(){return this.movedAt}getRemovedAt(){return this.removedAt}getPositionedAt(){return this.movedAt?this.movedAt:this.createdAt}setMovedAt(e){return!this.movedAt||e&&e.after(this.movedAt)?(this.movedAt=e,!0):!1}setRemovedAt(e){this.removedAt=e}remove(e){return e&&e.after(this.getPositionedAt())&&(!this.removedAt||e.after(this.removedAt))?(this.removedAt=e,!0):!1}isRemoved(){return!!this.removedAt}}class Ge extends Bt{constructor(e){super(e)}}class jn{constructor(e,t){u(this,"strKey"),u(this,"value"),this.strKey=e,this.value=t}static of(e,t){return new jn(e,t)}isRemoved(){return this.value.isRemoved()}getStrKey(){return this.strKey}getValue(){return this.value}remove(e){return this.value.remove(e)}}class Mt{constructor(){u(this,"nodeMapByKey"),u(this,"nodeMapByCreatedAt"),this.nodeMapByKey=new Map,this.nodeMapByCreatedAt=new Map}static create(){return new Mt}set(e,t,n){let s;const i=this.nodeMapByKey.get(e);i!=null&&!i.isRemoved()&&i.remove(n)&&(s=i.getValue());const o=jn.of(e,t);return this.nodeMapByCreatedAt.set(t.getCreatedAt().toIDString(),o),(i==null||n.after(i.getValue().getPositionedAt()))&&(this.nodeMapByKey.set(e,o),t.setMovedAt(n)),s}delete(e,t){this.nodeMapByCreatedAt.has(e.toIDString())||y.fatal(`fail to find ${e.toIDString()}`);const n=this.nodeMapByCreatedAt.get(e.toIDString());return n.remove(t),n.getValue()}subPathOf(e){const t=this.nodeMapByCreatedAt.get(e.toIDString());if(!!t)return t.getStrKey()}purge(e){const t=this.nodeMapByCreatedAt.get(e.getCreatedAt().toIDString());if(!t){y.fatal(`fail to find ${e.getCreatedAt().toIDString()}`);return}const n=this.nodeMapByKey.get(t.getStrKey());t===n&&this.nodeMapByKey.delete(n.getStrKey()),this.nodeMapByCreatedAt.delete(t.getValue().getCreatedAt().toIDString())}deleteByKey(e,t){const n=this.nodeMapByKey.get(e);if(n!=null&&!!n.remove(t))return n.getValue()}has(e){const t=this.nodeMapByKey.get(e);return t==null?!1:!t.isRemoved()}getByID(e){return this.nodeMapByCreatedAt.get(e.toIDString())}get(e){const t=this.nodeMapByKey.get(e);if(!(!t||t.isRemoved()))return t}*[Symbol.iterator](){for(const[,e]of this.nodeMapByKey)yield e}}class oe extends Ge{constructor(e,t){super(e),u(this,"memberNodes"),this.memberNodes=t}static create(e,t){if(!t)return new oe(e,Mt.create());const n=Mt.create();for(const[s,i]of Object.entries(t))n.set(s,i.deepcopy(),i.getCreatedAt());return new oe(e,n)}subPathOf(e){return this.memberNodes.subPathOf(e)}purge(e){this.memberNodes.purge(e)}set(e,t,n){return this.memberNodes.set(e,t,n)}delete(e,t){return this.memberNodes.delete(e,t)}deleteByKey(e,t){return this.memberNodes.deleteByKey(e,t)}get(e){const t=this.memberNodes.get(e);return t==null?void 0:t.getValue()}getByID(e){const t=this.memberNodes.getByID(e);return t==null?void 0:t.getValue()}has(e){return this.memberNodes.has(e)}toJSON(){const e=[];for(const[t,n]of this)e.push(`"${Be(t)}":${n.toJSON()}`);return`{${e.join(",")}}`}toJS(){return JSON.parse(this.toJSON())}toJSForTest(){const e={};for(const[t,n]of this){const{createdAt:s,value:i,type:o}=n.toJSForTest();e[t]={key:t,createdAt:s,value:i,type:o}}return{createdAt:this.getCreatedAt().toTestString(),value:e,type:"YORKIE_OBJECT"}}getKeys(){const e=Array();for(const[t]of this)e.push(t);return e}toSortedJSON(){var e;const t=Array();for(const[s]of this)t.push(s);const n=[];for(const s of t.sort()){const i=(e=this.memberNodes.get(s))==null?void 0:e.getValue();n.push(`"${Be(s)}":${i.toSortedJSON()}`)}return`{${n.join(",")}}`}getRHT(){return this.memberNodes}deepcopy(){const e=oe.create(this.getCreatedAt());for(const t of this.memberNodes)e.memberNodes.set(t.getStrKey(),t.getValue().deepcopy(),this.getPositionedAt());return e.remove(this.getRemovedAt()),e}getDescendants(e){for(const t of this.memberNodes){const n=t.getValue();if(e(n,this))return;n instanceof Ge&&n.getDescendants(e)}}*[Symbol.iterator](){const e=new Set;for(const t of this.memberNodes)e.has(t.getStrKey())||(e.add(t.getStrKey()),t.isRemoved()||(yield[t.getStrKey(),t.getValue()]))}}var M=(r=>(r.Local="local",r.Remote="remote",r.UndoRedo="undoredo",r))(M||{});class Ae{constructor(e,t){u(this,"parentCreatedAt"),u(this,"executedAt"),this.parentCreatedAt=e,this.executedAt=t}getParentCreatedAt(){return this.parentCreatedAt}getExecutedAt(){if(!this.executedAt)throw new Error("executedAt has not been set yet");return this.executedAt}setActor(e){this.executedAt&&(this.executedAt=this.executedAt.setActor(e))}setExecutedAt(e){this.executedAt=e}}class Cs{constructor(e){u(this,"value"),u(this,"left"),u(this,"right"),u(this,"parent"),u(this,"weight"),this.value=e,this.initWeight()}getNodeString(){return`${this.weight}${this.value}`}getValue(){return this.value}getLeftWeight(){return this.hasLeft()?this.left.getWeight():0}getRightWeight(){return this.hasRight()?this.right.getWeight():0}getWeight(){return this.weight}getLeft(){return this.left}getRight(){return this.right}getParent(){return this.parent}hasLeft(){return!!this.left}hasRight(){return!!this.right}hasParent(){return!!this.parent}setLeft(e){this.left=e}setRight(e){this.right=e}setParent(e){this.parent=e}unlink(){this.parent=void 0,this.right=void 0,this.left=void 0}hasLinks(){return this.hasParent()||this.hasLeft()||this.hasRight()}increaseWeight(e){this.weight+=e}initWeight(){this.weight=this.getLength()}}class Lt{constructor(e){u(this,"root"),this.root=e}get length(){return this.root?this.root.getWeight():0}find(e){if(!this.root||e<0)return[void 0,0];let t=this.root;for(;;)if(t.hasLeft()&&e<=t.getLeftWeight())t=t.getLeft();else if(t.hasRight()&&t.getLeftWeight()+t.getLength()<e)e-=t.getLeftWeight()+t.getLength(),t=t.getRight();else{e-=t.getLeftWeight();break}return e>t.getLength()&&y.fatal(`out of index range: pos: ${e} > node.length: ${t.getLength()}`),[t,e]}indexOf(e){if(!e||e!==this.root&&!e.hasLinks())return-1;let t=0,n=e,s;for(;n;)(!s||s===n.getRight())&&(t+=n.getLength()+(n.hasLeft()?n.getLeftWeight():0)),s=n,n=n.getParent();return t-e.getLength()}getRoot(){return this.root}insert(e){return this.insertAfter(this.root,e)}insertAfter(e,t){return e?(this.splayNode(e),this.root=t,t.setRight(e.getRight()),e.hasRight()&&e.getRight().setParent(t),t.setLeft(e),e.setParent(t),e.setRight(),this.updateWeight(e),this.updateWeight(t),t):(this.root=t,t)}updateWeight(e){e.initWeight(),e.hasLeft()&&e.increaseWeight(e.getLeftWeight()),e.hasRight()&&e.increaseWeight(e.getRightWeight())}updateTreeWeight(e){for(;e;)this.updateWeight(e),e=e.getParent()}splayNode(e){if(!!e)for(;;)if(this.isLeftChild(e.getParent())&&this.isRightChild(e))this.rotateLeft(e),this.rotateRight(e);else if(this.isRightChild(e.getParent())&&this.isLeftChild(e))this.rotateRight(e),this.rotateLeft(e);else if(this.isLeftChild(e.getParent())&&this.isLeftChild(e))this.rotateRight(e.getParent()),this.rotateRight(e);else if(this.isRightChild(e.getParent())&&this.isRightChild(e))this.rotateLeft(e.getParent()),this.rotateLeft(e);else{this.isLeftChild(e)?this.rotateRight(e):this.isRightChild(e)&&this.rotateLeft(e),this.updateWeight(e);return}}delete(e){this.splayNode(e);const t=new Lt(e.getLeft());t.root&&t.root.setParent();const n=new Lt(e.getRight());if(n.root&&n.root.setParent(),t.root){const s=t.getRightmost();t.splayNode(s),t.root.setRight(n.root),n.root&&n.root.setParent(t.root),this.root=t.root}else this.root=n.root;e.unlink(),this.root&&this.updateWeight(this.root)}deleteRange(e,t){if(!t){this.splayNode(e),this.cutOffRight(e);return}this.splayNode(e),this.splayNode(t),t.getLeft()!=e&&this.rotateRight(e),this.cutOffRight(e)}cutOffRight(e){const t=[];this.traversePostorder(e.getRight(),t);for(const n of t)n.initWeight();this.updateTreeWeight(e)}toTestString(){const e=[];return this.traverseInorder(this.root,e),e.map(t=>`[${t.getWeight()},${t.getLength()}]${t.getValue()||""}`).join("")}checkWeight(){const e=[];this.traverseInorder(this.root,e);for(const t of e)if(t.getWeight()!=t.getLength()+t.getLeftWeight()+t.getRightWeight())return!1;return!0}getRightmost(){let e=this.root;for(;e.hasRight();)e=e.getRight();return e}traverseInorder(e,t){!e||(this.traverseInorder(e.getLeft(),t),t.push(e),this.traverseInorder(e.getRight(),t))}traversePostorder(e,t){!e||(this.traversePostorder(e.getLeft(),t),this.traversePostorder(e.getRight(),t),t.push(e))}rotateLeft(e){const t=e.getParent();t.hasParent()?t===t.getParent().getLeft()?t.getParent().setLeft(e):t.getParent().setRight(e):this.root=e,e.setParent(t.getParent()),t.setRight(e.getLeft()),t.hasRight()&&t.getRight().setParent(t),e.setLeft(t),e.getLeft().setParent(e),this.updateWeight(t),this.updateWeight(e)}rotateRight(e){const t=e.getParent();t.hasParent()?t===t.getParent().getLeft()?t.getParent().setLeft(e):t.getParent().setRight(e):this.root=e,e.setParent(t.getParent()),t.setLeft(e.getRight()),t.hasLeft()&&t.getLeft().setParent(t),e.setRight(t),e.getRight().setParent(e),this.updateWeight(t),this.updateWeight(e)}isLeftChild(e){return e&&e.hasParent()?e.getParent().getLeft()===e:!1}isRightChild(e){return e&&e.hasParent()?e.getParent().getRight()===e:!1}}var H=(r=>(r[r.Null=0]="Null",r[r.Boolean=1]="Boolean",r[r.Integer=2]="Integer",r[r.Long=3]="Long",r[r.Double=4]="Double",r[r.String=5]="String",r[r.Bytes=6]="Bytes",r[r.Date=7]="Date",r))(H||{});class U extends Bt{constructor(e,t){super(t),u(this,"valueType"),u(this,"value"),this.valueType=U.getPrimitiveType(e),this.value=e===void 0?null:e}static of(e,t){return new U(e,t)}static valueFromBytes(e,t){switch(e){case 0:return null;case 1:return!!t[0];case 2:return t[0]|t[1]<<8|t[2]<<16|t[3]<<24;case 4:{const n=new DataView(t.buffer);return t.forEach(function(s,i){n.setUint8(i,s)}),n.getFloat64(0,!0)}case 5:return new TextDecoder("utf-8").decode(t);case 3:return k.fromBytesLE(Array.from(t));case 6:return t;case 7:return new Date(k.fromBytesLE(Array.from(t),!0).toNumber());default:throw new R(D.Unimplemented,`unimplemented type: ${e}`)}}toJSON(){return this.valueType===5?`"${Be(this.value)}"`:`${this.value}`}toSortedJSON(){return this.toJSON()}toJSForTest(){return{createdAt:this.getCreatedAt().toTestString(),value:this.value,type:"YORKIE_PRIMITIVE"}}deepcopy(){const e=U.of(this.value,this.getCreatedAt());return e.setMovedAt(this.getMovedAt()),e.setRemovedAt(this.getRemovedAt()),e}getType(){return this.valueType}static getPrimitiveType(e){switch(typeof e){case"undefined":return 0;case"boolean":return 1;case"number":return this.isInteger(e)?2:4;case"string":return 5;case"object":if(e===null)return 0;if(e instanceof k)return 3;if(e instanceof Uint8Array)return 6;if(e instanceof Date)return 7}}static isSupport(e){return U.getPrimitiveType(e)!==void 0}static isInteger(e){return e%1===0}isNumericType(){const e=this.valueType;return e===2||e===3||e===4}getValue(){return this.value}toBytes(){switch(this.valueType){case 0:return new Uint8Array;case 1:return this.value?new Uint8Array([1]):new Uint8Array([0]);case 2:{const e=this.value;return new Uint8Array([e&255,e>>8&255,e>>16&255,e>>24&255])}case 4:{const e=this.value,t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),t}case 5:return new TextEncoder().encode(this.value);case 3:{const t=this.value.toBytesLE();return Uint8Array.from(t)}case 6:return this.value;case 7:{const e=this.value,t=k.fromNumber(e.getTime(),!0).toBytesLE();return Uint8Array.from(t)}default:throw new R(D.Unimplemented,`unimplemented type: ${this.valueType}`)}}}class dn extends Cs{constructor(e){super(e),u(this,"prev"),u(this,"next"),this.value=e}static createAfter(e,t){const n=new dn(t),s=e.next;return e.next=n,n.prev=e,n.next=s,s&&(s.prev=n),n}remove(e){return this.value.remove(e)}getCreatedAt(){return this.value.getCreatedAt()}getPositionedAt(){return this.value.getPositionedAt()}release(){this.prev&&(this.prev.next=this.next),this.next&&(this.next.prev=this.prev),this.prev=void 0,this.next=void 0}getLength(){return this.value.isRemoved()?0:1}getPrev(){return this.prev}getNext(){return this.next}getValue(){return this.value}isRemoved(){return this.value.isRemoved()}}class $t{constructor(){u(this,"dummyHead"),u(this,"last"),u(this,"nodeMapByIndex"),u(this,"nodeMapByCreatedAt");const e=U.of(0,be);e.setRemovedAt(be),this.dummyHead=new dn(e),this.last=this.dummyHead,this.nodeMapByIndex=new Lt,this.nodeMapByCreatedAt=new Map,this.nodeMapByIndex.insert(this.dummyHead),this.nodeMapByCreatedAt.set(this.dummyHead.getCreatedAt().toIDString(),this.dummyHead)}static create(){return new $t}get length(){return this.nodeMapByIndex.length}findNextBeforeExecutedAt(e,t){let n=this.nodeMapByCreatedAt.get(e.toIDString());for(n||y.fatal(`cant find the given node: ${e.toIDString()}`);n.getNext()&&n.getNext().getPositionedAt().after(t);)n=n.getNext();return n}release(e){this.last===e&&(this.last=e.getPrev()),e.release(),this.nodeMapByIndex.delete(e),this.nodeMapByCreatedAt.delete(e.getValue().getCreatedAt().toIDString())}insertAfter(e,t,n=t.getCreatedAt()){const s=this.findNextBeforeExecutedAt(e,n),i=dn.createAfter(s,t);s===this.last&&(this.last=i),this.nodeMapByIndex.insertAfter(s,i),this.nodeMapByCreatedAt.set(i.getCreatedAt().toIDString(),i)}moveAfter(e,t,n){const s=this.nodeMapByCreatedAt.get(e.toIDString());s||y.fatal(`cant find the given node: ${e.toIDString()}`);const i=this.nodeMapByCreatedAt.get(t.toIDString());i||y.fatal(`cant find the given node: ${t.toIDString()}`),s!==i&&(!i.getValue().getMovedAt()||n.after(i.getValue().getMovedAt()))&&(this.release(i),this.insertAfter(s.getCreatedAt(),i.getValue(),n),i.getValue().setMovedAt(n))}insert(e){this.insertAfter(this.last.getCreatedAt(),e)}getByID(e){return this.nodeMapByCreatedAt.get(e.toIDString())}subPathOf(e){const t=this.nodeMapByCreatedAt.get(e.toIDString());if(!!t)return String(this.nodeMapByIndex.indexOf(t))}purge(e){const t=this.nodeMapByCreatedAt.get(e.getCreatedAt().toIDString());t||y.fatal(`fail to find the given createdAt: ${e.getCreatedAt().toIDString()}`),this.release(t)}getByIndex(e){if(e>=this.length)return;const[t,n]=this.nodeMapByIndex.find(e);let s=t;if(e===0&&t===this.dummyHead||n>0)do s&&(s=s.getNext());while(s&&s.isRemoved());return s}getPrevCreatedAt(e){let t=this.nodeMapByCreatedAt.get(e.toIDString());do t=t.getPrev();while(this.dummyHead!==t&&t.isRemoved());return t.getValue().getCreatedAt()}delete(e,t){const n=this.nodeMapByCreatedAt.get(e.toIDString()),s=n.isRemoved();return n.remove(t)&&!s&&this.nodeMapByIndex.splayNode(n),n.getValue()}deleteByIndex(e,t){const n=this.getByIndex(e);if(!!n)return n.remove(t)&&this.nodeMapByIndex.splayNode(n),n.getValue()}getHead(){return this.dummyHead.getValue()}getLast(){return this.last.getValue()}getLastCreatedAt(){return this.last.getCreatedAt()}toTestString(){const e=[];for(const t of this){const n=`${t.getCreatedAt().toIDString()}:${t.getValue().toJSON()}`;t.isRemoved()?e.push(`{${n}}`):e.push(`[${n}]`)}return e.join("")}*[Symbol.iterator](){let e=this.dummyHead.getNext();for(;e;)yield e,e=e.getNext()}}class he extends Ge{constructor(e,t){super(e),u(this,"elements"),this.elements=t}static create(e,t){if(!t)return new he(e,$t.create());const n=$t.create();for(const s of t)n.insertAfter(n.getLastCreatedAt(),s.deepcopy());return new he(e,n)}subPathOf(e){return this.elements.subPathOf(e)}purge(e){this.elements.purge(e)}insertAfter(e,t){this.elements.insertAfter(e,t)}moveAfter(e,t,n){this.elements.moveAfter(e,t,n)}get(e){const t=this.elements.getByIndex(e);return t==null?void 0:t.getValue()}getByID(e){const t=this.elements.getByID(e);return t==null?void 0:t.getValue()}getHead(){return this.elements.getHead()}getLast(){return this.elements.getLast()}getPrevCreatedAt(e){return this.elements.getPrevCreatedAt(e)}delete(e,t){return this.elements.delete(e,t)}deleteByIndex(e,t){return this.elements.deleteByIndex(e,t)}getLastCreatedAt(){return this.elements.getLastCreatedAt()}get length(){return this.elements.length}*[Symbol.iterator](){for(const e of this.elements)e.isRemoved()||(yield e.getValue())}toTestString(){return this.elements.toTestString()}getDescendants(e){for(const t of this.elements){const n=t.getValue();if(e(n,this))return;n instanceof Ge&&n.getDescendants(e)}}toJSON(){const e=[];for(const t of this)e.push(t.toJSON());return`[${e.join(",")}]`}toJS(){return JSON.parse(this.toJSON())}toJSForTest(){const e={};for(let t=0;t<this.length;t++){const{createdAt:n,value:s,type:i}=this.get(t).toJSForTest();e[t]={key:String(t),createdAt:n,value:s,type:i}}return{createdAt:this.getCreatedAt().toTestString(),value:e,type:"YORKIE_ARRAY"}}toSortedJSON(){return this.toJSON()}getElements(){return this.elements}deepcopy(){const e=he.create(this.getCreatedAt());for(const t of this.elements)e.elements.insertAfter(e.getLastCreatedAt(),t.getValue().deepcopy());return e.remove(this.getRemovedAt()),e}}class He extends Ae{constructor(e,t,n){super(e,n),u(this,"createdAt"),this.createdAt=t}static create(e,t,n){return new He(e,t,n)}execute(e,t){var n;const s=e.findByCreatedAt(this.getParentCreatedAt());if(s||y.fatal(`fail to find ${this.getParentCreatedAt()}`),s instanceof Ge||y.fatal(`only object and array can execute remove: ${s}`),t===M.UndoRedo){let h=s.getByID(this.createdAt);for(;h;){if(h.getRemovedAt())return;h=(n=e.findElementPairByCreatedAt(h.getCreatedAt()))==null?void 0:n.parent}}const i=s.subPathOf(this.createdAt),o=this.toReverseOperation(s),a=s.delete(this.createdAt,this.getExecutedAt());return e.registerRemovedElement(a),{opInfos:s instanceof he?[{type:"remove",path:e.createPath(this.getParentCreatedAt()),index:Number(i)}]:[{type:"remove",path:e.createPath(this.getParentCreatedAt()),key:i}],reverseOp:o}}toReverseOperation(e){if(e instanceof oe){const t=e.subPathOf(this.createdAt);if(t!==void 0){const n=e.get(t);if(n!==void 0)return it.create(t,n.deepcopy(),this.getParentCreatedAt())}}}getEffectedCreatedAt(){return this.getParentCreatedAt()}toTestString(){return`${this.getParentCreatedAt().toTestString()}.REMOVE.${this.createdAt.toTestString()}`}getCreatedAt(){return this.createdAt}}class it extends Ae{constructor(e,t,n,s){super(n,s),u(this,"key"),u(this,"value"),this.key=e,this.value=t}static create(e,t,n,s){return new it(e,t,n,s)}execute(e,t){var n;const s=e.findByCreatedAt(this.getParentCreatedAt());if(s||y.fatal(`fail to find ${this.getParentCreatedAt()}`),s instanceof oe||y.fatal("fail to execute, only object can execute set"),t===M.UndoRedo){let h=s;for(;h;){if(h.getRemovedAt())return;h=(n=e.findElementPairByCreatedAt(h.getCreatedAt()))==null?void 0:n.parent}}const i=s.get(this.key),o=this.toReverseOperation(i),a=this.value.deepcopy(),c=s.set(this.key,a,this.getExecutedAt());return t===M.UndoRedo&&e.findByCreatedAt(a.getCreatedAt())&&e.deregisterElement(a),e.registerElement(a,s),c&&e.registerRemovedElement(c),{opInfos:[{type:"set",path:e.createPath(this.getParentCreatedAt()),key:this.key}],reverseOp:o}}toReverseOperation(e){let t=He.create(this.getParentCreatedAt(),this.value.getCreatedAt());return e!==void 0&&!e.isRemoved()&&(t=it.create(this.key,e.deepcopy(),this.getParentCreatedAt())),t}getEffectedCreatedAt(){return this.value.getCreatedAt()}toTestString(){return`${this.getParentCreatedAt().toTestString()}.SET.${this.key}=${this.value.toSortedJSON()}`}getKey(){return this.key}getValue(){return this.value}}class _t extends Ae{constructor(e,t,n,s){super(e,s),u(this,"prevCreatedAt"),u(this,"value"),this.prevCreatedAt=t,this.value=n}static create(e,t,n,s){return new _t(e,t,n,s)}execute(e){const t=e.findByCreatedAt(this.getParentCreatedAt());t||y.fatal(`fail to find ${this.getParentCreatedAt()}`),t instanceof he||y.fatal("fail to execute, only array can execute add");const n=t,s=this.value.deepcopy();return n.insertAfter(this.prevCreatedAt,s),e.registerElement(s,n),{opInfos:[{type:"add",path:e.createPath(this.getParentCreatedAt()),index:Number(n.subPathOf(this.getEffectedCreatedAt()))}]}}getEffectedCreatedAt(){return this.value.getCreatedAt()}toTestString(){return`${this.getParentCreatedAt().toTestString()}.ADD.${this.value.toJSON()}`}getPrevCreatedAt(){return this.prevCreatedAt}getValue(){return this.value}}class Ye extends Ae{constructor(e,t,n,s){super(e,s),u(this,"prevCreatedAt"),u(this,"createdAt"),this.prevCreatedAt=t,this.createdAt=n}static create(e,t,n,s){return new Ye(e,t,n,s)}execute(e){const t=e.findByCreatedAt(this.getParentCreatedAt());t||y.fatal(`fail to find ${this.getParentCreatedAt()}`),t instanceof he||y.fatal("fail to execute, only array can execute move");const n=t,s=Number(n.subPathOf(this.createdAt));n.moveAfter(this.prevCreatedAt,this.createdAt,this.getExecutedAt());const i=Number(n.subPathOf(this.createdAt));return{opInfos:[{type:"move",path:e.createPath(this.getParentCreatedAt()),index:i,previousIndex:s}]}}getEffectedCreatedAt(){return this.createdAt}toTestString(){return`${this.getParentCreatedAt().toTestString()}.MOVE`}getPrevCreatedAt(){return this.prevCreatedAt}getCreatedAt(){return this.createdAt}}class ot{constructor(e,t,n,s){u(this,"key"),u(this,"value"),u(this,"updatedAt"),u(this,"_isRemoved"),this.key=e,this.value=t,this.updatedAt=n,this._isRemoved=s}static of(e,t,n,s){return new ot(e,t,n,s)}getKey(){return this.key}getValue(){return this.value}getUpdatedAt(){return this.updatedAt}isRemoved(){return this._isRemoved}toIDString(){return`${this.updatedAt.toIDString()}:${this.key}`}getRemovedAt(){if(this._isRemoved)return this.updatedAt}}class Ve{constructor(){u(this,"nodeMapByKey"),u(this,"numberOfRemovedElement"),this.nodeMapByKey=new Map,this.numberOfRemovedElement=0}static create(){return new Ve}getNodeMapByKey(){return this.nodeMapByKey}set(e,t,n){const s=this.nodeMapByKey.get(e);if(s&&s.isRemoved()&&n.after(s.getUpdatedAt())&&(this.numberOfRemovedElement-=1),s===void 0||n.after(s.getUpdatedAt())){const i=ot.of(e,t,n,!1);return this.nodeMapByKey.set(e,i),s!==void 0&&s.isRemoved()?[s,i]:[void 0,i]}return s.isRemoved()?[s,void 0]:[void 0,void 0]}setInternal(e,t,n,s){const i=ot.of(e,t,n,s);this.nodeMapByKey.set(e,i),s&&this.numberOfRemovedElement++}remove(e,t){const n=this.nodeMapByKey.get(e),s=[];if(n===void 0||t.after(n.getUpdatedAt())){if(n===void 0){this.numberOfRemovedElement+=1;const a=ot.of(e,"",t,!0);return this.nodeMapByKey.set(e,a),s.push(a),s}const i=n.isRemoved();i||(this.numberOfRemovedElement+=1),i&&s.push(n);const o=ot.of(e,n.getValue(),t,!0);return this.nodeMapByKey.set(e,o),s.push(o),s}return s}has(e){if(this.nodeMapByKey.has(e)){const t=this.nodeMapByKey.get(e);return t!==void 0&&!t.isRemoved()}return!1}get(e){if(!!this.nodeMapByKey.has(e))return this.nodeMapByKey.get(e).getValue()}deepcopy(){const e=new Ve;for(const[,t]of this.nodeMapByKey)e.setInternal(t.getKey(),t.getValue(),t.getUpdatedAt(),t.isRemoved());return e}toJSON(){if(!this.size())return"{}";const e=[];for(const[t,n]of this.nodeMapByKey)n.isRemoved()||e.push(`"${Be(t)}":"${Be(n.getValue())}"`);return`{${e.join(",")}}`}size(){return this.nodeMapByKey.size-this.numberOfRemovedElement}toObject(){const e={};for(const[t,n]of this.nodeMapByKey)n.isRemoved()||(e[t]=n.getValue());return e}*[Symbol.iterator](){for(const[,e]of this.nodeMapByKey)yield e}purge(e){const t=this.nodeMapByKey.get(e.getKey());t==null||t.toIDString()!=e.toIDString()||(this.nodeMapByKey.delete(e.getKey()),this.numberOfRemovedElement--)}}class Ut{constructor(e){u(this,"attributes"),u(this,"content"),this.attributes=Ve.create(),this.content=e}static create(e){return new Ut(e)}get length(){return this.content.length}substring(e,t){const n=new Ut(this.content.substring(e,t));return n.attributes=this.attributes.deepcopy(),n}setAttr(e,t,n){return this.attributes.set(e,t,n)}getAttrs(){return this.attributes}toString(){return this.content}toJSON(){const e=Be(this.content),t=this.attributes.toObject(),n=[];for(const[s,i]of Object.entries(t)){const o=JSON.parse(i),a=typeof o=="string"?`"${Be(s)}":"${Be(o)}"`:`"${Be(s)}":${String(o)}`;n.push(a)}return n.sort(),n.length===0?`{"val":"${e}"}`:`{"attrs":{${n.join(",")}},"val":"${e}"}`}getAttributes(){return this.attributes.toObject()}getContent(){return this.content}purge(e){this.attributes&&e instanceof ot&&this.attributes.purge(e)}getGCPairs(){const e=[];for(const t of this.attributes)t.getRemovedAt()&&e.push({parent:this,child:t});return e}}class pe extends Bt{constructor(e,t){super(t),u(this,"rgaTreeSplit"),this.rgaTreeSplit=e}static create(e,t){return new pe(e,t)}edit(e,t,n,s,i){const o=t?Ut.create(t):void 0;if(o&&s)for(const[l,m]of Object.entries(s))o.setAttr(l,m,n);const[a,c,h,f]=this.rgaTreeSplit.edit(e,n,o,i),p=f.map(l=>({...l,value:l.value?{attributes:Tt(l.value.getAttributes()),content:l.value.getContent()}:{attributes:void 0,content:""},type:"content"}));return[c,p,h,[a,a]]}setStyle(e,t,n,s){const[,i]=this.rgaTreeSplit.findNodeWithSplit(e[1],n),[,o]=this.rgaTreeSplit.findNodeWithSplit(e[0],n),a=[],c=this.rgaTreeSplit.findBetween(o,i),h=new Map,f=[];for(const l of c){const m=l.getCreatedAt().getActorID(),T=s!=null&&s.size?s.has(m)?s.get(m):be:Rt;if(l.canStyle(n,T)){const w=h.get(m),b=l.getCreatedAt();(!w||b.after(w))&&h.set(m,b),f.push(l)}}const p=[];for(const l of f){if(l.isRemoved())continue;const[m,T]=this.rgaTreeSplit.findIndexesFromRange(l.createPosRange());a.push({type:"style",actor:n.getActorID(),from:m,to:T,value:{attributes:Tt(t)}});for(const[w,b]of Object.entries(t)){const[C]=l.getValue().setAttr(w,b,n);C!==void 0&&p.push({parent:l.getValue(),child:C})}}return[h,p,a]}indexRangeToPosRange(e,t){const n=this.rgaTreeSplit.indexToPos(e);return e===t?[n,n]:[n,this.rgaTreeSplit.indexToPos(t)]}get length(){return this.rgaTreeSplit.length}checkWeight(){return this.rgaTreeSplit.checkWeight()}toJSON(){const e=[];for(const t of this.rgaTreeSplit)t.isRemoved()||e.push(t.getValue().toJSON());return`[${e.join(",")}]`}toSortedJSON(){return this.toJSON()}toJSForTest(){return{createdAt:this.getCreatedAt().toTestString(),value:JSON.parse(this.toJSON()),type:"YORKIE_TEXT"}}toString(){return this.rgaTreeSplit.toString()}values(){const e=[];for(const t of this.rgaTreeSplit)if(!t.isRemoved()){const n=t.getValue();e.push({attributes:Tt(n.getAttributes()),content:n.getContent()})}return e}getRGATreeSplit(){return this.rgaTreeSplit}toTestString(){return this.rgaTreeSplit.toTestString()}deepcopy(){const e=new pe(this.rgaTreeSplit.deepcopy(),this.getCreatedAt());return e.remove(this.getRemovedAt()),e}findIndexesFromRange(e){return this.rgaTreeSplit.findIndexesFromRange(e)}getGCPairs(){const e=[];for(const t of this.rgaTreeSplit){t.getRemovedAt()&&e.push({parent:this.rgaTreeSplit,child:t});for(const n of t.getValue().getGCPairs())e.push(n)}return e}}class Jt extends Ae{constructor(e,t,n,s,i,o,a){super(e,a),u(this,"fromPos"),u(this,"toPos"),u(this,"maxCreatedAtMapByActor"),u(this,"content"),u(this,"attributes"),this.fromPos=t,this.toPos=n,this.maxCreatedAtMapByActor=s,this.content=i,this.attributes=o}static create(e,t,n,s,i,o,a){return new Jt(e,t,n,s,i,o,a)}execute(e){const t=e.findByCreatedAt(this.getParentCreatedAt());t||y.fatal(`fail to find ${this.getParentCreatedAt()}`),t instanceof pe||y.fatal("fail to execute, only Text can execute edit");const n=t,[,s,i]=n.edit([this.fromPos,this.toPos],this.content,this.getExecutedAt(),Object.fromEntries(this.attributes),this.maxCreatedAtMapByActor);for(const o of i)e.registerGCPair(o);return{opInfos:s.map(({from:o,to:a,value:c})=>({type:"edit",from:o,to:a,value:c,path:e.createPath(this.getParentCreatedAt())}))}}getEffectedCreatedAt(){return this.getParentCreatedAt()}toTestString(){const e=this.getParentCreatedAt().toTestString(),t=this.fromPos.toTestString(),n=this.toPos.toTestString(),s=this.content;return`${e}.EDIT(${t},${n},${s})`}getFromPos(){return this.fromPos}getToPos(){return this.toPos}getContent(){return this.content}getAttributes(){return this.attributes||new Map}getMaxCreatedAtMapByActor(){return this.maxCreatedAtMapByActor}}class Ft extends Ae{constructor(e,t,n,s,i,o){super(e,o),u(this,"fromPos"),u(this,"toPos"),u(this,"maxCreatedAtMapByActor"),u(this,"attributes"),this.fromPos=t,this.toPos=n,this.maxCreatedAtMapByActor=s,this.attributes=i}static create(e,t,n,s,i,o){return new Ft(e,t,n,s,i,o)}execute(e){const t=e.findByCreatedAt(this.getParentCreatedAt());t||y.fatal(`fail to find ${this.getParentCreatedAt()}`),t instanceof pe||y.fatal("fail to execute, only Text can execute edit");const n=t,[,s,i]=n.setStyle([this.fromPos,this.toPos],this.attributes?Object.fromEntries(this.attributes):{},this.getExecutedAt(),this.maxCreatedAtMapByActor);for(const o of s)e.registerGCPair(o);return{opInfos:i.map(({from:o,to:a,value:c})=>({type:"style",from:o,to:a,value:c,path:e.createPath(this.getParentCreatedAt())}))}}getEffectedCreatedAt(){return this.getParentCreatedAt()}toTestString(){const e=this.getParentCreatedAt().toTestString(),t=this.fromPos.toTestString(),n=this.toPos.toTestString(),s=this.attributes;return`${e}.STYL(${t},${n},${JSON.stringify(s)})`}getFromPos(){return this.fromPos}getToPos(){return this.toPos}getAttributes(){return this.attributes}getMaxCreatedAtMapByActor(){return this.maxCreatedAtMapByActor}}const na=2,ra="root",qe="text";function Vt(r,e){let t=0;const n=r.children;for(let s=0;s<e;s++){const i=n[s];!i||i.isRemoved||(t+=i.paddedSize)}return t}class sa{constructor(e,t=[]){if(u(this,"type"),u(this,"parent"),u(this,"_children"),u(this,"size"),this.type=e,this.size=0,this._children=t,this.isText&&this._children.length>0)throw new Error(`Text node cannot have children: ${this.type}`)}updateAncestorsSize(){let e=this.parent;const t=this.isRemoved?-1:1;for(;e&&(e.size+=this.paddedSize*t,!e.isRemoved);)e=e.parent}updateDescendantsSize(){let e=0;for(const t of this._children){const n=t.updateDescendantsSize();t.isRemoved||(e+=n)}return this.size+=e,this.paddedSize}get isText(){return this.type===qe}get paddedSize(){return this.size+(this.isText?0:na)}isAncestorOf(e){return ia(this,e)}get nextSibling(){const e=this.parent.findOffset(this),t=this.parent.children[e+1];if(t)return t}get prevSibling(){const e=this.parent.findOffset(this),t=this.parent.children[e-1];if(t)return t}splitText(e,t){if(e===0||e===this.size)return;const n=this.value.slice(0,e),s=this.value.slice(e);if(!s.length)return;this.value=n;const i=this.cloneText(e+t);return i.value=s,this.parent.insertAfterInternal(i,this),i}get children(){return this._children.filter(e=>!e.isRemoved)}get allChildren(){return[...this._children]}hasTextChild(){return this.children.length>0&&this.children.every(e=>e.isText)}append(...e){if(this.isText)throw new Error("Text node cannot have children");this._children.push(...e);for(const t of e)t.parent=this,t.updateAncestorsSize()}prepend(...e){if(this.isText)throw new Error("Text node cannot have children");this._children.unshift(...e);for(const t of e)t.parent=this}insertBefore(e,t){if(this.isText)throw new Error("Text node cannot have children");const n=this._children.indexOf(t);if(n===-1)throw new Error("child not found");this.insertAtInternal(e,n),e.updateAncestorsSize()}insertAfter(e,t){if(this.isText)throw new Error("Text node cannot have children");const n=this._children.indexOf(t);if(n===-1)throw new Error("child not found");this.insertAtInternal(e,n+1),e.updateAncestorsSize()}insertAt(e,t){if(this.isText)throw new Error("Text node cannot have children");this.insertAtInternal(e,t),e.updateAncestorsSize()}removeChild(e){if(this.isText)throw new Error("Text node cannot have children");const t=this._children.indexOf(e);if(t===-1)throw new Error("child not found");this._children.splice(t,1),e.parent=void 0}splitElement(e,t){const n=this.cloneElement(t);this.parent.insertAfterInternal(n,this),n.updateAncestorsSize();const s=this.children.slice(0,e),i=this.children.slice(e);this._children=s,n._children=i,this.size=this._children.reduce((o,a)=>o+a.paddedSize,0),n.size=n._children.reduce((o,a)=>o+a.paddedSize,0);for(const o of n._children)o.parent=n;return n}insertAfterInternal(e,t){if(this.isText)throw new Error("Text node cannot have children");const n=this._children.indexOf(t);if(n===-1)throw new Error("child not found");this.insertAtInternal(e,n+1)}insertAtInternal(e,t){if(this.isText)throw new Error("Text node cannot have children");this._children.splice(t,0,e),e.parent=this}findOffset(e){if(this.isText)throw new Error("Text node cannot have children");if(e.isRemoved){const t=this._children.indexOf(e);return this.allChildren.splice(0,t).filter(s=>!s.isRemoved).length}return this.children.indexOf(e)}findBranchOffset(e){if(this.isText)throw new Error("Text node cannot have children");let t=e;for(;t;){const n=this._children.indexOf(t);if(n!==-1)return n;t=t.parent}return-1}}function ia(r,e){if(r===e)return!1;for(;e.parent;){if(e.parent===r)return!0;e=e.parent}return!1}var j=(r=>(r.Start="Start",r.End="End",r.Text="Text",r))(j||{});function Es(r,e,t,n){if(e>t)throw new Error(`from is greater than to: ${e} > ${t}`);if(e>r.size)throw new Error(`from is out of range: ${e} > ${r.size}`);if(t>r.size)throw new Error(`to is out of range: ${t} > ${r.size}`);if(e===t)return;let s=0;for(const i of r.children){if(e-i.paddedSize<s&&s<t){const o=i.isText?e-s:e-s-1,a=i.isText?t-s:t-s-1,c=!i.isText&&o<0,h=!i.isText&&a>i.size;(i.isText||c)&&n([i,i.isText?"Text":"Start"],h),Es(i,Math.max(0,o),Math.min(a,i.size),n),h&&n([i,"End"],h)}s+=i.paddedSize}}function Ps(r,e,t=0){for(const n of r.children)Ps(n,e,t+1);e(r,t)}function gn(r,e,t=0){for(const n of r._children)gn(n,e,t+1);e(r,t)}function zn(r,e,t=!0){if(e>r.size)throw new Error(`index is out of range: ${e} > ${r.size}`);if(r.isText)return{node:r,offset:e};let n=0,s=0;for(const i of r.children){if(t&&i.isText&&i.size>=e-s)return zn(i,e-s,t);if(e===s)return{node:r,offset:n};if(!t&&i.paddedSize===e-s)return{node:r,offset:n+1};if(i.paddedSize>e-s)return zn(i,e-s-1,t);s+=i.paddedSize,n+=1}return{node:r,offset:n}}function Os(r){return r.isText||r.children.length===0?r:Os(r.children[0])}function oa(r,e){if(r.size<e)throw new Error("unacceptable path");for(let t=0;t<r.children.length;t++){const n=r.children[t];if(n.size<e)e-=n.size;else{r=n;break}}return{node:r,offset:e}}class aa{constructor(e){u(this,"root"),this.root=e}tokensBetween(e,t,n){Es(this.root,e,t,n)}traverse(e){Ps(this.root,e,0)}traverseAll(e){gn(this.root,e,0)}findTreePos(e,t=!0){return zn(this.root,e,t)}treePosToPath(e){const t=[];let n=e.node;if(n.isText){const s=n.parent.findOffset(n);if(s===-1)throw new Error("invalid treePos");const i=Vt(n.parent,s);t.push(i+e.offset),n=n.parent}else if(n.hasTextChild()){const s=Vt(n,e.offset);t.push(s)}else t.push(e.offset);for(;n.parent;){const s=n.parent.findOffset(n);if(s===-1)throw new Error("invalid treePos");t.push(s),n=n.parent}return t.reverse()}pathToIndex(e){const t=this.pathToTreePos(e);return this.indexOf(t)}pathToTreePos(e){if(!e.length)throw new Error("unacceptable path");let t=this.root;for(let n=0;n<e.length-1;n++){const s=e[n];if(t=t.children[s],!t)throw new Error("unacceptable path")}if(t.hasTextChild())return oa(t,e[e.length-1]);if(t.children.length<e[e.length-1])throw new Error("unacceptable path");return{node:t,offset:e[e.length-1]}}getRoot(){return this.root}get size(){return this.root.size}findPostorderRight(e){const{node:t,offset:n}=e;if(t.isText){if(t.size===n){const s=t.nextSibling;return s||t.parent}return t}return t.children.length===n?t:Os(t.children[n])}indexOf(e){let{node:t}=e;const{offset:n}=e;let s=0,i=1;if(t.isText){s+=n;const o=t.parent,a=o.findOffset(t);if(a===-1)throw new Error("invalid pos");s+=Vt(o,a),t=t.parent}else s+=Vt(t,n);for(;t!=null&&t.parent;){const o=t.parent,a=o.findOffset(t);if(a===-1)throw new Error("invalid pos");s+=Vt(o,a),i++,t=t.parent}return s+i-1}indexToPath(e){const t=this.findTreePos(e);return this.treePosToPath(t)}}const ca=(r,e)=>r===e?0:r<e?-1:1;class ha{constructor(e,t,n){u(this,"key"),u(this,"value"),u(this,"parent"),u(this,"left"),u(this,"right"),u(this,"isRed"),this.key=e,this.value=t,this.isRed=n}}class ua{constructor(e){u(this,"stack"),this.stack=[],this.traverseInorder(e)}traverseInorder(e){!e||(this.traverseInorder(e.left),this.stack.push({key:e.key,value:e.value}),this.traverseInorder(e.right))}}class Ds{constructor(e){u(this,"root"),u(this,"comparator"),u(this,"counter"),this.comparator=typeof e<"u"?e:ca,this.counter=0}put(e,t){return this.root=this.putInternal(e,t,this.root),this.root.isRed=!1,t}get(e){const t=this.getInternal(e,this.root);return t?t.value:void 0}remove(e){!this.isRed(this.root.left)&&!this.isRed(this.root.right)&&(this.root.isRed=!0),this.root=this.removeInternal(this.root,e),this.root&&(this.root.isRed=!1)}getIterator(){return new ua(this.root)}values(){const e=[];for(const t of this.getIterator().stack)e.push(t.value);return e}floorEntry(e){let t=this.root;for(;t;){const n=this.comparator(e,t.key);if(n>0)if(t.right)t.right.parent=t,t=t.right;else return t;else if(n<0)if(t.left)t.left.parent=t,t=t.left;else{let s=t.parent,i=t;for(;s&&i===s.left;)i=s,s=s.parent;return s}else return t}}lastEntry(){if(!this.root)return this.root;let e=this.root;for(;e.right;)e=e.right;return e}size(){return this.counter}isEmpty(){return this.counter===0}getInternal(e,t){for(;t;){const n=this.comparator(e,t.key);if(n===0)return t;n<0?t=t.left:n>0&&(t=t.right)}}putInternal(e,t,n){if(!n)return this.counter+=1,new ha(e,t,!0);const s=this.comparator(e,n.key);return s<0?n.left=this.putInternal(e,t,n.left):s>0?n.right=this.putInternal(e,t,n.right):n.value=t,this.isRed(n.right)&&!this.isRed(n.left)&&(n=this.rotateLeft(n)),this.isRed(n.left)&&this.isRed(n.left.left)&&(n=this.rotateRight(n)),this.isRed(n.left)&&this.isRed(n.right)&&this.flipColors(n),n}removeInternal(e,t){if(this.comparator(t,e.key)<0)!this.isRed(e.left)&&!this.isRed(e.left.left)&&(e=this.moveRedLeft(e)),e.left=this.removeInternal(e.left,t);else{if(this.isRed(e.left)&&(e=this.rotateRight(e)),this.comparator(t,e.key)===0&&!e.right){this.counter-=1;return}if(!this.isRed(e.right)&&!this.isRed(e.right.left)&&(e=this.moveRedRight(e)),this.comparator(t,e.key)===0){this.counter-=1;const n=this.min(e.right);e.value=n.value,e.key=n.key,e.right=this.removeMin(e.right)}else e.right=this.removeInternal(e.right,t)}return this.fixUp(e)}min(e){return e.left?this.min(e.left):e}removeMin(e){if(!!e.left)return!this.isRed(e.left)&&!this.isRed(e.left.left)&&(e=this.moveRedLeft(e)),e.left=this.removeMin(e.left),this.fixUp(e)}fixUp(e){return this.isRed(e.right)&&(e=this.rotateLeft(e)),this.isRed(e.left)&&this.isRed(e.left.left)&&(e=this.rotateRight(e)),this.isRed(e.left)&&this.isRed(e.right)&&this.flipColors(e),e}moveRedLeft(e){return this.flipColors(e),this.isRed(e.right.left)&&(e.right=this.rotateRight(e.right),e=this.rotateLeft(e),this.flipColors(e)),e}moveRedRight(e){return this.flipColors(e),this.isRed(e.left.left)&&(e=this.rotateRight(e),this.flipColors(e)),e}isRed(e){return e&&e.isRed}rotateLeft(e){const t=e.right;return e.right=t.left,t.left=e,t.isRed=t.left.isRed,t.left.isRed=!0,t}rotateRight(e){const t=e.left;return e.left=t.right,t.right=e,t.isRed=t.right.isRed,t.right.isRed=!0,t}flipColors(e){e.isRed=!e.isRed,e.left.isRed=!e.left.isRed,e.right.isRed=!e.right.isRed}}class Se{constructor(e,t){u(this,"parentID"),u(this,"leftSiblingID"),this.parentID=e,this.leftSiblingID=t}static of(e,t){return new Se(e,t)}static fromTreePos(e){const{offset:t}=e;let{node:n}=e,s;return n.isText?(n.parent.children[0]===n&&t===0?s=n.parent:s=n,n=n.parent):t===0?s=n:s=n.children[t-1],Se.of(n.id,X.of(s.getCreatedAt(),s.getOffset()+t))}getParentID(){return this.parentID}static fromStruct(e){return Se.of(X.of(ne.fromStruct(e.parentID.createdAt),e.parentID.offset),X.of(ne.fromStruct(e.leftSiblingID.createdAt),e.leftSiblingID.offset))}toStruct(){return{parentID:{createdAt:this.getParentID().getCreatedAt().toStruct(),offset:this.getParentID().getOffset()},leftSiblingID:{createdAt:this.getLeftSiblingID().getCreatedAt().toStruct(),offset:this.getLeftSiblingID().getOffset()}}}toTreeNodePair(e){const t=this.getParentID(),n=this.getLeftSiblingID(),s=e.findFloorNode(t);let i=e.findFloorNode(n);if(!s||!i)throw new Error(`cannot find node of CRDTTreePos(${t.toTestString()}, ${n.toTestString()})`);return!n.equals(t)&&n.getOffset()>0&&n.getOffset()===i.id.getOffset()&&i.insPrevID&&(i=e.findFloorNode(i.insPrevID)),[s,i]}getLeftSiblingID(){return this.leftSiblingID}equals(e){return this.getParentID().getCreatedAt().equals(e.getParentID().getCreatedAt())&&this.getParentID().getOffset()===e.getParentID().getOffset()&&this.getLeftSiblingID().getCreatedAt().equals(e.getLeftSiblingID().getCreatedAt())&&this.getLeftSiblingID().getOffset()===e.getLeftSiblingID().getOffset()}}class X{constructor(e,t){u(this,"createdAt"),u(this,"offset"),this.createdAt=e,this.offset=t}static of(e,t){return new X(e,t)}static fromStruct(e){return X.of(ne.fromStruct(e.createdAt),e.offset)}static createComparator(){return(e,t)=>{const n=e.getCreatedAt().compare(t.getCreatedAt());return n!==0?n:e.getOffset()>t.getOffset()?1:e.getOffset()<t.getOffset()?-1:0}}getCreatedAt(){return this.createdAt}equals(e){return this.createdAt.compare(e.createdAt)===0&&this.offset===e.offset}getOffset(){return this.offset}setOffset(e){this.offset=e}toStruct(){return{createdAt:this.createdAt.toStruct(),offset:this.offset}}toIDString(){return`${this.createdAt.toIDString()}:${this.offset}`}toTestString(){return`${this.createdAt.toTestString()}/${this.offset}`}}class ue extends sa{constructor(e,t,n,s,i){super(t),u(this,"id"),u(this,"removedAt"),u(this,"attrs"),u(this,"insPrevID"),u(this,"insNextID"),u(this,"_value",""),this.id=e,this.removedAt=i,s&&(this.attrs=s),typeof n=="string"?this.value=n:Array.isArray(n)&&(this._children=n)}toIDString(){return this.id.toIDString()}getRemovedAt(){return this.removedAt}static create(e,t,n,s){return new ue(e,t,n,s)}deepcopy(){var e;const t=new ue(this.id,this.type);return t.removedAt=this.removedAt,t._value=this._value,t.size=this.size,t.attrs=(e=this.attrs)==null?void 0:e.deepcopy(),t._children=this._children.map(n=>{const s=n.deepcopy();return s.parent=t,s}),t.insPrevID=this.insPrevID,t.insNextID=this.insNextID,t}get value(){if(!this.isText)throw new Error(`cannot get value of element node: ${this.type}`);return this._value}set value(e){if(!this.isText)throw new Error(`cannot set value of element node: ${this.type}`);this._value=e,this.size=e.length}get isRemoved(){return!!this.removedAt}remove(e){const t=!this.removedAt;(!this.removedAt||this.removedAt.compare(e)>0)&&(this.removedAt=e),t&&this.updateAncestorsSize()}cloneText(e){return new ue(X.of(this.id.getCreatedAt(),e),this.type,void 0,void 0,this.removedAt)}cloneElement(e){return new ue(X.of(e(),0),this.type,void 0,void 0,this.removedAt)}split(e,t,n){const s=this.isText?this.splitText(t,this.id.getOffset()):this.splitElement(t,n);if(s){if(s.insPrevID=this.id,this.insNextID){const i=e.findFloorNode(this.insNextID);i.insPrevID=s.id,s.insNextID=this.insNextID}this.insNextID=s.id,e.registerNode(s)}return s}getCreatedAt(){return this.id.getCreatedAt()}getOffset(){return this.id.getOffset()}canDelete(e,t){return!this.getCreatedAt().after(t)&&(!this.removedAt||e.after(this.removedAt))}canStyle(e,t){return this.isText?!1:!this.getCreatedAt().after(t)&&(!this.removedAt||e.after(this.removedAt))}setAttrs(e,t){this.attrs||(this.attrs=new Ve);const n=new Array;for(const[s,i]of Object.entries(e))n.push(this.attrs.set(s,i,t));return n}purge(e){this.attrs&&this.attrs.purge(e)}getGCPairs(){const e=[];if(!this.attrs)return e;for(const t of this.attrs)t.getRemovedAt()&&e.push({parent:this,child:t});return e}}function Kn(r){var e;if(r.isText){const n=r;return{type:n.type,value:n.value}}const t={type:r.type,children:r.children.map(Kn)};return r.attrs&&(t.attributes=Tt((e=r.attrs)==null?void 0:e.toObject())),t}function Wn(r){if(r.isText)return r.value;let e="";return r.attrs&&r.attrs.size()&&(e=" "+Array.from(r.attrs).filter(t=>!t.isRemoved()).sort((t,n)=>t.getKey().localeCompare(n.getKey())).map(t=>{const n=JSON.parse(t.getValue());return typeof n=="string"?`${t.getKey()}="${n}"`:`${t.getKey()}="${Be(t.getValue())}"`}).join(" ")),`<${r.type}${e}>${r.children.map(t=>Wn(t)).join("")}</${r.type}>`}function xs(r){if(r.isText){const e=r;return{type:e.type,value:e.value,size:e.size,isRemoved:e.isRemoved}}return{type:r.type,children:r.children.map(xs),size:r.size,isRemoved:r.isRemoved}}class ye extends Bt{constructor(e,t){super(t),u(this,"indexTree"),u(this,"nodeMapByID"),this.indexTree=new aa(e),this.nodeMapByID=new Ds(X.createComparator()),this.indexTree.traverseAll(n=>{this.nodeMapByID.put(n.id,n)})}static create(e,t){return new ye(e,t)}findFloorNode(e){const t=this.nodeMapByID.floorEntry(e);if(!(!t||!t.key.getCreatedAt().equals(e.getCreatedAt())))return t.value}registerNode(e){this.nodeMapByID.put(e.id,e)}findNodesAndSplitText(e,t){const[n,s]=e.toTreeNodePair(this);let i=s;const o=n===i,a=i.parent&&!o?i.parent:n;if(i.isText&&i.split(this,e.getLeftSiblingID().getOffset()-i.id.getOffset()),t){const c=a.allChildren,h=o?0:c.indexOf(i)+1;for(let f=h;f<c.length;f++){const p=c[f];if(!p.id.getCreatedAt().after(t))break;i=p}}return[a,i]}style(e,t,n,s){const[i,o]=this.findNodesAndSplitText(e[0],n),[a,c]=this.findNodesAndSplitText(e[1],n),h=[],f=t?Tt(t):{},p=new Map,l=[];return this.traverseInPosRange(i,o,a,c,([m])=>{const T=m.getCreatedAt().getActorID(),w=s?s.has(T)?s.get(T):be:Rt;if(m.canStyle(n,w)&&t){const b=p.get(T),C=m.getCreatedAt();(!b||C.after(b))&&p.set(T,C);const L=m.setAttrs(t,n),E=L.reduce((J,[,ht])=>(ht&&(J[ht.getKey()]=f[ht.getKey()]),J),{}),B=m.parent,$=m.prevSibling||m.parent;Object.keys(E).length>0&&h.push({type:"style",from:this.toIndex(B,$),to:this.toIndex(m,m),fromPath:this.toPath(B,$),toPath:this.toPath(m,m),actor:n.getActorID(),value:E});for(const[J]of L)J&&l.push({parent:m,child:J})}}),[p,l,h]}removeStyle(e,t,n,s){const[i,o]=this.findNodesAndSplitText(e[0],n),[a,c]=this.findNodesAndSplitText(e[1],n),h=[],f=new Map,p=[];return this.traverseInPosRange(i,o,a,c,([l])=>{const m=l.getCreatedAt().getActorID(),T=s?s.has(m)?s.get(m):be:Rt;if(l.canStyle(n,T)&&t){const w=f.get(m),b=l.getCreatedAt();(!w||b.after(w))&&f.set(m,b),l.attrs||(l.attrs=new Ve);for(const E of t){const B=l.attrs.remove(E,n);for(const $ of B)p.push({parent:l,child:$})}const C=l.parent,L=l.prevSibling||l.parent;h.push({actor:n.getActorID(),type:"removeStyle",from:this.toIndex(C,L),to:this.toIndex(l,l),fromPath:this.toPath(C,L),toPath:this.toPath(l,l),value:t})}}),[f,p,h]}edit(e,t,n,s,i,o){const[a,c]=this.findNodesAndSplitText(e[0],s),[h,f]=this.findNodesAndSplitText(e[1],s),p=this.toIndex(a,c),l=this.toPath(a,c),m=[],T=[],w=[],b=new Map;this.traverseInPosRange(a,c,h,f,([E,B],$)=>{if(B===j.Start&&!$)for(const ut of E.children)w.push(ut);const J=E.getCreatedAt().getActorID(),ht=o?o.has(J)?o.get(J):be:Rt;if(E.canDelete(s,ht)||m.includes(E.parent)){const ut=b.get(J),Zt=E.getCreatedAt();(!ut||Zt.after(ut))&&b.set(J,Zt),(B===j.Text||B===j.Start)&&m.push(E),T.push([E,B])}});const C=this.makeDeletionChanges(T,s),L=[];for(const E of m)E.remove(s),E.isRemoved&&L.push({parent:this,child:E});for(const E of w)E.removedAt||a.append(E);if(n>0){let E=0,B=a,$=c;for(;E<n;)B.split(this,B.findOffset($)+1,i),$=B,B=B.parent,E++;C.push({type:"content",from:p,to:p,fromPath:l,toPath:l,actor:s.getActorID()})}if(t!=null&&t.length){const E=[];let B=c;for(const $ of t)B===a?a.insertAt($,0):a.insertAfter($,B),B=$,gn($,J=>{a.isRemoved&&(J.remove(s),L.push({parent:this,child:J})),this.nodeMapByID.put(J.id,J)}),$.isRemoved||E.push($);if(E.length){const $=E.map(J=>Kn(J));C.length&&C[C.length-1].from===p?C[C.length-1].value=$:C.push({type:"content",from:p,to:p,fromPath:l,toPath:l,actor:s.getActorID(),value:$})}}return[C,L,b]}editT(e,t,n,s,i){const o=this.findPos(e[0]),a=this.findPos(e[1]);this.edit([o,a],t,n,s,i)}move(e,t,n){throw new Error(`not implemented: ${e}, ${t}, ${n}`)}purge(e){var t;(t=e.parent)==null||t.removeChild(e),this.nodeMapByID.remove(e.id);const n=e.insPrevID,s=e.insNextID;if(n){const i=this.findFloorNode(n);i.insNextID=s}if(s){const i=this.findFloorNode(s);i.insPrevID=n}e.insPrevID=void 0,e.insNextID=void 0}getGCPairs(){const e=[];return this.indexTree.traverse(t=>{t.getRemovedAt()&&e.push({parent:this,child:t});for(const n of t.getGCPairs())e.push(n)}),e}findPos(e,t=!0){const n=this.indexTree.findTreePos(e,t);return Se.fromTreePos(n)}pathToPosRange(e){const t=this.pathToIndex(e);return[this.findPos(t),this.findPos(t+1)]}pathToPos(e){const t=this.indexTree.pathToIndex(e);return this.findPos(t)}getRoot(){return this.indexTree.getRoot()}getSize(){return this.indexTree.size}getNodeSize(){return this.nodeMapByID.size()}getIndexTree(){return this.indexTree}toXML(){return Wn(this.indexTree.getRoot())}toJSON(){return JSON.stringify(this.getRootTreeNode())}toJSForTest(){return{createdAt:this.getCreatedAt().toTestString(),value:JSON.parse(this.toJSON()),type:"YORKIE_TREE"}}toJSInfoForTest(){const e=this.indexTree.getRoot(),t=(n,s=void 0,i=void 0,o=0)=>{var a,c,h,f;let p,l,m;const T=n.isText?{node:n,offset:0}:s&&i?this.toTreePos(s,i):null;T&&(p=this.indexTree.indexOf(T),l=this.indexTree.treePosToPath(T),m=Se.fromTreePos(T).toStruct());const w={type:n.type,parent:s==null?void 0:s.id.toTestString(),size:n.size,id:n.id.toTestString(),removedAt:(a=n.removedAt)==null?void 0:a.toTestString(),insPrev:(c=n.insPrevID)==null?void 0:c.toTestString(),insNext:(h=n.insNextID)==null?void 0:h.toTestString(),value:n.isText?n.value:void 0,isRemoved:n.isRemoved,children:[],depth:o,attributes:n.attrs?Tt((f=n.attrs)==null?void 0:f.toObject()):void 0,index:p,path:l,pos:m};for(let b=0;b<n.allChildren.length;b++){const C=b===0?n:n.allChildren[b-1];w.children.push(t(n.allChildren[b],n,C,o+1))}return w};return t(e)}getRootTreeNode(){return Kn(this.indexTree.getRoot())}toTestTreeNode(){return xs(this.indexTree.getRoot())}toSortedJSON(){return this.toJSON()}deepcopy(){const e=this.getRoot();return new ye(e.deepcopy(),this.getCreatedAt())}toPath(e,t){const n=this.toTreePos(e,t);return n?this.indexTree.treePosToPath(n):[]}toIndex(e,t){const n=this.toTreePos(e,t);return n?this.indexTree.indexOf(n):-1}indexToPath(e){return this.indexTree.indexToPath(e)}pathToIndex(e){return this.indexTree.pathToIndex(e)}indexRangeToPosRange(e){const t=this.findPos(e[0]);return e[0]===e[1]?[t,t]:[t,this.findPos(e[1])]}indexRangeToPosStructRange(e){const[t,n]=e,s=this.findPos(t);return t===n?[s.toStruct(),s.toStruct()]:[s.toStruct(),this.findPos(n).toStruct()]}posRangeToPathRange(e){const[t,n]=this.findNodesAndSplitText(e[0]),[s,i]=this.findNodesAndSplitText(e[1]);return[this.toPath(t,n),this.toPath(s,i)]}posRangeToIndexRange(e){const[t,n]=this.findNodesAndSplitText(e[0]),[s,i]=this.findNodesAndSplitText(e[1]);return[this.toIndex(t,n),this.toIndex(s,i)]}traverseInPosRange(e,t,n,s,i){const o=this.toIndex(e,t),a=this.toIndex(n,s);return this.indexTree.tokensBetween(o,a,i)}toTreePos(e,t){if(!e||!t)return;if(e.isRemoved){let s;for(;e.isRemoved;)s=e,e=s.parent;const i=e.findOffset(s);return{node:e,offset:i}}if(e===t)return{node:e,offset:0};let n=e.findOffset(t);if(!t.isRemoved){if(t.isText)return{node:t,offset:t.paddedSize};n++}return{node:e,offset:n}}makeDeletionChanges(e,t){const n=[],s=[];let i=null,o=null;for(let a=0;a<e.length;a++){const c=e[a],h=e[a+1];i||(i=c),o=c;const f=this.findRightToken(c);(!f||!h||f[0]!==h[0]||f[1]!==h[1])&&(s.push([i,o]),i=null,o=null)}for(const a of s){const[c,h]=a,[f,p]=this.findLeftToken(c),[l,m]=h,T=p===j.Start?f:f.parent,w=m===j.Start?l:l.parent,b=this.toIndex(T,f),C=this.toIndex(w,l);b<C&&(n.length>0&&b===n[n.length-1].to?(n[n.length-1].to=C,n[n.length-1].toPath=this.toPath(w,l)):n.push({type:"content",from:b,to:C,fromPath:this.toPath(T,f),toPath:this.toPath(w,l),actor:t.getActorID()}))}return n.reverse()}findRightToken([e,t]){if(t===j.Start){const a=e.allChildren;return a.length>0?[a[0],a[0].isText?j.Text:j.Start]:[e,j.End]}const n=e.parent,s=n.allChildren,i=s.indexOf(e);if(n&&i===s.length-1)return[n,j.End];const o=s[i+1];return[o,o.isText?j.Text:j.Start]}findLeftToken([e,t]){if(t===j.End){const a=e.allChildren;if(a.length>0){const c=a[a.length-1];return[c,c.isText?j.Text:j.End]}return[e,j.Start]}const n=e.parent,s=n.allChildren,i=s.indexOf(e);if(n&&i===0)return[n,j.Start];const o=s[i-1];return[o,o.isText?j.Text:j.End]}}class qt extends Ae{constructor(e,t,n,s,i,o,a){super(e,a),u(this,"fromPos"),u(this,"toPos"),u(this,"contents"),u(this,"splitLevel"),u(this,"maxCreatedAtMapByActor"),this.fromPos=t,this.toPos=n,this.contents=s,this.splitLevel=i,this.maxCreatedAtMapByActor=o}static create(e,t,n,s,i,o,a){return new qt(e,t,n,s,i,o,a)}execute(e){var t;const n=e.findByCreatedAt(this.getParentCreatedAt());n||y.fatal(`fail to find ${this.getParentCreatedAt()}`),n instanceof ye||y.fatal("fail to execute, only Tree can execute edit");const s=this.getExecutedAt(),i=n,[o,a]=i.edit([this.fromPos,this.toPos],(t=this.contents)==null?void 0:t.map(c=>c.deepcopy()),this.splitLevel,s,(()=>{let c=s.getDelimiter();return this.contents!==void 0&&(c+=this.contents.length),()=>ne.of(s.getLamport(),++c,s.getActorID())})(),this.maxCreatedAtMapByActor);for(const c of a)e.registerGCPair(c);return{opInfos:o.map(({from:c,to:h,value:f,splitLevel:p,fromPath:l,toPath:m})=>({type:"tree-edit",path:e.createPath(this.getParentCreatedAt()),from:c,to:h,value:f,splitLevel:p,fromPath:l,toPath:m}))}}getEffectedCreatedAt(){return this.getParentCreatedAt()}toTestString(){const e=this.getParentCreatedAt().toTestString(),t=`${this.fromPos.getLeftSiblingID().getCreatedAt().toTestString()}/${this.fromPos.getLeftSiblingID().getOffset()}`,n=`${this.toPos.getLeftSiblingID().getCreatedAt().toTestString()}/${this.toPos.getLeftSiblingID().getOffset()}`,s=this.contents||[];return`${e}.EDIT(${t},${n},${s.map(i=>Wn(i)).join("")})`}getFromPos(){return this.fromPos}getToPos(){return this.toPos}getContents(){return this.contents}getSplitLevel(){return this.splitLevel}getMaxCreatedAtMapByActor(){return this.maxCreatedAtMapByActor}}class Xe{constructor(e,t,n,s){u(this,"clientSeq"),u(this,"serverSeq"),u(this,"lamport"),u(this,"actor"),this.clientSeq=e,this.serverSeq=s,this.lamport=t,this.actor=n}static of(e,t,n,s){return new Xe(e,t,n,s)}next(){return new Xe(this.clientSeq+1,this.lamport.add(1),this.actor)}syncLamport(e){return e.greaterThan(this.lamport)?new Xe(this.clientSeq,e,this.actor):new Xe(this.clientSeq,this.lamport.add(1),this.actor)}createTimeTicket(e){return ne.of(this.lamport,e,this.actor)}setActor(e){return new Xe(this.clientSeq,this.lamport,e,this.serverSeq)}getClientSeq(){return this.clientSeq}getServerSeq(){return this.serverSeq?this.serverSeq.toString():""}getLamport(){return this.lamport}getLamportAsString(){return this.lamport.toString()}getActorID(){return this.actor}toTestString(){return`${this.lamport.toString()}:${this.actor.slice(-2)}:${this.clientSeq}`}}const la=new Xe(0,k.fromInt(0,!0),fn);class at{constructor({id:e,operations:t,presenceChange:n,message:s}){u(this,"id"),u(this,"operations"),u(this,"presenceChange"),u(this,"message"),this.id=e,this.operations=t||[],this.presenceChange=n,this.message=s}static create({id:e,operations:t,presenceChange:n,message:s}){return new at({id:e,operations:t,presenceChange:n,message:s})}getID(){return this.id}getMessage(){return this.message}hasOperations(){return this.operations.length>0}getOperations(){return this.operations}setActor(e){for(const t of this.operations)t.setActor(e);this.id=this.id.setActor(e)}hasPresenceChange(){return this.presenceChange!==void 0}getPresenceChange(){return this.presenceChange}execute(e,t,n){const s=[],i=[];for(const o of this.operations){const a=o.execute(e,n);if(!a)continue;const{opInfos:c,reverseOp:h}=a;s.push(...c),h&&i.unshift(h)}return this.presenceChange&&(this.presenceChange.type===We.Put?t.set(this.id.getActorID(),we(this.presenceChange.presence)):t.delete(this.id.getActorID())),{opInfos:s,reverseOps:i}}toTestString(){return`${this.operations.map(e=>e.toTestString()).join(",")}`}toStruct(){return{changeID:z.bytesToHex(z.toChangeID(this.getID()).toBinary()),message:this.getMessage(),operations:this.getOperations().map(e=>z.bytesToHex(z.toOperation(e).toBinary())),presenceChange:this.getPresenceChange()}}static fromStruct(e){const{changeID:t,operations:n,presenceChange:s,message:i}=e;return at.create({id:z.bytesToChangeID(z.hexToBytes(t)),operations:n==null?void 0:n.map(o=>z.bytesToOperation(z.hexToBytes(o))),presenceChange:s,message:i})}}class mn{constructor(e,t,n,s,i,o){u(this,"documentKey"),u(this,"checkpoint"),u(this,"isRemoved"),u(this,"changes"),u(this,"snapshot"),u(this,"minSyncedTicket"),this.documentKey=e,this.checkpoint=t,this.isRemoved=n,this.changes=s,this.snapshot=i,this.minSyncedTicket=o}static create(e,t,n,s,i,o){return new mn(e,t,n,s,i,o)}getDocumentKey(){return this.documentKey}getCheckpoint(){return this.checkpoint}getIsRemoved(){return this.isRemoved}getChanges(){return this.changes}hasChanges(){return this.changes.length>0}getChangeSize(){return this.changes.length}hasSnapshot(){return!!this.snapshot&&!!this.snapshot.length}getSnapshot(){return this.snapshot}getMinSyncedTicket(){return this.minSyncedTicket}}class wt{constructor(e,t){u(this,"serverSeq"),u(this,"clientSeq"),this.serverSeq=e,this.clientSeq=t}static of(e,t){return new wt(e,t)}increaseClientSeq(e){return e===0?this:new wt(this.serverSeq,this.clientSeq+e)}forward(e){if(this.equals(e))return this;const t=this.serverSeq.greaterThan(e.serverSeq)?this.serverSeq:e.serverSeq,n=Math.max(this.clientSeq,e.clientSeq);return wt.of(t,n)}getServerSeqAsString(){return this.serverSeq.toString()}getClientSeq(){return this.clientSeq}getServerSeq(){return this.serverSeq}equals(e){return this.clientSeq===e.clientSeq&&this.serverSeq.equals(e.serverSeq)}toTestString(){return`serverSeq=${this.serverSeq}, clientSeq=${this.clientSeq}`}}const fa=new wt(k.fromInt(0,!0),0);class Me{constructor(e,t){u(this,"createdAt"),u(this,"offset"),this.createdAt=e,this.offset=t}static of(e,t){return new Me(e,t)}static fromStruct(e){return Me.of(ne.fromStruct(e.createdAt),e.offset)}getCreatedAt(){return this.createdAt}getOffset(){return this.offset}equals(e){return this.createdAt.compare(e.createdAt)===0&&this.offset===e.offset}hasSameCreatedAt(e){return this.createdAt.compare(e.createdAt)===0}split(e){return new Me(this.createdAt,this.offset+e)}toStruct(){return{createdAt:this.createdAt.toStruct(),offset:this.offset}}toTestString(){return`${this.createdAt.toTestString()}:${this.offset}`}toIDString(){return`${this.createdAt.toIDString()}:${this.offset}`}}const da=Me.of(be,0);class Ie{constructor(e,t){u(this,"id"),u(this,"relativeOffset"),this.id=e,this.relativeOffset=t}static of(e,t){return new Ie(e,t)}static fromStruct(e){const t=Me.fromStruct(e.id);return Ie.of(t,e.relativeOffset)}getID(){return this.id}getRelativeOffset(){return this.relativeOffset}getAbsoluteID(){return Me.of(this.id.getCreatedAt(),this.id.getOffset()+this.relativeOffset)}toTestString(){return`${this.id.toTestString()}:${this.relativeOffset}`}toStruct(){return{id:this.id.toStruct(),relativeOffset:this.relativeOffset}}equals(e){return this.id.equals(e.id)?this.relativeOffset===e.relativeOffset:!1}}class Ze extends Cs{constructor(e,t,n){super(t),u(this,"id"),u(this,"removedAt"),u(this,"prev"),u(this,"next"),u(this,"insPrev"),u(this,"insNext"),this.id=e,this.removedAt=n}static create(e,t){return new Ze(e,t)}static createComparator(){return(e,t)=>{const n=e.getCreatedAt().compare(t.getCreatedAt());return n!==0?n:e.getOffset()>t.getOffset()?1:e.getOffset()<t.getOffset()?-1:0}}getID(){return this.id}getCreatedAt(){return this.id.getCreatedAt()}getLength(){return this.removedAt?0:this.getContentLength()}getContentLength(){return this.value&&this.value.length||0}getPrev(){return this.prev}getNext(){return this.next}getInsPrev(){return this.insPrev}getInsNext(){return this.insNext}getInsPrevID(){return this.insPrev.getID()}setPrev(e){this.prev=e,e&&(e.next=this)}setNext(e){this.next=e,e&&(e.prev=this)}setInsPrev(e){this.insPrev=e,e&&(e.insNext=this)}setInsNext(e){this.insNext=e,e&&(e.insPrev=this)}hasNext(){return!!this.next}hasInsPrev(){return!!this.insPrev}isRemoved(){return!!this.removedAt}getRemovedAt(){return this.removedAt}split(e){return new Ze(this.id.split(e),this.splitValue(e),this.removedAt)}canDelete(e,t){const n=!this.removedAt;return!this.getCreatedAt().after(t)&&(!this.removedAt||e.after(this.removedAt))?n:!1}canStyle(e,t){return!this.getCreatedAt().after(t)&&(!this.removedAt||e.after(this.removedAt))}remove(e){this.removedAt=e}createPosRange(){return[Ie.of(this.id,0),Ie.of(this.id,this.getLength())]}deepcopy(){return new Ze(this.id,this.value,this.removedAt)}toTestString(){return`${this.id.toTestString()} ${this.value?this.value:""}`}splitValue(e){const t=this.value;return this.value=t.substring(0,e),t.substring(e,t.length)}toIDString(){return this.id.toIDString()}}class bt{constructor(){u(this,"head"),u(this,"treeByIndex"),u(this,"treeByID"),this.head=Ze.create(da),this.treeByIndex=new Lt,this.treeByID=new Ds(Ze.createComparator()),this.treeByIndex.insert(this.head),this.treeByID.put(this.head.getID(),this.head)}static create(){return new bt}edit(e,t,n,s){const[i,o]=this.findNodeWithSplit(e[1],t),[a,c]=this.findNodeWithSplit(e[0],t),h=this.findBetween(c,o),[f,p,l]=this.deleteNodes(h,t,s),m=o?o.getID():i.getID();let T=Ie.of(m,0);if(n){const b=this.posToIndex(a.createPosRange()[1],!0),C=this.insertAfter(a,Ze.create(Me.of(t,0),n));f.length&&f[f.length-1].from===b?f[f.length-1].value=n:f.push({actor:t.getActorID(),from:b,to:b,value:n}),T=Ie.of(C.getID(),C.getContentLength())}const w=[];for(const[,b]of l)w.push({parent:this,child:b});return[T,p,w,f]}indexToPos(e){const[t,n]=this.treeByIndex.find(e),s=t;return Ie.of(s.getID(),n)}findIndexesFromRange(e){const[t,n]=e;return[this.posToIndex(t,!1),this.posToIndex(n,!0)]}posToIndex(e,t){const n=e.getAbsoluteID(),s=t?this.findFloorNodePreferToLeft(n):this.findFloorNode(n);s||y.fatal(`the node of the given id should be found: ${n.toTestString()}`);const i=this.treeByIndex.indexOf(s),o=s.isRemoved()?0:n.getOffset()-s.getID().getOffset();return i+o}findNode(e){return this.findFloorNode(e)}get length(){return this.treeByIndex.length}checkWeight(){return this.treeByIndex.checkWeight()}toString(){const e=[];for(const t of this)t.isRemoved()||e.push(t.getValue());return e.join("")}*[Symbol.iterator](){let e=this.head.getNext();for(;e;)yield e,e=e.getNext()}getHead(){return this.head}deepcopy(){const e=new bt;let t=this.head.getNext(),n=e.head,s;for(;t;){if(s=e.insertAfter(n,t.deepcopy()),t.hasInsPrev()){const i=e.findNode(t.getInsPrevID());s.setInsPrev(i)}n=s,t=t.getNext()}return e}toTestString(){const e=[];let t=this.head;for(;t;)t.isRemoved()?e.push(`{${t.toTestString()}}`):e.push(`[${t.toTestString()}]`),t=t.getNext();return e.join("")}insertAfter(e,t){const n=e.getNext();return t.setPrev(e),n&&n.setPrev(t),this.treeByID.put(t.getID(),t),this.treeByIndex.insertAfter(e,t),t}findNodeWithSplit(e,t){const n=e.getAbsoluteID();let s=this.findFloorNodePreferToLeft(n);const i=n.getOffset()-s.getID().getOffset();for(this.splitNode(s,i);s.hasNext()&&s.getNext().getCreatedAt().after(t);)s=s.getNext();return[s,s.getNext()]}findFloorNodePreferToLeft(e){let t=this.findFloorNode(e);if(t||y.fatal(`the node of the given id should be found: ${e.toTestString()}`),e.getOffset()>0&&t.getID().getOffset()==e.getOffset()){if(!t.hasInsPrev())return t;t=t.getInsPrev()}return t}findFloorNode(e){const t=this.treeByID.floorEntry(e);if(!!t&&!(!t.key.equals(e)&&!t.key.hasSameCreatedAt(e)))return t.value}findBetween(e,t){const n=[];let s=e;for(;s&&s!==t;)n.push(s),s=s.getNext();return n}splitNode(e,t){if(t>e.getContentLength()&&y.fatal("offset should be less than or equal to length"),t===0)return e;if(t===e.getContentLength())return e.getNext();const n=e.split(t);this.treeByIndex.updateWeight(n),this.insertAfter(e,n);const s=e.getInsNext();return s&&s.setInsPrev(n),n.setInsPrev(e),n}deleteNodes(e,t,n){if(!e.length)return[[],new Map,new Map];const[s,i]=this.filterNodes(e,t,n),o=new Map,a=new Map,c=this.makeChanges(i,t);for(const h of s){const f=h.getCreatedAt().getActorID();(!o.has(f)||h.getID().getCreatedAt().after(o.get(f)))&&o.set(f,h.getID().getCreatedAt()),a.set(h.getID().toIDString(),h),h.remove(t)}return this.deleteIndexNodes(i),[c,o,a]}filterNodes(e,t,n){const s=!!n,i=[],o=[],[a,c]=this.findEdgesOfCandidates(e);o.push(a);for(const h of e){const f=h.getCreatedAt().getActorID(),p=s?n.has(f)?n.get(f):be:Rt;h.canDelete(t,p)?i.push(h):o.push(h)}return o.push(c),[i,o]}findEdgesOfCandidates(e){return[e[0].getPrev(),e[e.length-1].getNext()]}makeChanges(e,t){const n=[];let s,i;for(let o=0;o<e.length-1;o++){const a=e[o],c=e[o+1];a.getNext()!=c&&([s]=this.findIndexesFromRange(a.getNext().createPosRange()),c?[,i]=this.findIndexesFromRange(c.getPrev().createPosRange()):i=this.treeByIndex.length,s<i&&n.push({actor:t.getActorID(),from:s,to:i}))}return n.reverse()}deleteIndexNodes(e){for(let t=0;t<e.length-1;t++){const n=e[t],s=e[t+1];n.getNext()!=s&&this.treeByIndex.deleteRange(n,s)}}purge(e){const t=e.getPrev(),n=e.getNext(),s=e.getInsPrev(),i=e.getInsNext();t&&t.setNext(n),n&&n.setPrev(t),e.setPrev(void 0),e.setNext(void 0),s&&s.setInsNext(i),i&&i.setInsPrev(s),e.setInsPrev(void 0),e.setInsNext(void 0)}}const Rs=r=>r<0?Math.ceil(r):Math.floor(r);var Le=(r=>(r[r.IntegerCnt=0]="IntegerCnt",r[r.LongCnt=1]="LongCnt",r))(Le||{});class le extends Bt{constructor(e,t,n){switch(super(n),u(this,"valueType"),u(this,"value"),this.valueType=e,e){case 0:typeof t=="number"?t>Math.pow(2,31)-1||t<-Math.pow(2,31)?this.value=k.fromNumber(t).toInt():this.value=Rs(t):this.value=t.toInt();break;case 1:typeof t=="number"?this.value=k.fromNumber(t):this.value=t;break;default:throw new R(D.Unimplemented,`unimplemented type: ${e}`)}}static create(e,t,n){return new le(e,t,n)}static valueFromBytes(e,t){switch(e){case 0:return t[0]|t[1]<<8|t[2]<<16|t[3]<<24;case 1:return k.fromBytesLE(Array.from(t));default:throw new R(D.Unimplemented,`unimplemented type: ${e}`)}}toJSON(){return`${this.value}`}toSortedJSON(){return this.toJSON()}toJSForTest(){return{createdAt:this.getCreatedAt().toTestString(),value:this.value,type:"YORKIE_COUNTER"}}deepcopy(){const e=le.create(this.valueType,this.value,this.getCreatedAt());return e.setMovedAt(this.getMovedAt()),e}getType(){return this.valueType}static getCounterType(e){switch(typeof e){case"object":return e instanceof k?1:void 0;case"number":return e>Math.pow(2,31)-1||e<-Math.pow(2,31)?1:0;default:return}}static isSupport(e){return!!le.getCounterType(e)}static isInteger(e){return e%1===0}isNumericType(){const e=this.valueType;return e===0||e===1}getValueType(){return this.valueType}getValue(){return this.value}toBytes(){switch(this.valueType){case 0:{const e=this.value;return new Uint8Array([e&255,e>>8&255,e>>16&255,e>>24&255])}case 1:{const t=this.value.toBytesLE();return Uint8Array.from(t)}default:throw new R(D.Unimplemented,`unimplemented type: ${this.valueType}`)}}increase(e){function t(n){if(!n.isNumericType())throw new TypeError(`Unsupported type of value: ${typeof n.getValue()}`)}return t(this),t(e),this.valueType===1?this.value=this.value.add(e.getValue()):e.getType()===H.Long?this.value=this.value+e.getValue().toInt():this.value=k.fromNumber(this.value+Rs(e.getValue())).toInt(),this}}class At extends Ae{constructor(e,t,n){super(e,n),u(this,"value"),this.value=t}static create(e,t,n){return new At(e,t,n)}execute(e){const t=e.findByCreatedAt(this.getParentCreatedAt());t||y.fatal(`fail to find ${this.getParentCreatedAt()}`),t instanceof le||y.fatal("fail to execute, only Counter can execute increase");const n=t,s=this.value.deepcopy();return n.increase(s),{opInfos:[{type:"increase",path:e.createPath(this.getParentCreatedAt()),value:s.getValue()}],reverseOp:this.toReverseOperation()}}toReverseOperation(){const e=this.value.deepcopy(),n=e.getType()===H.Long?e.getValue().multiply(-1):e.getValue()*-1;return At.create(this.getParentCreatedAt(),U.of(n,e.getCreatedAt()))}getEffectedCreatedAt(){return this.getParentCreatedAt()}toTestString(){return`${this.getParentCreatedAt().toTestString()}.INCREASE.${this.value.toJSON()}`}getValue(){return this.value}}class je extends Ae{constructor(e,t,n,s,i,o,a){super(e,a),u(this,"fromPos"),u(this,"toPos"),u(this,"maxCreatedAtMapByActor"),u(this,"attributes"),u(this,"attributesToRemove"),this.fromPos=t,this.toPos=n,this.maxCreatedAtMapByActor=s,this.attributes=i,this.attributesToRemove=o}static create(e,t,n,s,i,o){return new je(e,t,n,s,i,new Array,o)}static createTreeRemoveStyleOperation(e,t,n,s,i,o){return new je(e,t,n,s,new Map,i,o)}execute(e){const t=e.findByCreatedAt(this.getParentCreatedAt());t||y.fatal(`fail to find ${this.getParentCreatedAt()}`),t instanceof ye||y.fatal("fail to execute, only Tree can execute edit");const n=t;let s,i;if(this.attributes.size){const o={};[...this.attributes].forEach(([a,c])=>o[a]=c),[,i,s]=n.style([this.fromPos,this.toPos],o,this.getExecutedAt(),this.maxCreatedAtMapByActor)}else{const o=this.attributesToRemove;[,i,s]=n.removeStyle([this.fromPos,this.toPos],o,this.getExecutedAt(),this.maxCreatedAtMapByActor)}for(const o of i)e.registerGCPair(o);return{opInfos:s.map(({from:o,to:a,value:c,fromPath:h,toPath:f})=>({type:"tree-style",from:o,to:a,value:this.attributes.size?{attributes:c}:{attributesToRemove:c},fromPath:h,toPath:f,path:e.createPath(this.getParentCreatedAt())}))}}getEffectedCreatedAt(){return this.getParentCreatedAt()}toTestString(){const e=this.getParentCreatedAt().toTestString(),t=`${this.fromPos.getLeftSiblingID().getCreatedAt().toTestString()}:${this.fromPos.getLeftSiblingID().getOffset()}`,n=`${this.toPos.getLeftSiblingID().getCreatedAt().toTestString()}:${this.toPos.getLeftSiblingID().getOffset()}`;return`${e}.STYLE(${t},${n},${Object.entries(this.attributes||{}).map(([s,i])=>`${s}:"${i}"`).join(" ")})`}getFromPos(){return this.fromPos}getToPos(){return this.toPos}getAttributes(){return this.attributes}getAttributesToRemove(){return this.attributesToRemove}getMaxCreatedAtMapByActor(){return this.maxCreatedAtMapByActor}}function ga(r){const e=new Un,t=e.data;for(const[n,s]of Object.entries(r))t[n]=JSON.stringify(s);return e}function ma(r){if(r.type===We.Put)return new _n({type:xt.PUT,presence:ga(r.presence)});if(r.type===We.Clear)return new _n({type:xt.CLEAR});throw new R(D.Unimplemented,"unimplemented type")}function pa(r){return new ms({serverSeq:r.getServerSeqAsString(),clientSeq:r.getClientSeq()})}function Bs(r){return new hn({clientSeq:r.getClientSeq(),lamport:r.getLamportAsString(),actorId:er(r.getActorID())})}function A(r){if(!!r)return new S({lamport:r.getLamportAsString(),delimiter:r.getDelimiter(),actorId:er(r.getActorID())})}function Ms(r){switch(r){case H.Null:return N.NULL;case H.Boolean:return N.BOOLEAN;case H.Integer:return N.INTEGER;case H.Long:return N.LONG;case H.Double:return N.DOUBLE;case H.String:return N.STRING;case H.Bytes:return N.BYTES;case H.Date:return N.DATE;default:throw new R(D.Unsupported,`unsupported type: ${r}`)}}function Ls(r){switch(r){case Le.IntegerCnt:return N.INTEGER_CNT;case Le.LongCnt:return N.LONG_CNT;default:throw new R(D.Unsupported,`unsupported type: ${r}`)}}function Gn(r){if(r instanceof oe)return new Je({type:N.JSON_OBJECT,createdAt:A(r.getCreatedAt()),value:Xs(r)});if(r instanceof he)return new Je({type:N.JSON_ARRAY,createdAt:A(r.getCreatedAt()),value:za(r)});if(r instanceof pe)return new Je({type:N.TEXT,createdAt:A(r.getCreatedAt())});if(r instanceof U)return new Je({type:Ms(r.getType()),createdAt:A(r.getCreatedAt()),value:r.toBytes()});if(r instanceof le)return new Je({type:Ls(r.getType()),createdAt:A(r.getCreatedAt()),value:r.toBytes()});if(r instanceof ye)return new Je({type:N.TREE,createdAt:A(r.getCreatedAt()),value:Wa(r)});throw new R(D.Unimplemented,"unimplemented element")}function ya(r){return new Ln({createdAt:A(r.getCreatedAt()),offset:r.getOffset()})}function pn(r){return new nt({createdAt:A(r.getID().getCreatedAt()),offset:r.getID().getOffset(),relativeOffset:r.getRelativeOffset()})}function yn(r){return new Dt({parentId:jt(r.getParentID()),leftSiblingId:jt(r.getLeftSiblingID())})}function jt(r){return new mt({createdAt:A(r.getCreatedAt()),offset:r.getOffset()})}function $s(r){const e=new Bn;if(r instanceof it){const t=r,n=new Xr;n.parentCreatedAt=A(t.getParentCreatedAt()),n.key=t.getKey(),n.value=Gn(t.getValue()),n.executedAt=A(t.getExecutedAt()),e.body.case="set",e.body.value=n}else if(r instanceof _t){const t=r,n=new Zr;n.parentCreatedAt=A(t.getParentCreatedAt()),n.prevCreatedAt=A(t.getPrevCreatedAt()),n.value=Gn(t.getValue()),n.executedAt=A(t.getExecutedAt()),e.body.case="add",e.body.value=n}else if(r instanceof Ye){const t=r,n=new Qr;n.parentCreatedAt=A(t.getParentCreatedAt()),n.prevCreatedAt=A(t.getPrevCreatedAt()),n.createdAt=A(t.getCreatedAt()),n.executedAt=A(t.getExecutedAt()),e.body.case="move",e.body.value=n}else if(r instanceof He){const t=r,n=new es;n.parentCreatedAt=A(t.getParentCreatedAt()),n.createdAt=A(t.getCreatedAt()),n.executedAt=A(t.getExecutedAt()),e.body.case="remove",e.body.value=n}else if(r instanceof Jt){const t=r,n=new ts;n.parentCreatedAt=A(t.getParentCreatedAt()),n.from=pn(t.getFromPos()),n.to=pn(t.getToPos());const s=n.createdAtMapByActor;for(const[o,a]of t.getMaxCreatedAtMapByActor())s[o]=A(a);n.content=t.getContent();const i=n.attributes;for(const[o,a]of t.getAttributes())i[o]=a;n.executedAt=A(t.getExecutedAt()),e.body.case="edit",e.body.value=n}else if(r instanceof Ft){const t=r,n=new ns;n.parentCreatedAt=A(t.getParentCreatedAt()),n.from=pn(t.getFromPos()),n.to=pn(t.getToPos());const s=n.createdAtMapByActor;for(const[o,a]of t.getMaxCreatedAtMapByActor())s[o]=A(a);const i=n.attributes;for(const[o,a]of t.getAttributes())i[o]=a;n.executedAt=A(t.getExecutedAt()),e.body.case="style",e.body.value=n}else if(r instanceof At){const t=r,n=new rs;n.parentCreatedAt=A(t.getParentCreatedAt()),n.value=Gn(t.getValue()),n.executedAt=A(t.getExecutedAt()),e.body.case="increase",e.body.value=n}else if(r instanceof qt){const t=r,n=new ss,s=n.createdAtMapByActor;for(const[i,o]of t.getMaxCreatedAtMapByActor())s[i]=A(o);n.parentCreatedAt=A(t.getParentCreatedAt()),n.from=yn(t.getFromPos()),n.to=yn(t.getToPos()),n.contents=Ia(t.getContents()),n.splitLevel=t.getSplitLevel(),n.executedAt=A(t.getExecutedAt()),e.body.case="treeEdit",e.body.value=n}else if(r instanceof je){const t=r,n=new is;n.parentCreatedAt=A(t.getParentCreatedAt()),n.from=yn(t.getFromPos()),n.to=yn(t.getToPos());const s=n.createdAtMapByActor;for(const[o,a]of t.getMaxCreatedAtMapByActor())s[o]=A(a);const i=t.getAttributesToRemove();if(i.length>0)n.attributesToRemove=i;else{const o=n.attributes;for(const[a,c]of t.getAttributes())o[a]=c}n.executedAt=A(t.getExecutedAt()),e.body.case="treeStyle",e.body.value=n}else throw new R(D.Unimplemented,"unimplemented operation");return e}function va(r){const e=[];for(const t of r)e.push($s(t));return e}function Ta(r){const e=new Yr({id:Bs(r.getID()),message:r.getMessage()});return r.hasOperations()&&(e.operations=va(r.getOperations())),r.hasPresenceChange()&&(e.presenceChange=ma(r.getPresenceChange())),e}function wa(r){const e=[];for(const t of r)e.push(Ta(t));return e}function ba(r){const e=[];for(const t of r)e.push(new fs({key:t.getStrKey(),element:Hn(t.getValue())}));return e}function Aa(r){const e=[];for(const t of r)e.push(new Mn({element:Hn(t.getValue())}));return e}function Sa(r){const e=[];for(const t of r){const n=new ds;n.id=ya(t.getID()),n.value=t.getValue().getContent(),n.removedAt=A(t.getRemovedAt());const s=n.attributes,i=t.getValue().getAttrs();for(const o of i){const a=new un;a.value=o.getValue(),a.updatedAt=A(o.getUpdatedAt()),s[o.getKey()]=a}e.push(n)}return e}function Ia(r){const e=[];if(!r||!r.length)return e;for(const t of r)e.push(new gs({content:_s(t)}));return e}function ka(r){const e={};for(const t of r)e[t.getKey()]=new un({value:t.getValue(),updatedAt:A(t.getUpdatedAt()),isRemoved:t.isRemoved()});return e}function _s(r){if(!r)return[];const e=[];return gn(r,(t,n)=>{const s=new $n({id:jt(t.id),type:t.type,removedAt:A(t.removedAt),depth:n});t.isText&&(s.value=t.value),t.insPrevID&&(s.insPrevId=jt(t.insPrevID)),t.insNextID&&(s.insNextId=jt(t.insNextID)),t.attrs&&(s.attributes=ka(t.attrs)),e.push(s)}),e}function Na(r){const e=new de;return e.body.case="jsonObject",e.body.value=new os({nodes:ba(r.getRHT()),createdAt:A(r.getCreatedAt()),movedAt:A(r.getMovedAt()),removedAt:A(r.getRemovedAt())}),e}function Us(r){const e=new de;return e.body.case="jsonArray",e.body.value=new as({nodes:Aa(r.getElements()),createdAt:A(r.getCreatedAt()),movedAt:A(r.getMovedAt()),removedAt:A(r.getRemovedAt())}),e}function Ca(r){const e=new de;return e.body.case="primitive",e.body.value=new cs({type:Ms(r.getType()),value:r.toBytes(),createdAt:A(r.getCreatedAt()),movedAt:A(r.getMovedAt()),removedAt:A(r.getRemovedAt())}),e}function Ea(r){const e=new de;return e.body.case="text",e.body.value=new hs({nodes:Sa(r.getRGATreeSplit()),createdAt:A(r.getCreatedAt()),movedAt:A(r.getMovedAt()),removedAt:A(r.getRemovedAt())}),e}function Pa(r){const e=new de;return e.body.case="counter",e.body.value=new us({type:Ls(r.getType()),value:r.toBytes(),createdAt:A(r.getCreatedAt()),movedAt:A(r.getMovedAt()),removedAt:A(r.getRemovedAt())}),e}function Js(r){const e=new de;return e.body.case="tree",e.body.value=new ls({nodes:_s(r.getRoot()),createdAt:A(r.getCreatedAt()),movedAt:A(r.getMovedAt()),removedAt:A(r.getRemovedAt())}),e}function Hn(r){if(r instanceof oe)return Na(r);if(r instanceof he)return Us(r);if(r instanceof U)return Ca(r);if(r instanceof pe)return Ea(r);if(r instanceof le)return Pa(r);if(r instanceof ye)return Js(r);throw new R(D.Unimplemented,"unimplemented element")}function Oa(r){return new Ue({documentKey:r.getDocumentKey(),checkpoint:pa(r.getCheckpoint()),isRemoved:r.getIsRemoved(),changes:wa(r.getChanges()),snapshot:r.getSnapshot(),minSyncedTicket:A(r.getMinSyncedTicket())})}function Fs(r){let e;return r.serverSeq&&(e=k.fromString(r.serverSeq,!0)),Xe.of(r.clientSeq,k.fromString(r.lamport,!0),Qn(r.actorId),e)}function I(r){if(!!r)return ne.of(k.fromString(r.lamport,!0),r.delimiter,Qn(r.actorId))}function Yn(r){const e={};return Object.entries(r.data).forEach(([t,n])=>{e[t]=JSON.parse(n)}),e}function Da(r){const e=r.type;if(e===xt.PUT){const t=Yn(r.presence);return{type:We.Put,presence:t}}if(e===xt.CLEAR)return{type:We.Clear};throw new R(D.Unsupported,`unsupported type: ${e}`)}function xa(r){const e=new Map;return Object.entries(r).forEach(([t,n])=>{e.set(t,Yn(n))}),e}function Vs(r){switch(r){case N.NULL:return H.Null;case N.BOOLEAN:return H.Boolean;case N.INTEGER:return H.Integer;case N.LONG:return H.Long;case N.DOUBLE:return H.Double;case N.STRING:return H.String;case N.BYTES:return H.Bytes;case N.DATE:return H.Date}throw new R(D.Unimplemented,`unimplemented value type: ${r}`)}function vn(r){switch(r){case N.INTEGER_CNT:return Le.IntegerCnt;case N.LONG_CNT:return Le.LongCnt}throw new R(D.Unimplemented,`unimplemented value type: ${r}`)}function Xn(r){switch(r.type){case N.JSON_OBJECT:return r.value?Ys(r.value):oe.create(I(r.createdAt));case N.JSON_ARRAY:return r.value?ja(r.value):he.create(I(r.createdAt));case N.TEXT:return pe.create(bt.create(),I(r.createdAt));case N.TREE:return Ka(r.value);case N.NULL:case N.BOOLEAN:case N.INTEGER:case N.LONG:case N.DOUBLE:case N.STRING:case N.BYTES:case N.DATE:return U.of(U.valueFromBytes(Vs(r.type),r.value),I(r.createdAt));case N.INTEGER_CNT:case N.LONG_CNT:return le.create(vn(r.type),le.valueFromBytes(vn(r.type),r.value),I(r.createdAt))}}function Tn(r){return Ie.of(Me.of(I(r.createdAt),r.offset),r.relativeOffset)}function qs(r){return Me.of(I(r.createdAt),r.offset)}function Ra(r){const e=Ut.create(r.value);Object.entries(r.attributes).forEach(([n,s])=>{e.setAttr(n,s.value,I(s.updatedAt))});const t=Ze.create(qs(r.id),e);return t.remove(I(r.removedAt)),t}function St(r){return Se.of(zt(r.parentId),zt(r.leftSiblingId))}function zt(r){return X.of(I(r.createdAt),r.offset)}function Ba(r){if(!r.length)return;const e=[];return r.forEach(t=>{const n=js(t.content);e.push(n)}),e}function js(r){if(r.length===0)return;const e=[];for(const n of r)e.push(La(n));const t=e[e.length-1];for(let n=e.length-2;n>=0;n--){let s;for(let i=n+1;i<e.length;i++)if(r[n].depth-1===r[i].depth){s=e[i];break}s.prepend(e[n])}return t.updateDescendantsSize(),ye.create(t,be).getRoot()}function Ma(r){const e=Ve.create();for(const[t,n]of Object.entries(r))e.setInternal(t,n.value,I(n.updatedAt),n.isRemoved);return e}function La(r){const e=zt(r.id),t=ue.create(e,r.type),n=Object.entries(r.attributes);return t.isText?t.value=r.value:n.length&&(t.attrs=Ma(r.attributes)),r.insPrevId&&(t.insPrevID=zt(r.insPrevId)),r.insNextId&&(t.insNextID=zt(r.insNextId)),t.removedAt=I(r.removedAt),t}function zs(r){if(r.body.case==="set"){const e=r.body.value;return it.create(e.key,Xn(e.value),I(e.parentCreatedAt),I(e.executedAt))}else if(r.body.case==="add"){const e=r.body.value;return _t.create(I(e.parentCreatedAt),I(e.prevCreatedAt),Xn(e.value),I(e.executedAt))}else if(r.body.case==="move"){const e=r.body.value;return Ye.create(I(e.parentCreatedAt),I(e.prevCreatedAt),I(e.createdAt),I(e.executedAt))}else if(r.body.case==="remove"){const e=r.body.value;return He.create(I(e.parentCreatedAt),I(e.createdAt),I(e.executedAt))}else if(r.body.case==="edit"){const e=r.body.value,t=new Map;Object.entries(e.createdAtMapByActor).forEach(([s,i])=>{t.set(s,I(i))});const n=new Map;return Object.entries(e.attributes).forEach(([s,i])=>{n.set(s,i)}),Jt.create(I(e.parentCreatedAt),Tn(e.from),Tn(e.to),t,e.content,n,I(e.executedAt))}else if(r.body.case==="style"){const e=r.body.value,t=new Map;Object.entries(e.createdAtMapByActor).forEach(([s,i])=>{t.set(s,I(i))});const n=new Map;return Object.entries(e.attributes).forEach(([s,i])=>{n.set(s,i)}),Ft.create(I(e.parentCreatedAt),Tn(e.from),Tn(e.to),t,n,I(e.executedAt))}else{if(r.body.case==="select")return;if(r.body.case==="increase"){const e=r.body.value;return At.create(I(e.parentCreatedAt),Xn(e.value),I(e.executedAt))}else if(r.body.case==="treeEdit"){const e=r.body.value,t=new Map;return Object.entries(e.createdAtMapByActor).forEach(([n,s])=>{t.set(n,I(s))}),qt.create(I(e.parentCreatedAt),St(e.from),St(e.to),Ba(e.contents),e.splitLevel,t,I(e.executedAt))}else if(r.body.case==="treeStyle"){const e=r.body.value,t=new Map,n=e.attributesToRemove,s=new Map;return e!=null&&e.createdAtMapByActor&&Object.entries(e.createdAtMapByActor).forEach(([i,o])=>{s.set(i,I(o))}),(n==null?void 0:n.length)>0?je.createTreeRemoveStyleOperation(I(e.parentCreatedAt),St(e.from),St(e.to),s,n,I(e.executedAt)):(Object.entries(e.attributes).forEach(([i,o])=>{t.set(i,o)}),je.create(I(e.parentCreatedAt),St(e.from),St(e.to),s,t,I(e.executedAt)))}else throw new R(D.Unimplemented,"unimplemented operation")}}function $a(r){const e=[];for(const t of r){const n=zs(t);n&&e.push(n)}return e}function Ks(r){const e=[];for(const t of r)e.push(at.create({id:Fs(t.id),operations:$a(t.operations),presenceChange:t.presenceChange?Da(t.presenceChange):void 0,message:t.message}));return e}function _a(r){return wt.of(k.fromString(r.serverSeq,!0),r.clientSeq)}function Ua(r){return mn.create(r.documentKey,_a(r.checkpoint),r.isRemoved,Ks(r.changes),r.snapshot,I(r.minSyncedTicket))}function Ws(r){const e=new Mt;for(const n of r.nodes){const s=Zn(n.element);e.set(n.key,s,s.getPositionedAt())}const t=new oe(I(r.createdAt),e);return t.setMovedAt(I(r.movedAt)),t.setRemovedAt(I(r.removedAt)),t}function Gs(r){const e=new $t;for(const n of r.nodes)e.insert(Zn(n.element));const t=new he(I(r.createdAt),e);return t.setMovedAt(I(r.movedAt)),t.setRemovedAt(I(r.removedAt)),t}function Ja(r){const e=U.of(U.valueFromBytes(Vs(r.type),r.value),I(r.createdAt));return e.setMovedAt(I(r.movedAt)),e.setRemovedAt(I(r.removedAt)),e}function Fa(r){const e=new bt;let t=e.getHead();for(const s of r.nodes){const i=e.insertAfter(t,Ra(s));s.insPrevId&&i.setInsPrev(e.findNode(qs(s.insPrevId))),t=i}const n=new pe(e,I(r.createdAt));return n.setMovedAt(I(r.movedAt)),n.setRemovedAt(I(r.removedAt)),n}function Va(r){const e=le.create(vn(r.type),le.valueFromBytes(vn(r.type),r.value),I(r.createdAt));return e.setMovedAt(I(r.movedAt)),e.setRemovedAt(I(r.removedAt)),e}function Hs(r){const e=js(r.nodes);return ye.create(e,I(r.createdAt))}function Zn(r){if(r.body.case==="jsonObject")return Ws(r.body.value);if(r.body.case==="jsonArray")return Gs(r.body.value);if(r.body.case==="primitive")return Ja(r.body.value);if(r.body.case==="text")return Fa(r.body.value);if(r.body.case==="counter")return Va(r.body.value);if(r.body.case==="tree")return Hs(r.body.value);throw new R(D.Unimplemented,"unimplemented element")}function qa(r){if(!r)return{root:oe.create(be),presences:new Map};const e=Eo.fromBinary(r);return{root:Zn(e.root),presences:xa(e.presences)}}function Ys(r){if(!r)throw new Error("bytes is empty");const e=de.fromBinary(r);return Ws(e.body.value)}function Xs(r){return Hn(r).toBinary()}function ja(r){if(!r)throw new Error("bytes is empty");const e=de.fromBinary(r);return Gs(e.body.value)}function za(r){return Us(r).toBinary()}function Ka(r){if(!r)throw new Error("bytes is empty");const e=de.fromBinary(r);return Hs(e.body.value)}function Wa(r){return Js(r).toBinary()}function Zs(r){return r?Array.from(r).map(e=>e.toString(16).padStart(2,"0")).join(""):""}function Qn(r){return Zs(r)}function Qs(r){return new Uint8Array(r.match(/.{1,2}/g).map(e=>parseInt(e,16)))}function er(r){return Qs(r)}function Ga(r){const e=hn.fromBinary(r);return Fs(e)}function Ha(r){const e=Bn.fromBinary(r);return zs(e)}const z={fromPresence:Yn,toChangePack:Oa,fromChangePack:Ua,fromChanges:Ks,objectToBytes:Xs,bytesToObject:Ys,bytesToSnapshot:qa,bytesToHex:Zs,hexToBytes:Qs,toHexString:Qn,toUint8Array:er,toOperation:$s,toChangeID:Bs,PbChangeID:hn,bytesToChangeID:Ga,bytesToOperation:Ha};function ei(){return"xxxxxxxx-xxxx-4xxxy-xxxx-xxxxxxxxxxx".replace(/[xy]/g,r=>{const e=Math.random()*16|0;return(r==="x"?e:e&3|8).toString(16)})}class Ya{constructor(e,t,n,s){u(this,"reconnectStreamDelay"),u(this,"doc"),u(this,"docID"),u(this,"syncMode"),u(this,"remoteChangeEventReceived"),u(this,"watchStream"),u(this,"watchLoopTimerID"),u(this,"watchAbortController"),this.reconnectStreamDelay=e,this.doc=t,this.docID=n,this.syncMode=s,this.remoteChangeEventReceived=!1}changeSyncMode(e){this.syncMode=e}needRealtimeSync(){return this.syncMode===Xt.RealtimeSyncOff?!1:this.syncMode===Xt.RealtimePushOnly?this.doc.hasLocalChanges():this.syncMode!==Xt.Manual&&(this.doc.hasLocalChanges()||this.remoteChangeEventReceived)}async runWatchLoop(e){const t=async()=>{if(this.watchStream)return Promise.resolve();this.watchLoopTimerID&&(clearTimeout(this.watchLoopTimerID),this.watchLoopTimerID=void 0);try{[this.watchStream,this.watchAbortController]=await e(()=>{this.watchStream=void 0,this.watchAbortController=void 0,this.watchLoopTimerID=setTimeout(t,this.reconnectStreamDelay)})}catch{}};await t()}cancelWatchStream(){this.watchStream&&this.watchAbortController&&(this.watchAbortController.abort(),this.watchStream=void 0,this.watchAbortController=void 0),clearTimeout(this.watchLoopTimerID),this.watchLoopTimerID=void 0}}const tr=()=>{};class Xa{constructor(e){u(this,"finalized",!1),u(this,"observers",[]),u(this,"finalError");try{e(this)}catch(t){this.error(t)}}next(e){this.forEachObserver(t=>{t.next(e)})}error(e){this.forEachObserver(t=>{t.error(e)}),this.close(e)}complete(){this.forEachObserver(e=>{e.complete()}),this.close()}subscribe(e,t,n){let s;e||y.fatal("missing observer"),this.finalized&&y.fatal("observable is finalized due to previous error"),typeof e=="object"?s=e:s={next:e,error:t,complete:n},s.next===void 0&&(s.next=tr),s.error===void 0&&(s.error=tr),s.complete===void 0&&(s.complete=tr);const i=ei(),o=this.unsubscribeOne.bind(this,i);if(this.observers.push({subscriptionID:i,observer:s}),this.finalized)try{this.finalError?s.error(this.finalError):s.complete()}catch(a){y.warn(a)}return o}unsubscribeOne(e){var t;this.observers=(t=this.observers)==null?void 0:t.filter(n=>n.subscriptionID!==e)}forEachObserver(e){if(!this.finalized)for(let t=0;t<this.observers.length;t++)this.sendOne(t,e)}sendOne(e,t){if(this.observers!==void 0&&this.observers[e]!==void 0)try{t(this.observers[e].observer)}catch(n){y.error(n)}}close(e){this.finalized||(this.finalized=!0,e!==void 0&&(this.finalError=e),this.observers=void 0)}}function Za(r){const e=new Xa(r);return{subscribe:e.subscribe.bind(e),getProxy:()=>e}}class It{constructor(e,t,n,s){u(this,"id"),u(this,"delimiter"),u(this,"message"),u(this,"root"),u(this,"operations"),u(this,"presenceChange"),u(this,"previousPresence"),u(this,"reversePresenceKeys"),this.id=e,this.delimiter=qn,this.root=t,this.operations=[],this.previousPresence=we(n),this.presenceChange=void 0,this.reversePresenceKeys=new Set,this.message=s}static create(e,t,n,s){return new It(e,t,n,s)}push(e){this.operations.push(e)}registerElement(e,t){this.root.registerElement(e,t)}registerRemovedElement(e){this.root.registerRemovedElement(e)}registerGCPair(e){this.root.registerGCPair(e)}getChange(){return at.create({id:this.id,operations:this.operations,presenceChange:this.presenceChange,message:this.message})}hasChange(){return this.operations.length>0||this.presenceChange!==void 0}setPresenceChange(e){this.presenceChange=e}setReversePresence(e,t){for(const n of Object.keys(e))t!=null&&t.addToHistory?this.reversePresenceKeys.add(n):this.reversePresenceKeys.delete(n)}getReversePresence(){if(this.reversePresenceKeys.size===0)return;const e={};for(const t of this.reversePresenceKeys)e[t]=this.previousPresence[t];return e}issueTimeTicket(){return this.delimiter+=1,this.id.createTimeTicket(this.delimiter)}getLastTimeTicket(){return this.id.createTimeTicket(this.delimiter)}}class Kt{constructor(e){u(this,"rootObject"),u(this,"elementPairMapByCreatedAt"),u(this,"gcElementSetByCreatedAt"),u(this,"gcPairMap"),this.rootObject=e,this.elementPairMapByCreatedAt=new Map,this.gcElementSetByCreatedAt=new Set,this.gcPairMap=new Map,this.registerElement(e,void 0),e.getDescendants(t=>{if(t.getRemovedAt()&&this.registerRemovedElement(t),t instanceof pe||t instanceof ye)for(const n of t.getGCPairs())this.registerGCPair(n);return!1})}static create(){return new Kt(oe.create(be))}findByCreatedAt(e){const t=this.elementPairMapByCreatedAt.get(e.toIDString());if(!!t)return t.element}findElementPairByCreatedAt(e){return this.elementPairMapByCreatedAt.get(e.toIDString())}createSubPaths(e){let t=this.elementPairMapByCreatedAt.get(e.toIDString());if(!t)return[];const n=[];for(;t.parent;){const s=t.element.getCreatedAt(),i=t.parent.subPathOf(s);i===void 0&&y.fatal(`cant find the given element: ${s.toIDString()}`),n.unshift(i),t=this.elementPairMapByCreatedAt.get(t.parent.getCreatedAt().toIDString())}return n.unshift("$"),n}createPath(e){return this.createSubPaths(e).join(".")}registerElement(e,t){this.elementPairMapByCreatedAt.set(e.getCreatedAt().toIDString(),{parent:t,element:e}),e instanceof Ge&&e.getDescendants((n,s)=>(this.registerElement(n,s),!1))}deregisterElement(e){let t=0;const n=s=>{const i=s.getCreatedAt().toIDString();this.elementPairMapByCreatedAt.delete(i),this.gcElementSetByCreatedAt.delete(i),t++};return n(e),e instanceof Ge&&e.getDescendants(s=>(n(s),!1)),t}registerRemovedElement(e){this.gcElementSetByCreatedAt.add(e.getCreatedAt().toIDString())}registerGCPair(e){if(this.gcPairMap.get(e.child.toIDString())){this.gcPairMap.delete(e.child.toIDString());return}this.gcPairMap.set(e.child.toIDString(),e)}getElementMapSize(){return this.elementPairMapByCreatedAt.size}getGarbageElementSetSize(){const e=new Set;for(const t of this.gcElementSetByCreatedAt){e.add(t);const n=this.elementPairMapByCreatedAt.get(t);n.element instanceof Ge&&n.element.getDescendants(s=>(e.add(s.getCreatedAt().toIDString()),!1))}return e.size}getObject(){return this.rootObject}getGarbageLen(){return this.getGarbageElementSetSize()+this.gcPairMap.size}deepcopy(){return new Kt(this.rootObject.deepcopy())}garbageCollect(e){let t=0;for(const n of this.gcElementSetByCreatedAt){const s=this.elementPairMapByCreatedAt.get(n);s.element.getRemovedAt()&&e.compare(s.element.getRemovedAt())>=0&&(s.parent.purge(s.element),t+=this.deregisterElement(s.element))}for(const[,n]of this.gcPairMap){const s=n.child.getRemovedAt();s!==void 0&&e.compare(s)>=0&&(n.parent.purge(n.child),this.gcPairMap.delete(n.child.toIDString()),t+=1)}return t}toJSON(){return this.rootObject.toJSON()}toSortedJSON(){return this.rootObject.toSortedJSON()}}function ti(r,e){const t=new Wt(r);return new Proxy(e,t.getHandlers())}class Wt{constructor(e){u(this,"context"),u(this,"handlers"),this.context=e,this.handlers={set:(t,n,s)=>(y.isEnabled(ce.Trivial)&&y.trivial(`obj[${n}]=${JSON.stringify(s)}`),Wt.setInternal(e,t,n,s),!0),get:(t,n)=>(y.isEnabled(ce.Trivial)&&y.trivial(`obj[${n}]`),n==="getID"?()=>t.getCreatedAt():n==="toJSON"||n==="toString"?()=>t.toJSON():n==="toJS"?()=>t.toJS():n==="toJSForTest"?()=>t.toJSForTest():ct(e,t.get(n))),ownKeys:t=>t.getKeys(),getOwnPropertyDescriptor:()=>({enumerable:!0,configurable:!0}),deleteProperty:(t,n)=>(y.isEnabled(ce.Trivial)&&y.trivial(`obj[${n}]`),Wt.deleteInternal(e,t,n),!0)}}static setInternal(e,t,n,s){if(n.includes("."))throw new R(D.InvalidObjectKey,"key must not contain the '.'.");const i=e.issueTimeTicket(),o=wn(e,s,i),a=t.set(n,o,i);e.registerElement(o,t),a&&e.registerRemovedElement(a),e.push(it.create(n,o.deepcopy(),t.getCreatedAt(),i))}static buildObjectMembers(e,t){const n={};for(const[s,i]of Object.entries(t)){if(s.includes("."))throw new R(D.InvalidObjectKey,"key must not contain the '.'.");const o=e.issueTimeTicket(),a=wn(e,i,o);n[s]=a}return n}static deleteInternal(e,t,n){const s=e.issueTimeTicket(),i=t.deleteByKey(n,s);!i||(e.push(He.create(t.getCreatedAt(),i.getCreatedAt(),s)),e.registerRemovedElement(i))}getHandlers(){return this.handlers}}function Qa(r,e){const t=new V(r,e);return new Proxy(e,t.getHandlers())}function ec(r){return typeof r=="string"||r instanceof String?!isNaN(r):!1}function tc(r){return["concat","entries","every","filter","find","findIndex","forEach","join","keys","map","reduce","reduceRight","slice","some","toLocaleString","toString","values"].includes(r)}class V{constructor(e,t){u(this,"context"),u(this,"handlers"),u(this,"array"),this.context=e,this.array=t,this.handlers={get:(n,s,i)=>s==="getID"?()=>n.getCreatedAt():s==="getElementByID"?o=>{const a=n.getByID(o);if(!(!a||a.isRemoved()))return Qe(e,a)}:s==="getElementByIndex"?o=>{const a=n.get(o);return Qe(e,a)}:s==="getLast"?()=>Qe(e,n.getLast()):s==="deleteByID"?o=>{const a=V.deleteInternalByID(e,n,o);return Qe(e,a)}:s==="insertAfter"?(o,a)=>{const c=V.insertAfterInternal(e,n,o,a);return Qe(e,c)}:s==="insertBefore"?(o,a)=>{const c=V.insertBeforeInternal(e,n,o,a);return Qe(e,c)}:s==="moveBefore"?(o,a)=>{V.moveBeforeInternal(e,n,o,a)}:s==="moveAfter"?(o,a)=>{V.moveAfterInternal(e,n,o,a)}:s==="moveFront"?o=>{V.moveFrontInternal(e,n,o)}:s==="moveLast"?o=>{V.moveLastInternal(e,n,o)}:ec(s)?ct(e,n.get(Number(s))):s==="push"?o=>V.pushInternal(e,n,o):s==="splice"?(o,a,...c)=>V.splice(e,n,o,a,...c):s==="length"?n.length:typeof s=="symbol"&&s===Symbol.iterator?V.iteratorInternal.bind(this,e,n):s==="includes"?(o,a)=>V.includes(e,n,o,a):s==="indexOf"?(o,a)=>V.indexOf(e,n,o,a):s==="lastIndexOf"?(o,a)=>V.lastIndexOf(e,n,o,a):s==="toJSForTest"?()=>n.toJSForTest():s==="toTestString"?()=>V.toTestString(n):typeof s=="string"&&tc(s)?(...o)=>{const a=Array.from(n).map(c=>ct(e,c));return Array.prototype[s].apply(a,o)}:Reflect.get(n,s,i),deleteProperty:(n,s)=>(y.isEnabled(ce.Trivial)&&y.trivial(`array[${s}]`),V.deleteInternalByIndex(e,n,Number.parseInt(s)),!0)}}static*iteratorInternal(e,t){for(const n of t)yield Qe(e,n)}static buildArrayElements(e,t){const n=[];for(const s of t){const i=e.issueTimeTicket(),o=wn(e,s,i);n.push(o)}return n}static pushInternal(e,t,n){return V.insertAfterInternal(e,t,t.getLastCreatedAt(),n),t.length}static moveBeforeInternal(e,t,n,s){const i=e.issueTimeTicket(),o=t.getPrevCreatedAt(n);t.moveAfter(o,s,i),e.push(Ye.create(t.getCreatedAt(),o,s,i))}static moveAfterInternal(e,t,n,s){const i=e.issueTimeTicket();t.moveAfter(n,s,i),e.push(Ye.create(t.getCreatedAt(),n,s,i))}static moveFrontInternal(e,t,n){const s=e.issueTimeTicket(),i=t.getHead();t.moveAfter(i.getCreatedAt(),n,s),e.push(Ye.create(t.getCreatedAt(),i.getCreatedAt(),n,s))}static moveLastInternal(e,t,n){const s=e.issueTimeTicket(),i=t.getLastCreatedAt();t.moveAfter(i,n,s),e.push(Ye.create(t.getCreatedAt(),i,n,s))}static insertAfterInternal(e,t,n,s){const i=e.issueTimeTicket(),o=wn(e,s,i);return t.insertAfter(n,o),e.registerElement(o,t),e.push(_t.create(t.getCreatedAt(),n,o.deepcopy(),i)),o}static insertBeforeInternal(e,t,n,s){return V.insertAfterInternal(e,t,t.getPrevCreatedAt(n),s)}static deleteInternalByIndex(e,t,n){const s=e.issueTimeTicket(),i=t.deleteByIndex(n,s);if(!!i)return e.push(He.create(t.getCreatedAt(),i.getCreatedAt(),s)),e.registerRemovedElement(i),i}static deleteInternalByID(e,t,n){const s=e.issueTimeTicket(),i=t.delete(n,s);return e.push(He.create(t.getCreatedAt(),i.getCreatedAt(),s)),e.registerRemovedElement(i),i}static splice(e,t,n,s,...i){const o=t.length,a=n>=0?Math.min(n,o):Math.max(o+n,0),c=s===void 0?o:s<0?a:Math.min(a+s,o),h=[];for(let f=a;f<c;f++){const p=V.deleteInternalByIndex(e,t,a);if(p){const l=p.deepcopy();l.setRemovedAt(),h.push(ct(e,l))}}if(i){let f=a===0?t.getHead().getID():t.get(a-1).getID();for(const p of i)f=V.insertAfterInternal(e,t,f,p).getID()}return h}static includes(e,t,n,s){var i;const o=t.length,a=s===void 0?0:s<0?Math.max(s+o,0):s;if(a>=o)return!1;if(U.isSupport(n))return Array.from(t).map(h=>ct(e,h)).includes(n,a);for(let c=a;c<o;c++)if(((i=t.get(c))==null?void 0:i.getID())===n.getID())return!0;return!1}static indexOf(e,t,n,s){var i;const o=t.length,a=s===void 0?0:s<0?Math.max(s+o,0):s;if(a>=o)return-1;if(U.isSupport(n))return Array.from(t).map(h=>ct(e,h)).indexOf(n,a);for(let c=a;c<o;c++)if(((i=t.get(c))==null?void 0:i.getID())===n.getID())return c;return-1}static lastIndexOf(e,t,n,s){var i;const o=t.length,a=s===void 0||s>=o?o-1:s<0?s+o:s;if(a<0)return-1;if(U.isSupport(n))return Array.from(t).map(h=>ct(e,h)).lastIndexOf(n,a);for(let c=a;c>0;c--)if(((i=t.get(c))==null?void 0:i.getID())===n.getID())return c;return-1}static toTestString(e){return e.toTestString()}getHandlers(){return this.handlers}}class Gt{constructor(e,t){u(this,"context"),u(this,"text"),this.context=e,this.text=t}initialize(e,t){this.context=e,this.text=t}getID(){return this.text.getID()}edit(e,t,n,s){if(!this.context||!this.text){y.fatal("it is not initialized yet");return}if(e>t){y.fatal("from should be less than or equal to to");return}const i=this.text.indexRangeToPosRange(e,t);y.isEnabled(ce.Debug)&&y.debug(`EDIT: f:${e}->${i[0].toTestString()}, t:${t}->${i[1].toTestString()} c:${n}`);const o=s?vt(s):void 0,a=this.context.issueTimeTicket(),[c,,h,f]=this.text.edit(i,n,a,o);for(const p of h)this.context.registerGCPair(p);return this.context.push(new Jt(this.text.getCreatedAt(),i[0],i[1],c,n,o?new Map(Object.entries(o)):new Map,a)),this.text.findIndexesFromRange(f)}delete(e,t){return this.edit(e,t,"")}empty(){return this.edit(0,this.length,"")}setStyle(e,t,n){if(!this.context||!this.text)return y.fatal("it is not initialized yet"),!1;if(e>t)return y.fatal("from should be less than or equal to to"),!1;const s=this.text.indexRangeToPosRange(e,t);y.isEnabled(ce.Debug)&&y.debug(`STYL: f:${e}->${s[0].toTestString()}, t:${t}->${s[1].toTestString()} a:${JSON.stringify(n)}`);const i=vt(n),o=this.context.issueTimeTicket(),[a,c]=this.text.setStyle(s,i,o);for(const h of c)this.context.registerGCPair(h);return this.context.push(new Ft(this.text.getCreatedAt(),s[0],s[1],a,new Map(Object.entries(i)),o)),!0}indexRangeToPosRange(e){if(!this.context||!this.text){y.fatal("it is not initialized yet");return}const t=this.text.indexRangeToPosRange(e[0],e[1]);return[t[0].toStruct(),t[1].toStruct()]}posRangeToIndexRange(e){if(!this.context||!this.text){y.fatal("it is not initialized yet");return}const t=this.text.findIndexesFromRange([Ie.fromStruct(e[0]),Ie.fromStruct(e[1])]);return[t[0],t[1]]}toTestString(){if(!this.context||!this.text){y.fatal("it is not initialized yet");return}return this.text.toTestString()}values(){if(!this.context||!this.text){y.fatal("it is not initialized yet");return}return this.text.values()}get length(){return this.text.length}checkWeight(){return this.text.checkWeight()}toString(){return!this.context||!this.text?(y.fatal("it is not initialized yet"),""):this.text.toString()}toJSON(){if(!this.context||!this.text)throw new Error("it is not initialized yet");return this.text.toJSON()}toJSForTest(){if(!this.context||!this.text)throw new Error("it is not initialized yet");return this.text.toJSForTest()}createRangeForTest(e,t){if(!this.context||!this.text){y.fatal("it is not initialized yet");return}return this.text.indexRangeToPosRange(e,t)}}class Ht{constructor(e,t){u(this,"valueType"),u(this,"value"),u(this,"context"),u(this,"counter"),this.valueType=e,this.value=t}initialize(e,t){this.valueType=t.getValueType(),this.context=e,this.counter=t,this.value=t.getValue()}getID(){return this.counter.getID()}getValue(){return this.value}getValueType(){return this.valueType}increase(e){if(!this.context||!this.counter){y.fatal("it is not initialized yet");return}const t=this.context.issueTimeTicket(),n=U.of(e,t);if(!n.isNumericType())throw new TypeError(`Unsupported type of value: ${typeof n.getValue()}`);return this.counter.increase(n),this.context.push(At.create(this.counter.getCreatedAt(),n,t)),this}toJSForTest(){if(!this.context||!this.counter)throw new Error("it is not initialized yet");return this.counter.toJSForTest()}}function nr(r,e,t){const{type:n}=r,s=t.issueTimeTicket();if(n===qe){ni(r);const{value:i}=r,o=ue.create(X.of(s,0),n,i);e.append(o)}else{const{children:i=[]}=r;let{attributes:o}=r,a;if(typeof o=="object"&&!Ns(o)){o=vt(o),a=new Ve;for(const[h,f]of Object.entries(o))a.set(h,f,s)}const c=ue.create(X.of(s,0),n,void 0,a);e.append(c);for(const h of i)nr(h,c,t)}}function nc(r,e){const{type:t}=e,n=r.issueTimeTicket();let s;if(e.type===qe){const{value:i}=e;s=ue.create(X.of(n,0),t,i)}else if(e){const{children:i=[]}=e;let{attributes:o}=e,a;if(typeof o=="object"&&!Ns(o)){o=vt(o),a=new Ve;for(const[c,h]of Object.entries(o))a.set(c,h,n)}s=ue.create(X.of(r.issueTimeTicket(),0),t,void 0,a);for(const c of i)nr(c,s,r)}return s}function ni(r){if(!r.value.length)throw new Error("text node cannot have empty value");return!0}function ri(r){if(!r.length)return!0;if(r[0].type===qe)for(const t of r){const{type:n}=t;if(n!==qe)throw new Error("element node and text node cannot be passed together");ni(t)}else for(const t of r){const{type:n}=t;if(n===qe)throw new Error("element node and text node cannot be passed together")}return!0}class Yt{constructor(e){u(this,"initialRoot"),u(this,"context"),u(this,"tree"),this.initialRoot=e}initialize(e,t){this.context=e,this.tree=t}getID(){return this.tree.getID()}buildRoot(e){if(!this.initialRoot)return ue.create(X.of(e.issueTimeTicket(),0),ra);const t=ue.create(X.of(e.issueTimeTicket(),0),this.initialRoot.type);for(const n of this.initialRoot.children)nr(n,t,e);return t}getSize(){if(!this.context||!this.tree)throw new Error("it is not initialized yet");return this.tree.getSize()}getNodeSize(){if(!this.context||!this.tree)throw new Error("it is not initialized yet");return this.tree.getNodeSize()}getIndexTree(){if(!this.context||!this.tree)throw new Error("it is not initialized yet");return this.tree.getIndexTree()}styleByPath(e,t){if(!this.context||!this.tree)throw new Error("it is not initialized yet");if(!e.length)throw new Error("path should not be empty");const[n,s]=this.tree.pathToPosRange(e),i=this.context.issueTimeTicket(),o=t?vt(t):void 0,[a]=this.tree.style([n,s],o,i);this.context.push(je.create(this.tree.getCreatedAt(),n,s,a,o?new Map(Object.entries(o)):new Map,i))}style(e,t,n){if(!this.context||!this.tree)throw new Error("it is not initialized yet");if(e>t)throw new Error("from should be less than or equal to to");const s=this.tree.findPos(e),i=this.tree.findPos(t),o=this.context.issueTimeTicket(),a=n?vt(n):void 0,[c,h]=this.tree.style([s,i],a,o);for(const f of h)this.context.registerGCPair(f);this.context.push(je.create(this.tree.getCreatedAt(),s,i,c,a?new Map(Object.entries(a)):new Map,o))}removeStyle(e,t,n){if(!this.context||!this.tree)throw new Error("it is not initialized yet");if(e>t)throw new Error("from should be less than or equal to to");const s=this.tree.findPos(e),i=this.tree.findPos(t),o=this.context.issueTimeTicket(),[a,c]=this.tree.removeStyle([s,i],n,o);for(const h of c)this.context.registerGCPair(h);this.context.push(je.createTreeRemoveStyleOperation(this.tree.getCreatedAt(),s,i,a,n,o))}editInternal(e,t,n,s=0){var i;if(n.length!==0&&n[0]&&(ri(n),n[0].type!==qe))for(const f of n){const{children:p=[]}=f;ri(p)}const o=this.context.getLastTimeTicket();let a=new Array;if(((i=n[0])==null?void 0:i.type)===qe){let f="";for(const p of n){const{value:l}=p;f+=l}a.push(ue.create(X.of(this.context.issueTimeTicket(),0),qe,f))}else a=n.map(f=>f&&nc(this.context,f)).filter(f=>f);const[,c,h]=this.tree.edit([e,t],a.length?a.map(f=>f==null?void 0:f.deepcopy()):void 0,s,o,()=>this.context.issueTimeTicket());for(const f of c)this.context.registerGCPair(f);return this.context.push(qt.create(this.tree.getCreatedAt(),e,t,a.length?a:void 0,s,h,o)),!0}editByPath(e,t,n,s=0){if(!this.context||!this.tree)throw new Error("it is not initialized yet");if(e.length!==t.length)throw new Error("path length should be equal");if(!e.length||!t.length)throw new Error("path should not be empty");const i=this.tree.pathToPos(e),o=this.tree.pathToPos(t);return this.editInternal(i,o,n?[n]:[],s)}editBulkByPath(e,t,n,s=0){if(!this.context||!this.tree)throw new Error("it is not initialized yet");if(e.length!==t.length)throw new Error("path length should be equal");if(!e.length||!t.length)throw new Error("path should not be empty");const i=this.tree.pathToPos(e),o=this.tree.pathToPos(t);return this.editInternal(i,o,n,s)}edit(e,t,n,s=0){if(!this.context||!this.tree)throw new Error("it is not initialized yet");if(e>t)throw new Error("from should be less than or equal to to");const i=this.tree.findPos(e),o=this.tree.findPos(t);return this.editInternal(i,o,n?[n]:[],s)}editBulk(e,t,n,s=0){if(!this.context||!this.tree)throw new Error("it is not initialized yet");if(e>t)throw new Error("from should be less than or equal to to");const i=this.tree.findPos(e),o=this.tree.findPos(t);return this.editInternal(i,o,n,s)}toXML(){if(!this.context||!this.tree)throw new Error("it is not initialized yet");return this.tree.toXML()}toJSON(){if(!this.context||!this.tree)throw new Error("it is not initialized yet");return this.tree.toJSON()}toJSForTest(){if(!this.context||!this.tree)throw new Error("it is not initialized yet");return this.tree.toJSForTest()}toJSInfoForTest(){if(!this.context||!this.tree)throw new Error("it is not initialized yet");return this.tree.toJSInfoForTest()}getRootTreeNode(){if(!this.context||!this.tree)throw new Error("it is not initialized yet");return this.tree.getRootTreeNode()}indexToPath(e){if(!this.context||!this.tree)throw new Error("it is not initialized yet");return this.tree.indexToPath(e)}pathToIndex(e){if(!this.context||!this.tree)throw new Error("it is not initialized yet");return this.tree.pathToIndex(e)}pathRangeToPosRange(e){if(!this.context||!this.tree){y.fatal("it is not initialized yet");return}const t=[this.tree.pathToIndex(e[0]),this.tree.pathToIndex(e[1])],n=this.tree.indexRangeToPosRange(t);return[n[0].toStruct(),n[1].toStruct()]}indexRangeToPosRange(e){if(!this.context||!this.tree){y.fatal("it is not initialized yet");return}return this.tree.indexRangeToPosStructRange(e)}posRangeToIndexRange(e){if(!this.context||!this.tree){y.fatal("it is not initialized yet");return}const t=[Se.fromStruct(e[0]),Se.fromStruct(e[1])];return this.tree.posRangeToIndexRange(t)}posRangeToPathRange(e){if(!this.context||!this.tree){y.fatal("it is not initialized yet");return}const t=[Se.fromStruct(e[0]),Se.fromStruct(e[1])];return this.tree.posRangeToPathRange(t)}}function si(r,e){return ti(r,e)}function Qe(r,e){if(e){if(e instanceof U)return e;if(e instanceof oe)return ti(r,e);if(e instanceof he)return Qa(r,e);if(e instanceof pe)return new Gt(r,e);if(e instanceof le){const t=new Ht(Le.IntegerCnt,0);return t.initialize(r,e),t}else if(e instanceof ye){const t=new Yt;return t.initialize(r,e),t}}else return;throw new TypeError(`Unsupported type of element: ${typeof e}`)}function ct(r,e){const t=Qe(r,e);return t instanceof U?t.getValue():t}function wn(r,e,t){let n;if(U.isSupport(e))n=U.of(e,t);else if(Array.isArray(e))n=he.create(t,V.buildArrayElements(r,e));else if(typeof e=="object")e instanceof Gt?(n=pe.create(bt.create(),t),e.initialize(r,n)):e instanceof Ht?(n=le.create(e.getValueType(),e.getValue(),t),e.initialize(r,n)):e instanceof Yt?(n=ye.create(e.buildRoot(r),t),e.initialize(r,n)):n=oe.create(t,Wt.buildObjectMembers(r,e));else throw new TypeError(`Unsupported type of value: ${typeof e}`);return n}const ii=50;class rc{constructor(){u(this,"undoStack",[]),u(this,"redoStack",[])}hasUndo(){return this.undoStack.length>0}hasRedo(){return this.redoStack.length>0}pushUndo(e){this.undoStack.length>=ii&&this.undoStack.shift(),this.undoStack.push(e)}popUndo(){return this.undoStack.pop()}pushRedo(e){this.redoStack.length>=ii&&this.redoStack.shift(),this.redoStack.push(e)}popRedo(){return this.redoStack.pop()}clearRedo(){this.redoStack=[]}getUndoStackForTest(){return this.undoStack}getRedoStackForTest(){return this.redoStack}}const oi="yorkie-devtools-panel",ai="yorkie-devtools-sdk";let kt="disconnected";const ci=new Map,bn=new Map;typeof window<"u"&&(window.transactionEventsByDocKey=bn);function An(r,e){!((e==null?void 0:e.force)||kt!=="disconnected")||window.postMessage({source:ai,...r},"*")}function sc(r){if(!r.isEnableDevtools()||typeof window>"u"||ci.has(r.getKey()))return;bn.set(r.getKey(),[]);const e=r.subscribe("all",t=>{t.some(n=>n.type!==re.StatusChanged&&n.type!==re.Snapshot&&n.type!==re.LocalChange&&n.type!==re.RemoteChange&&n.type!==re.Initialized&&n.type!==re.Watched&&n.type!==re.Unwatched&&n.type!==re.PresenceChanged)||(bn.get(r.getKey()).push(t),kt==="synced"&&An({msg:"doc::sync::partial",docKey:r.getKey(),event:t}))});ci.set(r.getKey(),[e]),An({msg:"refresh-devtools"},{force:!0}),window.addEventListener("message",t=>{var n;if(((n=t.data)==null?void 0:n.source)!==oi)return;switch(t.data.msg){case"devtools::connect":if(kt!=="disconnected")break;kt="connected",An({msg:"doc::available",docKey:r.getKey()}),y.info(`[YD] Devtools connected. Doc: ${r.getKey()}`);break;case"devtools::disconnect":kt="disconnected",y.info(`[YD] Devtools disconnected. Doc: ${r.getKey()}`);break;case"devtools::subscribe":kt="synced",An({msg:"doc::sync::full",docKey:r.getKey(),events:bn.get(r.getKey())}),y.info(`[YD] Devtools subscribed. Doc: ${r.getKey()}`);break}})}var ze=(r=>(r.Detached="detached",r.Attached="attached",r.Removed="removed",r))(ze||{}),re=(r=>(r.StatusChanged="status-changed",r.ConnectionChanged="connection-changed",r.SyncStatusChanged="sync-status-changed",r.Snapshot="snapshot",r.LocalChange="local-change",r.RemoteChange="remote-change",r.Initialized="initialized",r.Watched="watched",r.Unwatched="unwatched",r.PresenceChanged="presence-changed",r))(re||{}),Sn=(r=>(r.Connected="connected",r.Disconnected="disconnected",r))(Sn||{}),In=(r=>(r.Synced="synced",r.SyncFailed="sync-failed",r))(In||{});class rr{constructor(e,t){u(this,"key"),u(this,"status"),u(this,"opts"),u(this,"changeID"),u(this,"checkpoint"),u(this,"localChanges"),u(this,"root"),u(this,"clone"),u(this,"eventStream"),u(this,"eventStreamObserver"),u(this,"onlineClients"),u(this,"presences"),u(this,"history"),u(this,"internalHistory"),u(this,"isUpdating"),this.opts=t||{},this.key=e,this.status="detached",this.root=Kt.create(),this.changeID=la,this.checkpoint=fa,this.localChanges=[],this.eventStream=Za(n=>{this.eventStreamObserver=n}),this.onlineClients=new Set,this.presences=new Map,this.isUpdating=!1,this.internalHistory=new rc,this.history={canUndo:this.canUndo.bind(this),canRedo:this.canRedo.bind(this),undo:this.undo.bind(this),redo:this.redo.bind(this)},sc(this)}update(e,t){if(this.getStatus()==="removed")throw new R(D.DocumentRemoved,`${this.key} is removed`);this.ensureClone();const n=this.changeID.getActorID(),s=It.create(this.changeID.next(),this.clone.root,this.clone.presences.get(n)||{},t);try{const i=si(s,this.clone.root.getObject());this.presences.has(n)||this.clone.presences.set(n,{}),this.isUpdating=!0,e(i,new Vn(s,this.clone.presences.get(n)))}catch(i){throw this.clone=void 0,y.error(i),i}finally{this.isUpdating=!1}if(s.hasChange()){y.isEnabled(ce.Trivial)&&y.trivial(`trying to update a local change: ${this.toJSON()}`);const i=s.getChange(),{opInfos:o,reverseOps:a}=i.execute(this.root,this.presences,M.Local),c=s.getReversePresence();c&&a.push({type:"presence",value:c}),this.localChanges.push(i),a.length>0&&this.internalHistory.pushUndo(a),o.length>0&&this.internalHistory.clearRedo(),this.changeID=i.getID();const h=[];o.length>0&&h.push({type:"local-change",source:M.Local,value:{message:i.getMessage()||"",operations:o,actor:n,clientSeq:i.getID().getClientSeq(),serverSeq:i.getID().getServerSeq()},rawChange:this.isEnableDevtools()?i.toStruct():void 0}),i.hasPresenceChange()&&h.push({type:"presence-changed",source:M.Local,value:{clientID:n,presence:this.getPresence(n)}}),this.publish(h),y.isEnabled(ce.Trivial)&&y.trivial(`after update a local change: ${this.toJSON()}`)}}subscribe(e,t,n,s){if(typeof e=="string"){if(typeof t!="function")throw new Error("Second argument must be a callback function");if(e==="presence"){const a=t;return this.eventStream.subscribe(c=>{for(const h of c)h.type!=="initialized"&&h.type!=="watched"&&h.type!=="unwatched"&&h.type!=="presence-changed"||a(h)},n,s)}if(e==="my-presence"){const a=t;return this.eventStream.subscribe(c=>{for(const h of c)h.type!=="initialized"&&h.type!=="presence-changed"||h.type==="presence-changed"&&h.value.clientID!==this.changeID.getActorID()||a(h)},n,s)}if(e==="others"){const a=t;return this.eventStream.subscribe(c=>{for(const h of c)h.type!=="watched"&&h.type!=="unwatched"&&h.type!=="presence-changed"||h.value.clientID!==this.changeID.getActorID()&&a(h)},n,s)}if(e==="connection"){const a=t;return this.eventStream.subscribe(c=>{for(const h of c)h.type==="connection-changed"&&a(h)},n,s)}if(e==="status"){const a=t;return this.eventStream.subscribe(c=>{for(const h of c)h.type==="status-changed"&&a(h)},n,s)}if(e==="sync"){const a=t;return this.eventStream.subscribe(c=>{for(const h of c)h.type==="sync-status-changed"&&a(h)},n,s)}if(e==="all"){const a=t;return this.eventStream.subscribe(a,n,s)}const i=e,o=t;return this.eventStream.subscribe(a=>{for(const c of a){if(c.type!=="local-change"&&c.type!=="remote-change")continue;const h=[];for(const f of c.value.operations)this.isSameElementOrChildOf(f.path,i)&&h.push(f);h.length&&o({...c,value:{...c.value,operations:h}})}},n,s)}if(typeof e=="function"){const i=e,o=t,a=n;return this.eventStream.subscribe(c=>{for(const h of c)h.type!=="snapshot"&&h.type!=="local-change"&&h.type!=="remote-change"||i(h)},o,a)}throw new Error(`"${e}" is not a valid`)}publish(e){this.eventStreamObserver&&this.eventStreamObserver.next(e)}isSameElementOrChildOf(e,t){if(t===e)return!0;const n=e.split(".");return t.split(".").every((i,o)=>i===n[o])}applyChangePack(e){for(e.hasSnapshot()?this.applySnapshot(e.getCheckpoint().getServerSeq(),e.getSnapshot()):e.hasChanges()&&this.applyChanges(e.getChanges(),M.Remote);this.localChanges.length&&!(this.localChanges[0].getID().getClientSeq()>e.getCheckpoint().getClientSeq());)this.localChanges.shift();this.checkpoint=this.checkpoint.forward(e.getCheckpoint()),this.garbageCollect(e.getMinSyncedTicket()),e.getIsRemoved()&&this.applyStatus("removed"),y.isEnabled(ce.Trivial)&&y.trivial(`${this.root.toJSON()}`)}getCheckpoint(){return this.checkpoint}getChangeID(){return this.changeID}hasLocalChanges(){return this.localChanges.length>0}ensureClone(){this.clone||(this.clone={root:this.root.deepcopy(),presences:we(this.presences)})}createChangePack(){const e=Array.from(this.localChanges),t=this.checkpoint.increaseClientSeq(e.length);return mn.create(this.key,t,!1,e)}setActor(e){for(const t of this.localChanges)t.setActor(e);this.changeID=this.changeID.setActor(e)}isEnableDevtools(){return!!this.opts.enableDevtools}getKey(){return this.key}getStatus(){return this.status}getCloneRoot(){if(!!this.clone)return this.clone.root.getObject()}getRoot(){this.ensureClone();const e=It.create(this.changeID.next(),this.clone.root,this.clone.presences.get(this.changeID.getActorID())||{});return si(e,this.clone.root.getObject())}garbageCollect(e){return this.opts.disableGC?0:(this.clone&&this.clone.root.garbageCollect(e),this.root.garbageCollect(e))}getRootObject(){return this.root.getObject()}getGarbageLen(){return this.root.getGarbageLen()}getGarbageLenFromClone(){return this.clone.root.getGarbageLen()}toJSON(){return this.root.toJSON()}toSortedJSON(){return this.root.toSortedJSON()}toJSForTest(){return{...this.getRoot().toJSForTest(),key:"root"}}applySnapshot(e,t){const{root:n,presences:s}=z.bytesToSnapshot(t);this.root=new Kt(n),this.presences=s,this.changeID=this.changeID.syncLamport(e),this.clone=void 0,this.publish([{type:"snapshot",source:M.Remote,value:{snapshot:this.isEnableDevtools()?z.bytesToHex(t):void 0,serverSeq:e.toString()}}])}applyChanges(e,t){y.isEnabled(ce.Debug)&&y.debug(`trying to apply ${e.length} remote changes.elements:${this.root.getElementMapSize()}, removeds:${this.root.getGarbageElementSetSize()}`),y.isEnabled(ce.Trivial)&&y.trivial(e.map(n=>`${n.getID().toTestString()}	${n.toTestString()}`).join(`
`));for(const n of e)this.applyChange(n,t);y.isEnabled(ce.Debug)&&y.debug(`after appling ${e.length} remote changes.elements:${this.root.getElementMapSize()},  removeds:${this.root.getGarbageElementSetSize()}`)}applyChange(e,t){this.ensureClone(),e.execute(this.clone.root,this.clone.presences,t);const n=[],s=e.getID().getActorID();if(e.hasPresenceChange()&&this.onlineClients.has(s)){const o=e.getPresenceChange();switch(o.type){case We.Put:n.push(this.presences.has(s)?{type:"presence-changed",source:t,value:{clientID:s,presence:o.presence}}:{type:"watched",source:M.Remote,value:{clientID:s,presence:o.presence}});break;case We.Clear:n.push({type:"unwatched",source:M.Remote,value:{clientID:s,presence:this.getPresence(s)}}),this.removeOnlineClient(s);break}}const{opInfos:i}=e.execute(this.root,this.presences,t);if(this.changeID=this.changeID.syncLamport(e.getID().getLamport()),i.length>0){const o=this.isEnableDevtools()?e.toStruct():void 0;n.push(t===M.Remote?{type:"remote-change",source:t,value:{actor:s,clientSeq:e.getID().getClientSeq(),serverSeq:e.getID().getServerSeq(),message:e.getMessage()||"",operations:i},rawChange:o}:{type:"local-change",source:t,value:{actor:s,clientSeq:e.getID().getClientSeq(),serverSeq:e.getID().getServerSeq(),message:e.getMessage()||"",operations:i},rawChange:o})}n.length>0&&this.publish(n)}applyWatchStream(e){if(e.body.case==="initialization"){const t=e.body.value.clientIds,n=new Set;for(const s of t)s!==this.changeID.getActorID()&&n.add(s);this.setOnlineClients(n),this.publish([{type:"initialized",source:M.Local,value:this.getPresences()}]);return}if(e.body.case==="event"){const{type:t,publisher:n}=e.body.value,s=[];if(t===cn.DOCUMENT_WATCHED)this.addOnlineClient(n),this.hasPresence(n)&&s.push({type:"watched",source:M.Remote,value:{clientID:n,presence:this.getPresence(n)}});else if(t===cn.DOCUMENT_UNWATCHED){const i=this.getPresence(n);this.removeOnlineClient(n),i&&s.push({type:"unwatched",source:M.Remote,value:{clientID:n,presence:i}})}s.length>0&&this.publish(s)}}applyStatus(e){this.status=e,e==="detached"&&this.setActor(fn),this.publish([{source:e==="removed"?M.Remote:M.Local,type:"status-changed",value:e==="attached"?{status:e,actorID:this.changeID.getActorID()}:{status:e}}])}applyDocEvent(e){if(e.type==="status-changed"){this.applyStatus(e.value.status),e.value.status==="attached"&&this.setActor(e.value.actorID);return}if(e.type==="snapshot"){const{snapshot:t,serverSeq:n}=e.value;if(!t)return;this.applySnapshot(k.fromString(n),z.hexToBytes(t));return}if(e.type==="local-change"||e.type==="remote-change"){if(!e.rawChange)return;const t=at.fromStruct(e.rawChange);this.applyChange(t,e.source)}if(e.type==="initialized"){const t=new Set;for(const{clientID:n,presence:s}of e.value)t.add(n),this.presences.set(n,s);this.setOnlineClients(t);return}if(e.type==="watched"){const{clientID:t,presence:n}=e.value;this.addOnlineClient(t),this.presences.set(t,n);return}if(e.type==="unwatched"){const{clientID:t}=e.value;this.removeOnlineClient(t),this.presences.delete(t)}if(e.type==="presence-changed"){const{clientID:t,presence:n}=e.value;this.presences.set(t,n)}}applyTransactionEvent(e){for(const t of e)this.applyDocEvent(t)}getValueByPath(e){if(!e.startsWith("$"))throw new R(D.InvalidArgument,'path must start with "$"');const t=e.split(".");t.shift();let n=this.getRoot();for(const s of t)if(n=n[s],n===void 0)return;return n}setOnlineClients(e){this.onlineClients=e}resetOnlineClients(){this.onlineClients=new Set}addOnlineClient(e){this.onlineClients.add(e)}removeOnlineClient(e){this.onlineClients.delete(e)}hasPresence(e){return this.presences.has(e)}getMyPresence(){if(this.status!=="attached")return{};const e=this.presences.get(this.changeID.getActorID());return e?we(e):{}}getPresence(e){if(e===this.changeID.getActorID())return this.getMyPresence();if(!this.onlineClients.has(e))return;const t=this.presences.get(e);return t?we(t):void 0}getPresenceForTest(e){const t=this.presences.get(e);return t?we(t):void 0}getPresences(){const e=[];e.push({clientID:this.changeID.getActorID(),presence:we(this.getMyPresence())});for(const t of this.onlineClients)this.presences.has(t)&&e.push({clientID:t,presence:we(this.presences.get(t))});return e}getSelfForTest(){return{clientID:this.getChangeID().getActorID(),presence:this.getMyPresence()}}getOthersForTest(){const e=this.getChangeID().getActorID();return this.getPresences().filter(t=>t.clientID!==e).sort((t,n)=>t.clientID>n.clientID?1:-1)}canUndo(){return this.internalHistory.hasUndo()&&!this.isUpdating}canRedo(){return this.internalHistory.hasRedo()&&!this.isUpdating}undo(){if(this.isUpdating)throw new Error("Undo is not allowed during an update");const e=this.internalHistory.popUndo();if(e===void 0)throw new Error("There is no operation to be undone");this.ensureClone();const t=It.create(this.changeID.next(),this.clone.root,this.clone.presences.get(this.changeID.getActorID())||{});for(const h of e){if(!(h instanceof Ae)){new Vn(t,we(this.clone.presences.get(this.changeID.getActorID()))).set(h.value,{addToHistory:!0});continue}const f=t.issueTimeTicket();h.setExecutedAt(f),t.push(h)}const n=t.getChange();n.execute(this.clone.root,this.clone.presences,M.UndoRedo);const{opInfos:s,reverseOps:i}=n.execute(this.root,this.presences,M.UndoRedo),o=t.getReversePresence();if(o&&i.push({type:"presence",value:o}),i.length>0&&this.internalHistory.pushRedo(i),!n.hasPresenceChange()&&s.length===0)return;this.localChanges.push(n),this.changeID=n.getID();const a=this.changeID.getActorID(),c=[];s.length>0&&c.push({type:"local-change",source:M.UndoRedo,value:{message:n.getMessage()||"",operations:s,actor:a,clientSeq:n.getID().getClientSeq(),serverSeq:n.getID().getServerSeq()},rawChange:this.isEnableDevtools()?n.toStruct():void 0}),n.hasPresenceChange()&&c.push({type:"presence-changed",source:M.UndoRedo,value:{clientID:a,presence:this.getPresence(a)}}),this.publish(c)}redo(){if(this.isUpdating)throw new Error("Redo is not allowed during an update");const e=this.internalHistory.popRedo();if(e===void 0)throw new Error("There is no operation to be redone");this.ensureClone();const t=It.create(this.changeID.next(),this.clone.root,this.clone.presences.get(this.changeID.getActorID())||{});for(const h of e){if(!(h instanceof Ae)){new Vn(t,we(this.clone.presences.get(this.changeID.getActorID()))).set(h.value,{addToHistory:!0});continue}const f=t.issueTimeTicket();h.setExecutedAt(f),t.push(h)}const n=t.getChange();n.execute(this.clone.root,this.clone.presences,M.UndoRedo);const{opInfos:s,reverseOps:i}=n.execute(this.root,this.presences,M.UndoRedo),o=t.getReversePresence();if(o&&i.push({type:"presence",value:o}),i.length>0&&this.internalHistory.pushUndo(i),!n.hasPresenceChange()&&s.length===0)return;this.localChanges.push(n),this.changeID=n.getID();const a=this.changeID.getActorID(),c=[];s.length>0&&c.push({type:"local-change",source:M.UndoRedo,value:{message:n.getMessage()||"",operations:s,actor:a,clientSeq:n.getID().getClientSeq(),serverSeq:n.getID().getServerSeq()},rawChange:this.isEnableDevtools()?n.toStruct():void 0}),n.hasPresenceChange()&&c.push({type:"presence-changed",source:M.UndoRedo,value:{clientID:a,presence:this.getPresence(a)}}),this.publish(c)}getUndoStackForTest(){return this.internalHistory.getUndoStackForTest()}getRedoStackForTest(){return this.internalHistory.getRedoStackForTest()}}function ic(r,e){return t=>async n=>(r&&n.header.set("x-api-key",r),e&&n.header.set("authorization",e),await t(n))}const hi={name:"yorkie-js-sdk",version:"0.4.25",description:"Yorkie JS SDK",main:"./dist/yorkie-js-sdk.js",typings:"./dist/yorkie-js-sdk.d.ts",files:["dist"],scripts:{build:"tsc && vite build","build:proto":"npx buf generate","build:docs":"typedoc","build:examples":"npm run build --workspace examples","build:ghpages":"mkdir -p ghpages/examples && cp -r docs ghpages/api-reference && find examples -name 'dist' -type d -exec sh -c 'cp -r {} ghpages/examples/$(basename $(dirname {}))' \\;",dev:"vite build -c vite.preview.ts && vite preview",test:"vitest run","test:watch":"vitest","test:bench":"vitest bench","test:ci":"vitest run --coverage","test:yorkie.dev":"TEST_RPC_ADDR=https://api.yorkie.dev vitest run --coverage",lint:"eslint . --fix --max-warnings=0 --ext .ts",prepare:"npm run build"},engines:{node:">=18.0.0",npm:">=7.1.0"},repository:{type:"git",url:"git+https://github.com/yorkie-team/yorkie-js-sdk.git"},author:{name:"hackerwins",email:"susukang98@gmail.com"},license:"Apache-2.0",bugs:{url:"https://github.com/yorkie-team/yorkie-js-sdk/issues"},homepage:"https://github.com/yorkie-team/yorkie-js-sdk#readme",devDependencies:{"@bufbuild/buf":"^1.28.1","@bufbuild/protoc-gen-es":"^1.6.0","@connectrpc/protoc-gen-connect-es":"^1.2.0","@types/google-protobuf":"^3.15.5","@types/jsdom":"^21.1.3","@types/long":"^4.0.1","@typescript-eslint/eslint-plugin":"^5.30.6","@typescript-eslint/parser":"^5.30.6","@vitest/coverage-istanbul":"^0.34.5","@vitest/coverage-v8":"^0.34.5",eslint:"^8.19.0","eslint-plugin-jsdoc":"^39.3.3","eslint-plugin-prettier":"^4.2.1","eslint-plugin-tsdoc":"^0.2.16",husky:"^8.0.3",jsdom:"^22.1.0",prettier:"^2.7.1","ts-node":"^10.9.1",typedoc:"^0.25.13",typescript:"^4.7.4","typescript-transform-paths":"^3.3.1",vite:"^4.4.9","vite-plugin-commonjs":"^0.10.1","vite-plugin-dts":"^3.9.1","vite-tsconfig-paths":"^4.2.1",vitest:"^0.34.5","vitest-environment-custom-jsdom":"file:test/vitest/env"},dependencies:{"@bufbuild/protobuf":"^1.6.0","@connectrpc/connect":"^1.2.0","@connectrpc/connect-web":"^1.2.0",long:"^5.2.0"},husky:{hooks:{"pre-commit":"npm run lint"}},workspaces:["examples/*"]};function oc(){return r=>async e=>(e.header.set("x-yorkie-user-agent",hi.name+"/"+hi.version),await r(e))}var Xt=(r=>(r.Manual="manual",r.Realtime="realtime",r.RealtimePushOnly="realtime-pushonly",r.RealtimeSyncOff="realtime-syncoff",r))(Xt||{}),ui=(r=>(r.Deactivated="deactivated",r.Activated="activated",r))(ui||{});const kn={syncLoopDuration:50,retrySyncLoopDelay:1e3,reconnectStreamDelay:1e3};class sr{constructor(e,t){u(this,"id"),u(this,"key"),u(this,"status"),u(this,"attachmentMap"),u(this,"apiKey"),u(this,"syncLoopDuration"),u(this,"reconnectStreamDelay"),u(this,"retrySyncLoopDelay"),u(this,"rpcClient"),t=t||kn,this.key=t.key?t.key:ei(),this.status="deactivated",this.attachmentMap=new Map,this.apiKey=t.apiKey||"",this.syncLoopDuration=t.syncLoopDuration||kn.syncLoopDuration,this.reconnectStreamDelay=t.reconnectStreamDelay||kn.reconnectStreamDelay,this.retrySyncLoopDelay=t.retrySyncLoopDelay||kn.retrySyncLoopDelay,this.rpcClient=ro(Yo,Co({baseUrl:e,interceptors:[ic(t.apiKey,t.token),oc()]}))}activate(){return this.isActive()?Promise.resolve():this.rpcClient.activateClient({clientKey:this.key},{headers:{"x-shard-key":this.apiKey}}).then(e=>{this.id=e.clientId,this.status="activated",this.runSyncLoop(),y.info(`[AC] c:"${this.getKey()}" activated, id:"${this.id}"`)}).catch(e=>{throw y.error(`[AC] c:"${this.getKey()}" err :`,e),e})}deactivate(){return this.status==="deactivated"?Promise.resolve():this.rpcClient.deactivateClient({clientId:this.id},{headers:{"x-shard-key":this.apiKey}}).then(()=>{for(const[e,t]of this.attachmentMap)t.doc.applyStatus(ze.Detached),this.detachInternal(e);this.status="deactivated",y.info(`[DC] c"${this.getKey()}" deactivated`)}).catch(e=>{throw y.error(`[DC] c:"${this.getKey()}" err :`,e),e})}attach(e,t={}){var s;if(!this.isActive())throw new R(D.ClientNotActive,`${this.key} is not active`);if(e.getStatus()!==ze.Detached)throw new R(D.DocumentNotDetached,`${e.getKey()} is not detached`);e.setActor(this.id),e.update((i,o)=>o.set(t.initialPresence||{}));const n=(s=t.syncMode)!=null?s:"realtime";return this.rpcClient.attachDocument({clientId:this.id,changePack:z.toChangePack(e.createChangePack())},{headers:{"x-shard-key":`${this.apiKey}/${e.getKey()}`}}).then(async i=>{const o=z.fromChangePack(i.changePack);return e.applyChangePack(o),e.getStatus()===ze.Removed||(e.applyStatus(ze.Attached),this.attachmentMap.set(e.getKey(),new Ya(this.reconnectStreamDelay,e,i.documentId,n)),n!=="manual"&&await this.runWatchLoop(e.getKey()),y.info(`[AD] c:"${this.getKey()}" attaches d:"${e.getKey()}"`)),e}).catch(i=>{throw y.error(`[AD] c:"${this.getKey()}" err :`,i),i})}detach(e,t={}){var s;if(!this.isActive())throw new R(D.ClientNotActive,`${this.key} is not active`);const n=this.attachmentMap.get(e.getKey());if(!n)throw new R(D.DocumentNotAttached,`${e.getKey()} is not attached`);return e.update((i,o)=>o.clear()),this.rpcClient.detachDocument({clientId:this.id,documentId:n.docID,changePack:z.toChangePack(e.createChangePack()),removeIfNotAttached:(s=t.removeIfNotAttached)!=null?s:!1},{headers:{"x-shard-key":`${this.apiKey}/${e.getKey()}`}}).then(i=>{const o=z.fromChangePack(i.changePack);return e.applyChangePack(o),e.getStatus()!==ze.Removed&&e.applyStatus(ze.Detached),this.detachInternal(e.getKey()),y.info(`[DD] c:"${this.getKey()}" detaches d:"${e.getKey()}"`),e}).catch(i=>{throw y.error(`[DD] c:"${this.getKey()}" err :`,i),i})}async changeSyncMode(e,t){if(!this.isActive())throw new R(D.ClientNotActive,`${this.key} is not active`);const n=this.attachmentMap.get(e.getKey());if(!n)throw new R(D.DocumentNotAttached,`${e.getKey()} is not attached`);const s=n.syncMode;return s===t?e:(n.changeSyncMode(t),t==="manual"?(n.cancelWatchStream(),e):(t==="realtime"&&(n.remoteChangeEventReceived=!0),s==="manual"&&await this.runWatchLoop(e.getKey()),e))}sync(e){if(!this.isActive())throw new R(D.ClientNotActive,`${this.key} is not active`);const t=[];if(e){const n=this.attachmentMap.get(e.getKey());if(!n)throw new R(D.DocumentNotAttached,`${e.getKey()} is not attached`);t.push(this.syncInternal(n,"realtime"))}else this.attachmentMap.forEach(n=>{t.push(this.syncInternal(n,n.syncMode))});return Promise.all(t)}remove(e){if(!this.isActive())throw new R(D.ClientNotActive,`${this.key} is not active`);const t=this.attachmentMap.get(e.getKey());if(!t)throw new R(D.DocumentNotAttached,`${e.getKey()} is not attached`);e.setActor(this.id);const n=z.toChangePack(e.createChangePack());return n.isRemoved=!0,this.rpcClient.removeDocument({clientId:this.id,documentId:t.docID,changePack:n},{headers:{"x-shard-key":`${this.apiKey}/${e.getKey()}`}}).then(s=>{const i=z.fromChangePack(s.changePack);e.applyChangePack(i),this.detachInternal(e.getKey()),y.info(`[RD] c:"${this.getKey()}" removes d:"${e.getKey()}"`)}).catch(s=>{throw y.error(`[RD] c:"${this.getKey()}" err :`,s),s})}getID(){return this.id}getKey(){return this.key}isActive(){return this.status==="activated"}getStatus(){return this.status}runSyncLoop(){const e=()=>{if(!this.isActive()){y.debug(`[SL] c:"${this.getKey()}" exit sync loop`);return}const t=[];for(const[,n]of this.attachmentMap)n.needRealtimeSync()&&(n.remoteChangeEventReceived=!1,t.push(this.syncInternal(n,n.syncMode)));Promise.all(t).then(()=>setTimeout(e,this.syncLoopDuration)).catch(n=>{y.error(`[SL] c:"${this.getKey()}" sync failed:`,n),setTimeout(e,this.retrySyncLoopDelay)})};y.debug(`[SL] c:"${this.getKey()}" run sync loop`),e()}async runWatchLoop(e){const t=this.attachmentMap.get(e);if(!t)throw new R(D.DocumentNotAttached,`${e} is not attached`);return t.runWatchLoop(n=>{if(!this.isActive())return Promise.reject(new R(D.ClientNotActive,`${this.key} is not active`));const s=new AbortController,i=this.rpcClient.watchDocument({clientId:this.id,documentId:t.docID},{headers:{"x-shard-key":`${this.apiKey}/${e}`},signal:s.signal});return t.doc.publish([{type:re.ConnectionChanged,value:Sn.Connected}]),y.info(`[WD] c:"${this.getKey()}" watches d:"${e}"`),new Promise((o,a)=>{(async()=>{try{for await(const h of i)this.handleWatchDocumentsResponse(t,h),h.body.case==="initialization"&&o([i,s])}catch(h){t.doc.resetOnlineClients(),t.doc.publish([{type:re.Initialized,source:M.Local,value:t.doc.getPresences()}]),t.doc.publish([{type:re.ConnectionChanged,value:Sn.Disconnected}]),y.debug(`[WD] c:"${this.getKey()}" unwatches`),h instanceof G&&h.code!=P.Canceled&&n(),a(h)}})()})})}handleWatchDocumentsResponse(e,t){if(t.body.case==="event"&&t.body.value.type===cn.DOCUMENT_CHANGED){e.remoteChangeEventReceived=!0;return}e.doc.applyWatchStream(t)}detachInternal(e){const t=this.attachmentMap.get(e);!t||(t.cancelWatchStream(),y.debug(`[WD] c:"${this.getKey()}" unwatches`),this.attachmentMap.delete(e))}syncInternal(e,t){const{doc:n,docID:s}=e,i=n.createChangePack();return this.rpcClient.pushPullChanges({clientId:this.id,documentId:s,changePack:z.toChangePack(i),pushOnly:t==="realtime-pushonly"},{headers:{"x-shard-key":`${this.apiKey}/${n.getKey()}`}}).then(o=>{const a=z.fromChangePack(o.changePack);if(a.hasChanges()&&(e.syncMode==="realtime-pushonly"||e.syncMode==="realtime-syncoff"))return n;n.applyChangePack(a),e.doc.publish([{type:re.SyncStatusChanged,value:In.Synced}]),n.getStatus()===ze.Removed&&this.detachInternal(n.getKey());const c=n.getKey(),h=a.getChangeSize();return y.info(`[PP] c:"${this.getKey()}" sync d:"${c}", push:${i.getChangeSize()} pull:${h} cp:${a.getCheckpoint().toTestString()}`),n}).catch(o=>{throw n.publish([{type:re.SyncStatusChanged,value:In.SyncFailed}]),y.error(`[PP] c:"${this.getKey()}" err :`,o),o})}}const ac=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"})),cc={Client:sr,Document:rr,Primitive:U,Text:Gt,Counter:Ht,Tree:Yt,IntType:Le.IntegerCnt,LongType:Le.LongCnt};typeof globalThis<"u"&&(globalThis.yorkie={Client:sr,Document:rr,Primitive:U,Text:Gt,Counter:Ht,Tree:Yt,IntType:Le.IntegerCnt,LongType:Le.LongCnt}),O.Change=at,O.Client=sr,O.ClientStatus=ui,O.Counter=Ht,O.Devtools=ac,O.DocEventType=re,O.Document=rr,O.DocumentStatus=ze,O.DocumentSyncStatus=In,O.EventSourceDevPanel=oi,O.EventSourceSDK=ai,O.OpSource=M,O.Primitive=U,O.StreamConnectionStatus=Sn,O.SyncMode=Xt,O.Text=Gt,O.TimeTicket=ne,O.Tree=Yt,O.converter=z,O.default=cc,O.setLogLevel=ta,Object.defineProperties(O,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})})})(Nn,Nn.exports);const li=fc(Nn.exports),fi=["Ali","Beatriz","Charles","Diya","Eric","Fatima","Gabriel","Hanna","Johnson","Perry","Parker","Kelly"],dc=()=>{const F=Math.floor(Math.random()*fi.length);return fi[F]},di=["red","yellow","orange","green","blue","purple"],gc=()=>{const F=Math.floor(Math.random()*di.length);return di[F]};async function mc(){const F=new li.Client("https://api.yorkie.dev",{apiKey:"cedaovjuioqlk4pjqn6g"});await F.activate();const ee=new li.Document("profile-stack",{enableDevtools:!0});ee.subscribe("presence",O=>{O.type!==Nn.exports.DocEventType.PresenceChanged&&pc(ee.getPresences(),F.getID())}),await F.attach(ee,{initialPresence:{name:dc(),color:gc()}}),window.addEventListener("beforeunload",()=>{F.deactivate()})}const ir=4,or=(F,ee,O)=>{const se=document.createElement("div");return se.className="peer",O==="main"?se.innerHTML=`
    <div class="profile">
      <img src="./images/profile-${ee}.svg" alt="profile" class="profile-img"/>
    </div>
    <div class="name speech-bubbles">${F}</div>
  `:O==="more"&&(se.innerHTML=`
    <img src="./images/profile-${ee}.svg" alt="profile" class="profile-img"/>
    <span class="name">${F}</span>
  `),se},pc=(F,ee)=>{const O=F.filter(({clientID:fe,presence:lt})=>fe!==ee&&lt.name&&lt.color),se=O.length+1,K=se>ir,u=document.getElementById("peerList");u.innerHTML="";const P=document.createElement("div");P.className="peer-more-list speech-bubbles";const Y=F.find(({clientID:fe})=>fe===ee).presence,Qt=or(`${Y.name} (me)`,Y.color,"main");if(Qt.classList.add("me"),u.appendChild(Qt),O.forEach((fe,lt)=>{const{name:en,color:tn}=fe.presence;if(lt<ir-1){const Nt=or(en,tn,"main");u.appendChild(Nt);return}const ft=or(en,tn,"more");P.appendChild(ft)}),K){const fe=document.createElement("div");fe.className="peer more",fe.innerHTML=`
      <div class="profile">
      +${se-ir}
      </div>
    `,fe.appendChild(P),u.appendChild(fe)}};mc();
